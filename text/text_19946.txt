BACKGROUND
microarrays are an experimental method for detecting the presence or absence of multiple genes within a sample simultaneously, through specific binding to an array of high-density probes. they therefore have a diagnostic potential in a number of areas including that of infectious diseases. a microarray containing probes for genes specific to different strains of an organism can detect the presence of a particular strain of the organism in a clinical sample according to which of the probes have an elevated signal. diagnostic testing by microarray is potentially quicker, easier and more reliable than established tests  <cit> . it also has the scope for detecting a range of organisms in a sample in a single test.

a microarray for molecular serotyping of the bacterium streptococcus pneumoniae was designed to detect  <dig> known serotypes of the pneumococcus from dna extracts  <cit> . clinical samples may contain more than one serotype of s. pneumoniae. a key feature of molecular serotyping by microarray, spurring interest in the method, is that rapid detection of multiple serotypes in a clinical sample should be feasible. in addition it should be possible to quantify the relative abundance of each of the serotypes in the sample. achieving these two goals with established serotyping methods is either prohibitively time consuming or simply not possible. here we propose a statistical analysis of the s. pneumoniae microarray data that achieves both these objectives, identifying both the serotype and their relative abundance in samples.

the streptococcus pneumoniae molecular serotyping microarray was designed with multiple probes representing all the known capsular polysaccharide synthesis genes. in the rest of this paper we refer to these genes as cps genes and these genes' probes as the cps probes. the cps genes encode the proteins and enzymes that biosynthesise and assemble the capsular polysaccharide. serotyping was classically established through cross-reactivity with typing antisera which discriminate each serotype due to structural differences in the capsular polysaccharide. the serotype is relevant because the capsular polysaccharide represents the interface between bacterium and host and so is associated with immunity and invasive disease and forms the basis of polyvalent vaccines currently available. each serotype of the pneumococcus contains a small subset of the cps genes, ranging in number from  <dig> to  <dig>  <cit> , which determines the nature and structure of the capsule polysaccharide, and thus the serotype may be determined at the genetic level by the combination of cps genes present.

for this reason the cps genes have been sequenced for all  <dig> serotypes. most of the serotypes are not fully sequenced. the design of probes for the array is therefore essentially limited to these genes. however, a number of serotypes may have very similar or even identical combinations of cps genes present. therefore additional probes on the microarray test for more subtle genetic differences between key cps genes of such serotypes. in the rest of this paper we refer to these additional probes as stids. one problem that the statistical analysis needed to address was the integration of the cps probe data and the stids probe data.

the technique presents several further analysis problems. fluorescent intensity signals from microarray probes for genes indicate gene abundance only indirectly. such signals are disturbed by a variety of random factors which are difficult to control: from variation in the dna extraction to variation in the binding of the dna to its oligonucleotide probe. concerning the identification of genes, it is sometimes difficult to design probes which are entirely specific to a particular gene. due to gene homology and the overall similarity of their dna sequences, a probe for one gene may bind to the dna from a different gene . in addition, the genomic dna of the organisms of interest can be contaminated by dna from the host and from other commensal or pathogenic organisms.

in the following we develop an empirical bayesian statistical model for calculating the probabilities of serotype combinations based on the data from the serotyping microarrays. we first set up likelihoods for gene binding depending on microarray log intensities for cps genes. then, likelihoods of serotype combinations depending on gene binding and incorporating cross-hybridisation effects are described. further, likelihoods for serotypes depending on log intensities of stid probes are provided. finally, all these likelihoods are put together to give a likelihood of serotype combinations depending on log intensities from cps probes and stid probes. combined with a prior on serotype combinations this allows us to infer a posterior probability for serotype combinations, apart from a normalising constant. some of the hyperparameters of the model are estimated in an empirical bayes fashion from the microarray data. since there are exponentially many combinations of serotypes, we use a heuristic to limit the number of combinations to a subset of serotypes and serotype combinations with a potential for high probabilities.

the second objective of the analysis is to quantify the relative abundance of the serotypes in the sample. so in the final part of the methods section we describe a bayesian random effects model for estimating abundances of serotypes for a fixed combination of serotypes.

in order to assess the accuracy of our experimental and statistical approach, we analysed microarray data from samples of the  <dig> known serotypes of the bacterium s. pneumoniae. we refer to these  <dig> microarrays as reference arrays. in the first assessment of the method the task was to detect the single serotype present in the sample when applied to the  <dig> reference arrays. then, in order to assess the capability of the method to detect combinations of more than one serotype, four additional sets of microarray data were produced using a combination of three or five serotypes in known abundance in a sample. the latter microarrays, to which we refer as spike-in experiments, also allow us to assess the accuracy of the bayesian random effects model in predicting abundances of serotypes.

methods
the first part of the methods section describes the data; the streptococcus pneumoniae microarray and the datasets used in this article. in the second part we develop a probabilistic model for calculating the likelihood of a combination of serotypes given the binding intensities measured for cps probes and stid probes on a microarray. in the third part of the methods we describe a bayesian random effects model for estimating the abundance of each serotype in a combination.

data
streptococcus pneumoniae microarray
the bμgs sp-cpsv <dig> . <dig> microarray  <cit>  is a custom designed microarray on the agilent sureprint platform  <cit> , printed in the  <dig> × 15k format and comprised primarily of 60mer oligonucleotides probes. these microarrays were hybridized as two colour arrays but the two channels were analysed entirely independently, so that one array can measure two different samples, one sample analysed in the red  channel and one analysed in the green  channel. this means that the probe intensity measures used are not intensity ratios but raw fluorescent intensity values. these values have been background subtracted at the feature extraction stage and logs of these intensities are used throughout unless otherwise stated. between array normalisation is not necessary since the data on different arrays, or indeed different channels, are never used in conjunction with each other for determining the individual serotype call for a sample.

the microarray contains several thousand oligonu-cleotide probes designed to detect a number of different entities:

 <dig>  it contains probes, referred to here as cps probes, for  <dig> cps genes. on average there are  <dig> probes per gene. these probes are used for serotyping the sample.

 <dig>  it contains probes, referred to here as stid probes, designed to identify serotypes that are too closely related to be resolved by the cps genes alone.

 <dig>  there are further probes on the microarray for the entire genome of streptococcus pneumoniae from two sequenced strains of the bacterium ,  <dig> probes in total, as well as probes for antibiotic resistance genes and for other pathogens commonly found in nasopharyngeal swabs.

the serotype analysis only uses the first two types of probes directly, the cps probes and the stid probes, for calculating the probabilities of combinations of serotypes. some of the other probes are used indirectly, in that the median of the log intensities of the  <dig> probes for the entire s. pneumoniae genome is used to derive priors for the bayes calculations in the analysis.

any particular serotype of s. pneumoniae only contains a small subset of the  <dig> cps genes. in figure  <dig> the subset of cps genes found in the serotype being tested by this example microarray experiment are marked in black. some of the cps genes not found in this serotype have elevated intensities. this reflects cross-hybridization of probes; in some cases it is difficult to design probes which are entirely specific to a particular gene, so probes for one gene may bind to the dna from a different gene.

for the  <dig> serotypes of s. pneumoniae that have been identified to date, the subsets of cps genes that they contain are known  <cit> . as an example, the cps gene composition for a selection of nine of the  <dig> known serotypes are shown in table  <dig>  the number of cps genes present in a serotype varies from as few as  <dig> to as many as  <dig>  with an average of  <dig>  in general any two serotypes will have some cps genes in common. and some serotypes may have very similar sets of characteristic cps genes, which makes differentiating between them more difficult.

the cps gene composition for a selection of nine of the  <dig> known serotypes of streptococcus pneumoniae  <cit> . the entries in the table are serial numbers for individual cps genes.

in practice a clinical sample may contain more than one serotype. figure  <dig> shows a boxplot of the cps probe intensities from a microarray testing a sample containing five serotypes, 23f,  <dig>  6b,  <dig> and 19f, in proportions 50%, 25%, 15%, 8% and 2%. only the cps genes found in the five serotypes are shown in the figure for clarity. it can be seen that some of the cps genes are found in two or more of the serotypes contained in this sample. one gene  is found in all five serotypes. the effect of cross-hybridisation can also be seen in figure  <dig> 

a further complexity in the design of the s. pneumoniae molecular serotyping microarray is that eighteen sets of closely related serotypes have identical, or nearly identical, sets of cps genes. an example can be seen in table  <dig> where serotypes 35c and  <dig> have identical gene complements, so could not be distinguished by cps probes alone. for such cases, the microarray contains extra probes in order to distinguish between the serotypes. the extra probes are here referred to as stids. the serotypes that were targeted by the stid probes are listed in the first column of table  <dig>  as can be seen from the table, most stids are designed to differentiate between two serotypes. such stid probes for a pair of serotypes come in pairs, with one probe for one serotype and a paired probe for the corresponding region of the genome of the second serotype. a stid test for a pair of serotypes comprises, on average,  <dig> pairs of stid probes.

the stid tests designed to discriminate identical or very similar serotypes and the actual stid tests carried out in practice.

whilst the stids are designed to discriminate specific pairs of serotypes, in some cases further serotypes, closely related to the pair in question, will also elevate the intensities of the stid probes. this is because in the region of the genome being targeted by the stid probes, they have identical, or nearly identical sequences, as one or other of the pair of serotypes in question. hence in practice the stid tests are more complex than indicated in the first column of table  <dig>  the actual tests being carried out, due to this effect, are listed in the second column of table  <dig> 

datasets used in study
we used two different experimental datasets in order to validate the probabilistic model described in this article:

 <dig>  reference arrays:  <dig> microarrays each testing a sample containing a single serotype.

 <dig>  spike-in experiments: four arrays with samples of more than one serotype. the composition of the combinations are given in table  <dig> 

the serotype combinations and percentage abundances used in the spike-in experiment and the results of the data analysis. the figures in brackets following the estimated % abundance πi are the lower and upper 95% credible intervals.

the likelihood of a combination of serotypes
the aim is to identify the serotypes present in a sample. the presence or absence of each of the s serotypes is indicated by a binary random variable sj ∈ { <dig> }, 1≤ j ≤ s. where s is the number of known serotypes, currently  <dig>  we combine the variables in a binary vector s = . depending on the context, s will also denote the set of indices of present serotypes. similarly, whether any gene i of the n genes binds successfully to its cps probes is indicated by binary random variables gi, 1≤ i ≤ n. where n is the number of cps genes, currently  <dig>  g denotes the binary vector as well as the set of indices of binding genes. each serotype j is associated with a subset of cps genes known in advance to characterize this particular serotype . we denote this set of genes by . similarly, we denote the set of all the serotypes that contain gene i by .

the likelihood of the combination of serotypes consists of three parts enumerated below:

 <dig>  likelihood of a gene binding depending on cps probes. we denote the set of log intensities of cps probes for cps gene i by yi, 1≤ i ≤ n. the vector y =  denotes the data sets for all the cps genes on the microarray. this part describes the likelihood of gene i binding depending on its probes yi.

 <dig>  likelihood of a serotype combination depending on gene binding. each serotype is defined by a characteristic subset of cps genes. the subsets of cps genes of different serotypes might partly be identical. in addition genes occurring in the characteristic subsets of genes of two different serotypes may be very similar  to each other, resulting in cross-hybridisation. these dependencies between serotypes need to be taken into account. this part describes the likelihood of a serotype combination s depending on genes binding and the grouping of genes according to homology.

 <dig>  likelihood of a serotype combination depending on stid probes. in order to help with the differentiation between serotypes with identical or very similar sets of cps genes, additional probes are added to the microarrays, the stid probes. each set dl,  <dig> ≤ l ≤ l, of stid probes is designed to differentiate between two serotypes . the vector d =  denotes all the stid data from a microarray experiment. this part describes the likelihood of a serotype combination s depending on stid probes d.

these three likelihoods are explained in the following three sections. the fourth section, combines the above likelihoods into p for a serotype combination s and data y, d. this likelihood can be evaluated for any combination s of the  <dig> serotypes. since this is impractical for all  <dig> possible combinations, we resort to using a heuristic to select a subset of combinations of serotypes. we also suggest a prior p in this section.

the prior p and likelihood p for s allow us to calculated the posterior p apart from a normalising constant  

likelihood of a gene binding depending on cps probes
each cps gene i is represented by a set of about ten cps probes with log intensities , where ri is the number of probes on the array for gene i. assume the true log intensity value for binding of a gene i is μi, with . we simplify notation by setting . if gi =  <dig>  that is, binding is successful, then μi >m, where m is the log intensity of the background signal due to unspecific binding. if gi =  <dig>  that is, binding is unsuccessful, then μi = m. since we have little information about μi, m, and  we consider them to be nuisance parameters over which should be integrated. assuming reasonable priors for these parameters we can calculate p and p as follows.

in general, visual inspection of distributions of log intensities suggests that assumptions of gaussian distributions on the above parameters might not oversimplify matters too much . this is also the standard assumption in much of the analysis of log intensity values from microarray experiments in the literature  <cit> .

as priors for μi, m, and  we assume:

 <dig>  , a scaled inverse χ <dig> distribution with shape and scale parameter ν <dig> and  .

 <dig>  , where μ <dig> and  are the prior mean and variance of the background distribution of log intensity values.

 <dig>  μi = m if gi =  <dig>  and  and μi >m if gi =  <dig>  where μ is the prior mean for the log intensity signal of the probes when a gene binds, and κ <dig> is a prior scaling factor for the variance.

for gi =  <dig> we obtain the likelihood   

here p <dig> is a multivariate t distribution as in equation  <dig> in additional file  <dig>  the integral over μ is solved numerically. similarly, for gi =  <dig> we obtain   

where i is an indicator variable for an event, and p <dig> κ <dig>  ν <dig>  ρ0) is a multivariate t distribution as in equation  <dig> in additional file  <dig>  the integral over μ is solved numerically: the 'int' function of the r  <cit>  package 'rmutil'  <cit>  was found to be a reliable option for evaluating these equations with the given data. equation  <dig> is normalised by a factor obtained by a similar numerical integration where the term pn is dropped.

constants for the prior distributions were chosen using statistics from the arrays, so that the above approach is a test of hypotheses via an empirical bayes procedure:

 <dig>  for the gaussian prior on background signal  we set the mean μ <dig> to the mode of all the log intensities on the array. the scale parameter  was set to the  <dig>  quantile of all log intensities below the mode. this seems to capture the overall distribution of unspecific signals. figure  <dig> shows the density distribution of the data plotted in figure  <dig>  with the background prior distribution  superimposed.

 <dig>  the prior mean μ for the log signal intensity was set to the median of the data from the  <dig> probes on the array for the entire s. pneumoniae sptigr4+r <dig> genome. this genome provides a standard reference level for a binding signal, but is actually independent of the binding of the cps genes in our model. the value of the prior mean for the log signal intensity μ is marked on figure  <dig> 

two values were used for the prior scaling factor for the variance κ <dig>  for increased specificity, that is, less chance of false positives, but with a concomitant increase in false negatives, a value of κ <dig> =  <dig> was used, which is the average number of genes of a serotype. for increased sensitivity, that is, fewer false negatives, but possibly more false positives, a value of κ <dig> =  <dig> was used.

 <dig>  the shape parameter ν <dig> of the variance prior  was set to  <dig> in all cases to give a reasonably broad prior distribution on the noise variance. the scale parameter ρ <dig> of the variance prior is calculated as 1/ <dig> of the distance between μ <dig> and μ.

likelihood of a serotype combination depending on gene binding
if any one of the serotypes  containing gene i is present, we expect gi =  <dig>  that is, gene i binds to its probes. we assume that the binding might fail with small probability β for one serotype. the reason may be experimental failure or biological variation. for simplicity we further assume that these failures are independent for each serotype. hence the probability that a gene i fails to bind is βk, where  is the number of serotypes present in the sample and containing gene i. on the other hand, there might be a small probability α of a spurious binding response. after consultation with experimentalists, these parameters are assumed to be around α = β =  <dig>  .

some of the cps genes are evolutionarily closely related   <cit> . their dna sequences may be quite similar. the intensities of the probes for a particular gene may be elevated not by the presence of the gene they were designed to target, but by the presence of a homologous gene. the probes on the array have been designed to minimize cross-hybridisation, and in practice we find that the signal for most genes are independent. there is however a subset of  <dig> genes in  <dig> different homology groups where there is significant cross-hybridisation. we consider these  <dig> genes as belonging to  <dig> cross-hybridisation groups, and the remaining  <dig> genes as belonging to  <dig> groups containing just one gene. we assume a constant probability γ that a gene wrongly appears as present due to the presence of another gene in the same cross-hybridisation group. after consultation with experimentalists we set the value of γ to  <dig> . a maximum likelihood estimation of γ is presented in the results section.

for the sake of brevity denote the set of genes present in a set of serotypes by . the binary variable hk indicates the presence of a representative gene of cross-hybridisation group k in . ℋ is the index set of genes belonging to group k. when a serotype is present with a gene from the hybridisation group, that group counts as present:   

for i ∈ ℋ we have   

note that in the third condition hk =  <dig> means that no member of the cross-hybridisation group ℋ is present, in contradiction to gene i being a member ) and being present ; the corresponding probability can be set to any arbitrary value, say  <dig> 

likelihood of a serotype combination depending on stid probes
a number of pairs of serotypes have identical cps gene complements. in order to distinguish between these serotypes the microarray contains extra oligonucleotide probes which test subtle genetic differences between key cps genes of these serotypes. these extra probes are referred to as stids.

stid probes are different from the cps probes in that they enable a direct comparison of two specific sets of serotypes: a set tl of stid probes is designed to show the presence or absence of any serotype of a set  of serotypes compared to presence or absence of any serotype of another set  of serotypes. the stid probes for  and  are paired, that is, each probe for one serotype set has a corresponding probe for the other serotype set. we analyse the difference of values of the paired probes. for a set tl of stids we denote the measured differences in log intensities by dl. similar to equations  <dig> and  <dig> we define  

where  and  are as defined in equations  <dig> and 2; they can be expressed analytically as in equation  <dig> and  <dig> in additional file  <dig>  we obtain for the distribution of differences between log intensities of stid probes   

after inspection of typical differences in log intensities of stid probes we use prior values μ <dig> =  <dig> ,  =  = ν <dig> = κ <dig> = 1

posterior of combinations of serotypes
the likelihood of a given serotype combination is given by combining equations  <dig>   <dig>   <dig>   <dig>  and  <dig>  

this model is represented schematically in figure  <dig> 

in practice there are too many different serotypes s, currently  <dig>  to calculate p  for all possible  <dig> combinations. the question is whether we need to test all possible combinations of serotypes. in principle some higher order combination of serotypes might show an unexpectedly high probability, higher than any of its subsets, for example, due to the cross hybridisation effect. however, here we assume that such cases are rare. the observation that in clinical samples a combination containing more than three serotypes is highly unusual provides a further justification for this assumption.

therefore we try to catch at least all pairwise interactions by calculating p  for all s with at most two serotypes. we assume it is unlikely that higher order interactions are not visible in at least pairwise interactions. the serotypes from the thirty most probable of these pairwise combinations are pooled and used to calculate p  for all possible combinations of three or fewer serotypes out of the pool, thus allowing for some high probability three-way interactions that have less probable two-way interactions. finally, serotypes of the fifteen most probable combinations from this pool are selected to create a final pool of serotypes that is small enough to allow calculation of the probability of combinations of eight or less serotypes from the pool.

in order to calculate the posterior p  from the likelihood we require a prior p . let p denote the prior probability of being infected by a number of serotypes λ out of a total of s =  <dig> possible serotypes. since there are  serotype combinations with λ serotypes this implies a prior p of  

where λ is the number of serotypes in s. the probability p is probably declining rapidly with λ. since the exact distribution is unknown, we assume for simplicity that this probability is constant p = 1/ for all λ . prior and likelihood for s allow us to calculated the posterior p apart from a normalising constant  

the software implementation of the analysis method normalises pp for a particular set of combinations of serotypes s, using the sum of pp from all the combinations of serotypes chosen according to the above selection heuristic. since these combinations seem to capture most of the posterior probability mass for s we take these normalised values as approximation to the posterior p.

proportional abundance of serotypes
if the analysis detects the presence of more than one serotype within a sample then information on the relative abundance of the serotypes is desirable. each serotype is represented by a selection of genes, whose abundance can be measured. this suggests an anova analysis to estimate abundance of serotypes. again we opt for a bayesian treatment which allows us to integrate out nuisance variables such as gene specific effects and to derive credible intervals for the serotype abundance estimates.

for the following analysis we work with raw intensities without log transformation since serotype presence and abundance will have an additive effect on gene specific intensities. for obtaining an analytical solution, a linear model with untruncated gaussian distributions as error and prior distributions is convenient. since intensities can only be positive such a model can only be considered an approximation. a further problem is that the variance of a variable measuring abundance is often not constant and depends on the size of the variable. this is mitigated to some degree by integrating over variances in the bayesian model. despite its shortcomings, the results indicate the model reproduces experimental data reasonably well.

more specifically, we want to estimate the proportion of b serotypes in the sample. each serotype is represented by a set of genes as specified in a g × b binary 0/ <dig> matrix g, where g is the number of genes involved. we assume that gene abundance as reflected in its probe intensities is linearly related to the sum of the abundances of serotypes containing the gene. each gene in turn is represented by a set of probes. from visual inspection  it is clear that all these probes are affected in a similar way by gene specific noise. an n × g binary 0/ <dig> matrix z indicates which of the n probes represents each of the g genes and a vector u represents gene specific noise levels. the information in the matrices g and z can be combined in a n × b binary 0/ <dig> matrix x indicating for each of the b serotypes by which of the n probes it is represented.

the response variables wj ≥  <dig>   <dig> ≤ j ≤ n, are intensities of the probes. a random effects anova model is  

where θ is a b-vector of the abundance of serotypes, u is a g-vector of nuisance parameters for noise affecting all probes of a gene in the same way, and ε is a noise term for individual probes. note that there is no mean parameter and the entries in the matrix x are  <dig> or  <dig>  hence θ is the vector of direct  abundances of all serotypes in the sample. as priors we assume , , and , where a is a b × b matrix, b is a g × g matrix, in is the unit matrix, and cb and ca are scaling constants. the matrices a and b are fixed in advance, while the scaling constants cb and ca are considered hyperparameters. the matrix b is set to b = g'g, that is, the more genes two serotypes have in common the higher their abundance is assumed to correlate. matrix a is simply set to ig. to enable the calculation of an analytical solution for the posterior θ of via a conjugate analysis and also to make the scaling constants ca and cb identifiable, we assume . an inverse χ <dig> prior with degree ν <dig> =  <dig> and expected variance  is assumed for . detailed derivations for this model are provided in additional file  <dig>  analysis of simulated data showed that the hyperparameters ca, cb, ν <dig> and  are best set in an empirical bayes fashion by optimising the marginal likelihood .

once a posterior distribution  with mean  for the serotype abundances θ is derived, an estimate of the proportions of serotypes is provided by . due to our model assumptions  can be negative, in which case it is reset to  <dig>  to obtain 95% credible intervals for πi we draw  <dig> samples θ from the posterior of θ and obtain sample proportions . credible  intervals for πi are then easily obtained from the distributions of simulated serotype proportions .

RESULTS
reference arrays
the analysis method gave a correct result for  <dig> of the  <dig> reference arrays. prior parameter values were κ <dig> =  <dig>  α =  <dig> , β =  <dig> , γ =  <dig> . three reference arrays, testing serotypes  <dig>  25a and  <dig>  appeared to give incorrect results.

on the reference array testing serotype  <dig> the analysis called serotype 12f as present, and on the array testing 25a, serotype 25f was called as present. these are two pairs of closely related serotypes and therefore it is likely that the probes designed to discriminate these were not performing optimally or were targeting a poor region for reliable differentiation. the array testing serotype  <dig> detected a combination of serotype  <dig> and serotype 33a. this is expected since serotype  <dig> contains a non-functional copy of the cps gene complement of serotype 33a. hence the bayesian model does produce the correct call after all.

for the majority of the reference arrays the particular serotype being tested in the array experiment had a probability p of effectively  <dig>  the other  <dig> serotypes having extremely low probabilities. for a few arrays the serotype being tested had a probability markedly lower than  <dig>  figure 5a shows a histogram of the highest probability p in the analysis of each of the  <dig> reference arrays. the lower probabilities of a few of the correct serotypes are due to the existence of another serotype with a very similar cps gene complement, differing by just one gene.

originally the model did not include cross-hybridisation. without the inclusion of cross-hybridisation the model still gives relatively good results, although three more reference arrays gave incorrect calls. the array testing serotype 24f called a combination of 24f and 24b, whilst the array testing 33a called 33f, and the array testing 7b called a combination of 7b and 7c. the inclusion of cross-hybridisation solved these three problem serotypes.

spike-in experiment
analysis of the four samples in the spike-in experiment gave the correct serotype combinations, with no false positives and no false negatives. the parameter values, κ <dig> =  <dig>  α =  <dig> , β =  <dig> , γ =  <dig> , were the same as used for the analysis of the reference arrays.

influence of prior value κ1
the results for the reference arrays in figure 5a are for a value of κ <dig> =  <dig>  which gives optimal results. in a clinical context, however, not missing a serotype present in a sample in only trace abundance is of importance. we therefore provide a second choice of a high sensitivity setting with κ <dig> =  <dig> in the software implementation of the analysis. figure 5b shows a histogram of the highest p probability in the analysis of each of the  <dig> reference array experiments when κ <dig> =  <dig>  when κ <dig> =  <dig> there are three extra apparent errors.

the array calling serotype 23f calls a combination of serotypes 23f and 23b. these two serotypes have thirteen cps genes in common and five different. the five differences are in cps genes which are closely related. the extra sensitivity of the analysis with κ <dig> =  <dig> is detecting the five cps genes of serotype 23b. these have levels slightly elevated from the background due in part to cross-hybridisation from the corresponding five genes in serotype 23f. refinement of the cross-hybridisation analysis may be able to resolve this problem, although the fact that 23f and 23b are closely related means that from a clinical stand point this false positive is not too critical. in addition the software implementation of the analysis carries out further checks. for each called serotype, the software checks the probabilities of that serotype's genes ). if any serotype's genes have p <  <dig>  that serotype is flagged as such. in this case serotype 23b is flagged as having genes with p <  <dig> , alerting users to the need for further investigation.

the array testing serotype 33a now calls a combination of serotypes 33a &  <dig>  and the array testing serotype  <dig> calls a combination of  <dig> & 19a. serotypes 33a and  <dig> are not closely related, with only one cps gene in common. similarly serotypes  <dig> and 19a are also unrelated with only one cps gene in common, so it was thought unlikely that these incorrect calls were due to a problem with the analysis. further analysis indicates that the genes for  <dig> and 19a are actually present in very low relative abundance in the samples and we think that these calls are due to contamination of samples 33a and  <dig> at some stage in the experimental process. eight microarrays are mounted on a single glass slide. the arrays testing serotypes  <dig> and 19a were adjacent on the glass slide so contamination of the sample containing serotype  <dig> with serotype 19a at this stage of the experiment is plausible. if the assumption of contamination is correct, the setting of κ <dig> =  <dig> seems to be able to detect the presence of contaminating serotypes at very low abundance levels.

for the spike-in experiment, with a value of κ <dig> =  <dig> the analysis still identified all the correct serotypes as being present but, due to the higher sensitivity at this set-ting, the analysis also gave some false positives . all the false positives were flagged by the software as having genes with p <  <dig> , but none of the true positives were flagged.

we recommend that users of the software implementation of the algorithm run the analysis twice. an initial run with κ <dig> =  <dig> will indicate the main serotype or serotypes present in the sample. a second run with κ <dig> =  <dig> will indicate if there may also be extra low abundance serotypes present. if any of these serotypes have genes with p <  <dig>  they will be flagged, to alert the user that they may warrant further investigation.

influence of prior values α, β and γ
the optimum values of α, β and γ will vary with serotype being studied, so general values of the three priors that work well for all serotypes were chosen, based on expert estimates of expected true and false response rates of probes, namely α =  <dig> , β =  <dig> , γ =  <dig> . the suitability of the chosen values was investigated further. each reference array was analysed in turn. the values of α, β and γ that gave the highest value of p for the serotype that the array was testing were found by numerical optimisation. figure  <dig> shows pairwise plots of the optimum values for α, β and γ for the  <dig> reference arrays. whilst there are some outliers the optimum values for α, β and γ for most serotypes cluster in the region of the chosen values α =  <dig> , β =  <dig> ,  <dig> -γ =  <dig> .

the sensitivity of the results to the values of α, β and γ was also investigated. the  <dig> reference arrays were analysed in turn. each array was analysed with all combinations of eight different values of α and β  and γ . the effect of the prior values that we are most interested in is not so much the absolute value of p for the serotype s being tested on the array, but whether this probability is the highest on that array. therefore for each combination of prior values the fraction of the  <dig> reference arrays that call the correct serotype as the most probable serotype on the array was recorded.

the results for α and β are presented in figure  <dig>  the figure shows how the fraction of correctly called serotypes varies with α and β . the default values of α =  <dig>  and β =  <dig>  lie within the optimal range to generate the maximum number of correctly called serotypes.

it can be seen from figure  <dig> that values of β between  <dig> and  <dig>  give the same results as the default of β =  <dig> . β is the false negative rate for binding, allowing for those genes that do not bind to their probes, despite a serotype that contains those genes being present in a sample. for the reference arrays, which test samples containing only one serotype, the intensities of the probes that should be present are sufficiently high for this correction to be less important. the benefit of including β =  <dig> , arises when a sample contains a combination of serotypes, some with low percentage abundance. then the intensities of some of the probes that should be present will be much closer to the background noise .

whereas the value of γ effects the value of p, the correct calling of the three serotypes that are influenced by cross-hybridisation  was found to be insensitive to the values of γ tested. as the serotyping array develops in the future, as more closely related serotypes of s. pneumoniae are discovered, and more probes are added to the array, then cross-hybridisation may become a greater problem and it may be necessary to adjust the value of γ to give optimal results.

CONCLUSIONS
the streptococcus pneumoniae molecular serotyping microarray combined with an empirical bayesian data analysis presents two main advantages over conventional methods for serotyping strains. firstly, it is extremely accurate in identifying the correct serotype in single serotype samples. secondly, it has the ability to easily detect combinations of serotypes within a sample. initially we tried a simpler analysis of the array data, based on frequentist methods, in which p-values for individual genes were calculated using t-tests and then combined. on the reference arrays a p-value approach gave thirteen incorrect serotype calls, an unacceptably high error rate, so the current bayesian model was adopted. the empirical bayesian data analysis does give two incorrect serotype calls for closely related pairs of serotypes, but these errors have been identified as design problems with the array rather than a problem with the analysis, a de-sign problem that will be addressed in future releases of the array.

the bayesian approach enables additional information, such as on cross-hybridisation or on stids, to be integrated into the main model. the method does not require accurate estimates of prior parameters, working well with general estimates of these values for all serotypes. a few hyperparameters are estimated from the data in an empirical bayes fashion, but in a way that is independent of knowledge of present serotypes or combinations of serotypes. the prior parameters were chosen to be standardised and repeatable across arrays, where levels of signal or background intensity can change. for the reference arrays the signal in the data is reasonably strong. however, for the low percent-age abundance serotypes in the spike-in arrays the signal to noise ratio is much lower, but the same prior parameter values work well.

the spike-in experiment indicates that the method can detect multiple serotypes in samples with as large a number of serotypes as is ever likely to be found in a clinical setting. serotypes with very low abundance within a combination can be detected by the method. as well as detecting the presence of serotype combinations, an approximate measure of the percentage abundance of the serotypes within the combination can be obtained. of the  <dig> estimated abundances in table  <dig>  one serotype  lies slightly outside the credible interval. further experimental work will be required to determine whether this is a problem with the statistical analysis or has arisen from experimental imprecision in the creation of this particular spike-in sample. however the overall conclusions from the results to date suggest that as well as the molecular serotyping microarray's primary role as a method for calling serotypes, it can also provide a useful indication of serotype relative abundance.

in this article we have proposed two separate models. the first is for calculating posterior probabilities of combinations of serotypes where only presence or absence of serotypes is considered. the second model estimates the relative abundance of serotypes. in principle the two models could be combined. however, the primary clinical interest is in calling presence or absence of serotypes. their quantitative assessment is of secondary interest. a model comprising both would be more complex and might compromise the performance as a serotype caller.

the linear gaussian model with constant variances for estimating relative abundances of serotypes makes assumptions which are certainly only approximately correct. for example, abundances are always positive and variances will depend on the abundance values. however, in simulations and in the analysis of the spike-in data this model performed considerably better than simpler models without integration over variances or over the hidden gene abundances. that is, under the constraint of having a model that can be solved analytically, which is important when analysing larger data sets interactively as is currently done with the present software, the current model is an excellent approximation.

this algorithm has been applied to over one thousand clinical samples, containing both single serotypes and combinations of serotypes. the cps gene content of these samples have been checked by manual data analysis methods which has confirmed that the technique described in this article is a reliable automatic analysis method for the s. pneumoniae molecular serotyping microarray. the inference could be affected by the heuristic we employ to reduce the number of combinations tested to a computationally feasible level. increasing the number of combinations tested does not produce any extra combinations of serotypes that have a non-negligible probability, when applied to the clinical data or the reference and spiked-in arrays, indicating that the current cut-off is quite generous.

in this bayesian method to analyse the s. pneumoniae molecular serotyping microarray the serotype combination with the highest probability is accepted as the answer. alternatively, probabilities for properties of interest, for example, the co-occurrence of specific serotypes, may be obtained by model averaging, that is, by summing probabilities of the corresponding serotype combinations. the method is also easily extensible as more is learned of the different strains of this important pathogen. the use of diagnostic microarrays is not confined to the field of infectious diseases. for example arrays have been used as potential diagnostic tools in oncology  <cit>  and cytogenetics  <cit> . the statistical analysis method is quite general and is easily adapted for other diagnostic microarrays that use similar technology. the bayesian approach means that if these microarrays contain extra features, they can be incorporated into the analysis with minimal modification.

an alternative solution to the problem of cross-hybridisation would be to reannotate the cps gene com-positions of the serotypes. the advantage of our approach is that the invariant biological input to the model, that is the cps gene complements of the serotypes determined experimentally by sequencing is separate from the cross-hybridisation input which is a design issue with the array and may not be invariant. the array is being constantly revised and improved so the bayesian model keeps separate the information that will not change from the information that may change in the future.

the method as it stands works very well. future work will concentrate on solving problems that may arise as further data sets become available. adding prior information on gene specific variances and stid specific variances will be investigated as a method for improving the accuracy of the analysis  <cit> . in general cross-hybridisation is not a problem due to careful probe design. where it is a problem the current model treats it at the gene rather than at the probe level. dealing with cross-hybridisation at the probe level may improve the model. however, cross-hybridisation is only a problem between some of the homologous genes, which are very similar in sequence. this means that most of the genes' probes do cross-hybridise, so treating cross-hybridisation at the probe level may not significantly improve performance. an advantage of the current approach is that it is essentially analytical so works well without the need for expert input, and is not too computationally intensive. but the potential of more complex models that require a sampling approach should also be investigated.

the algorithms described in this paper were implemented in the r statistical system  <cit> . for the benefit of researchers in the field of s. pneumoniae who are unfamiliar with r, a user friendly web interface was created for the r script. this web interface was created using the web application rwui  <cit> .

authors' contributions
lw and rn devised the statistical analysis. jh contributed the experimental data and guided interpretation. all authors read and approved the final manuscript.

supplementary material
additional file 1
distributions and posteriors. equations and derivations for all distributions used in calculating the probabilities of combinations of serotypes.

click here for file

 additional file 2
bayesian anova. equations and derivation of the bayesian anova.

click here for file

 acknowledgements
the bacterial microarray group at st. george's, university of london  is funded by the wellcome trust .

BACKGROUND
high-throughput experiments are commonplace in molecular biology and aim to identify genomic measurements associated with clinical phenotypes and biological mechanisms. microarrays and next generation sequencing are popular measurement tools for these experiments and assay tens of thousands of genes at once. typically, data normalization and preprocessing approaches reduce technical variability  <cit>  but there often remain high levels of systematic heterogeneity in the data which can obscure biological phenomena under study. because its impact is often severe, understanding of such heterogeneity should be an integral part of processing and exploration of genomic data.

much of this underlying variability is observed to be systematic with the order in which samples are processed, and therefore is commonly referred to as “batch effects”  <cit> . there are currently two general classes of “batch” correction methods: those that use linear modeling when batches are known or assumed  and those that attempt to identify and control for potential batch effects   <cit> , among others). while uncorrected “batch effects” still appear in published high-throughput data, an additional, more subtle, yet perhaps more common issue has arisen: the incorrect or imprecise definition of biological enquiry during “cleaning” of genomic data, resulting either in the removal of important biological signal, or the retention of unwanted latent variability. it is important to note that all of these algorithms depend on well-designed studies to properly identify these “batch effects”, i.e. where the outcome of interest is balanced across potential batches, as in randomization procedures—otherwise, it is difficult to attribute variance in the data to “batch” or biology of interest  <cit> .

the first class of batch correction methods may miss artifacts due to biology, and unannotated technical variation, while the second class of factor-based estimation may remove biological variation of interest. here we present three illustrative data analyses using sva  and describe how to perform artifact discovery in light of natural heterogeneity within biological groups, secondary biological questions of interest, and non-linear treatment effects. we do this using two publicly available gene expression datasets, one from differentiating pluripotent cells, and another in the developing and aging human brain. our analysis indicates that artifact discovery is an important component of high-throughput analysis pipelines but caution should be exercised in supervising the discovery of artifacts to avoid removing biological signal of interest. in particular, researchers should be aware that many biological effects of potential importance can be removed if they are not explicitly protected during the cleaning process.

methods
a summary of sva
regardless of data processing methods used, an explicit definition of the precise biological question under study is particularly crucial in genomics investigation. using sva formalizes this process in that this “biological model” is an explicitly defined mathematical model passed to sva. effects specified in this model are preserved while systematic heterogeneity that affects many measurements unrelated to these effects are identified and subsequently adjusted for in subsequent statistical analyses. this approach has previously been shown to result in more accurate and stable gene rankings, improved false discovery estimation and correct p-value distributions  <cit> . under this framework, the biological effects interrogated in the data must be limited to those specified in this model as passed to the sva algorithm. if this is not the case, effects of interest may be treated as latent heterogeneity and removed from the data. the impact of researchers’ conception of the biological enquiry on the nature of possible discovery should not be underestimated in this process.

sva’s purely data-driven methods for the estimation of and adjustment for unwanted systematic variance take particular advantage of the breadth of high-dimensional genomics data. the algorithm does not require a priori information about what variables measured by the researcher might represent a “batch effect”. by using the structure of thousands of measures uncorrelated to the effect under study, sva estimates unwanted effects and allows sculpting of a dataset to focus on an explicitly defined biological effect. this is important as commonly-used “batch” variables, such as microarray scan/hybridization date, are likely surrogates for unmeasured variables that are better estimated by the data themselves  <cit> . to determine the number of surrogate variables  to estimate  the sva algorithm can take user input, or use an automated approach via permutation testing to estimate the number of svs present in the data. the correct usage of sva has the potential to increase statistical power when analyzing experimental data, but note that while increasing the number of svs reduces the variability in the dataset, it may also reduce variability in the direction of the effect of interest based on the iterative algorithm used to estimate the svs.

to best assess the biological effect of interest, all estimated svs, along with the defined “biological model” are included for the adjustment of data in downstream differential expression statistical analyses  <cit> . we note that the sva algorithm can permit correlation between these svs and the outcome of interest  <cit> . model selection that removes surrogate or measured variables will lead to p-values that are smaller than their true value   <cit> , greatly increasing probability of identifying false positives. additionally, svs can be regressed out of the data to obtain “cleaned” data for visualization , however differential expression statistics should not be performed on this “clean” data, as this too can lead to anti-conservative bias resulting from between-sample correlation being introduced by regressing out the svs and from inflating variance partitioning related to the effect of interest, as the total variance of the system has been reduced without being taken into account during the linear modeling. we also suggest incorporating a priori biological data, when available, into the evaluation of data “cleaning” by any method, with the goal of using known biology as an additional guide in this process .

RESULTS
batch correction increases ability to detect defined effects
first, we analyze gene expression data from differentiating pluripotent cells  <cit>   using the principles outlined above as a guide in applying sva to focus on particular biological effects in the data. these analyses illustrate how the details of defining biological enquiry in the “cleaning” process impact discovery on both a global and gene-specific level. human pluripotent cell lines were differentiated towards neuroectodermal and mesendodermal fates. biological replicates  for each cell line in each condition were collected after 8 days of differentiation and hybridized to agilent g4112f arrays to measure gene expression. data were preprocessed and normalized using the ‘limma’ r package  <cit>  with background correction and quantile normalization .

following normalization and preceding any “cleaning” of the data principal component analysis  is useful to gain a global perspective on the structure of the data . while the first principal component  reflects the differences between treatments , the second pc correlates strongly with processing data . this is common in gene expression data  <cit> .fig.  <dig> global transcriptional landscape in differentiating pluripotent cells. pca of expression data from differentiating pluripotent cells prior to sva colored by differentiation treatment  and microarray scan date . the first pc shows a strong effect of treatment, while the second pc is related to “batch”: boxplots of the second pc indicate strong association with scan date . pca following estimation and removal of svs again colored by differentiation treatment  and microarray scan date . both the first and second pc now show systematic association with differentiation, and the second pc no longer shows systematic change with scan date . letters are also used to distinguish individual scan dates in  and 



to perform sva here, we define the biological model as the average change in gene expression associated with each treatment . hence, sva will preserve this mean effect while removing other systematic heterogeneity in the data that effect many measures uncorrelated with this mean effect. after performing sva and subsequently regressing out the  <dig> automatically determined svs in this dataset, biological patterns are clearer in this global expression landscape . now, the 1st pc constructs an axis of differentiation primarily towards a mesendodermal fate . the 2nd pc identifies an axis that is exclusively represented in neuroectodermal differentiation. importantly, these samples no longer cluster by processing date, indicating that sva has successfully accounted for the batch effects while preserving biological signal . when combined with precise biological and technical data, these dimension-reducing plots provide a starting point for evaluating both global patterns of biology across the samples under study as well as the extent of technical variation in the data.

we now turn from the impact of this “cleaning” procedure on global gene expression patterns to individual genes. we compared the results of gene-level contrasts between neuroectodermal and mesendodermal differentiation with and without sva . genes expected to be differentially expressed by these treatments, such as pax <dig>  <cit> , are significant without, but much more significant with sva . we also highlight one gene, olfml <dig>  that has not previously been associated with neuroectodermal differentiation and which is non-significant before sva  but very significant after . the majority of contrasts between neuroectodermal and mesendodermal differentiation are more significant after applying sva . here, incorporating svs as adjustment variables in individual-gene models reduces within treatment variability by assigning unrelated variance to the identified latent heterogeneity, hence increasing the power to identify biological differences. furthermore, the relative ranks of genes previously reported to be involved with neuronal  and mesendodermal  differentiation are relatively preserved before and after sva, demonstrating the relative stability of likely true positive effects.fig.  <dig> sva improves power to identify differentially expressed genes. a
pax <dig> shows significant differential expression between mesendodermal and neurectodermal differentiation before sva  and b this effect becomes more significant following sva . c prior to sva, olfml <dig> is not identified as being differentially expressed between differentiation conditions , but d is highly significant after properly controlling for unwanted latent heterogeneity with sva . expression values are on the log <dig> scale. statistical significance was derived from a moderated t-statistic comparing expression in the mesendodermal differentiation condition versus that in the neurectodermal differentiation while also allowing variability to be explained by the undifferentiated condition . individual cell lines are represented on the x-axis. gene expression on the y-axis is depicted in quantile normalized, log2-scale intensities



it is crucial to note here that by defining the biological effect of interest to be the average change in expression with treatment, sva removes many individual sample-specific expression traits. for example, there are multiple cell lines which do not induce pax <dig> expression in the neuroectodermal differentiation condition , but this is not observable after sva . this is desirable if the goal is to estimate the mean effect of each treatment, but detrimental if expression phenotypes of individual cell lines are of interest .

we note that similar reductions in technical variability are seen with the “combat” empirical bayes batch correction approach  <cit> , which also can also utilize an explicit definition of biological enquiry . however, the empirical bayes method places less emphasis on the biological model, mostly reducing global variation even without specifying a biological model . on the gene-level, combat produced smaller p-values on average .

batch correction may remove secondary effects of interest
in figs.  <dig> and  <dig>  our biological model included only a treatment effect. if we are interested in exploring additional effects, this initial model specification is not complete. analysis of additional effects requires their explicit inclusion in the biological model along with the primary effect of interest. statistical analysis can then be applied to the data while incorporating the latent factors identified by the sv analysis.

for example, if we are also interested in gene expression differences between the two sexes in the data depicted in figs.  <dig> and  <dig>  failure to include a “sex” variable in the biological model passed to sva results in the removal of many sex effects in the data . sex is correlated with the expression of multiple genes, and therefore appears as latent systematic heterogeneity to the sva algorithm. the gene rps4y <dig>  is on the y-chromosome, and therefore only expressed in males. in the expression data analyzed without sva, cell lines derived from males have over 256-fold increased expression of this gene . however, after removing the effects of the svs derived from a treatment-only biological model , this effect disappears entirely . therefore, in order to preserve sex differences for exploration, a sex variable should be included along with treatment in the biological model for surrogate variable estimation .fig.  <dig> the biological model limits the scope of biological questions that can be asked. defining a biological model that only preserves the effect of treatment obscures other true biological effects. the rps4y <dig> gene is differentially expressed by sex . however, when the biological model passed to sva does not include sex , the effect of sex at this gene is not apparent . when the effects defined in sva include sex, the difference by sex is preserved in the data . similarly, with gstt <dig>  copy number variation has a large impact on gene expression  which is removed by sva under a treatment-only biological model . including a term for gstt <dig> copy number in the biological model passed to sva preserves the effect . individual cell lines are represented on the x axis. gene expression on the y-axis is depicted in quantile normalized, log2-scale intensities



we explore another example at the gstt <dig> gene , which has common copy number variants  in human populations  <cit>  that are associated with gstt <dig> expression differences and local genetic structure of neighboring genes gstt <dig> and gstt2b  <cit> . the expression data analyzed without sva suggests three different copy numbers  at this gene  which are validated with snp microarray intensities in a subset of these samples . without accounting for gstt <dig> copy number  sva removes the expression differences related to gstt <dig> cnv’s . however, accounting for copy number at this location in the biological model passed to sva retains the copy number effect in the data .

hence, when directed to preserve only the effect of treatment, sva finds and removes wide-spread systematic expression effects associated with both sex and gstt <dig> copy number . this serves as a positive control indicating that sva can successfully identify these known effects in expression data. this is also a cautionary note, reinforcing the notion that analyses must remain within the bounds set by the biological question defined at the outset of the data “cleaning”. hence, any re-analyses of existing data with new questions requires an entirely novel re-processing of the data to address these new questions, not simply the calculation of additional statistics on the same processed data. here we can clearly see how strong an impact our prior conception of the biological system can have on discovery in genomics data.

batch correction may remove non-linear expression patterns
next, we re-analyzed an existing dataset measuring gene expression in the dorsolateral prefrontal cortex region  of the brain across the human lifetime.  <cit> . data was processed and normalized as previously described  <cit> . briefly, background correction and loess normalization were performed on raw two-channel intensity data, and low quality probes were removed from subsequent analysis, leaving  <dig>  probes on  <dig> samples across the lifespan .

patterns of gene expression across age are dynamic and non-linear: the largest changes occur during fetal life and infancy, and decrease in magnitude with age  <cit> . here we expand on the previous modeling of age patterns across the lifespan in several key ways: 1) we applied splines to capture non-linear gene expression effects while ensuring patterns of gene expression are continuous across the lifespan the previous analysis used age by decade interaction terms, which are not necessarily continuous. 2) we estimated and adjusted for a much higher number of svs. the previous analysis used only  <dig> svs, here we allowed sva to automatically determine this number:  <dig> svs were used. this much increased “cleaning” further tuned this dataset to age effects . hence, this newly processed data should only be used for the estimation of canonical, mean patterns of expression across the lifetime. 3) we regressed out svs while allowing the effects of age and mean gene expression  to remain in the data. previously, svs were regressed out while ignoring possible correlation between svs and age, potentially obscuring some age effects.

we applied three related spline models to the dataset, which were a) a linear spline with a knot at birth , i.e. a line fit to expression across age in fetal life, and a second line fit to expression across age in postnatal life. b) a 2nd degree basis spline with a knot at birth , i.e. a curve fit to expression across age in fetal life, and a second curve fit to expression across age in postnatal life. c) a 2nd degree basis spline with knots at birth,  <dig>   <dig>   <dig> and 50 years , i.e. a curve fit to expression across age within each age range between these knots. each model also allowed an offset at birth, because there were no samples in the third trimester of fetal life.

we applied sva to the normalized raw data under each model described above, allowing each to have its own set of svs, which were regressed out of the data to remove their effects for visualization. the impact of each different model employed with sva is depicted globally using pca  and at the individual gene level . consistently, increasing model complexity and flexibility produces pc’s which are more dynamic across age with the least variance within age . these effects are increasingly clear in deeper pc’s. it is of particular interest that this increased power to identify global patterns in the data is achieved while maintaining higher fidelity to the original normalized data: in ~2/ <dig> of the ~30 k probes measured, the adjustment to the data made by sva under model c is less than that made by sva under either of the other models .fig.  <dig> global view of the impact of differing models in sva. pca performed on the original normalized data , and on data “cleaned” with sva using the  <dig> different models described in the text . values of individual samples in the first  <dig> pcs are shown for each analysis, along with a smoothing spline to these pc’s across age . sva model a: linear spline with a knot at birth , sva model b: 2nd degree basis spline with a knot at birth , sva model c: 2nd degree basis spline with knots at birth,  <dig>   <dig>   <dig> and 50 years . each model also incorporated an offset at birth

fig.  <dig> individual gene view of the impact of differing models in sva. cndp <dig> gene expression is shown in the original normalized data  in the top panels. each of the  <dig> different models used for sva are shown overlaid on this original data in the top panels. this fit represents the effect that sva will preserve for this particular gene in each of the  <dig> different scenarios . bottom panels show cndp <dig> gene expression adjusted with svs generated using each of the  <dig> different models. smoothing splines for expression across age are shown for each to depict the difference in expression patterns present when using sva under the different models 



inspection of the impact of these different models on sva’s adjustment of individual gene data demonstrates that increased flexibility in modeling effects can result in both higher fidelity to the original data and the increased ability to distinguish specific dynamic patterns : models a and b introduce greater adjustments to the original normalized data than model c. model c, however effectively reduces within age variance while preserving a gene expression pattern apparent in the normalized data in which dynamics are limited to the range of birth-10 year. while perhaps reducing some variance, both models a and b produce a pattern of expression across age where dynamics are spread from birth-50 year, demonstrating the increased resolution of pattern identification possible with the more flexible model c. this newly processed data is available along with original raw data at the geo repository: gse <dig> 

CONCLUSIONS
using sva, combat or related tools that require the precise definition of biological enquiry can increase the power to identify specific signals in complex genomic datasets. however, especially when high levels of correction are used , biological discovery is directly limited by researchers’ prior conception of the system under study. hence, we must be precise and deliberate in the design and analysis of experiments and the resulting data, and also mindful of the limitations we impose with our own perspective.

here we have discussed primarily how to focus as much as possible on a single narrowly defined question. methods such as sva can also be used in the more open exploration of genomics data. for this, the definition of the biological model of interest would have to be designed specifically for flexibility, to allow more diverse effects to coexist in the sv-adjusted data. perhaps equally important would be the reduction of the amount of “cleaning” performed. in the use of sva this would be done by tempering the number of svs identified and used for the adjustment of the data so that large components of unwanted heterogeneity can be removed while leaving intact a broad range of biological effects to explore. we do note that performing sva does not necessarily produce overly optimistic results, as the sva algorithm allows for potential correlation between the primary variables and estimated latent variables. regardless, this is a balancing act that necessarily entails iterative data processing and assessment of global and gene-specific impacts of the analysis, and can be guided by perspectives and plots that we illustrate in this report.

while we have primarily explored the sva batch correction algorithm, we note comparable global and gene-level results using the combat batch-correction algorithm  <cit>  within the stem cell dataset. however, as the combat algorithm requires categorical “batch” variables, we could not optimally implement it in the brain dataset - several of the top principal components associated with the quantitative rna integrity numbers , suggesting that tissue quality likely induces “batch”-like effects in the data. similarly, while we view the remove unwanted variation  algorithm  <cit>  a natural extension of the sva algorithm, we found that many housekeeping genes  <cit> , typically used as “negative control genes” in the algorithm, were differentially expressed by differentiation in the stem cell dataset  and development/birth in the brain dataset, highlighting the difficulty in selecting an a priori set of negative controls required by the algorithm. the selection of “negative control genes” that associate with the outcome of interest has a similar effect as sva model misspecification displayed in fig.  <dig>  without studies dedicated to the identification of expressed yet outcome-independent genes within the system under study, the selection of such control genes is quite difficult, although recent work has suggested that the approach may be robust to the specific choice of control genes  <cit> , particularly when technical replicate samples have been generated  <cit> .

the analysis structures described here focus on mean effects across all samples studied. analysis of experiments in dynamic systems including replicates of a wide diversity of individual subjects and well-characterized genomes will be necessary to move beyond the study of average population effects, into functional genomics where we may begin to estimate the impact of individual genomes on precise molecular and cellular phenotypes. in this context, the use of data “cleaning” must be used with extreme caution as it can remove a great deal of information from genomic data as we have demonstrated here.

code
all code for processing, analyzing and visualizing is available at: https://github.com/andrewejaffe/stemcellsva.

additional files
additional file 1: supplementary methods and supplementary figure legends. 

additional file 2: figure s <dig>  transcriptome-wide changes in differential expression from sva.  log fold change for neurectodermal  versus mesendodermal  treatment effects before  and after  sva.  variance in regression model for treatment effect before and after sva.  –log10
p-values from moderated t-statistics calculated using the log fold changes in . dot color in each panel identifies genes depicted in fig.  <dig> – pax <dig> is blue and olfml <dig> is red. 

additional file 3: figure s <dig>  gene ranks before and after sva. ranks of genes  for  mesendodermal and  neuroectoderal differentiation conditions before and after sva. highlighted genes are  mbnl <dig>  zhx <dig>  tom1l <dig>  hgsnat, ssfa <dig>  fkbp <dig>  parva, lrrc8b, npm <dig>  snurf, rtn <dig>  eif5a <dig>  cutc, sall <dig> and  tspan <dig>  bbs <dig>  tarbp <dig> c17orf <dig>  abi <dig>  nrcam, scg <dig>  smad <dig>  coro2a, slc25a <dig> which have been previously implicated in each differentiation condition. 

additional file 4: figure s <dig>  global transcriptional landscape in differentiating pluripotent cells using combat  <cit> . pca of expression data from differentiating pluripotent cells prior to combat colored by differentiation treatment  and microarray scan date . the first pc shows a strong effect of treatment, while the second pc is related to “batch”: boxplots of the second pc indicate strong association with scan date . pca following shrinkage again colored by differentiation treatment  and microarray scan date . both the first and second pc now show systematic association with differentiation, and the second pc no longer shows systematic change with scan date . letters are also used to distinguish individual scan dates in  and . 

additional file 5: figure s <dig>  raw copy number estimates via microarray intensities.  log r ratios and  b-allele frequencies from illumina snp microarrays for the various cell lines in the expression dataset. a log r ratio of  <dig> indicates  <dig> copies of the gene, which also corresponds to b-allele frequencies near  <dig>   <dig> , and/or  <dig>  

additional file 6: figure s <dig>  model comparison density plots.  sva model c versus model a,  sva model c versus model b, and  sva model b versus model a. each panel contains one point per probe, and groups of nearby points are shaded by density. note that each model is relative to a model of no sva, so that that y-axis: log102) – log102) and x-axis: 2) + log102))/ <dig> which roughly translate into the typical “ma” plot in the microarray literature  <cit> . the dashed black line is  <dig> and the solid red line corresponds to the mean difference in model fits. numbers indicate how many points are above and below  <dig>  

additional file 7: figure s <dig>  distribution of differential expression signal at housekeeping genes. housekeeping genes  have very significant t-statistics for differentiation conditions suggesting they would be poor “control” genes for an algorithm like remove unwanted variation   <cit> . 



competing interests

the authors declare they have no competing interests.

authors’ contributions

aej and cc designed the study, performed the analyses and wrote the manuscript. jtl provided guidance at all levels of using sva and edited the manuscript. jc and rdgm provided guidance in the analysis of cellular data and edited the manuscript. jek, th and drw provided guidance in the analysis of postmortem human brain data and edited the manuscript. all authors have read and approved this manuscript.


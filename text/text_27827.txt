BACKGROUND
recent microbiome studies have revealed the complex functional relationships between microorganisms and their environment. most notably, numerous human microbiome studies have aimed to elucidate the biological functional roles that microbial communities play within the niches of the human body, all of which can modulate host metabolism, development and health. two large studies, the human microbiome project  <cit>  and the metahit consortium  <cit> , have catalogued the various microbial communities found in the human body and further facilitated understanding of the relationship between changes in the human microbiome and the state of human health. these studies have utilized microbial taxonomic group classification using 16s rrna sequences and gene content using whole genome shotgun  sequencing in order to identify the functional capabilities of microbial communities. expression, translation and enzymatic functions have also been interrogated using techniques such as metatranscriptomics, metaproteomics and meta-metabolomics in order to understand how genomic composition translates into phenotype.

functional characterization of microbiomes using sequencing by wgs and metatranscriptomics relies on  sensitive and accurate sequence alignment,  a functionally well-characterized sequence database, and  robust downstream statistical analysis for comparative and enrichment analysis. currently, there are a few available software packages for metagenomics/metatranscriptomic functional characterization. mg-rast  <cit>  provides an easy-to-use web-interface for metagenomics analysis, including alignment, but imposes file size limits for users. humann  <cit>  and megan  <cit>  both lack an integrated alignment tool and are notably unable to perform comprehensive downstream processes such as operon-level analysis  <cit> . finally, shotgunfunctionalizer  <cit>  is a package for determining statistically significant differentially abundant pathways, requiring pre-processed data in the form of raw cog  counts.

therefore, we developed a tool called functional mapping and analysis pipeline . fmap is a downloadable integrated package that utilizes raw sequencing data and sample information to perform advanced statistical analyses to identify differentially abundant features. fmap can take raw sequence data and generate the following output:  an alignment of reads to a reference database,  the abundances of gene families, and  enriched operons and pathways from the differentially abundant  gene analysis. additionally, fmap provides a customized comprehensive reference for metagenomics analysis and integrates a powerful suite of statistical and annotation modules, which can help the flexibility of functional analysis of metagenomics and metatranscriptomics data.

implementation
fmap performs sequence alignment, gene family abundance calculations, and differential feature statistical analysis . the low-quality sequence reads and human sequences are first removed using bmtagger  <cit> . fmap aligns the remaining reads using usearch  <cit>  or diamond  <cit>  against a kegg filtered uniprot  <cit>  reference cluster , which is filtered for bacteria, fungi and archaea sequences with kegg functional classifications in order to reduce the search library, yet retains functionally informative sequences . best-hit matches are filtered by e-value < 1e- <dig>  percent identity > 80 %. in sequencing data analysis, quantifying gene abundance by rpkm  has become standard practice. however, because genes are comprised of promiscuous protein domains , the calculation of an accurate gene length is not trivial. therefore, fmap calculates the abundance of kegg orthologous groups  by  simply calculating the number of reads mapping to each ko  or  calculating rpkm where we assume that the gene length is the minimum gene length for the best hit . the rpkm value of the gene g, rpkmg, is calculated by employing the equation:fig.  <dig> fmap workflow. a representation of the fmap workflow, where input data is expected to be sequence data and the final output of each step includes alignments to the kfu reference database, quantification of kegg ortholog groups , differentially abundant genes and operon and pathways enriched in the da kos. the green box indicates the input of the workflow and the blue box is the output result


 rpkmg=∑r∈rg1plr⋅3×1t× <dig> 


where rg is the set of all sequencing reads mapped to the gene g, plr is the length of the best hit protein of the read r, and t is the total number of mapped reads.

fmap provides analysis of differentially abundant  genes and enrichment analysis of pathways and operons, offering three built-in statistical testing methods to choose from:  metagenomeseq  <cit> , using the raw count data;  kruskal-wallis rank-sum tests , using rpkm; and  quasi-poisson  <cit> , also using rpkm. since each of these three popular statistical methods has its own distinct advantages , they are all supported by fmap and can complement each other in practical analysis. for example, the default method, the kruskal-wallis test, has robust performance and relatively high statistical power in a wide range of scenarios  <cit> .

in order to assess differential operon abundance, we made the assumption that if genes in the same operon were differentially abundant, then the operon itself would be differentially abundant. in fmap, an operon is a group of closely related orthologous genes , although they do not necessarily come from one genera or species. we modeled the “operon”  as a smaller analysis unit compared to the pathway. once we determined the list of differentially abundant kos, we used the operon database   <cit>  to identify operons in which all of the members were differentially abundant. enrichment analysis was then used  <cit>  to determine da operons and pathways using fisher’s exact test, using the da kos which users can choose to filter on the raw p-value or fdr-adjusted p-value. the package reports the average log <dig>  and enrichment significance.

in addition to the ability of fmap to examine gene content  and expression data , the software provides the output necessary to easily visualize results. from the orthology abundance results, users can generate heatmaps with the abundances of ko in samples. from the pathway enrichment analysis results, users can directly use the “orthology.colors” column as the input to the kegg online pathway map tool: http://www.genome.jp/kegg/tool/map_pathway <dig> html . this allows users to easily visualize pathways.fig.  <dig> integration of fmap with kegg pathway mapping visualization tool. workflow for extracting enriched pathways and visualizing these pathways using the kegg pathway-mapping tool available at http://www.genome.jp/kegg/tool/map_pathway <dig> html. orthology.count: number of ko orthologies in the pathway; orthology.colors: fmap outputs this column to highlight over-abundant  or under-abundant  genes




RESULTS
fmap has been applied to a broad range of datasets, with specific details included in the relevant sections below. but for the purposes of validating the accuracy of the software, we first compared the gene abundance results generated by fmap to those generated by the well-established humann pipeline. we generated  <dig> simulated datasets of metagenomic sequences from  <dig>  whole bacterial genomes. these datasets were generated at 1x coverage to resemble typical read length from the illumina  and  <dig> platforms  generated using art  <cit> . next we aligned the sequences using diamond  against fmap’s kfu database and humann kegg  database. then we generated the ko abundance calculation using  fmap with the kfu best-hit match results and  humann with the kegg best-hit match results. in order to determine the true abundance, we determined the ko abundance of the genes in the  <dig>  bacterial genomes by aligning the genes to the kegg protein database  using diamond. compared to the true abundances and measured by correlation distance, rpkm abundances calculated by fmap were much more similar to the true abundance than the abundances calculated by humann . when we compared the resulting abundances of fmap and humann directly , the ko abundances shared a strong correlation . the result based on the  <dig> platform synthetic reads showed similar results .fig.  <dig> performance of ko abundance calculation of fmap and humann in simulated dataset . a heatmap of correlation distances between the true expected, fmap-predicted and humann-predicted ko abundances in a simulated dataset . b plot of fmap log <dig> ko abundance calculated from fmap compared to log <dig> ko abundance calculated from huumann. r is pearson’s correlation coefficient




to evaluate the performance of fmap on different sequencing platforms and from different physiologic settings for metagenomics and metatranscriptomic data, we ran fmap on a set of  <dig> publicly available samples collected from four microbial datasets generated using  <dig> and illumina sequencing technology:  srp <dig>  a gut metagenomic twin pair study examining biomarkers in crohn’s disease   <cit> ;  srp <dig>  an ocean metagenomic sequencing study examining microbial communities at different sea depths   <cit> ;  srp <dig>  an oral metatranscriptomic study examining biomarkers of biofilms in root caries   <cit> ; and  srp <dig>  a gut metagenomic study examining biomarkers in schizophrenia   <cit> . in evaluating the reference database customized in fmap software, we aligned reads to the kegg filtered uniprot reference cluster  using diamond. for comparison with the other commonly used reference databases, we used diamond to map against three commonly used reference databases:  cog ;  refseq ; and  kegg  used in humann. mapping rates were consistently higher using the kfu databases compared to other functional databases , with the median difference in percentage reads mapped  <dig>  % higher than cog,  <dig>  % higher than refseq and  <dig>  % higher than kegg .fig.  <dig> performance of fmap in real datasets. a boxplots of percent mapping rates of fmap using diamond using four reference libraries, including the following: cog  used by shotgunfunctionalizer, kegg  used by humann, kfu used by fmap, and refseq  used by megan. b boxplots of differences in mapping rates of cog, kegg and refseq compared to the kfu. the values are the percent of reads mapped by kfu that are greater than the comparison database shown in a. the points indicate the values for samples from srp <dig> , srp <dig> , and srp <dig> . boxplots drawn to represent the 25th and 75th percentiles  as a box with a band in the box representing 50th percentile . the upper whisker is located at the ‘smaller’ of the maximum x value and 3rd quartile +  <dig>  inner quantile range , whereas the lower whisker is located at the ‘larger’ of the smallest x value and 1st quartile -  <dig>  iqr. c heatmap of differentially abundant genes of srp <dig>  the samples were clustered by the genes into the two groups, healthy control  and crohn’s disease 




to compare the performance of fmap with comparable tools for pathway analysis, we performed functional analysis using  fmap using the kfu alignment,  humann using the kegg alignments and  shotgunfunctionalizer using raw counts of cogs calculated from the cog alignments. in this comparison, we used the crohn’s twin study that includes  <dig> twin pairs , where  <dig> twin pairs are phenotype discordant. for fmap, the kruskal-wallis rank-sum test was used to detect da genes, which resulted in  <dig> da kos  > ± 1). the resulting da ko profile differentiated the crohn’s disease and healthy control samples, even in discordant twin pairs . pathway analysis revealed  <dig> pathways that were significantly associated with the crohn’s disease phenotype, including the following : flagellar assembly, bacterial chemotaxis , two-component system , glutathione metabolism, glycine, serine and threonine metabolism, pentose and glucuronate interconversions, glyoxylate and dicarboxylate metabolism, porphyrin and chlorophyll metabolism, synthesis and degradation of ketone bodies, and butanoate metabolism. butanoate metabolism, flagellar assembly and synthesis and degradation of ketone bodies are consistent with previously observed decreases in short-chain fatty acid metabolism in crohn’s disease  <cit> . additionally, changes in pathways involved in amino acid and sugar metabolism are consistent with previously observed changes in crohn’s microbiomes compared to healthy controls  <cit> . lefse was used for a comparison analysis from pathway abundances estimated by humann. the analysis of the same dataset using humann and lefse predicted  <dig> differentially abundant pathways,  <dig> of which overlap with the fmap analysis or are consistent with previous findings showing changes in amino acid and sugar metabolism . on the other hand, shotgunfunctionalizer predicted  <dig> da pathways, which overlapped well with both humann and fmap, and also predicted many pathways in other functional categories, including nucleotide metabolism, translation, and transcription . these differences can be accounted for because of the differences in the cog database used by shotgunfunctionalizer versus humann and fmap, which relied on kegg. using fmap’s unique operon analysis, by mapping genes to a database of  <dig>  known operons  <cit> , our results revealed  <dig> da operons involved in flagellar structure and function .table  <dig> fmap performs pathway analysis of a crohn’s disease study

fmap can automatically streamline its built-in pathway analysis. here we show the fmap pathway analysis results of a crohn’s disease study . ko count: number of differentially abundant  genes detected by fmap; pathway coverage: normalized coverage in each pathway; p-value: fisher’s exact test used to assess the over/under representation of da genes



fig.  <dig> fmap of differentially abundant operons. the fmap analysis of a gut metagenomic twin pair study examining biomarkers in crohn’s disease  detected  <dig> differentially-abundant operons involved in the pathways of flagellar assembly, bacterial chemotaxis, abc transporters, and pentose and glucoronate interconversions




finally, the computation time for metagenomic pathway analysis can be quite burdensome. for example, a dataset of srp <dig> can take up to a half hour to process. strikingly, fmap is able to complete a metagenomic pathway analysis five times faster than humann when analyzing the same data set . these advantages also hold when compared with the same analysis in shotgunfunctionalizer. in all, the computation time for this pathway analysis is quite short for fmap compared to humann .fig.  <dig> comparison of computation time in pathway analysis. barplot of computation time in hours of pathway analysis of humann, shotgunfunctionalizer , and fmap. the data of srp <dig> was used to estimate the computation times




CONCLUSIONS
here we introduced fmap, a straightforward and facile tool for metagenomic/metatranscriptomic functional analysis. fmap combines read mapping to a reference database, ortholog  quantification and statistical analysis all in one package. the default reference database for fmap, a functionally annotated filtered uniref <dig>  is optimized for an increased mapping rate and is updated regularly . aside from identification of ortholog and pathway analysis, fmap also has integrated operon analysis. when analyzing identical datasets, fmap produced results consistent with previously published results and the results of similar software programs, albeit ones that lack fmap’s mapping or operon analysis features. fmap results can be used upstream of visualization tools, including the kegg pathway mapping tool. finally, fmap is able to complete these analyses with improved computation time efficiency compared to comparable analysis pipelines. as such, fmap will have broad appeal and utility for biologists and computational biologists.

additional files

additional file 1: figure s <dig>  workflow to create kegg filtered uniprot  reference cluster. first, uniprot id mapping data was downloaded.  <dig>  million protein accessions were in the data. to build connections between the uniprot database and kegg orthology database, we used kegg linkdb api  to select a subset from the uniprot proteins, and to retain only bacteria, archaea or fungi sequences. next, we built connections between uniprot sequences and uniref <dig> sequences via the uniprot id mapping data, and retain only one-one correspondences. finally, we obtained  <dig> , <dig> sequences termed as kfu , and all the sequences had a known relationship between uniref  <dig> and kegg orthology. solid black lines with arrows indicate data processing steps. solid black lines with diamond-shaped heads are direct one-to-one relationships. dashed black lines with diamond-shaped heads are indirect one-to-one relationships. 


additional file 2: figure s <dig>  performance of ko abundance calculation of fmap and humann in simulated dataset .  heatmap of correlation distances between the true expected, fmap-predicted and humann-predicted ko abundances in a simulated dataset .  plot of fmap log <dig> ko abundance calculated from fmap compared to log <dig> ko abundance calculated from huumann. r is pearson’s correlation coefficient. 


additional file 3: table s <dig>  shotgunfunctionalizer predicted  <dig> differentially abundant pathways. shotgunfunctionalier uses quasi-poisson model to assess each pathway provided in the cog database. category size, gene family size and adjusted p-value  are provided according to shotgunfunctionalizer user’s guide  <cit> . 




abbreviations
dadifferentially abundant

fmapfunctional mapping and analysis pipeline

keggkyoto encyclopedia of genes and genomes

kokegg ortholog

odb3operon database v3


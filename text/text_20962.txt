BACKGROUND
horizontal gene transfer  has distributed genes that are required for pathogenicity among many bacterial lineages  <cit> . hgt, also known as lateral gene transfer, occurs when genes move between different genomes. transfers can occur both between closely and distantly related species or strains, and are thought to be frequent events. for example, marine bacteriophages alone have been estimated to cause  <dig> ×  <dig> horizontal transfer events per second  <cit> . most of these horizontally transferred genes are lost from the population through drift or selection. however, under extreme selective pressure, such as exposure to antibiotics, some hgt genes can be stably incorporated into the genome  <cit> . in addition to genes that confer drug resistance, genes that are directly involved in pathogenicity, such as type iii secretion systems  <cit> , have repeatedly undergone hgt  <cit> . thus, detecting hgt has enormous practical significance for identifying new drug targets and for providing a better understanding of many bacterial pathogens.

although hgt is thought to be an important process, the agreement between existing sequence-based hgt detection methods is surprisingly poor  <cit> . estimates of the fraction of genes in modern bacterial genomes that show evidence of horizontal transfer  average 5–10% across species <cit> , but can reach much higher levels. for example, initial estimates based on gc content suggested that as many as 24% of the genes in the thermophile thermotoga maritima had been horizontally transferred  <cit> . however, more recent estimates that use different methods on the same genome place this number at  <dig> % <cit>  and  <dig> % <cit> . the sensitivity of different methods for detecting hgt may correlate with the time since the transfer event  <cit> . these large discrepancies between methods suggest that a combination of approaches may be needed to accurately detect the full range of observable hgt events  <cit> .

the two most popular strategies for detecting hgt from sequence data  are phylogenetic methods and compositional methods. both strategies have been successfully used to detect hgt events that have later been well-supported by many independent lines of evidence  <cit> . however, both strategies also have substantial drawbacks.

phylogenetic methods typically compare the evolutionary history of each gene to the best estimate of the evolutionary history of the genome. for example, genes that cluster specifically with other genes from a more distantly related species, rather than with genes from a closely related species, are often inferred to have been horizontally transferred. this method has been used to identify the transfer of many genes in high-and low-temperature  <cit>  and hospital environments  <cit> . however, many phenomena other than hgt can cause the phylogenetic tree for a gene to differ from that for the species. thus, except in certain well-established cases of transfer of highly conserved genes such as aminoacyl-trna synthetases  <cit> , phylogenetic disagreement by itself is often inconclusive  <cit> . moreover, phylogenetic methods are also subject to false negative results, for example when there are too few closely related sequences from which to build a tree. this is particularly a problem when sequences were transferred from species that were not included in the analysis.

compositional methods test genes for nucleotide, codon, oligonucleotide or amino acid usage that is atypical for the genome in which they are found; less typical genes may have been horizontally transferred. these methods work because genomes vary widely in gc content  <cit> , dinucleotide frequency  <cit> , and frequencies of longer oligonucleotides  <cit> . therefore, genes transferred from one genome to another often differ in these properties. compositional methods have been successful in both gram-negative and gram-positive bacteria. for example, compositional methods were used to identify genomic regions known as the pathogenicity islands spi <dig> and spi <dig> in salmonella enterica  <cit> , and genomic islands in bacillus cereus and b. anthracis  <cit> . that compositional methods work at all is strong evidence that many hgt genes do not have the same composition as their new genomes. however, the main drawback of compositional methods is that they likely detect only recent transfer events from genomes of very different composition. this limitation arises because the composition of transferred genes changes to match the composition of the new genome  <cit> .

the limitations of these methods suggest that sequence-based hgt detection has both high false-positive and false-negative rates: many hgt events likely remain undiscovered, and many vertically inherited genes may have been misidentified as horizontally transferred. here we present a new class of methods that detect hgt by looking for genes that evolve according to a different nucleotide substitution rate matrix than does the genome as a whole. the rate matrix consists of model parameters in the theory of neutral sequence evolution  <cit>   and is explained in more detail below.

our hypothesis is that hgt changes nucleotide substitution dynamics because mutational processes differ between the old and new organisms. thus, methods that detect changes in the rate matrix should be able to detect hgt events. we extend previous methods to detect changes in the micleotide substitution rate matrix  <cit>  by  comparing three genes instead of two genes and  studying multiple statistics derived from a set of nucleotide substitution rate matrices. to test whether this method can detect horizontally transferred genes, we simulated sequence evolution and hgt events under a wide range of conditions. we show that the new techniques we introduce here can significantly decrease the error rate when detecting simulated hgt events: a combination of four of our new statistics decreases the error rate in classifying hgt and non-hgt phylogenies up to 10-fold compared to examining variations in gc content. our results suggest that sequence-based hgt-detection methods can be made significantly more accurate by using our new methods.

theory
using changes in the nucleotide substitution rate matrix to detect hgt
different species have characteristic nucleotide compositions  <cit> , which means that they must have different rate matrices. many mechanisms are known to affect the rate matrix. these mechanisms include loss, gain, or alteration of enzymes that affect dna repair and/or replication, as well as production or deactivation of free radicals or other mutagens  <cit> . for example, mutations of mutt in e. coli, which encodes a dna repair enzyme, were experimentally shown to induce directional mutation from at to cg pairs  <cit> , a signature of change in the rate matrix. change in composition, and hence in the rate matrix, can be rapid on an evolutionary time scale, and large differences in composition can be observed even within a genus. for example, completely sequenced mycoplasma genomes range from 24% gc in m. mycoides to 41% gc in m. pneumonae .

a horizontally transferred gene would typically experience an abrupt change in its rate matrix when it moves from one species to another. in contrast, all genes in a genome that have not undergone hgt should share approximately the same rate matrix. thus, we can identify putative hgt genes as those with rate matrices that differ from the rate matrices of other genes in the same species. different genes within a species can show small deviations in their rate matrices due to differences in transcription and replication  <cit> . for example, deamination proceeds much more rapidly in single-stranded dna, so genes coded on the leading and lagging strands can experience different rate matrices  <cit> . in addition, differences in the rate matrix inferred from sequence data can occur due to sampling errors. however, these deviations are small compared to the differences between species.

the markov model of neutral sequence evolution
the markov model of neutral sequence evolution is a useful approximation that underlies many standard bioinformatics algorithms. these algorithms range from sequence search  <cit>  to alignment  <cit>  to phylogeny  <cit> . the model, when applied to dna, represents the four possible nucleotides at a given position in the dna sequence as four states t, c, a, and g. each nucleotide has a rate of change to each other nucleotide. for example, we denote the rate of change from g to c as rg→c. these rates of change are grouped into rows and columns in the nucleotide substitution rate matrix, conventionally called q . the rows of q must sum to zero because the rate of change away from each state must balance the rate of change towards it. thus, q has negative diagonal elements and non-negative off-diagonal elements. we denote the probability of finding a g as pg . the model assumes pg changes in time according to the following equation  <cit> :

dpgdt
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaadawcaaqaaiabdsgakjabdchawjabdeeahbqaaiabdsgakjabdsha0baaaaa@334f@ = -pg + ra→g pa + rc→g pc + rt→g pt.     

if the probabilities of change from each single nucleotide to each other single nucleotide  are grouped into a row vector u, we can write the model as dudt
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaadawcaaqaaiabdsgakhqabiab=vha1bqaaiabdsgakjabdsha0baaaaa@3248@ = uq. these differential equations allow us to calculate the probability of change between each pair of bases after a specified amount of time t, because they have a formal solution for t ≥ 0:

u = ueqt = up.     

the probability matrices pi generated from a single q form a markov semigroup with generator q  <cit> , which provides a structure that we can use to test whether a set of pi could have come from the same q. given a valid rate matrix q, in which there are no negative off-diagonal elements, p = eqt is guaranteed to be a probability matrix in which each row sums to  <dig>  <cit> . the probability matrix can be estimated from sequences arranged in a phylogenetic tree. thus, qt can be estimated by taking the logarithm of an empirically derived p^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgqbaugaqcaaaa@2de5@. if p^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgqbaugaqcaaaa@2de5@ is a probability matrix, then ln p^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgqbaugaqcaaaa@2de5@ = q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ is guaranteed to be a pseudo-rate matrix with row sums equal to zero and diagonal elements each less than or equal to zero  <cit> . however, q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ may also have negative off-diagonal elements, making it an invalid rate matrix.

any sequence that mutates according to this model under a specified q will eventually reach a steady-state composition, a process called equilibration or amelioration  <cit> . the equilibirum composition is given by the eigenvector of q corresponding to the zero eigenvalue. thus, the model can be used to predict the extent of equilibration of a transferred sequence to its new genome composition after a specified time. because each q has a characteristic steady-state composition, sequences with different compositions must either be under selection or differ in q.

although widely used and generally useful, the markov model requires some assumptions that are not always biologically justified. for example, this model assumes all sites are identical and that sites are uncorrelated with each other. however, sites are often correlated in dna sequences, especially those that encode rna  <cit> . most previous work also assumes that the mutational process is constant in time and time-reversible  <cit> , but these assumptions are frequently violated by biological sequences  <cit> . in particular, methods for phylogenetic inference typically constrain q to reduce the number of free parameters  <cit> . however, these constraints limit our ability to infer the true form of the matrix  <cit> . although some of these problems, such as correlations between sites, affect all methods that use markov models, we were able to decrease the error rate by not assuming a time-reversible markov process. comparisons between pairs of modern sequences force a time-reversible model because the ancestral state is not known. consequently, it is impossible to determine whether the change was from the state in the first sequence to the state in the second sequence, or vice versa. our use of rooted triples  of sequences both allows more accurate inference of q and allows the direction of each change to be inferred, which is useful when q is not time-reversible.

we also limit the influence of selection on our results by using only nucleotides at the third codon position, at which changes are typically not under selection  <cit> .

mathematics of detecting changes in q
we hypothesize that hgt causes abrupt changes in the rate matrix experienced by a gene. we therefore scan the sequences of genes within an individual genome, looking for abrupt changes in q. if changes in q occur during the process of evolution of a set of homologous genes , a model that assumes a single q should fit the data poorly. for example, suppose that we compare each triple of homologous genes in a phylogenetic tree, and use the differences to infer a set of probability matrices p^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgqbaugaqcaaaa@2de5@i for the homologous group. we then infer the rate matrices using q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ti = ln p^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgqbaugaqcaaaa@2de5@i. suppose all the genes in the homologous group evolved under a single q. other than noise, the only differences between the different q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ti will be that they come from probability matrices representing different amounts of time since divergence. in this case, all the inferred q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ti are scalar multiples of one another. therefore a singular-value decomposition  of the set of rate matrices should show that the largest singular value is sufficient to describe the set of rate matrices  <cit> . when many singular values are required to describe the set q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ti the different inferred rate matrices for different groups of genes from the same phylogenetic tree are not scalar multiples of each other and the single-q model fails to explain the data.

we are especially interested in detecting hgt in cases where genes in different parts of a phylogenetic tree have evolved under precisely two different q, because this suggests a single transfer between different species. to detect this situation, we compare the uncentered and centered svd of the set of inferred rate matrices from homologous genes within a single phylogenetic tree. in uncentered svd , we perform the svd on the raw q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ti. this requires that the zero matrix is the origin of the space, and all basis vectors found in the svd must pass through this origin. this coordinate system works well when all the q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ti are related by scalar multiplication, because the zero matrix is then a part of the set. in centered svd , we perform the svd on either the covariance matrix or the correlation matrix of the set of q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ti. this technique is also called principal components analysis . csvd has an effect similar to subtracting the mean of the q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ti from each q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ti, thus centering the coordinate space on the mean of the q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ti. using the correlation matrix instead of the covariance matrix has the additional effect of scaling each axis to the same coordinate system, controlling for different amounts of variation in different variables  <cit> . in csvd, the origin of the coordinate system corresponds to the average q, not the zero matrix. therefore the axes corresponding to large singular values need not correspond to directions in which the original rate matrices are related by scalar multiplication. this coordinate system is particularly suited to detecting changes in q .

for a set of homologous sequences related by a single q, usvd and csvd should both find a good fit, because most of the variance in the rate matrices is due to variation in time, which corresponds to scalar multiplication . both usvd and csvd should also find the same axis, which accounts for most of the variation in the set of rate matrices obtained from different combinations of genes in the tree. for a set of homologous sequences evolved under two different rate matrices, usvd should fit the single-q model poorly, because the variation in the inferred rate matrices, q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ti, is influenced both by variation in t and by variation in q. on the other hand, csvd should find a good fit because it subtracts out the time variation: most of the variance will be explained by a single axis that links the two clusters from the two distinct q .

we propose that comparison of usvd and csvd fits can reveal when a single change in q occurred. we expect that this method will work better for larger differences in q, and where the differences are not solely due to scalar multiplication. below, we address precisely how large a difference this method can detect using simulated sequence evolution.

RESULTS
inferring the rate matrix
we first checked that we can recover the rate matrix accurately enough for inferred differences in q to be valid. this is a critical first step in demonstrating that the method works. the main sources of error are sampling error from the finite amount of sequence data, and numerical error introduced by the matrix logarithm and exponentiation. both numerical error and sampling error can lead to the inference of a pseudo-rate matrix with negative off-diagonal elements when taking the logarithm of p. to estimate the effects of sampling, we compared each p^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgqbaugaqcaaaa@2de5@ determined from the sequence to the expected p using p = eq, and found a sampling error of  <dig>  to  <dig>  . thus our method gives errors comparable to the intrinsic sampling error. we found that the sampling error was relatively small when the sequence length exceeded  <dig> nucleotides , a reasonable estimate for a single gene.
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgqbaugaqcaaaa@2de5@ determined from the data have higher sampling error.

variation in the rate matrix within and between genomes
we used both simulated sequence evolution and representative bacterial genome sequences to  test how many genes are required for accurate inference of the rate matrix and  confirm that the rate matrices estimated from genes in a single species are more similar to each other than to rate matrices estimated from genes in different genomes. we expected that when we increased the number of genes n used to determine the rate matrix, the estimated rate matrices would become more accurate. for large n the estimated rate matrix should converge to the average rate matrix for the genome. for the rate matrix estimates from bacterial sequence data, we chose sets of three genomes  at approximately the same level of divergence as the sequences used in the simulations .

to infer how different the rate matrix is between different genomes, we used the rate matrix estimates based on samples of  <dig> genes . for samples of genes taken from the same genome, the average distance between rate matrices is only  <dig> . when we compare estimated rate matrices of sister genomes, the average distance between rate matrices is  <dig> , while for distantly related genomes the average distance between rate matrices is  <dig> . we note that rate matrices of sister genomes look nearly as different from each other, on average, as do the rate matrices of distantly related species.

the average distances between rate matrices which we estimate from biological sequence data correspond to per-element perturbations of  <dig> – <dig> . this within the range of matrix divergences we used in our simulations. the genomes used for the comparison were all relatively gc-rich. therefore we expect the rate matrices to differ substantially more for genomes with greater compositional differences. these results demonstrate that our conclusions based on simulated sequence data are likely to be relevant to biological sequences.

discriminating among phylogenies generated with one, two, or many rate matrices
we found that we can determine whether a phylogeny was generated by one, two, or many rate matrices with greater accuracy than allowed by previous methods. we used a total of  <dig> different statistics based on properties of the set of qti inferred from homologous sequences within each simulated phylogenetic tree  to test whether we could distinguish among single-q, double-q, and multi-q phylogenies. we found that many of the statistics offered substantial improvement over previously published statistics for detecting changes in the rate matrix.

table of  <dig> statistics derived from collections of rate matrices. columns are: #: number of each method, used in the text for reference. type: type of statistic, either svd, mean distance of each qi from the average of all qi ), variance of the distances of the qi from the average of all qi ), or variance in gc content ). sequences: either  <dig>  for pairwise sequence comparisons that assume a time-reversible substitution model, or  <dig>  for three-way sequence comparisons that do not assume a time-reversible model. normalized: either no, for unnormalized qi, yes, for qi normalized to a trace of  <dig> , or n/a, where normalization was not applicable. centered: yes, for csvd, no, for usvd, or n/a, where svd was not used. sv measure: statistic for characterizing singular values, either a, for ratio of the two largest singular values, or b, for ratio of the largest singular value to the sum of all singular values, or c, for ∑i ln, where the σi are the singular values , or n/a, where not applicable. csvd method: covariance if the covariance matrix was used for csvd, correlation if the correlation matrix was used, n/a if not applicable . rank: rank of the statistic in contributing to overall classification accuracy using random forests  <cit> . %: percentage contribution of the statistic to overall classification accuracy using random forests. the statistic used by devauchelle et al.  <cit>  corresponds to statistic 7; that used by weiss et al.  <cit>  corresponds to statistic  <dig> 

we tested classification of three types of simulated phylogenetic trees, generated by one, two, or many rate matrices , according to the model shown in figure  <dig>  for the data shown in figures 7– <dig>  we simulated balanced trees with  <dig> sequences . in the double-q phylogenies,  <dig> of the sequences evolved according to one random q, and the remaining  <dig> sequences evolved according to another random q. in the multi-q phylogenies, a new, random rate matrix was generated for each branch. results shown are for trees with an average divergence of 10% between the most closely related sequence pairs, but results were similar for divergences ranging from 5% to 50% in steps of 5% . neither of the previously published statistics we tested, statistic  <dig> and statistic  <dig>  <cit> , nor their use in combination, could reliably separate the three types of trees . however, the combination of two of our best-performing statistics, statistic  <dig> and statistic  <dig>  efficiently separated all three classes of phylogenetic trees .
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgqbaugaqcaaaa@2de5@ by counting the directed changes in each of the two sister sequences , and infer q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ by taking the log of p^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgqbaugaqcaaaa@2de5@ . the inferred rate matrix q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ may contain negative off-diagonal elements ; note the error in the corresponding elements of q and q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ . finally, we combine the q from each triple and derive summary statistics.

detecting simulated hgt events
our simulation of hgt events was designed to model orthologous gene displacement. in this type of transfer event, the gene in one species is replaced by or supplemented with an ortholog from another species.  orthologous gene displacement has been documented for several functional categories of genes, including enzymes in the citric acid cycle  <cit> , antibiotic resistance genes such as variant dihydrofolate reductases  <cit> , and even the genes comprising the entire type iii secretion system apparatus  <cit> . however, these orthologous displacements are difficult to detect with existing techniques  <cit> . therefore, we hypothesized a more-powerful hgt-detection method based on changes in q to be especially useful for detecting orthologous gene displacement.

to design simulations of orthologous gene displacement, we assumed that genes diverge from a common ancestor. initially, both daughter species have the same rate matrix. one of the two daughter species then undergoes a mutation that changes its rate matrix, changing the evolutionary pattern of the gene in that lineage. finally, the gene transfers back to the other lineage , and undergoes a period of evolution under that original matrix. this simulated transfer event is a challenge for hgt detection methods, because orthologous gene displacement can be difficult to distinguish from loss of alternate paralogs. furthermore, orthologous gene displacement is a challenge for methods of hgt detection that rely on nucleotide composition because of rapid equilibration to the new genome in the final period of evolution .

to determine which statistics could most accurately identify hgt by orthologous gene replacement, we simulated samples of balanced eight-taxon phylogenetic trees with 10% divergence between sister taxa. these trees either evolved according to a single random q, or contained a horizontal transfer event . in the simulated hgt phylogenies, four of the sequences initially evolve under a different, random q, and then transfer to taxa with the same q as the remaining species. we compared the ability of our new methods, and of the standard compositional method based on variation in gc content , to discriminate between hgt and non-hgt phylogenies.

we focus on gc content rather than other compositional measures for two reasons. first, gc content is much more consistent within bacterial genomes than between genomes  <cit> . this means that variation in gc content is widely used in practice to detect genomic islands . second, almost all of the variation in composition in biological sequences is in gc content rather than along the other two possible axes of composition; this is true both for coding sequences  <cit>  and for non-coding sequences such as rrna  <cit> . the rare exceptions are in genomes that exhibit extreme bias between the leading and lagging strand  <cit> , although these effects are small in most microbial genomes  <cit> . 

we found that our methods could detect hgt much more sensitively and specifically than by using gc content. in our simulations, the variance in gc content was not highly discriminatory . although the difference in variance in gc content between hgt and non-hgt trees was highly significant , the optimal single-variable classifier  <cit>  gave 21% false positives and  <dig> % false negatives. in contrast, the best of our statistics, statistic  <dig>  resulted in only  <dig> % false positives and 5% false negatives, a three-fold improvement in overall error rate despite the increase in false negatives . the difference in this statistic was highly significant . in simulated phylogenies we can detect hgt with much higher precision than existing methods.

limits of accuracy
we expected that our method for hgt detection will work best when the original and new host species have very different rate matrices. to determine what changes in the rate matrix are required for accurate detection, we repeated the hgt-detection analysis with restrictions on the average variation in q. this analysis indicates how recently a transfer must have occurred, and how different q must have been in the organism that the gene came from, to be detectable. we tested the minimum difference in q we could detect by constraining the extent to which the two qs could vary from one another on 8- and 16-taxon double-q phylogenies .

some of our new statistics outperformed gc-content substantially when used as single-variable classifiers. for example, using 16-taxon trees with divergence =  <dig>  and a branch ratio of  <dig> or  <dig>  statistic  <dig> gave a 10-fold decrease in error rate relative to gc content. the improvement was largest when the changes in the rate matrix were unrestricted , and when the branch ratio of internal to external branches was low . this result was expected because long internal branches lead to very different sequence compositions, which are easily identifiable by gc content changes alone. several of our new statistics consistently outperformed gc content when both the overall divergence and the ratio of divergence in the inner and outer branches were relatively low . these conditions model cases under which hgt might be mistaken for differential loss of members of a gene family. our ability to detect hgt more sensitively under these conditions is thus encouraging.

combinations of statistics reduce the error rate by an order of magnitude
to assess the performance of different statistics, both alone and in combination, over the entire data set, we used the random forests algorithm  <cit> . random forests allow us to determine classifiers that combine multiple statistics and to identify the combinations of statistics that gave most weight to the optimal classifiers . we found that no single statistic performed well under all circumstances. the best performer overall, statistic  <dig>  accounted for only  <dig> % of the variable importance across all classifiers, and was closely followed by statistic  <dig>  and statistic  <dig> .

these three statistics with highest variable importance are mathematically different and uncorrelated. although all use three-sequence comparisons rather than pairwise comparisons,  <dig> and  <dig> use svd on the scaled and unsealed q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ti respectively, and  <dig> uses the mean distance of each q^
 mathtype@mtef@5@5@+=feaafiart1ev1aaatcvaufkttlearuwrp9mdh5mbpbiqv92aaexatlxbi9gbaebbnrfifhhdyfgasaach8aky=wiffydh8gipec8eeeu0xxdbba9frfj0=oqffea0dxdd9vqai=hguq8kuc9pgc9s8qqaq=dirpe0xb9q8qilsfr0=vr0=vr0dc8meaabaqaciaacagaaeqabaqabegadaaakeaacuwgrbqugaqcaaaa@2de7@ti from the mean. the three best statistics were all based on usvd, although both usvd and csvd-based statistics contributed to the best ten and together provide highly sensitive discrimination. in general, the best statistics were not highly correlated with one another. pairwise correlation coefficients among the best  <dig> statistics averaged r = - <dig> , ranging from - <dig>  to  <dig> .

of the  <dig> statistics we tested, gc content  placed llth. this relatively poor showing underscores the importance of using the full rate matrix, rather than simply examining the composition. however, gc content does work well when the sequences have diverged markedly in composition, especially when the internal branches are very long .

we also found that using three-sequence estimates of the rate matrix  provided far more power to detect changes in q than did pairwise estimates . of the top  <dig> statistics in the combined classifier, all were based on three-sequence comparisons , whereas  <dig> of the  <dig> worst statistics were based on pairwise comparisons . this difference indicates that three-sequence estimates of q perform significantly better than pairwise estimates. thus, eliminating the assumption of time-reversibility is important for detecting hgt.

we started with the single best statistic and added back each additional statistic  to test how using combinations of statistics improves the accuracy of classification. we found that adding statistics dramatically decreases the error rate for a wide range of parameter settings. this effect is most dramatic when changes in the rate matrix are unrestricted: going from the single best statistic to the combination of the four best statistics reduces the error rate more than 10-fold, from 38% to  <dig> %. the corresponding error rate for gc content alone with the same data was 39% . these figures reflect the performance of a trained classifier on new data, so are unlikely to be vulnerable to overfitting.

discussion and 
CONCLUSIONS
in this paper, we developed new measures which use sequence data to predict whether or not a gene has been horizontally transferred. these measures are based on apparent changes in the micleotide substitution dynamics that occur when a gene is transferred to a new organism; these changes can be described by changes in the micleotide substitution rate matrix q. we used simulated sequence evolution to assess our ability to infer the rate matrix and use changes in the rate matrix to assess horizontal transfer. our results show that we are able to accurately infer the rate matrix from simulated sequence data. using a combination of statistics derived from svd of a set of rate matrices inferred from different pairs or triples of genes within a single phylogenetic tree, simulated hgt events can be detected with an error rate as low as  <dig> %. our new measures of horizontal transfer demonstrate greatly improved accuracy and sensitivity in the detection of simulated horizontal transfer: using a four of our new statistics gives a factor of  <dig> decrease in the error rate of simulated hgt detection, relative to the error rate of hgt detection solely by changes in gc content. thus, we have demonstrated a powerful new class of methods for detecting hgt that combine some of the best features of existing phylogenetic and compositional methods.

our results demonstrate that taking the micleotide substitution rate matrix into account provides substantial advances over simply examining the composition of the sequences. in addition, we show that the combination of different svd-based statistics is an efficient way of making use of these data. as we expected, no single statistic performs well for all simulation conditions. this result, especially the different performance between methods at different levels of sequence divergence , is consistent with previous observations that different composition-based statistics may be most effective for changes that occurred at different times during evolutionary history  <cit> .

many changes in the rate matrix would be expected to leave gc content unchanged. the micleotide substitution rate matrix can thus be thought of as generalizing the concept of gc content to take into account the dynamics of compositional change as well as the composition of modern genes. therefore, as our results show, examination of changes in the rate matrix can be more powerful than examination of composition alone.

we were particularly interested in understanding whether the assumption of a time-reversible markov process affects the ability to detect hgt from sequence data. we found that using methods that do not assume time reversibility is critical to detecting hgt in our simulated phylogenies.

in many ways, our simulations were more restrictive than the conditions that exist in real sequences. for example, our phylogenies simulate temporary changes in q in the past, rather than trees in which q changes and in which the new q persists to the present. the temporary change in the rate matrix leaves a weaker signature in the sequence than does a persistent change. we require that genes share a common ancestor that has evolved for part, but not all, of its history under a different q from the modern species in which it is found. detecting these transient changes in q is more difficult than simply testing whether q has changed anywhere in the phylogenetic tree  <cit> . sequences that currently share a genome experience mutational processes that reflect the same q, blurring distinctions that may have accumulated in the past when the sequences were found in different genomes.

our results on both simulated and real sequences show that our method is likely to identify short blocks of ten or more transferred genes, including difficult-to-detect cases in which genes replace orthologs already present in the genome. large errors in the inference of q from single genes, largely due to sampling error, limit our ability to observe the transfer of short fragments of dna. however, many hgt events involve multiple genes: a recent study of genomic islands showed that a sample of  <dig> transferred blocks reported in the literature contained  <dig> genes on average  <cit> . we thus expect the new methods to be useful for uncovering a wide range of transfer events, especially those mediated by plasmids or phages  <cit> .

the analysis of bacterial sequence data demonstrates that we can detect changes in the rate matrix even between closely related genomes with similar gc content, including different strains of the same species. this further confirms our hypothesis that the use of the full rate matrix can detect differences in sequence divergence with greater power than compositional statistics. we thus expect that this technique will be useful  for detecting recent transfers across large taxonomic groups  when both donor and recipient genomes have similar overall composition, and  for detecting transfers of blocks of genes between closely related genomes. this latter case of orthologous gene displacement is thought to be important in the transfer of antibiotic resistance .

our improved ability to detect ancient changes in q will be especially important for detecting subtle changes in biological sequences that compositional and phylogenetic methods alone cannot resolve. our ability to reliably detect per-element changes in q as small as a factor of two will be especially important for resolving transfers between species with similar q. this may assist in the detection of transfers between closely related lineages, which often have similar q. to our knowledge, this work is the first time that sensitivity of any method, including gc-content, to variations in the rate matrix has been measured. we expect that our new methods will greatly enhance our ability to detect horizontal gene transfer and a wide range of other alternative phylogenetic events throughout the tree of life.


BACKGROUND
conventional analyses of bulk cells, such as bulk transcriptome analyses, are based on the averaged data of an ensemble of cells and cannot reveal the states of individual cells. therefore, such analyses cannot distinguish cell types due to the effect of averaging across all cells in a sample, unless each cell lineage is divided in advance by using prior knowledge, such as marker genes. additionally, bulk transcriptome during differentiation is usually the ensemble of the cells of different degrees of differentiation and information regarding changes in cellular state is smeared. accordingly, the accurate investigation for gene expression dynamics and regulatory relationships among genes during differentiation are difficult.

with the advent of single-cell technologies, such as single-cell rna-seq, quantification of the comprehensive states of individual cells is possible  <cit> . using single-cell technologies, investigations of cellular states and its transition processes, such as the classification and identification of cell types , reconstruction of cell lineages  <cit> , and embryonic development  <cit> , have made remarkable progress. single-cell data is also useful for elucidating cell fate decision mechanisms of multi-lineage differentiation from a single progenitor cell type  <cit> . thus, single-cell technologies have the power to shed light on differentiation in particular  <cit> .

to fully analyze the single-cell expression data during differentiation, novel computational methods are necessary  <cit> . first, ordering of the cells based on expression data so that the order represents the trajectory of differentiation is necessary to investigate gene expression dynamics and regulatory mechanisms. although experimental time can be used for ordering cells, even cells derived from the same time-point can exhibit different degrees of differentiation  <cit> . moreover, computational ordering method is often useful to reconstruct the differentiation process from in vivo snap-shot data, which contains cells at distinct stages of differentiation  <cit> . second, estimating the lineage of the cells is necessary to investigate multi-lineage differentiation. although the expression of marker genes will be useful to classify cell lineages, the prior knowledge of marker genes is limited. therefore, a lineage estimation method without prior knowledge is necessary to fully analyze the mechanisms of cell fate decisions.

wanderlust  <cit>  is a pioneering study for ordering cells based on expression data. it uses n-dimensional space composed by n marker genes and constructs the i-nearest neighbor graph in the space, and then reconstructs the differentiation path based on the graph. the degree of differentiation of a cell  is defined by the position on the path. although wanderlust is a promising method for reconstructing the differentiation path, it will not work when prior knowledge of marker genes is not given. therefore, several methods that do not require the prior knowledge of marker genes have been developed to order cells  <cit> . these methods use dimension reduction techniques, such as principal component analysis , and reconstruct the differentiation path in reduced space using several approaches, such as minimum spanning tree  and principal curves. each cell is projected onto the reconstructed path and pseudo-time is defined by the projected position on the path. to estimate cell lineage from expression data, a few methods, which use the same framework, have been developed. monocle  <cit> , a dimension reduction-based approach, estimates the lineage of each cell by estimating multiple paths in reduced space and assigning each cell to one of the paths. these approaches are powerful tools to reconstruct the differentiation process without prior knowledge, and the development of such computational methods will help reveal the mechanisms of differentiation in conjunction with the advancement of single-cell technologies.

however, pseudo-time estimation and cell lineage estimation based on dimension reduction have several problems. for example, interpreting the biological meaning of the path in reduced space is difficult. additionally, the position in reduced space is affected by noise and gene expression that is irrelevant to differentiation, and the results can therefore change significantly in a subsequent analysis. moreover, deterministic approaches, such as applications of mst in reduced space, cannot quantify the subtle differences among cells and are inadequate to estimate the lineages of cells at an early stage of bifurcation, which are important for analyzing cell fate decisions. hence, we developed another approach based on stochastic processes.

in this research, we developed a novel method scoup . scoup describes the dynamics of gene expression throughout differentiation directly, including pseudo-time and cell fate of individual cells. scoup is based on the ornstein–uhlenbeck  process, which represents a variable moving toward an attractor with brownian motion. in the case of differentiation, an attractor is regarded as a stable expression pattern of a gene after differentiation, and hence, an ou process is appropriate to describe expression dynamics throughout differentiation. because ou processes suppose only a single attractor and cannot represent multi-lineage differentiation, we expand the typical ou process into a mixture ou process by representing the cell fate of each cell and lineage-specific expression patterns with latent values and different attractors, respectively. we compared the accuracy of pseudo-time estimates from scoup with those of previous methods using time-series scqpcr and scrna-seq, and scoup was superior to previous methods in almost all conditions. we also evaluated the cell lineage estimation using scqpcr data in which cells exhibit multi-lineage differentiation. scoup successfully estimated cell lineage more accurately than monocle, especially for cells at an early stage of bifurcation. in addition, scoup represents each gene expression dynamic directly and can be applied to various downstream analyses. as an example, we developed a novel correlation calculation method for elucidating regulatory relationships among genes. we normalized data based on the optimized parameters in our model, which assumes the conditional independency among genes, and calculated correlations within normalized data, and this method detected covariance that cannot be explained by the model alone. we applied this method to scrna-seq data and detected a candidate of key regulator for differentiation and clusters in a correlation network which were not detected with conventional correlation analysis.

we proposed a novel theoretical and computational method scoup to analyze single-cell data. the theoretical basis of scoup will be useful not only for pseudo-time and cell lineage estimation, but also for various biological analyses such as gene regulatory network inference. in particular, scoup can represent continuous-time stochastic dynamics and is suited for analyzing time-series data. as the number of single-cell data with high temporal resolution is increasing, computational methods for analyzing such data are becoming more important. thus, scoup is a promising approach for further single-cell analysis and bioinformatics method development.

methods
ornstein-uhlenbeck process
let xt be an ou process. xt satisfies the following stochastic differentiation equation: 
  <dig> dxt=−αxt−θdt+σdwt, 

where α, θ, σ, and wt denote the strength of relaxation toward the attractor, the value of the attractor, the strength of noise, and “white noise,” respectively. if the initial value is given by x <dig>  the value at time t  satisfies the following normal distribution:

  <dig> pxt|x <dig> α,σ <dig> θ,t=nxt|e−αtx0+1−e−αtθ,σ22α. 

this ou process represents a variable moving toward attractor θ with brownian motion  and has been used to describe adaptive evolution of a quantitative trait along phylogenetic tree  <cit> , for example.
fig.  <dig> the conceptual diagrams of the ou process  and scoup for multi-lineage differentiation . a the ou process represents a variable  moving toward attractor  with brownian motion. the value at time t satisfies the normal distribution . b each lineage has distinct attractor , and the lineage of a cell c is represented with latent value z
c. the expression of gene g in cell c is described with the mixture ou process



in the process of cellular differentiation, a cell changes from one cell type to another, and its expression pattern changes from a specific pattern to a different specific pattern. moreover, each single cell exhibits different degrees of differentiation, and therefore a continuous-time model is necessary to represent single-cell expression dynamics. with the ou process, we can describe such dynamics by considering that x <dig> and θ are the expression patterns of progenitor cells and differentiated cells, respectively. in addition, other parameters α and σ can be regarded as the speed of expression change and level of noise, respectively. thus, the ou process is suitable for modeling gene expression dynamics throughout differentiation. in this research, we extended the ou process for single-cell expression data and developed a parameter optimization method.

ou process for single lineage differentiation
we developed a probabilistic model for single lineage differentiation. hereinafter, we denote the number of cells, the number of genes, the cell index, and the gene index as c, g, c, and g, respectively. we assume that expression in each cell is independent and that the total probability p, where e is the expression data of all cells and genes and Φ is the set of parameters, is the product of cell probabilities. each cell has a degree of differentiation progression parameter  tc. although genes interact with each other and multivariate ou process can be more appropriate to describe all gene expression dynamics, multivariate ou process requires more computational and analytical complexity. therefore, we assume that each gene follows its ou process independently and has parameters αg, σg <dig>  and θg. despite the above assumption, we can infer the regulatory relationship between genes by calculating the covariance that is not explained by gene independent model . thus, a cell probability is the product of gene expression probability p, where ecg is the expression data of gene g in cell c. thus, the probability of single lineage differentiation is given by 
  <dig> p=∏c=1c∏g=1gp=∏c=1c∏g=1g∫dscgpoup, 

where Φg=, Φ={Φg|g= <dig> …,g}, t={tc|c= <dig> …,c}, scg is the expression of gene g in cell c at t= <dig>  and pou is a probability distribution based on an ou process and described by the following normal distribution: 
  <dig> pouecg|scg,Φg,tc=necg|e−αgtcscg+1−e−αgtcθg,σg21−e−2αgtc2αg. 

p is the initial distribution of a gene and is given by a normal distribution as follows: 
  <dig> p=nscg|μ0g,σ0g <dig>  

although optimization of these initial parameters is possible, a fully differentiated state may be regarded as an initial state and pseudo-time may be inferred in the reverse order of differentiation. in this way, deciding the direction of differentiation without the knowledge of initial condition is difficult. moreover, the expression data of progenitor cells are available in many experimental studies. therefore, we assume that μ0g and σ0g <dig> are known in this research.

sufficient statistic for ou processes
like a continuous markov model for nucleotide evolution  <cit> , the continuous ou process can be regarded as the limit of a discrete time ou process. pou can be described as follows: 
  <dig> pouecg|scg,Φg,tc=limn→∞pnxcgn|xcg <dig> Φg,tc 

  <dig> pnxcgn|xcg <dig> Φg,tc=∫dxcg∏s=1npouxcgs|xcgs− <dig> Φg,tc/n 

  <dig> pxcg|Φg,tc=∏s=1npouxcgs|xcgs− <dig> Φg,tc/np, 

where xcg={xcgs|s= <dig> …,n} represents a path such that xcg <dig> and xcgn satifsy scg and ecg, respectively. in other words, xcgs corresponds to the variable at time stc/n. in this model, we assume scg <dig> is fixed and consider xcg as xcg∈{xcgs|s= <dig> …,n} for simplicity . accordingly, we consider the likelihood of xcg as follows: 
  <dig> pxcg|scg,Φg,tc=∏s=1npouxcgs|xcgs− <dig> Φg,tc/n. 

according to the expansion of the above likelihood, the log-likelihood of xcg is described as follows . here, we abbreviate the indexes c and g and represent xcg and xcgs as x and xs for simplicity. 
  <dig> l=∑s=1nlnpouxs|xs− <dig> Φg,t/n=−n2lnαπσ21−e−2αt−n2tσ22∑s=1n−1xs2−∑s=0n−1xsxs+1+x02+xn2+α2σ2x02−xn2−2θx0+2θxn+α2t2nσ2−2∑s=1n−1xs2+∑s=0n−1xsxs+1+2θ∑s=1n−1xs−nθ2+o. 

accordingly, we can calculate the log-likelihood by using the following statistics ∑s=1n−1xs <dig>  ∑s=0n−1xsxs+ <dig>  and ∑s=1n−1xs.

the expected values of the above statistics are sufficient for parameter optimization. the posterior probability p is regarded as the multivariate normal distribution, and the expectation of xs and xs <dig> can be calculated from the mean and variance–covariance matrix of the multivariate normal distribution. however, the expansion of the posterior probability gives only the × precision matrix, and we must therefore calculate the inverse of the matrix to obtain the variance–covariance matrix. although we cannot use numerical methods to solve the inverse of the precision matrix because we consider n as the limit for infinite, we can solve for the inverse matrix analytically by using the tridiagonal property of the precision matrix  <cit> . by hand calculation, we showed that the expected values of these statistics were able to be solved analytically. for example, the expected value of one of the statistics is as follows:

  <dig> ∑s=1n−1<xs>=x0+xn−2θsinhαt∑s=1n−1sinhsαtn+θ+o. 

the detailed calculation is described in the additional file  <dig> 

em algorithm
we employed a parameter optimization using an expectation–maximization  algorithm. when the likelihood function contains unobserved variables, an em algorithm can be used for parameter optimization. the em algorithm runs e step and m step iteratively and finds parameters that satisfy the local maximum of the marginal likelihood function. in the e step, we calculate the expectation of a specific statistic with current parameters. in the m step, we calculate the expected log-likelihood function  and optimize parameters so that they maximize the q function. in our model, the path xcg1…xcgn− <dig> is unobserved, and the q function is as follows: 
  <dig> q,Φold,told=∏c∏g∫dxcg1:n−1pxcg1:n−1|xcgn,xcg <dig> Φgold,tcoldl, 

where xcg1:n−1=.

the q function can be expanded analytically with an expected value of the statistic described in the previous section. thus, we can optimize Φg by solving dq/dθg= <dig> dq/dαg= <dig> dq/dσg2= <dig>  which results in the following equations: 
  <dig> θg∗=θg+1∑tc∑c2xcgn−e−αgtcxcg0−1−e−αgtcθgαg1+e−2αgtc 

  <dig> αg∗=∑c−tcσg2−xcg0−θg2+xcgn−θg2∑czcαg 

  <dig> σg∗2=1c∑c2αg1−e−2αgtcxcgn−e−αgtcxcg0−1−e−αgtcθg <dig>  

where zα is explained in the additional file  <dig>  the pseudo-time variable tc cannot be optimized analytically, and we therefore solve tc to satisfy dq/dtc= <dig> by newton’s method.

in cases, xcg <dig> is also unobserved, so we must calculate the expected value of xcg <dig>  as such, we calculate the expected values, including the expected value of xcg <dig> and xcg <dig>  in the e step and optimize parameters with the above equation in the m step. the detailed optimization process and calculation are described in the additional file  <dig> 

we validated our parameter optimization method with simulation data and confirmed that scoup succeeded to optimize parameters so that the marginal likelihood was maximized .

mixture ou process for multi-lineage differentiation
we also extended the single lineage model to a mixture model in order to consider multi-lineage differentiation, such as bifurcation . we assume that the number of lineages is known and given by k and that each lineage has a different attractor θgk. the fate of a cell c is unknown and is represented with the latent value zc, which is  <dig> of k representations. with this latent value, the mixture ou process is given by 
  <dig> pec,sc=∑k=1kπk∏g=1gpouecg|scgαg,σg,θgk,tcp 

  <dig> pec,sc,zc=∏k=1kπkzck∏g=1gpouecg|αg,σg,θgk,tcpzck, 

where πk is the probability of lineage k. this mixture model describes the multi-lineage case that each lineage diverges from the common initial distribution . this mixture model is a basic model for describing bifurcation and will be a useful method to analyze several bifurcation processes. even in the cases that progenitor cells differentiate into different lineages through multi-step bifurcation, we can use the same model to represent multi-step processes by combining the one-step bifurcation models. however, the ou process with multi-step bifurcation becomes mathematically difficult and we leave it for future work.

here, zc is an unobserved value, and we maximize the marginal likelihood with the em algorithm. as described in the previous section, we must calculate the expectation of the unobserved value to calculate the q function. the posterior probability of zc and the expectation of zc  are described as follows: 
  <dig> p∝∏k=1kπkzck∏g=1gpouzck 

  <dig> γck=e=πk∏g=1gpou∑k′πk′∏g=1gpou. 

by using the above equation and previous description, we can calculate the q function analytically. we optimize 
  <dig> πk=∑cγck∑c∑k′γck" 

by solving dq/dπk= <dig>  other parameters are optimized likewise using the single lineage model. accordingly, we calculate the expected values of variables, such as γck and scg <dig>  in the e step and update parameters in the m step.

the lineage of a cell is estimated from the expectation of the latent value of a cell . scoup can quantify the certainty of the estimated lineage of a cell from the the value of γc.

initialization of time parameter
our method might converge to undesirable local optima if t is initialized randomly. for example, estimated pseudo-time might be inferred in the reverse order of differentiation. to avoid undesirable local optima, rough initialization of t is effective. although experimental time will be useful for initialization, such data are not always available. for example, experimental time does not exist for expression data of an in vivo snap-shot sample  <cit> . therefore, an initialization method that does not depend on experimental time is necessary. here, we explain our initialization method based on a dimension reduction approach.

we developed dimension reduction approach for pseudo-time initialization, called sp . firstly, we added the mean of the initial distribution  to expression data and regarded it as an initial point for the pseudo-time calculation. next, we performed pca, constructed msts in the reduced space, searched for the shortest path from an initial point using prim’s algorithm, and regarded the weight of the shortest path as the pseudo-time. in this paper, we set the dimensionality of the pca to two and used this pseudo-time for the initialization of our method.

dimension reduction approach
in this section, we explain the previous pseudo-time estimation methods based on a dimension reduction approach.

monocle  <cit>  constructs a mst in reduced space, searches for the longest path in the mst, and estimates pseudo-time along the longest path. we added the mean of the initial distribution data and regarded it as an initial point for the pseudo-time calculation. we used all genes in a dataset as marker genes and the other parameters of monocle were set to default values, unless otherwise specified.

tscan  <cit>  performs model-based clustering in reduced space, connects clusters, and estimates pseudo-time by projecting cells onto the connected path. although tscan can infer an order of clusters, it cannot regard a point as an initial point. therefore, we compared the accuracy of outputted pseudo-time with reversed pseudo-time and defined the pseudo-time of tscan as the superior one. because tscan failed to output pseudo-time of partial cells when we set a high number of clusters, we set the number of clusters to three in this research.

in this paper, we compared the performance of scoup with those of above dimension reduction-based methods in addition to sp. although wanderlust is also a useful method to estimate pseudo-time and cell lineage, we exclude it from comparison. this is because we consider the condition that the prior knowledge of marker genes is not given and wanderlust is designed not for single-cell qpcr and rna-seq but for mass and flow cytometry data.

correlation between genes
we also proposed a novel correlation function between two genes. although we assume the conditional independence among genes to represent gene dynamics, we can detect the regulatory relationship between genes by calculating the covariance. our correlation function quantifies the covariance between genes that is not explained by our model.

for time-series data, a ordinal correlation coefficient will be high even if two variables only have similar time-trend. for example, any two independent genes that are upregulated in accordance with differentiation exhibit a high correlation. in the case of the detection of interactions between genes, it is most appropriate to remove the influence of time-trend. to remove this trend effect, the expression data at a specific experimental time point is often used to calculate the correlation. however, this approach is insufficient to remove the time effect resulting from the difference between the experiment time and the progression of cells. accordingly, the trend effect is best removed by using cells within a specific pseudo-time span for calculation. although this analysis will remove the trend effect, the number of cells that are used for the calculation decreases owing to the limit of the span of pseudo-time and precise calculation will therefore be difficult.

several methods have been developed to calculate correlation while removing the confounding effects. for example, sclvm  <cit>  revealed hidden subpopulations from single-cell rna-seq data by removing the effects, such as cell cycle. in this research, we developed a novel correlation function based on our probabilistic model to remove the effect of time-trend. as described in the section on “ou process for single lineage differetiatiation” and the additional file  <dig>  the probabilistic distribution of the expression of a gene g at time t  is described as follows:

  <dig> pxtg|Φg,tc=∫dsgpouxtg|sg,Φg,tp=nxtg|μtg,σtg <dig>  

where 
  <dig> μtg=e−αgtμ0g+1−e−αgtθg 

  <dig> σtg2=σg21−e−2αgt2αg+e−2αgtσ0g <dig>  

as such, we can remove the time dependency by standardizing the time-dependent mean and variance as follows: 
  <dig> zcg=ecg−μtcgσtcg <dig>  

we calculated the correlation coefficient for the above standardized values. this correlation function can detect gene pairs that exhibit interactions that are unexplained by the model, which assume the conditional independence among genes.

the above standardization assumes a single normal distribution and is not suitable for multi-lineage model. however, maxkγck of most cells, which we analyzed, were about  <dig> , and hence, most cells would be assigned to one of the lineage. therefore, the standardization will be effective by assigning a cell to a relevant lineage. in addition, correlation of each lineage will be calculated by dividing cells into each lineage in advance.

dataset
single-cell qpcr for single-lineage differentiation
we used the time-series single-cell qpcr dataset produced by kouno’s group  <cit>  from thp- <dig> human myeloid monocytic leukemia cells differentiating into macrophages. they investigated the expression of  <dig> transcription factors by  <dig> single cells at each eight time point  after phorbol myristate acetate stimulation.

to evaluate the estimated pseudo-time in many conditions, we constructed a dataset, ) follows. we added noise to raw expression data as described below to investigate the effect of noise in pseudo-time estimation. we added noise to raw expression data ecg by adding Ēg×ur, where Ēg is the mean expression of a gene and ur is a uniform random number from  <dig> to ε. we produced  <dig> replicates for each ε , and validated the pseudo-time of each method for each noise level.

we also constructed another dataset, ), to validate lineage estimation by adding  <dig> pseudogenes that exhibit various expression patterns among lineages. we initially selected  <dig> cells randomly from  <dig> cells at a given time point. the expression ecg′ of a pseudogene g′ by the selected cells is equal to raw expression . for the remaining cells, we inverted the raw expression in relation to the initial mean . we also added noise as mentioned above in regard to kouno’s data . because monocle cannot accept negative values, we incremented the values by a minimum of  <dig> to make the expression positive.

the initial distribution μ0gandσ0g <dig> was calculated from 0-h cells as follows, 
  <dig> μ0g=∑c∈c0ecg|c0|, 

  <dig> σ0g2=∑c∈c0ecg−μ0g2|c0|, 

where c <dig> is the set of 0-h cells and |c0| is the number of 0-h cells.

single cell qpcr for bifurcation
to validate the lineage estimation in real data, we used a dataset produced by moignard’s group  <cit> . they investigated the single-cell qpcr results for  <dig> transcription factors throughout hematopoietic development from embryonic day   <dig>  to e <dig>  in mouse embryos. these data include a lineage bifurcation between e <dig>  and e <dig> ; at this time, head fold  cells differentiate into putative blood and endothelial populations, which are distinguished as either gfp+ cells  or flk1+gfp− cells . we used the expression profiles of hf, 4sg, and 4sfg− and investigated whether scoup and monocle can classify 4sg and 4sfg− using only their expression profiles. we randomly selected  <dig> cells because monocle did not seem to work correctly for a large number of cells and this procedures left  <dig> hf cells,  <dig> 4sg cells, and  <dig> 4sfg− cells. the initial distribution was calculated from hf cells in the same way as kouno’s data.

single-cell rna-seq for single-lineage differentiation
we also investigated the stimulation time-series single-cell rna-seq dataset  for primary mouse bone-marrow-derived dendritic cells that was produced by shalek’s group  <cit> . this dataset contains data for three different time series corresponding to each of the different stimulation methods: lipopolysaccharide , viral-like double-stranded rna , and synthetic mimic of a bacterial lipopeptides . first, we converted transcripts per million  to log and defined this value as gene expression. next, we removed outlier cells so that each cell in the dataset contained more than  <dig> genes with detectable levels of expression; this left  <dig> lps cells,  <dig> pam cells, and  <dig> pic cells. third, we calculated the absolute difference in mean gene expression between the 1-h cells and 6-h cells for each stimulation. we extracted the top  <dig> genes in descending order of this difference for each stimulation and used these genes for pseudo-time estimation. we also added unstimulated cells  to the lps, pam, and pic data and regarded these cells as 0-h data. the initial distribution was calculated from unstimulated cells in the same way as kouno’s data.

accuracy measure
pseudo-time evaluation
to evaluate the accuracy of pseudo-time estimated from each method, we regarded experimental time as genuine time and calculated the rate of inconsistency between pseudo-time and experimental time. by using the accuracy measure of tscan as a reference, we evaluated the inconsistency by calculating the rate of cell pairs whose pseudo-time ordering was inconsistent with experimental-time ordering, and we defined the pseudo-time inconsistency score  as follows: 
  <dig> pis=∑∈ti<tji∑∈ti<tji+i, 

where tc and tc are respectively the experimental time and pseudo-time of cell c. i is an indicator function that takes the value  <dig> if the conditional expression is true.

lineage evaluation
we evaluated the performance of lineage estimation by scoup and monocle by comparing the cell lineage annotation of each cell. the annotation of a cell from simulation data is obvious and that of moignard’s data is given by 4sg or 4sfg− in accordance with gfp+ or flk1+gfp−. scoup estimates a cell lineage based on the expectation of the posterior probability of cell fate . we classified cells into one of two lineages on the basis of whether γck exceeded a threshold. we calculated the precision and recall for each threshold and calculated the area under the curve  value. monocle also can estimate cell lineage by setting the parameter num_paths to  <dig>  thereby outputting the state of a cell as either state <dig> , state <dig> , or state <dig> . monocle is a deterministic method and cannot distinguish subtle differences. therefore, we regard that state <dig>  state <dig>  and state <dig> belong to one lineage with probabilities  <dig> ,  <dig> , and  <dig> , respectively. we calculated the auc value for monocle in the same way.

RESULTS
validation of parameter optimization
we validated our parameter optimization method with simulation data. we generated simulation data from the normal distribution based on the ou process by varying the parameters. the number of genes and cells are set to  <dig> and  <dig>  respectively.

firstly, we compared the values of estimated parameters with those of true parameters . the values of estimated time and estimated θg are highly correlated with those of true values . the values of estimated mean and variance of the ou process are also highly correlated with those of true mean and variance , and hence, scoup succeeded to reconstruct the original probabilistic distribution with high accuracy .
fig.  <dig> validation of parameter estimation of scoup for simulation data. a and b is the comparison between the estimated values and true values for pseudo-time  and θ
g, respectively. the outlier whose estimated value exceeds the boundary of drawing area is visualized in the border with a red circle for visualization. c is the log-likelihood curve with respect to t
c of a cell. the optimized t
c is indicated with x-max



next, we investigated that the log-likelihood of optimized parameters was higher than those of varied parameters. figure 2c is the example of the log-likelihood curve with respect to time parameter of a cell , and the value of optimized tc is drawn with x-mark. the log-likelihood of the optimized tc was located in the top of the log-likelihood curve. we also verified that the optimized parameters were located in the top of the log-likelihood surface in regards to other parameters . thus, scoup can optimize the parameters correctly.

validation of pseudo-time estimation
in this section, we compared the accuracy of the pseudo-time of each method: scoup, our method; sp, pseudo-time estimation based on shortest path in the mst in reduced space; monocle, dimension reduction-based method that reconstruct differentiation path by the longest path in the mst; tscan, dimension reduction-based method that reconstruct differentiation path by running model-based clustering and connecting clusters. for pseudo-time evaluation, we used kouno’s data  and the shalek’s data.
fig.  <dig> the histograms of pseudo-time estimates produced by each method for kouno’s data  without additional noise. the histograms are drawn for each experimental time point with different colors. the pseudo-time values inferred by scoup over  <dig>  are integrated into  <dig>  for visualization. the pseudo-time values inferred by monocle and tscan are normalized so that maximum =  <dig> 



next, we quantitatively evaluated the accuracy of pseudo-time estimated by each method for kouno’s data  based on the pseudo-time inconsistency score  . the piss of scoup were superior to those of other methods under most conditions. this demonstrates that scoup can estimate pseudo-time well, even from noisy data. under one condition, the pis of monocle was superior to that of scoup, and scoup was the second best. this can be because scoup does not describe the differentiation process completely. for example, scoup cannot represent variable attractors, such as transient patterns, and dimension reduction-based methods might be able to accommodate such expression patterns. in future work, we will extend scoup to represent such dynamics.
fig.  <dig> pis of each method applied to kouno’s data . the x-axis represents the noise level   and the y-axis represents the degree of inconsistency between the pseudo-time and experimental time . each method is distinguished by color: red, scoup; yellow, sp; green, monocle; and blue, tscan. we compared the pis of monocle for different parameters m
a
x_c
o
m
p
o
n
e
n
t
s, which correspond to dimensions. the solid and dotted lines correspond to m
a
x_c
o
m
p
o
n
e
n
t
s= <dig> and  <dig>  respectively



we also investigated the effect of the number of dimensions of reduced space for pseudo-time estimation in monocle. we set the argument of monocle max_components, which corresponds to the number of dimensions, to  <dig> and  <dig> and denote monocle analyses with each configuration as monocle and monocle, respectively. across all conditions, monocle was inferior to monocle. this is because the third dimension of reduced space represents something unrelated to differentiation. without prior knowledge, it is difficult to set a proper number of dimensions, and pseudo-time can be erroneous under an improper number of dimensions. although scoup is based on a dimension reduction approach in the process of pseudo-time initialization, we verified that the pseudo-time estimated from different numbers of dimensions  converged to almost same value in this dataset . even if the estimated pseudo-times of scoup differ, we can infer appropriate pseudo-times by selecting the model with the highest likelihood.

next, we evaluated the pseudo-time of each method as inferred from shalek’s data. the pis of each method is shown in table  <dig>  across all conditions, the piss of scoup were superior to those of other methods. unlike qpcr, rna-seq provides comprehensive gene expression profiles and contains the expression of genes that are largely unrelated to differentiation. scoup can omit the effect of such genes by reducing the weight of their influence automatically in pseudo-time optimization. in contrast, the positions of cells in reduced space will be affected and the pseudo-time will vary with the presence of such genes. moreover, the dispersion of rna-seq is higher than that of qpcr, which influences the analyses.
each row represents the method, and each column represents the kind of stimulation for differentiation. na means that monocle did not work well



the piss of pic and pam were higher than those of lps. this will be because the numbers of pic and pam cells were lower than that of lps. it is difficult to reconstruct differentiation trajectories from a small number of samples. in particular, it is important to obtain cells distributed evenly throughout the differentiation process in order to reconstruct trajectories with high accuracy.

in summary, scoup estimated pseudo-time with high accuracy, especially for rna-seq data. moreover, scoup successfully identified the initial state which was difficult to be detected with dimension reduction-based approaches. in addition, scoup is based on a probabilistic model, and hence can evaluate proper pseudo-time by using likelihood. thus, scoup has advantages over dimension reduction-based methods in pseudo-time estimation.

validation of cell lineage estimate
in this section, we evaluate the accuracy of cell lineage estimation from single-cell expression data containing lineage bifurcation.

first, we validated scoup and monocle with simulation data ). table  <dig> shows the mean auc values of each method for each condition. the auc values for scoup were higher than those for monocle in every condition. figure  <dig> summarizes cells in the space of the first two pcs for expression data with ε= <dig> . the color of each cell represents its genuine cell lineage , lineage estimated with scoup , and lineage estimated with monocle . both methods estimated cell lineage with high accuracy for cells that were sufficiently separated in pca space. this result suggests that estimating the lineage of a cell whose expression pattern has changed sufficiently after bifurcation is not difficult using these methods. however, monocle was not able to estimate cell lineage correctly for cells whose expression pattern did not change sufficiently after bifurcation. in contrast, scoup successfully quantified the certainty of lineage of such cells and estimated their lineages with fairly high accuracy . to understand cell fate decision mechanisms, it is important to analyze cells immediately after bifurcation. therefore, scoup, which can quantify the certainty of estimated cell lineage and accurately estimate the lineage of cells that have just undergone bifurcation, will be useful for investigations of cell fate decision mechanisms.
fig.  <dig> pca of cells of kouno’s data based on gene expression. the cell colors indicate the genuine lineage , lineage estimated with scoup , and lineage estimated with monocle . the color for scoup is defined by γ
c0; black,  <dig> ; red,  <dig> ; and blue,  <dig> . the color for monocle is defined by estimated states: black, state  <dig> ; red, state 2; and blue, state  <dig>  the color of each state is defined to be consistent among each plots



next, we investigated cell lineage estimation using moignard’s data. the moignard’s data includes the lineage bifurcation as follows; head fold  cells differentiate into putative blood and endothelial populations, which are distinguished as either gfp+ cells  or flk1+gfp− cells . scoup was able to distinguish cells of 4sfg− and 4sg almost completely correctly . this result did not change for moignard’s data with all hf, 4sfg− and 4sg cells  . the auc value of monocle was  <dig> . figure  <dig> shows cells in the space of the first two pcs and the colors of cells indicate the genuine cell lineage , the lineage estimated using our method , and the lineage using monocle . the lineage estimation using scoup were highly consistent with cell annotations, while monocle incorrectly regarded a non-negligible number of 4sfg− cells as 4sg cells. this tendency of monocle did not change when we changed the dimension number parameter . in contrast with simulation data, which were produced based on symmetric bifurcation, real data likely show complicated bifurcation patterns, and hence, a deterministic approach, such as mst in reduced space, might be inadequate to capture bifurcation.
fig.  <dig> pca of cells of moignard’s data based on gene expression. the cell colors represent the genuine lineage , lineage estimated with scoup , and lineage estimated with monocle . the color for the genuine lineage is defined by the annotation of the cell; yellow, hf; red, 4sg; and purple, 4sfg−. the color for the scoup analysis is defined by γ
c0; black,  <dig> ; red,  <dig> ; and blue,  <dig> . the color for the monocle analysis is defined by estimated states; black, state  <dig> ; red, state 2; and blue, state  <dig>  we determined the color of each state to be consistent among each plot



the results described above show that scoup is superior to monocle with respect to cell lineage estimation for both simulated and real data. scoup can capture subtle differences in cells immediately after bifurcation and will be a powerful method for investigations of cell fate decision mechanisms.

we also investigated cell lineage estimation with gaussian mixture model  implemented in mclust package  <cit> . the auc values for mclust were inferior to those of scoup, and mclust was not able to estimate cell lineage correctly for cells at an early stage of bifurcation . this is because mclust does not have time parameters in the model and will work well only for cells whose expression pattern has sufficiently changed after bifurcation. moreover, gmm fitted to the position in which large number of cells exist for moignard’s data. therefore, gmm is inadequate to estimate the path of bifurcation in the condition that cells are unevenly distributed. thus, it is important to take time parameters into account to estimate the path of differentiation and cell lineage.

clustering genes
we grouped genes for shalek’s data based on expression patterns along pseudo-time estimated with scoup. hereafter, we used the data for lps stimulation because the number of lps cells is largest in shalek’s data. in this analysis, we investigated the top  <dig> genes by the clustering method implemented in monocle. monocle regards the expression pattern as a function of pseudo-time and calculates a smooth response curve based on generalized additive models. then, monocle defines the distance between two genes as 1−ρxy/ <dig>  where ρ is the pearson correlation coefficient of standardized response curves, and groups genes with k-medoids clustering. in this analysis, we set the number of clusters as  <dig> and the overall trend in expression pattern for each cluster and the number of genes in each cluster are shown in fig.  <dig> and table  <dig> 
fig.  <dig> overall trend in standardized expression patterns along pseudo-time for each group. this plot is drawn with the plot_clusters function in the monocle package



we performed gene ontology  enrichment analyses for genes in each group with david  <cit> , and the top three go terms  for each cluster are shown in table  <dig>  the cells of shalek’s data are differentiated into dendritic cells, and immune response genes were upregulated . genes in groups  <dig> and  <dig> were downregulated and were enriched for the cell cycle go term, consistent with previous research  <cit> . in this previous study, increased energy usage was also detected. in our analysis, genes related to energy usage were enriched in groups  <dig> and  <dig>  which show a transient upregulation. thus, we can classify gene function based on expression patterns along pseudo-time and the landscape of gene regulation can be characterized by investigating differences in these patterns. for example, although both groups  <dig> and  <dig> exhibited an upregulation, its timing was later for group  <dig> than group  <dig>  the go term related to “antigen” was enriched only in group  <dig>  and this might reflect a different regulatory cascade during differentiation. we also calculated kegg pathway enrichment for genes of group  <dig> and group  <dig>  respectively. group  <dig> did not include the term of kegg pathway whose benjamin-adjusted p-value was less than 10− <dig>  wheres the term “toll-like receptor signaling pathway” was the most significantly enriched in group  <dig> and benjamin-adjusted p-value was  <dig> ×10− <dig>  this data is the rna-seq of lps stimulated bone-marrow derived dendritic cells and lps is known to activate “toll-like receptor signaling pathway” at first which cause the up-regulation of “antigen processing and presentation” a little late  <cit> . our result is consistent with such mechanisms. thus, investigations of expression patterns along pseudo-time can elucidate the regulatory machinery involved in differentiation.


correlation analysis
in this research, we propose a novel correlation analysis by using standardization based on scoup to detect covariance that cannot explained by the model that assumes the conditional independence among genes alone, and investigated the regulatory relationships among genes using correlations within raw expression data or standardized expression data. hereafter, we refer to the correlations within raw data and standardized data as craw and cstd, respectively. we first investigated whether the target genes of a transcription factor  can be predicted under the assumption that the expression of a tf and its target genes are highly correlated. the list of tfs and their target genes was downloaded from the integrated transcription factor platform   <cit> , a database containing  <dig> tfs and  <dig> pairs of tfs and target genes in the top  <dig> genes. we calculated the craw and cstd values between  <dig> tfs and the remaining  <dig> genes and extracted from the top  <dig> positively correlated pairs of tfs and genes according to each correlation method. the top  <dig> craw and cstd values contained correlations of  <dig> and  <dig> annotated pairs, respectively , and the probabilities of capturing these annotated pairs by random sampling are p< <dig> ×10− <dig> and p< <dig> ×10− <dig>  respectively. this suggests that target genes of a specific tf can be predicted from a correlation analysis of single-cell expression data.

only three annotated pairs were common between the  <dig> craw correlation values and the  <dig> cstd correlation values, which indicates that different regulatory relationships were detected when analyzing raw and standardized expression data. analysis of standardized expression data revealed correlations that were not explained by the model that assumes the conditional independence among genes, whereas raw expression data analysis revealed correlations produced from similar expression patterns during differentiation. thus, our novel correlation analysis method can deliver new insights that are not detected by conventional correlation methods.

next, we aimed to detect a key regulator of each group by using the two correlation methods. we downloaded the candidates of key regulator tfs and their related genes from the riken transcription factor database   <cit>  and fantom <dig> sstar  <cit>  as well as tf data from itfp. in this analysis,  <dig> genes of the annotated tfs and their related genes were contained in top  <dig> gene and were considered as key regulator candidates. we calculated the craw  values between each candidate and genes in a group, and calculated the average craw  value of the candidate for the group. we denote these values as c¯raw and c¯std, where i is the index of a candidate and j is the index of a group. we assumed the key regulator of the group is highly correlated with genes in the group and investigated to detect the key regulators by extracting the candidates of high c¯raw or c¯std. there were few differences between c¯raw and c¯std for groups  <dig> and  <dig> because our standardization was inadequate to deal with the transient patterns found in these groups. the difference between c¯raw and c¯std was largest among all groups, and therefore we focused on group  <dig> hereafter.
table  <dig> the top three transcription factors and their related genes for group 1

c
raw
c
std
ifit1
sqstm1
ifi205
ifih1
ifi204
ifit1
the left and right tables correspond to c¯raw and c¯std, respectively. the first column of each table contains the rank of the absolute difference of expression between 1-h cells and 6-h cells, and the second column lists the gene names. the third column contains the c¯raw or ) of the candidate genes



next, we investigated the correlation network for all genes in group  <dig> based on both the correlation methods. we omitted the genes with maximum of craw  values lower than  <dig>   to improve visibility. figure  <dig> show the correlation networks based on craw  and cstd . in the craw network, the correlations of most of the gene pairs are positive because of spurious correlations over time, and most of the genes are therefore positively connected with each other. in contrast, the cstd network mainly consists of two clusters, and there are a considerable number of negative correlations between the genes of different clusters. we assumed that each cluster is regulated by distinct regulatory mechanisms and investigated the differences of genes between two clusters. hereafter, we focus on the chemokine genes , which are a family of small cytokines or proteins secreted by cells and are known to be involved in immune response  <cit> . in the cstd network, cxcl <dig>  cxcl <dig>  and cxcl <dig> belong to one cluster, while cxcl <dig> and ccl <dig> belong to another cluster. although cxcl <dig> belongs to the same cxc gene family, as cxcl <dig>  cxcl <dig>  and cxcl <dig>  it has properties that distinguish it from other cxc chemokine genes. for example, cxcl <dig>  cxcl <dig>  and cxcl <dig> are located in the proximal chromosomal region , while cxcl <dig> is located on another chromosome   <cit> . further, although ccl <dig> belongs to a different gene family , ccl <dig> is located proximal to cxcl <dig> . the up-regulation of chemokine genes located in the proximal region has been suggested in breast cancer  <cit> , and our correlation analysis also suggests that chemokine genes in located in the proximal region  are regulated by different mechanisms than are cxcl <dig> and ccl <dig>  thus, each clusters in the cstd network is likely to be regulated by region-dependent mechanisms, and examining correlations among standardized gene expression profiles is a useful approach to elucidate regulatory networks that works by controlling for the effect of trends over time.
fig.  <dig> the correlation network based on c
raw  and c
std  for genes in group  <dig>  there are a total of  <dig> and  <dig> genes in the c
raw and c
std network, respectively. the width of each edge represents the magnitude of an expression correlation between the two genes, and color represents the sign, green for a positive correlation and red for a negative correlation. to improve clarity, correlations with an absolute value lower than  <dig>   are not shown for c
raw  network



CONCLUSIONS
the advancement of single-cell technologies will enable the elucidation of many biological processes, such as differentiation. the development of a novel computational method is necessary to fully analyze single-cell data. we developed a novel method, scoup, to analyze single-cell expression data for differentiation. unlike previous methods, which use dimension reduction approaches and reconstruct differentiation trajectories in reduced space, scoup describes gene expression dynamics during differentiation directly, including pseudo-time and cell fate. we evaluated pseudo-time using scoup and previous methods based on the consistency between pseudo-time and experimental time and showed that the scoup results were superior to those of other methods for almost all conditions. we also compared the accuracy of cell lineage estimation using scoup and monocle, and showed that scoup can estimate cell lineages with high accuracy, even for the cells at an early stage of bifurcation. scoup is based on a probabilistic model and can be extended to many applications. in this research, we developed a novel correlation analysis method based on scoup. it calculates the covariance that cannot be explained by a model, which assumes the conditional independence among genes, alone. we applied this method to scrna-seq, and detected the candidate of key regulator of differentiation and the clusters in the correlation network which were not detected with conventional correlation analysis. in future work, we plan to extend our model to consider transient expression patterns complicated cell lineage pattern. in addition, we will develop a multivariate ou process to estimate gene regulatory networks more directly.

abbreviations
em, expectation-maximization; gmm, gaussian mixture model; go, gene ontology; lps, lipopolysaccharide; mst, minimum spanning tree; ou, ornstein–uhlenbeck; pam, synthetic mimic of a bacterial lipopeptides; pca, principal component analysis; pis, pseudo-time inconsistency score; pic, viral-like double-stranded rna


additional file
additional file  <dig> supplementary text. full explanation and supplementary validation of scoup. 




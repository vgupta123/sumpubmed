BACKGROUND
the assembly and analysis of short-read sequence data presents a number of well known challenges including error correction, correct determination of repetitive regions, and accurate identification of genetic variation such as single nucleotide polymorphisms  and insertions/deletions . the end result of an assembly is a set of consensus sequences that ideally matches genetic sequence found on naturally occurring chromosomes. when input reads are all sourced from highly inbred individuals , this is easy to ensure: any variation should result from sequencing error, and the popular "majority vote" mechanism will create a correct consensus  <cit> .

when reads are sourced from non-inbred individuals, the majority vote mechanism reduces to an uninformed parsimony approach; we assume the existence of a "most frequent" consensus and rely on coverage depth to identify it. unfortunately, this approach disregards the extant sequence diversity, and does not identify possible errors in the consensus assembly caused by it. thus, proper analysis of diverse data should focus on the assembly or reassembly of haplotypes--consensus sequences that match to at least one of the diverse set of chromosomes in the sample.

reconstructing haplotypes from low cost, low fidelity data sources has been an active area of research for over  <dig> years  <cit> , but not always in the context of sequence assembly. for example, genotype  data sourced from many diploid individuals of a population or lineage provides alleles present in each individual, but does not associate co-occurring alleles across loci and requires statistical methods to infer haplotypes  <cit> .

haplotypes can also be reconstructed given an assembly  of the polymorphic reads. because reads may span multiple variant loci, each read may contain a small amount of haplotype information. when the number of haplotypes is known to be two, this is known as the single-individual haplotype assembly problem.

here, we are interested in a recent variant of the problem: assembling haplotypes from read data where the true number of source haplotypes is unknown, which we call the population haplotype assembly problem. for the related problem of viral quasispecies estimation, eriksson et al. and zagondi et al. previously formulated a graph-theoretic solution called shorah  <cit> , which was applied to high diversity, high coverage data . this application benefits from high diversity, because overlapping individual reads are likely to share informative snps, and errors can be more clearly identified because of high coverage.

many recent biological studies, however, have sequenced genetic data from pools of higher-order individuals. for example, population-level de novo transcriptome assemblies provide a low cost alternative to whole genome sequencing for ecologically important non-model species  <cit> . such populations represent less genetic diversity  and are sequenced to shallower depths   <cit> . for haplotyping, these properties result in difficulties that we address here:

• less concrete haplotype information is available.

• sequencing errors are more difficult to identify.

this paper expands on hapler  <cit> , a tool for assembling reliable haplotypes given a preliminary alignment of genetically diverse reads. here, we describe and discuss the methods used by hapler in detail, including a new feature that reconstructs full consensus sequences. this reconstruction identifies and minimizes possible chimeric crossover points  while maximizing the read coverage, effectively recovering the parsimony principle of majority vote. because the length of discernible haplotype regions is usually limited by read length, we focus on gene-sized alignments as would be found in transcriptome studies. the core of the graph theoretic formulation of eriksson et al. relies on a maximum unweighted matching of a bipartite representation of the alignment. our formulation builds on this and incorporates 1) in-situ isolation of reads likely containing errors, via a weighted matching of a related representation, and 2) parameter adjustable "quality" constraints, reducing the probability of reconstructing chimeric haplotypes . this is accomplished by exploiting the mechanism of the hungarian weighted matching method, sampling from the space of possible haplotypings and retaining only commonalities; by default, this parameter is kept high to ensure high-quality output.

we test hapler by simulating sequencing, alignment, haplotype assembly and consensus reconstruction for population-sourced data representing diversities of  <dig> % and  <dig> %. these simulations indicate that the novel methods employed by hapler effectively assemble correct haplotype regions, and that the quality of results produced will scale with the quality of future input data: as datasets grow to contain longer reads and fewer sequencing errors, more correct and complete haplotypes will result.

finally, we find that the consensus sequences produced include less chimerism than related approaches of quasispecies estimation and majority vote.

related work
combinatorial approaches for the single-individual haplotype assembly problem abound . in these approaches, certain columns in the alignment m are identified as snp columns. based on these, a conflict graph gm is created wherein each node represents one read, and nodes in gm are connected if their reads conflict, i.e., overlap at some snp column and disagree in the allele. some snp columns may contain gaps, positions where the allele is unknown. in this paper, we distinguish deletion alleles  that cause conflicts from gap positions , which do not. for example, paired-end reads and newer strobe reads can be viewed as long sequences containing one or more sections of contiguous gaps that do not contain discernible snps.

in the single individual haplotype assembly problem, the conflict graph will necessarily be bipartite in the absence of sequencing errors. in this case, computing the bipartition reconstructs haplotypes. when sequencing errors are present, the graph may not be bipartite. various optimizations exist for inducing bipartiteness such as minimum snp removal  and minimum fragment removal , though these are np-hard unless the reads are all gapless  <cit> . other models are np-hard even in the gapless case  <cit> . because of similar theoretical constraints in hapler, all results presented here assume gapless reads .

recently, the mfr problem has been extended to when the number of known haplotypes is increased from two to a known constant k  <cit> . non-graph theoretic approaches also exist for the single individual haplotype assembly problem . the related problem of determining haplotypes from unphased genotype "snp-chip" data of several diploid individuals has also received extensive attention; see salem et al. for a comprehensive review  <cit> .

in our formulation of the population haplotype assembly problem, the goal is not to bipartition gm, but rather to minimally color it--or, equivalently, minimally clique cover the complement "compatibility" graph gm′--assuming sequencing errors have been addressed . in the context of the quasispecies estimation problem, eriksson et al. observed that with gapless data the set of irredundant reads and their conflict information induce a partial order. thus, dilworth's theorem applies, and it is sufficient to find a chain decomposition of a transitive orientation, g′m ⃗, of the compatibility graph. such a chain decomposition is found via a maximum unweighted matching in a bipartite graph representation of the "reachability" relationships in g′m ⃗. recently, the method of eriksson et al. has been improved upon by astrovskaya et al., who incorporated probabilistic weights  <cit> . both of these methods attempt to reconstruct full end-to-end haplotype consensus sequences by relying on suffcient per-haplotype coverage  <cit> .

reconstructing consensus sequences with a focus on identifying and minimizing chimerism has been minimally studied. for single individual haplotype assembly, the number of possible crossover points is fully determined by the number of connected components with at least two nodes in the bipartite conflict graph  <cit> . the celera assembler incorporated a window-based phasing heuristic, reporting a number of "variant regions" for each consensus  <cit> .

RESULTS
we previously tested hapler's haplotype assembly abilities on a low diversity dataset, including a single outgroup haplotype for higher diversity tests  <cit> . these initial results suggested that hapler can effectively assemble haplotype regions, however the inclusion of only a single outgroup sequence limited the generality of the conclusions. here, we test both hapler's haplotyping and consensus reconstruction abilities on data sourced from a  <dig> bp barcoding region of the coi gene of melitaea cinxia, a well-studied butterfly. of the known haplotypes for this gene, we chose eight from two distinct clades . the first, "clade  <dig> " consists of four haplotypes containing  <dig> snps for a total diversity of  <dig> %, just below that estimated for the transcriptome as a whole . this clade represents our "low diversity" test data. the second clade also consists of four haplotypes, and contains  <dig> snps. when combined, these two clades contain  <dig> snps, for a total diversity of  <dig> %. these combined clades represent our "high diversity" data.

unless otherwise specified, we simulated sequencing and perfect assembly by randomly selecting subsequences of haplotypes of a specific length. for the low diversity dataset, we sequenced each of the four haplotypes to 6x coverage to achieve total coverage similar to recent transcriptome sequencing projects . for the high diversity dataset, each of the eight haplotypes was sequenced to 3x coverage. because we are interested in testing up to sanger size read lengths on full gene transcripts, each coi barcoding variant was quadrupled in length by concatenating the coi variant, the variant with t's and c's switched, the variant with a's and g's switched, and the variant with a's and t's switched. this process retains the same level of diversity and allows for comparisons to other tools that map reads to a reference. this process did not introduce inter-snp distances longer than those present in the original coi barcoding variants.

if a sequencing error e is specified, each base of each read is mutated to one of the remaining three bases  with probability e. unless otherwise specified, default parameters were used for hapler .

read length and diversity
we first tested hapler's ability to assemble correct haplotypes by varying simulated read lengths without sequencing error and assuming perfect snp calling. for each read length, we assembled haplotypes over  <dig> trials of random simulated sequencing. all haplotype regions reported here exclude the "universal" haplotype, which is composed of reads that are common to all complete haplotypes . for all tests, we call a haplotype assembly correct if it is an exact subsequence of some original coi sequence, otherwise it is incorrect.

results for both datasets are largely similar: in both cases, longer sequences result in longer haplotypes, and longer haplotypes tend to have higher coverage. in both cases, we see improvements between  <dig> bp and  <dig> bp reads. this is unsurprising, as all extended coi variants share identical regions with other variants of size ≈  <dig> bp. lack of > <dig> bp reads prevents phasing across these regions, which hapler correctly infers. for the low diversity dataset, all reconstructed haplotypes were correct; for the high diversity dataset, of the  <dig>  assembled sequences only seven were incorrect chimeras, shown offset for readability in figure  <dig> 

error rate
next, we tested hapler's performance with sequencing errors. for these tests, we fixed read lengths to  <dig> bp . in order to show the results for haplotype assembly in the general case, for each sequencing error rate e in figure  <dig>  we show the haplotypes assembled over  <dig> trials.

as the error rate increases, the average length of correct haplotypes decreases, while the number of incorrect haplotypes increases. length of incorrect haplotypes is comparable to correct haplotypes, particularly for high error rates. however, when error rate is high the average coverage of incorrect haplotypes is low, indicating that hapler successfully isolates sequencing errors as anomalous, rare haplotypes with little support.

we evaluated each of these consensus generation techniques by computing the minimum number of crossovers  necessary to reconstruct the consensus amongst 1) original input haplotypes, representing "true" crossovers, and 2) hapler assembled haplotypes, representing "estimated" crossovers; in both cases, sequencing errors included in consensus sequences at snp positions also incur crossovers . for chimerism analyses, each data point is an average of  <dig> sequencings/assemblies/consensus reconstructions.

hapler's estimate of the number of crossover points trends between one and two above the true number for its own and the majority vote consensus. at high error rates, the estimated number of crossovers for the vispa consensus diverges from the true number faster than for the other two. for the high diversity dataset , the true number of crossovers for hapler only increases by approximately one, whereas the number for the majority vote suffers significantly incurring over  <dig> crossovers on average.

random repetitions
because many possible haplotypings may exist, we randomly repeat the colorings that produce haplotype assemblies and only infer information common to all of them . by default, hapler runs a minimum of  <dig> such repetitions, and continues until the number of haplotypes assembled has stabilized for the previous 50% of repetitions. for figure  <dig>  we use artificially low numbers of repetitions on the low diversity dataset; read length was held at  <dig> bp and the error rate was held at  <dig> , and we again show haplotype assemblies produced over  <dig> trials of sequencing.

with only a single minimum coloring most haplotype assemblies, while long, are incorrect chimeras. as the number of repetitions increases, correct haplotype inferences quickly begin to outnumber incorrect ones and the lengths of both correct and incorrect haplotypes drop. we quickly see an asymptotic behavior: correct haplotypes reach a minimum length and incorrect haplotypes reach a small average coverage. results were similar for the high diversity dataset , additional file 1). figure  <dig> shows the chimerism analysis for consensus reconstructions. while we varied the number of repetitions used by hapler from  <dig> to  <dig>  we also varied the n parameter used by vispa from  <dig> to  <dig>  when the number of repetitions is very small, we see hapler for the first time consistently underestimating the number of crossovers. in this case, although the number of true crossovers is steady for hapler's consensus sequences at approximately two, hapler estimates zero crossovers because of its assembly of long  haplotypes. for both the low and high diversity datasets, the estimated chimerism approximates or exceeds the true chimerism after four colorings , supplementary figure  <dig>  additional file 1).

unequal haplotype representation
the situation tested thus far--equal representation of several haplotypes--represents a difficult scenario for the majority vote mechanism, which is expected to perform better when a single haplotype is more prevalent. in this section, we modified the low diversity dataset such that one haplotype is represented three times in the "population" while the other three haplotypes are represented once. we simulated sequencing of these to 4x coverage each  keeping the read length at  <dig> bp and varying error rate. figure  <dig> shows the haplotype region assembly results over  <dig> trials of sequencing; these are similar to those of figure  <dig>  though at high error rates assembled haplotypes are shorter.

runtime
hapler's robustness comes at a computational cost: repeated weighted matching dominates the runtime at o , where r is the number of repetitions and n is the number of irredundant reads in the largest haplotype block . even when the largest haplotype block is small, reconstruction of the minimum chimerism consensus runs in o  time and space, where m is the number of called snps and k is the number of haplotype regions.

runtimes, simulating sequencing of the low diversity dataset with high error rate and "simple" snp caller .

as expected, runtimes grow super-linearly with the number of reads . for comparison to the table  <dig>  we consider an example  <dig> kilobase contig of the population-sourced anopheles gambiae genome assembly  comprised of  <dig> reads containing  <dig> non-redundant reads with the largest of  <dig> haplotype blocks containing  <dig>  for this contig, hapler called  <dig>  snps  and reconstructed a consensus with  <dig> estimated crossovers in  <dig> minutes  <dig> seconds. all individual hapler runs contributing to figures  <dig> through  <dig> ran in under  <dig> seconds.

CONCLUSIONS
until recently, the analysis of genetically diverse short read data has focused on identifying single-locus polymorphisms such as snps . however, haplotypic information is often more useful than locus-specific information  <cit> . here, we described a new software tool called hapler designed to accurately assemble haplotypes from low diversity, low coverage data. assemblies can be improved by minimizing the number of haplotypes supported by the data while maximizing the number with minimal support, and sampling from the many possible consistent haplotypings to infer only robust haplotype regions .

the theoretical foundations of hapler require that sequences be gapless. in support of this requirement, initial experiments that incorporated mate-pair information only produced few incorrect haplotypes, with many internal errors. for this reason hapler currently does not incorporate mate-pair information. hapler's added robustness does come at a computational cost, but experimental runtime analysis indicates that runtime will nevertheless be adequate for single alignments up to  <dig> kilobases in length, though low levels of phasing information are likely to prevent useful results over regions of this size. runtimes also suggest that hapler will be useful in practice for whole-transcriptome assemblies, where contig alignments are on the order of a few kilobases in length.

although low levels of phasing information may prevent assembly of many long haplotype regions in some applications, hapler can use the few long and highly covered regions to produce a full consensus minimizing possible chimerism. in this regard, hapler performs well compared to the majority vote and quasispecies estimation tools . perhaps most telling, of the  <dig> consensus sequences produced by hapler over various error rates for figure  <dig>   <dig> were exact matches to some sequenced haplotype, whereas the other approaches produced no exact matches. results were similar when varying parameters  and in the unequal representation test . we emphasize that quasispecies estimation tools are designed for datasets of much higher coverage and diversity, and thus optimize criteria and utilize parameters specific to those applications.

hapler can estimate the chimerism of any consensus against its own haplotype region assemblies. this estimate will naturally overestimate the true chimerism ; however, in most tests hapler's estimated chimerism for the approaches tested preserved the ranking of true chimerism. the only exception we found was when error rates were high , and hapler estimated vispa as having a higher chimerism than the majority vote, when in fact vispa performed similarly to or slightly better than the majority vote.

finally, hapler not only minimizes chimerism in its consensus reconstructions, it also identifies where possible chimeric points might occur. this is useful information, for example, when designing microarray probes or pcr primers that may fail if they include chimeric sequence.

software availability
hapler is packaged as a single java.jar file, and has been tested with java  <dig> , requiring no other dependencies. it is available at http://www.nd.edu/~biocmp/hapler and is released under an lgpl license. hapler is also easy to use: to reconstruct haplotypes for a list of contig ids in an amos bank, one can simply use the amos tools in conjunction with hapler: bank2contig -e eidlist.txt amosbank | java - jar hapler.jar --input -.


BACKGROUND
discovering differential expression has been the main focus of many biological experiments and many patient cohort studies for several decades. since the invention of microarray chips twenty years ago, a huge amount of data has been generated by profiling thousands of genes in various cell lines, model organisms, and human samples. recently, rna-seq technology became the replacement of array technology because of its ability to not only quantify the transcriptome but also detect gene isoforms, novel transcripts, and gene fusion . similar to microarray studies, sample size calculations and power estimation are still some of the key issues in designing rna-seq experiments, but face some new challenges given the nature of rna-seq data.

rna-seq studies generate count based data. several earlier published papers used poisson distribution to model the count data . due to the restraint of the mean equal to the variance under the poisson distribution, the negative binomial  distribution is a natural choice to provide a better fit for rna-seq data by allowing an over-dispersion parameter to capture extra variability over the mean. thus, several specialized software packages have been developed to model rna-seq data based on the negative binominal distribution. robinson et al.  <cit>  developed the r package edger, which provides an exact test for two group comparisons initially and then was expanded to allow multifactor designs by a generalized linear model. additionally, love et al.  <cit>  developed the r package deseq <dig> for differential expression analysis, which provides shrinkage estimators for both log fold change and dispersion by imposing a hierarchical model on them.

for testing differential expression with rna-seq experiments, several studies have attempted to provide sample size calculation and power estimation at a single gene level in the recent literature. fang and cui  <cit>  introduced a simulation based power estimation approach using wald test and likelihood ratio test . li et al.  <cit>  proposed an exact test method for calculating sample size at a single gene level or the marginal level, which is implemented in a web tool called rnaseqps  <cit>  and an r package called rnaseqsamplesize. other studies have been published for sample size calculation and power estimation at a data set level by evaluating the proportion of true discoveries. shyr and li  <cit>  proposed a sample size calculation method using tcga data. ching et al.  <cit>  simulated data from six public data sets and compared power in the paired and unpaired designs. the proper method by wu et al.  <cit>  is a prospective power assessment approach, which simulated data based on an actual rna-seq data set, assessed several empirical error rates and empirical power levels, and stratified them by mean expression and dispersion. however these methods require simulations of all genes based on pilot data or data with similar biological context, and the specification of effect sizes of all genes simultaneously is a big challenge.

the above-mentioned literature on rna-seq sample size calculation and power estimation employed common analysis approaches, such as edger or deseq <dig>  that assume the negative binomial distribution. however, all these nb-based approaches have resulted in an inflated type i error rate as reported in several papers . accurate sample size calculation and power estimation should rely on an appropritate control of false positive error rate. thus the major contribution of our study is that we addressed this issue by using a simulation based empirical approach. this approach properly controls the false positive error rate at the desired level. the idea of using the simulation based approach was originally proposed for modeling brain lesion counts in a multiple slerosis clinical trial by rettiganti and nagaraja  <cit> . but in their study, a simulation based method, called an exact parametric test, was developed for determining the critical values for testing treatment effect. the authors showed that the chi-square test used for wald, score, and lrt fails to maintain the nominal significance level, especially for small sample size studies. to overcome this deficiency in sample size calculation and power estimation approaches and to accommodate designs with multiple groups or multiple factors, we provide a framework that can be implemented for power estimation. the proposed simulation based procedure at a single gene level or marginal level uses the exact parametric test for power estimation to ensure the false positive error rate is properly controlled at the nominal level. in addition, we extended this procedure to unequal dispersion parameter cases for rna-seq sample size calculation and power estimation, which has not been proposed before. simulations were conducted for the proposed procedure under both scenarios.

methods
negative binomial model
a negative binomial random variable x with mean μ and dispersion ϕ is denoted as n
b. it has variance μ+μ
2
ϕ and probability mass function as follows: 
  <dig> p=ΓΓΓ11+μϕϕ−1μϕ−1+μx, 



x= <dig> , <dig> ⋯ ;μ>0;ϕ> <dig> 

dispersion as a function of mean expression
love et al.  <cit>  assume that the dispersion ϕ follows a log-normal prior distribution with mean as a function of μ. the dispersion’s functional trend is modeled as 
  <dig> ϕtr=a1μ+a <dig>  


to estimate this functional form, gene-wise dispersion estimators were regressed against the means of the normalized counts. this approach provides gene-wise shrinkage estimators of the dispersion parameter by assuming the mean-dispersion dependence for all genes and shows adequate power for detecting differential expression especially in small sample size experiments.

likelihood ratio test
without loss of generality, we use γ to denote the fold ratio of a gene between two biological conditions. we are interested in testing the hypothesis h
0:γ= <dig> vs. hypothesis h
1:γ≠ <dig>  let x <dig> x <dig> ⋯,xn <dig> and y <dig> y <dig> ⋯,yn <dig> represent the gene expression counts from each condition. the lrt statistic is given by 
  <dig> l=−2logsupΘ0lsupΘl. 


according to rettiganti and nagaraja  <cit> , the maximum likelihood estimate  of μ under Θ
 <dig> is 
  <dig> μ~=n1x¯+n2y¯n1+n <dig>  


while under Θ, the mle of μ is x¯ <dig>  and the mle of γ is y¯/x¯. dispersion ϕ is estimated by numerically maximizing the likelihood.

wald test
a wald test for testing log transformed γ with h
0:l
o
g= <dig> vs. h
1:l
o
g≠ <dig> is given by 
  <dig> w)=logσ^γ/γ^ <dig>  


false positive error rate control
with thousands of genes tested in an rna-seq study, multiple comparison adjustment is necessary. while the bonferroni method for controlling the family-wise error rate  is very conservative, a less conservative procedure, named the extended interpretation of the bonferroni method, for controlling the mean number of false positives can be used for multiplicity adjustment  <cit> . in other words, the procedure controls the per family error rate  or per comparison error rate . it can be made as powerful as the benjamimi-hochberg fdr control procedure, and shows greater stability than the fdr. in our simulations, the nominal false positive error rate α will be the pcer for a single gene or at the marginal level.

empirical parametric test
inferences on the wald test and the lrt typically rely on the chi-square distribution by asymptotic theory for large sample sizes. but this may lead to liberal results for small sample sizes since asymptotic theory may not work as expected. to address this issue for small sample sizes, the simulation based test by rettiganti and nagaraja  <cit>  is used to provide a proper false positive error rate control. in summary, the empirical null distribution of the test statistics  is obtained from simulated experimental data under the null hypothesis for a large number of iterations . the 100t
h percentile from the null test statistics will be used as a significance cutoff for testing under the alternative hypothesis by comparing the test statistics with this percentile cutoff value.

power estimation procedure

specify all input parameters: sample size per condition n; mean expression μ; fold ratio between conditions γ, nominal false positive error rate α, number of simulations t.

estimate the mean-dispersion functional form using pilot data set or specify an assumed functional form.

calculate dispersion ϕ using eq.  <dig> with mean expression μ.

simulate count data from n
bt times under both null and alternative hypotheses using the input parameters.

fit nb model and obtain the test statistics  under the null hypothesis.

calculate 100t
h percentile as the significance cutoff.

fit nb model and obtain test statistics  under the alternative hypothesis.

calculate power for the specified input parameters.




RESULTS
simulations
parameter settings
count data were simulated from a negative binomial distribution under two experimental conditions  with equal dispersion parameters or unequal dispersion parameters  between conditions. the parameters needed to calculate power of a single gene or marginal level are sample size per condition n, mean expression μ of control group, treatment-to-control fold ratio γ, and nominal false positive error rate α. simulation settings were n= <dig> , <dig> ,40;μ= <dig> , <dig> ;γ= <dig> , <dig> , <dig> . <dig> ,3;α= <dig> , <dig> , <dig> , <dig> . the dispersion parameter ϕ was calculated for each μ from the mean-dispersion functional form ϕ= <dig> + <dig> /μ estimated from an unpublished canine thyroid rna-seq data set . to explore the effect of the mean-dispersion functional form, a low-dependency  and a high-dependency  were also considered in the simulations as shown in fig.  <dig>  at each setting,  <dig>  simulations were run under the null hypothesis and  <dig>  simulations were run under the alternative hypothesis. the critical value was estimated by the empirical 100t
h percentile from the null wald and lrt statistics.
fig.  <dig> mean-dispersion functional form for simulations. deseq <dig> method was applied on a pilot data of unpublished canine thyroid rna-seq data set for setting up simulation parameters. the plot shows the estimated mean-dispersion function form  relative to the mean of the normalized counts. black dots represent per-gene estimates of the dispersion while blue dots represent moderated estimates calculated by deseq <dig>  the fitted functional form and a lower and higher dependency functional forms were used in the simulation studies




equal dispersion
figures  <dig> and  <dig> show the qq plots for the wald statistics and the lrt statistics under the null hypothesis at sample size n= <dig> , <dig>  with mean expression μ= <dig>  when sample size increases, the distribution of either wald or lrt statistics converges toward the chi-square distribution with  <dig> degree of freedom with a faster convergence for the lrt. the discrepancy is quite large when the sample size is small. figure  <dig> shows the critical values using the empirical parametric test and the chi-square distribution at  <dig> different sample sizes and  <dig> different mean expression levels for both wald test and lrt. the critical values get smaller with larger sample sizes. the empirical parametric approach for both wald test and lrt has much higher critical values than the chi-square distribution at smaller sample sizes, and the differences decrease when the sample size gets larger. the wald test has larger critical values than the lrt in general. at each sample size and each mean expression level, the false positive error rate is controlled at the nominal level by the empirical parametric test. however, the estimated false positive error rate of either wald test or lrt  following the asymptotic chi-square distribution with  <dig> degree of freedom is much larger than the nominal false positive error rate, especially for small sample sizes.
fig.  <dig> qq plot of null wald statistics with equal dispersion parameters. data were simulated  <dig>  times with μ= <dig> under the null hypothesis. sample sizes were set at n= <dig> , <dig> and  <dig>  wald test was used for testing mean difference between two conditions. the discrepancy of the null wald statistics from chi-square distribution with  <dig> degree of freedom gets smaller when sample size increases


fig.  <dig> qq plot of null lrt statistics with equal dispersion parameters. data were simulated  <dig>  times with μ= <dig> under the null hypothesis. sample sizes were set at n= <dig> , <dig> and  <dig>  the lrt was used for testing mean difference between two conditions. the discrepancy of the null lrt statistics from chi-square distribution with  <dig> degree of freedom gets smaller when sample size increases


fig.  <dig> critival values plot for both wald test and lrt with equal dispersion parameters. critical values were calculated at the nominal false positive error rate of  <dig>  from empirical percentile of null statisitics at  <dig> different mean expression levels for both wald test  and lrt , and for the chi-square distribution with  <dig> degree of freedom . both wald test and lrt with the empirical distribution have larger critical values than both wald test and lrt with the chi-square distribution, and the wald test has much larger values than the lrt with the empirical distribution


fig.  <dig> false positive error rate plot for both wald test and lrt with equal dispersion parameters. false positive error rate was calculated for both wald test  and lrt  following a chi-square distribution with  <dig> degree of freedom at  <dig> different mean expression levels. the nominal false positive error rate for both wald and lrt with the empirical distribution is shown in purple line . both tests with the chi-square distribution have the inflated false positive error rates



fig.  <dig> power plot at μ= <dig> for the wald test with equal dispersion parameters. power was calculated at  <dig> different sample sizes and  <dig> different fold changes under the alternative hypothesis with μ= <dig> and α= <dig> . power is higher for larger sample sizes and higher absolute fold changes


fig.  <dig> power plot at γ= <dig> for the wald test with equal dispersion parameters. power was calculated at  <dig> different sample sizes and  <dig> different expression levels with γ= <dig> under the alternative hypothesis and α= <dig> . power is higher for larger sample sizes and higher expression levels




unequal dispersion
the qq plot of the wald test under the unequal dispersion setting  is similar to the qq plot of the equal dispersion setting, but the lrt  has minor differences between qq plots of different sample sizes. figure  <dig> shows the critical values of the empirical parametric distribution and the chi-square distribution at  <dig> different sample sizes and  <dig> different mean expression levels for both wald test and lrt. similar to the equal dispersion setting, the empirical parametric test of the wald test has much higher critical values than the chi-square distribution at small sample sizes, and the differences get smaller when sample size gets larger. however, the lrt has slightly higher critical values than the chi-square distribution. for false positive error rate , the wald test with the chi-square distribution has much higher values than the nominal level, while the lrt with the chi-square distribution has slightly higher values. similar to the equal dispersion setting, the power of the wald test  and the lrt  at α= <dig>  is increased with larger sample sizes, larger mean expression levels, and larger absolute fold changes. -dependency functional form).
fig.  <dig> critival values plot for both wald test and lrt with unequal dispersion parameters. critical values were calculated at the nominal false positive error control level of  <dig>  from empirical percentile of null statisitics at  <dig> different mean expression levels for both wald test  and lrt , and for a chi-square distribution with  <dig> degree of freedom . both wald test and lrt have larger critical values than the chi-square distribution, and the wald test has much larger values than the lrt


fig.  <dig> false positive error rate plot for both wald test and lrt with unequal dispersion parameters. false positive error rate was calculated for both wald test  and lrt  following a chi-square distribution with  <dig> degree of freedom at  <dig> different mean expression levels. the nominal false positive error rate control level for the empirical parametric test is shown in purple line . both tests have inflated false positive error rates


fig.  <dig> power plot at μ= <dig> for the wald test with unequal dispersion parameters. power was calculated at  <dig> different sample sizes and  <dig> different fold changes under the alternative hypothesis with μ= <dig> and α= <dig> . power is higher for larger sample sizes and higher absolute fold changes


fig.  <dig> power plot at γ= <dig> for the wald test with unequal dispersion parameters. power was calculated at  <dig> different sample sizes and  <dig> different expression levels with γ= <dig> under the alternative hypothesis and α= <dig> . power is higher for larger sample sizes and higher expression levels




applications
tcga data set
to study and demonstrate the proposed power estimation procedure in a real data application, we used the tcga breast cancer data set as a pilot data for designing a new study for detecting differential expression. the tcga breast cancer data set, acquired in sep.  <dig> from cbioportal for cancer genomics, contains  <dig> tumor samples with clinical information and  <dig> gene features with non-zero counts. we chose the comparison between two tumor stage categories i-ii  vs. iii-iv  when fitting the deseq <dig> package for estimating the mean-dispersion functional form . the estimated mean expression levels were  <dig>   <dig>   <dig> at the 10t
h, 50t
h, 90t
h percentiles for all gene features, respectively. figure  <dig> shows the power as a function of sample sizes  at these mean expression percentiles for a 2-fold difference between two patient subgroups. wald test for the proposed empirical distribution and for the chi-square distribution were used at α= <dig> . figure  <dig> shows the false positive error rate at α= <dig> . even though the wald test for the chi-square distribution has a little higher power at smaller sample sizes, this is mainly due to the failure to properly control false positive rate. to design a new study with 80% power, we will need n= <dig> samples per group to detect a 2-fold difference for genes at the mean expression level of  <dig>  the computation time for this power estimation is about  <dig> hours on a standard windows laptop with intel core i7-6820hq cpu at  <dig> ghz and 32gb ram.
fig.  <dig> power plot for the wald test with equal dispersion parameters for tcga breast cancer data set. power was calculated for the wald test with the empirical distribution  or with a chi-square distribution with  <dig> degree of freedom  at  <dig> different mean expression levels,  <dig> different sample sizes , and a fold change of  <dig> under the alternative hypothesis with α= <dig> 


fig.  <dig> false positive error rate plot for the wald test with equal dispersion parameters for tcga breast cancer data set. false positive error rate was calculated for the wald test with the empirical distribution  or with a chi-square distribution with  <dig> degree of freedom  at  <dig> different mean expression levels and  <dig> different sample sizes . the nominal false positive error rate for the wald test with the empirical distribution is shown in purple line . wald test with the chi-square distribution has the inflated false positive error rates




discussion
many published methods on identifying differentially expressed genes are based on the negative binomial distribution, and the inference mainly relies on asymptotic theory which is biased for small sample sizes. several studies by leng et al.  <cit> , lund et al.  <cit> , reeb and steibel  <cit> , and rocke et al.  <cit>  have reported the excess false positives by using these methods for differential expression detection with rna-seq data. the main reason is that the use of the significance cutoff from biased asymptotic distribution leads to the inflated false positive error rate especially for small sample sizes. our simulation results confirm the great downward bias in the significance cutoff values when an asymptotic chi-square distribution is applied for both wald test and lrt. using the empirical parametric test for estimating the critical values, we are able to control the false positive error rate at the desired nominal level for both tests .

in all current published methods on differential expression detection and power estimation, the dispersion parameter is assumed equal across conditions. under this assumption, the power will be misestimated if dispersion values are very different across conditions. therefore in the simulations we allowed the dispersion parameter to be equal or unequal across conditions to achieve accurate power. when the dispersion parameter is assumed equal, the exact test method by li et al.  <cit>  can be used for power estimation. however this exact test method only works for two group comparisons and it can not be adapted to allow for unequal dispersion across conditions.

the proposed work not only can be applied to multiple groups and multiple factor designs through generalized linear models, it can also be extended to the data set level. in this case, the null distribution of the test statistics could be simulated for each gene or for a group of genes with similar expression profile for a proper control of the false positive error rate.

CONCLUSIONS
with the emergence of rna-seq technology in recent years, rna-seq experiments have been widely used as an alternative to microarrays in biomedical research. due to different data types, data analysis and power estimation are also different. new methods on sample size calculations and power estimation using the negative binomial distribution have already been proposed for this new technology. to overcome some of the limitations in current methods, we provide a framework for power estimation of rna-seq experiments by proposing a simulation based procedure, which provides a proper false positive control and can be applied in generalized linear model settings.

additional file

additional file  <dig> this file provides all supplementary figures referenced in results section. figure s <dig>  power plot at μ= <dig> for the lrt with equal dispersion parameters. figure s <dig>  power plot at γ= <dig> for the lrt with equal dispersion parameters. figure s <dig>  critival values plot for both wald test and lrt with equal dispersion parameters at α= <dig> . figure s <dig>  false positive error rate plot for both wald test and lrt with equal dispersion parameters at α= <dig> . figure s <dig>  power plot at μ= <dig> for the wald test with equal dispersion parameters at α= <dig> . figure s <dig>  power plot at μ= <dig> for the lrt with equal dispersion parameters at α= <dig> . figure s <dig>  power plot at γ= <dig> for the wald test with equal dispersion parameters at α= <dig> . figure s <dig>  power plot at γ= <dig> for the lrt with equal dispersion parameters at α= <dig> . figure s <dig>  critival values plot for both wald test and lrt with equal dispersion parameters assuming the high dependency functional form. figure s <dig>  false positive error rate plot for both wald test and lrt with equal dispersion parameters assuming the high dependency functional form. figure s <dig>  power plot at μ= <dig> for the wald test with equal dispersion parameters assuming the high dependency functional form. figure s <dig>  power plot at μ= <dig> for the lrt with equal dispersion parameters assuming the high dependency functional form. figure s <dig>  power plot at γ= <dig> for the wald test with equal dispersion parameters assuming the high dependency functional form. figure s <dig>  power plot at γ= <dig> for the lrt with equal dispersion parameters assuming the high dependency functional form. figure s <dig>  critival values plot for both wald test and lrt with equal dispersion parameters assuming the low dependency functional form. figure s <dig>  false positive error rate plot for both wald test and lrt with equal dispersion parameters assuming the low dependency functional form. figure s <dig>  power plot at μ= <dig> for the wald test with equal dispersion parameters assuming the low dependency functional form. figure s <dig>  power plot at μ= <dig> for the lrt with equal dispersion parameters assuming the low dependency functional form. figure s <dig>  power plot at γ= <dig> for the wald test with equal dispersion parameters assuming the low dependency functional form. figure s <dig>  power plot at γ= <dig> for the lrt with equal dispersion parameters assuming the low dependency functional form. figure s <dig>  qq plot of null wald statistics with unequal dispersion parameters. figure s <dig>  qq plot of null lrt statistics with unequal dispersion parameters. figure s <dig>  power plot at μ= <dig> for the lrt with unequal dispersion parameters. figure s <dig>  power plot at γ= <dig> for the lrt with unequal dispersion parameters. figure s <dig>  critival values plot for both wald test and lrt with unequal dispersion parameters at α= <dig> . figure s <dig>  false positive error rate plot for both wald test and lrt with unequal dispersion parameters at α= <dig> . figure s <dig>  power plot at μ= <dig> for the wald test with unequal dispersion parameters at α= <dig> . figure s <dig>  power plot at μ= <dig> for the lrt with unequal dispersion parameters at α= <dig> . figure s <dig>  power plot at γ= <dig> for the wald test with unequal dispersion parameters at α= <dig> . figure s <dig>  power plot at γ= <dig> for the lrt with unequal dispersion parameters at α= <dig> . figure s <dig>  critival values plot for both wald test and lrt with unequal dispersion parameters assuming the high dependency functional form. figure s <dig>  false positive error rate plot for both wald test and lrt with unequal dispersion parameters assuming the high dependency functional form. figure s <dig>  power plot at μ= <dig> for the wald test with unequal dispersion parameters assuming the high dependency functional form. figure s <dig>  power plot at μ= <dig> for the lrt with unequal dispersion parameters assuming the high dependency functional form. figure s <dig>  power plot at γ= <dig> for the wald test with unequal dispersion parameters assuming the high dependency functional form. figure s <dig>  power plot at γ= <dig> for the lrt with unequal dispersion parameters assuming the high dependency functional form. figure s <dig>  critival values plot for both wald test and lrt with unequal dispersion parameters assuming the low dependency functional form. figure s38: false positive error rate plot for both wald test and lrt with unequal dispersion parameters assuming the low dependency functional form. figure s <dig>  power plot at μ= <dig> for the wald test with unequal dispersion parameters assuming the low dependency functional form. figure s <dig>  power plot at μ= <dig> for the lrt with unequal dispersion parameters assuming the low dependency functional form. figure s <dig>  power plot at γ= <dig> for the wald test with unequal dispersion parameters assuming the low dependency functional form. figure s <dig>  power plot at γ= <dig> for the lrt with unequal dispersion parameters assuming the low dependency functional form. figure s <dig>  mean-dispersion functional form of tcga breast cancer data set. figure s <dig>  false positive error rate plot for both wald test and lrt with equal dispersion parameters. figure s <dig>  false positive error rate plot for both wald test and lrt with unequal dispersion parameters. 




abbreviations
lrtlikelihood ratio test

mlemaximum likelihood estimation

nbnegative binomial

pcerper comparison error rate

pferper family error rate

tcgathe cancer genome atlas


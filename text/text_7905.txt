BACKGROUND
many large scale molecular biology experiments now use cdna microarray technology for measuring expression levels of a large number of genes for a small tissue sample or cell. however, there are a number of projects underway to map spatial patterns of gene expression using in situ hybridization   <cit>  for tens of thousands of genes in different organisms. in contrast to microarray based methods, these projects can produce huge archives of high-resolution 2d and 3d images and involve the analysis of complex spatial patterns of expression in the context of anatomical structures, tissues and cells. these types of ish experiments are essentially a type of tissue array.

in recent years, genome-wide ish experiments have started to become publicly available, including: the berkeley ish embryonic fruit fly  experiments  <cit> , the ish mouse embryo experiments at the max-planck institute  <cit> , projects at harvard  <cit>  and baylor  <cit>  and the extremely large scale ish experiments of the allen brain atlas  <cit> , involving over  <dig>   <dig> genes and roughly three hundred  <dig> ×  <dig> pixel images per gene for the adult mouse brain. the processing and analysis of ish experiments, the linking of atlas based experimental archives with relevant scientific literature, and the comparison of results with existing knowledge, together have the potential for tremendous impact on the scientific community. in our experiments here we focus on the processing and analysis of ish experiments of the adult mouse brain using data from the allen brain atlas  <cit>  with properties very similar to the the max-planck data  <cit> . figure  <dig> shows some examples of the imagery from the allen brain atlas.

we concentrate here on extracting expression information from the type of imagery typically found in these resources. to achieve this we have developed algorithms to register each gene expression cross section to a corresponding reference image. we then use these warped images to estimate the expression characteristics of a gene across different anatomical structures and extract biologically meaningful information from this data through a simple enrichment analysis, as well as with a block clustering algorithm.

in both the allen atlas and the max-planck data, images are of very high resolution  while the number of slices through the brain for a given gene expression experiment is moderate for the allen atlas  and small  for the max-planck data. the intensity of each pixel gives an estimate of the expression of that particular gene at that location. basic searching tools have been integrated into the brainatlas that help users search for genes expressed in specific parts of the brain  <cit> .

since our goal is to gather statistics about common expression patterns in anatomical structures across experiments, it is important that we achieve a registration that is as accurate and robust as possible. in most of our experiments, we align each expression image to a hand drawn anatomical reference image. this hand drawn reference was created by an anatomist referring to their allen reference atlas, which consists of nissl stained sections of an unfixed, unfrozen mouse brain  <cit> . the reference image shows major anatomical structures as fixed colored regions. several properties characterize the specific nature of our registration task and influenced our approach to the registration problem:

• our images have very high resolution. because of this, we are frequently able to find a large number of points in the registration for which we have high confidence. in other words, there is a lot of data for establishing correspondences in certain areas. this suggests using a method that uses a combination of local registrations. such an approach may not be possible in registration problems using images of lower resolution, since there may not be enough information in the images to have high confidence for a large number of registration points.

• our images have undergone large non-linear distortions. because of this, and the size of the images, the space of possible transformations is very large relative to some other registration problems, such as intra-patient registrations in medical imaging. searching this transformation space directly, either by trying all possible transformations, or through iterative optimization methods, is not feasible: there are simply too many transformations, and a program designed to do this would take prohibitively long to run. iterative optimization methods like gradient descent, in which a small change is made to the current transformation at each step to improve the results, is likely to get caught in local optima, where all small changes make the result worse, and yet a good transformation has not yet been found. these difficulties further point toward the use of a piecewise, or local, registration process.

• finally, we wish to have a fully automatic registration procedure. while the first two points above suggest landmark based registration methods, we would like these landmarks to be selected automatically, rather than manually as occurs in many methods.

together these considerations led us to the development of a fully automated, piecewise, landmark-based registration method. below we discuss our method in the context of other registration work, and we give details of our approach in the section on methods.

analysis of the resulting data suggests that this approach can yield biologically meaningful information. many genes had high expression values in the organs consistent with their known function. furthermore, our novel, probabilistically principled block clustering algorithm also discovers biologically meaningful clusters. to summarize, the contributions of this paper are:  a novel information theory-based landmark algorithm to register images;  extraction of expression values; and  analysis of these expression values to generate biologically-motivated hypotheses.

previous work
registration and feature extraction
registration of medical and biological images is a heavily studied topic with dozens of distinct approaches and a huge literature. general surveys of registration include those by toga  <cit>  and by maintz and viergever  <cit> .

our registration procedure relies on automatically identified landmarks, and then bases a global registration on a piecewise landmark-based registration. this means that certain landmarks which are deemed to be in correspondence in the two images are "pinned" to each other and the remaining parts of the images are stretched to fit amongst these pinned landmarks. the most closely related method of which we are aware, developed for multi-modal image analysis, is from gopalakrishnan et al.  <cit> , which finds information rich landmarks automatically and uses an approximate local affine , rotations, scaling , and shearing. while it is not technically correct, affine transformations are sometimes referred to as linear transformations. in this work, we consider a subset of affine transformations that include all of the above operations except shearing.) registration using these landmarks. although there are many differences in the details, the methods are similar in spirit. another very similar strategy has been used by pitiot et al.  <cit>  to analyze histological sections.

our criterion for alignment is based upon mutual information, as in the original work by maes et al.  <cit>  and by viola and wells  <cit> . mutual information is a common criterion of alignment, and has been used heavily in registration algorithms. intuitively, mutual information alignment is similar to correlation based methods, in which one image is warped until the brightness values at each location correlate as strongly as possible with the brightness values in the other image. mutual information registration works on a similar principle, but rather than striving to maximize linear dependence among pixel values, as in correlation methods, mutual information methods strive to maximize general statistical dependence, both linear and non-linear. mutual information is, in fact, a numerical measure of this statistical dependendence between the pixel values in two images. we discuss how it is computed for a pair of images in the methods section. the idea, then, behind mutual information registration is that, when images are registered  as well as possible, the pixel values in the images will have the strongest possible statistical dependencies. an extensive survey of mutual information alignment algorithms has been published by pluim et al.  <cit> .

other work related to our goals here has sought to construct 3d models from high resolution optical photography of post-mortem human brain slices  <cit>  or registration of mouse brain histology from a nissl stain to obtain a reference volume  <cit> . in contrast, here we are interested in obtaining registrations between a reference volume and gene expression experiments, potentially a more challenging problem. recently, ng et al.  <cit>  explored a strategy for ish to nissl registration in which a high resolution b-spline grid is used to obtain a deformation field that warps a nissl reference onto a subject image. for their local matching cost for the deformation they used a weighted combination of a mean squared difference of a tissue mask and the mutual information of image intensities. they note that the problem is challenging because the expression data is by nature, regionally variable and of varying intensity. further, they suggest that landmark based approaches show future promise for this setting. these observations further motivate our approach here.

recent attention has also been given to the processing of less complicated, high resolution in situ images of drosophila embryos  <cit> . in such cases, the registration step is fairly straightforward because the embryonic shape is simple and smooth; basic affine transformations appear to lead to registrations of satisfactory accuracy for early stages of development.

spatial expression clusterin
in this work, we frame the analysis of extracted expression levels in terms of a clustering problem in two dimensions: genes and anatomical structures. approaches to such clustering include independently grouping the rows and columns of the data matrix  <cit>   and bi-clustering  <cit> , in which both the rows and columns of the matrix are simultaneously clustered. this setting can lead to a coupling of the two clustering procedures  <cit> . these methods have been widely applied to microarray data  <cit>  as well as other heterogeneous data  <cit> . earlier related work on direct clustering  <cit>  considered finding joint row and column clusters or blocks. more recently,  <cit>  have cast the joint row and column clustering problem as a block mixture model. here we present a novel block mixture model and novel algorithms for optimizing the model. using these methods we perform block cluster analysis of expression levels extracted for anatomical structures.

RESULTS
to test the viability of our system we collected several mid-sagittal section images from the brain atlas for each of  <dig> genes and also collected five reference brain images from the same region. the resolution of each image  is  <dig> ×  <dig> pixels. while the raw imagery in the atlas has a purple color, we work with images in "gray scale", which means each pixel is defined by a single numerical value representing its brightness, and there is no color information. registration between a reference image and an expression image was performed in two stages: coarse registration and fine registration.

registration
the coarse registration step is done to put the ish image in rough alignment with the reference image. figure  <dig> shows the result of the coarse registration step. the main purpose of this step is to ease the computational burden on the fine registration step . in particular, if the images are in rough alignment, the fine registration step can assume that a pair of corresponding points in the reference image and the histological image are at similar locations. to obtain a rough alignment, a global affine transformation  is done between the reference image and the expression image. more details are given on this step in the methods section.

once a coarse registration has been done, a more accurate fine registration is performed. this fine registration consists of five steps.

 <dig>  in the first step, which is only performed once per reference image, points in the reference image that are "distinctive" are selected as a basis for the alignment. the goal is to find a set of points which can be matched with corresponding points in the histological image with high reliability. the measure of distinctiveness is the entropy of the neighborhood of the point. the entropy can be thought of as a measure of the complexity of a point's neighborhood in the reference image. neighborhoods with high entropy  are likely to have more structure to provide a local and repeatable match. neighborhoods with low entropy  do not have enough structure to provide an unambiguous match. the left side of figure  <dig> shows some of the high entropy neighborhoods selected in the reference image as distinctive landmarks for registration.

 <dig>  once a set of distinctive points have been found in the reference image, the next goal is to find the corresponding points in the expression image. this is done by searching a small neighborhood in the expression image for the best match to the reference image. because the two images are roughly aligned from the previous step, the search for the best match can take place over a smaller zone in the expression image. the right side of figure  <dig> shows the matched landmarks in the expression image.

 <dig>  using the landmarks in the reference image , the next step is to define a set of triangular regions in the reference image that will be individually registered to corresponding regions in the expression image. to do this, a "triangulation" of the reference image, using the set of identified landmarks, must be performed. we do this using a standard procedure known as delaunay triangulation, which is described further in the methods section. intuitively, a delaunay triangulation is designed to break the image into triangles such that "sliver-like" triangles are avoided as much as possible. the left side of figure  <dig> shows a delaunay triangulation of the reference image based upon the landmarks which have been defined at each triangle vertex.

 <dig>  once the reference image has been triangulated, the corresponding triangulation of the expression image is formed. it may be necessary to eliminate some reference points in order to keep the new triangulation from containing crossed lines . details on this culling procedure are given in the methods section. the right side of figure  <dig> shows a typical triangulation of an expression image.

 <dig>  at this stage, the algorithm has established correspondences among triangles in the reference image and the expression image. the pixels within each triangle of the expression image are then warped according to a bi-cubic interpolation scheme  to match the pixels in the reference image.

all images for each gene were registered against all five reference images and the best pair was selected according to maximum mutual information. figures  <dig>   <dig> and  <dig> show the resulting images at various steps of registration. analytical results of the registration is presented in figure  <dig>  masks  were created for each anatomical structure that was labeled in the reference image, allowing for the corresponding pixels to be extracted for each feature . further analysis was done on these extracted features to provide biological validation of the methods . detailed results are provided below.

feature extraction: estimation of expression values
individual "anatomical structure masks" were constructed for each of the brain regions annotated in the reference images . figure  <dig> shows some of these masks. each of these masks were applied on the corresponding registered image for each gene to extract pixels for that structure. figure  <dig> shows some of the registered expression images masked for specific structures. while most images are not sufficiently well-registered to do a pixel-level feature extraction, gross features like mean, median and quantile for expression levels across the entire structure can be extracted with a high reliability. in the following analysis we chose to use the  <dig>  quantile value of these pixel intensities as the expression statistic, which we found to be more robust to outlier effects due to registration errors and heterogeneity within the structure.

lein, et al.  <cit>  reported that expression levels were typically consistent within structures in the mouse brain. for example, they note that expression levels are "relatively uniform ... across all cortical areas, consistent with the idea that the basic  microcircuit is conserved across the entire neocortex." it is these sorts of structural effects that we aim to capture in our feature extraction. nevertheless, lein also emphasize that there are notable examples of expression sub-structure, such as varying expression among hippocampal sub-regions. figure  <dig> shows this phenomenon in the hippocampus. automated identification of such sub-regions and the correlation of genes within these sub-regions is an area for future improvement.

in this paper, we limit our concern to the major annotated structures, which allows for a consistent set of biologically meaningful structures across all gene expression experiments. this naturally yields a matrix of anatomy-by-gene expression level. figure  <dig> shows a heat map where columns correspond to the anatomical structures and rows correspond to genes. red indicates high expression and green, low expression.

scaling to high resolution
a key question is whether the registration and feature extraction techniques are scalable to higher resolution images. although not publicly available at the time of these experiments, the allan brain atlas images, for example, have original dimensions of ≈ <dig> ×  <dig> pixels. to begin to address this question, we obtained a small amount of data directly from the allen institute as well as additional high resolution mouse brain imagery from the max-planck institute's genepaint database. in this case, we do not have hand-annotated reference maps of anatomical structures and so instead we treat an arbitrary image as a reference and consider the pairwise registration quality between ish images.

sample results from these experiments are presented in figures  <dig>   <dig> and  <dig>  table  <dig> contains the performance of our algorithm in terms of mutual information. figure  <dig> shows that delicate anatomical structures, such as the hippocampus, can be successfully assigned.

functional analysis and block clustering
there is substantial enrichment of brain-related gene function in specific anatomical structures. for example, in figure  <dig> b, genes associated with learning and memory  were found to be highly expressed in the upper parts of the cortex and the medial habenula, just below the hippocampal formation . in another case, feeding behavior genes  were found to be highly expressed in the lower part of the olfactory bulb . in the same figure, additional examples of spatial enrichment can be seen for brain-related gene functions related to sensory perception and visual learning.

using a novel block clustering technique described in the methods section, below, we permuted the rows  and columns  to group correlated regions and gene sets. we believe that this clustering assists us in identifying biologically meaningful information about genes and anatomical structures. we justify this by noting that many genes within block clusters have high expression values in organs consistent with their known functional annotations. for example, when a coarse scale  <dig> ×  <dig> block clustering is applied to our data, we find a high expression block for the cerebellum and the cortex with gene clusters containing aff <dig>  prkar1b, shc <dig>  tmod <dig>  abi <dig>  all of which are associated with learning and memory . figure  <dig> displays the block clustering results of a  <dig> ×  <dig> class model, which demonstrates that block constant patterns are indeed present within the data. we use a false color image with scaling in a format commonly used in microarray visualization, high expression levels are red and low expression levels are green. missing values arising from different anatomy and slice cross sections are indicated in blue.

both the variational and sequential optimization methods described in the methods section for block clustering with a row-column mixture model produce comparable and improved quality clustering results in comparison to independently applied row and column clustering methods and a variety of other optimization algorithms  <cit> . here we used the sequential method for the results shown in figure  <dig> as our implementation runs faster for matrices of the size considered. we used the best result over  <dig> runs for a  <dig> row and  <dig> column class model. table  <dig> shows the clusters from figure  <dig> that are enriched for genes associated with a particular go category with p-values ≤  <dig> . we contrast this with table  <dig> in which we used the same enrichment analysis for independently applied clustering on rows and columns for a traditional mixture model. from this comparison we see that the joint clustering of the row column mixture has allowed us to obtain more clusters enriched for biologically meaningful go categories.

for practical reasons due to data availability and ease of analysis, we focused on a relatively small set of  <dig> well-annotated genes and limited our consideration of structures to the major anatomical features defined in the reference maps. since additional spatial sub-structure clearly exists, future work requires scaling up the clustering to include hundreds or thousands of sub-structures and incorporating all  gene expression hybridizations. based on previous work  <cit> , we expect that hard assignment, variational methods will have superior running times to sequential methods in these larger matrices. thus, the methods we have developed here should be applicable to other ish image collections and should scale to larger image sets of higher resolution.

room for improvement certainly remains. although we have shown reasonable block constant structure is present in the data matrix, recently developed, related methods allowing overlapping groups such as matrix tile analysis  <cit>  and other bi-clustering methods  <cit>  may yield future insights. a potentially more important extension of this approach is to use more sophisticated feature extraction methods to obtain richer cellular level information. such methods could capture expression properties related to cell type such as neurons, astrocytes, oligodendrocytes and others. for example, our subset of experimental images exhibited striking expression differences in the purkinje cell layer of the cerebellum.

CONCLUSIONS
the high mutual information gain in our image registration scheme  along with manual review suggests that the registration method is largely successful. from figures  <dig> and  <dig> it is evident that anatomical structures can be registered reasonably well even when there is a large variation in shape or there is deletion of parts or presence of debris. figures  <dig> and  <dig> show that assignment of very delicate anatomical structures, such as the hippocampus, are often successful. however the variation in image and sample quality is high, leading to difficult cases that probably cannot be adequately registered under any continuity preserving transformation.

we found functional enrichment among anatomical structures, as expected. but more generally, we demonstrated how our novel block clustering strategy can extract block constant structure and is likely to also scale well to larger problems.


BACKGROUND
fregene  is c++ code for simulating sequence-level genetic data over large genomic regions in large populations. unlike coalescent-based simulators it runs forward-in-time, which allows it to provide a wide range of scenarios for selection, recombination , population size and structure, and migration. the advantages of forward simulators over coalescent simulators are discussed in  <cit> . a recent study  <cit>  has shown that coalescent-based approaches can have serious limitations when there is a large recombination rate over the simulated genomic region. the main limitation of alternative forward-in-time simulators  is the size of genome and population that can be accommodated. a primary objective in the development of fregene has been computational efficiency. we implement a rescaling technique that greatly extends the feasible simulation size at the cost of some approximation. as a result, fregene can simulate a  <dig> mb genome in  <dig> k diploid individuals over  <dig> k generations in a few days on a standard computer without rescaling, and only a few hours with rescaling.

since its first publication  <cit> , fregene has been extended to incorporate several new features. a general migration model has now been included. selection at a locus can be switched off at a random time, and can be geographically restricted. the rescaling technique has also been fully automated. a new program, sample, has been developed that samples individuals from a fregene population, returning genotype and/or haplotype data. sample can also assign binary and/or continuous phenotypes generated under a user-specified model, and can replicate snp and individual ascertainment schemes. thus methods for the analysis of genetic association studies can be tested under realistic scenarios.

in this article we recap the main features of fregene, detail new developments, and illustrate its application by generating and analysing six large datasets. these datasets may serve as useful standards for testing methods to infer population genetic parameters, such as recombination rates and selection coefficients, and together with sample can be used to assess genetic association methods. we model three populations: two with constant population size  and one population that mimics the major features of worldwide human genetic variation  <cit> . the latter incorporates bottlenecks, periods of growth, and subdivision into three major continental groups. for each population there are two simulations, one neutral and the other adopting a complex selection model. analyses of genetic diversity and the role of selection in these datasets are reported below.

fregene has been developed and tested under a linux environment and uses the gnu scientific library . it can also be installed on a mac platform . source code, executables, datasets and r scripts for generating figures such as those shown below are all freely available for download from , together with extensive documentation .

implementation
overview
fregene simulates the evolution of a monoecious, diploid, potentially subdivided, population over non-overlapping generations. the genome consists of a single, linear chromosome, whose sequence is recorded as a list of sites at which the minor allele is present. allele frequencies are checked at regular intervals, and if the minor allele has become the major allele at a site the sequence lists are appropriately updated. these updating operations are recorded such that it can always be determined whether the minor allele is ancestral or derived.

parameters characterising the mutation, recombination, demographic and selection processes, are specified by the user, via either input files or the command line. a starting population is also specified, typically either a 'null' population with no diversity, or a population that is the result of a previous run of fregene. at the start of a fregene run, a c++ recombination object is invoked and uses the recombination parameters specified in the input file to stochastically assign recombination rates over the genome, including the locations and intensities of hotspots. the resulting 'recombination map' remains unchanged throughout the simulation.

subsequently, each new generation is created one individual at a time. a parent is chosen at random, weighted by fitness, and a new sequence is generated by randomly recombining its two sequences. new mutations arise uniformly at random on the new sequence, regardless of current allelic status. thus a mutation can arise on an already polymorphic site, in which case a 'double hit' mutation  or 'back' mutation  can occur, both of which are recorded. a second sequence is generated in the same way from a parent that is either the same as the first with probability equal to the selfing coefficient, or is a different individual chosen at random in the same way as the first parent. the pair of new sequences becomes an individual in the next generation.

recombination
the recombination model is based on a hierarchical approach similar to that of  <cit>  . an example over a  <dig> mb genomic region is shown in figure  <dig>  the model is highly flexible and incorporates uniform rate as a special case, as well as hotspots that can vary between regions in frequency and in intensity.

although recombination rates are computed for each run, the random number seed used by the recombination module is recorded so that the recombination map can be maintained between successive runs.

demography
currently, fregene accommodates constant population size, and growth/decline that is either exponential or instantaneous at the start of the run.

the population may be subdivided, in which case migration between subpopulations can occur according to arbitrary 'backward' migration rates: for an offspring in subpopulation i, its two parents are chosen from subpopulation j with probability mij, which for i ≠ j is specified by the user, and mii =  <dig> - ∑j≠imij.

to allow successive runs of fregene where the output of one run becomes the input for the next, the main output file has the same structure as the input file: it contains the sequences in the final generation, and all the simulation parameters required as input. this facility allows complex demographic scenarios to be constructed from the simple demographic models offered within each fregene run. for example, in successive runs populations can split or subpopulations merge, and bottlenecks can be implemented in some subpopulations or the entire population.

selection
a key feature of fregene is that complex selection scenarios can be implemented: fregene allows for positive, negative and directional selection, as well as dominance and over-dominance at each site. the latter can lead to quasi-stable polymorphisms maintained under balancing selection. crucially, the combined effects of multiple forms of selection at linked sites can be studied.

novel mutant alleles are under selection with a specified probability. if so, two coefficients are assigned at random according to parameters set in an input file: s, which we call the 'selection' coefficient, and h the 'dominance' coefficient. the contribution to an individual's fitness at a site is s for a derived-allele homozygote, sh for a heterozygote, and zero for an ancestral-allele homozygote. thus, for s >  <dig>  a site is recessive if h = 0; co-dominant if  <dig> <h < 1; and over-dominant if h >  <dig>  individual fitness is one plus the sum of these contributions over all selected sites. after a derived allele reaches fixation it makes no contribution to fitness.

to model geographical variation in selection, due to differing environments, fregene allows subpopulation-specific selection. each selected site is under selection either globally, or locally in the subpopulation where it arose, according to a probability specified by the user.

the selection coefficients of a site are constant over time until fixation, except that with a fixed probability at each generation selection is switched off, potentially reflecting a change in environment that eliminates the previous selective effect. the rate at which selection is switched off can be set to control the number of balancing polymorphisms at equilibrium.

details of sites under selection  are recorded.

scaling the population: computation time and memory savings
a scaling technique, described in  <cit> , can lead to dramatic reductions in computing time and memory use at the cost of some approximation. scaling involves increasing all rate parameters  by a common factor λ >  <dig>  while reducing by a factor of λ both the population size and the number of generations. fregene allows the user to specify λ, and it calculates the appropriate scaled parameters from the target values specified by the user. an undesirable feature of scaling is that the output population size is reduced by a factor of λ, but fregene now offers an option either to output this reduced population or to run additional generations during which scaling is relaxed and the population size expands linearly from n/λ to n.

generating genotype, haplotype and phenotype data: sample
the program sample samples individuals or chromosomes from fregene output to give, respectively, genotype or haplotype data. association studies can be simulated by assigning continuous or binary  phenotypes to individuals according to a user-defined model. in the continuous case, the user specifies the phenotypic standard deviation, the number of causal snps  and their heritabilities. in the binary case, the user specifies the prevalence of the trait, the number of cases and controls, the number of causal snps and their risk ratios. in either case the user can also supply a range for the allele frequency for each causal snp. the snp ascertainment scheme can be controlled by the user: the user can set the minimum minor allele frequency, or to simulate any given snp ascertainment bias  <cit> , a list of snps to be output can be specified by location of individual snps or ranges of snp locations.

ascertainment bias in structured populations, where cases and controls are sampled unequally in different subpopulations, is a potential problem in association analyses as it may result in false positives  <cit> . sample can simulate ascertainment bias, from a fregene subpopulation simulation, by allowing the user to specify the numbers of cases and controls from each subpopulation. this facility will be useful for testing methods that aim to correct for the effects of population structure.

RESULTS
'ready to use' simulated data sets
two standard population models, each with  <dig>  k individuals, have been simulated over  <dig> mb genomes, and the final generations are available as test datasets: population a is panmictic, while population b is subdivided into three subpopulations each of  <dig>  k individuals. migration rates in population b are all equal, and the common migration rate is chosen such that fst, measuring the genetic distance between populations  <cit> , is equal to 10%.

a third and more complex simulation , over a  <dig> mb genomic region, uses parameter values found by  <cit>  to provide the neutral model that best fits the major features of current worldwide human genetic variation. this simulation used a per-site and per generation mutation rate of  <dig>  × 10- <dig> and required seven steps :

• founding population in africa: an homogeneous population  evolves for  <dig> k generations.

• expansion in africa: the population expands from  <dig> k to  <dig> k sequences and evolves during  <dig> k further generations.

• out of africa  split and bottleneck: among the  <dig> k sequences,  <dig> %  leave africa. simultaneously, the population in africa encounters a bottleneck of size ratio  <dig> %, leaving  <dig> sequences in that subpopulation.

• african and ooa expansion: african population expands back to n =  <dig> k. similarly the ooa population expands to n =  <dig>  k and evolves for  <dig>  k generations.

• asian and european split: the ooa population encounters a bottleneck of size n =  <dig> , and splits with n =  <dig> moving to europe and n =  <dig>  to asia.

• asian and european expansion: asian and european populations both expand to n =  <dig>  k, and evolve for  <dig> k generations. during this stage, migration occurs symmetrically, first between asia and africa , and between europe and africa .

• independent evolution of the three populations: african, asian and european populations evolve, without migration, during  <dig>   <dig> and  <dig> generations respectively, while each population expands to reach a final population size of n =  <dig> k sequences.

for each of the three populations described above, two simulated datasets are available, one neutral and one with selection. for all three populations, the same selection and recombination parameters were employed , and the realised recombination rates were identical for the simulations of populations a and b . the selection model is intended to be illustrative rather than representing a realistic scenario for selection.

the first section only applies to populations a and b; the corresponding values for population c are detailed in the main the text and some are also illustrated in figure  <dig> 

results available for download include the main fregene output files, from which genotype, haplotype and phenotype data can be generated using sample. it is possible to generate haplotype data for subsequences with length defined by the user up to the full simulation length . in addition, the datasets available also include most of the optional fregene outputs to allow various analyses and plots.

genetic diversity in the worldwide human simulation 
during the first  <dig> k generations , diversity increases to reach an equilibrium value, which for the neutral model is close to the expected value under neutrality , given by eh = 2nμ/, where μ denotes the mutation rate per site and per generation. for the selection model, the diversity approaches an equilibrium value that is lower than eh. during the next  <dig> k generations , diversity under neutrality increases towards the new equilibrium expected value  but does not reach it, whereas under selection diversity is little affected by the population expansion. during steps  <dig> and  <dig>  when a strongly selected site  reaches fixation , a trough in diversity is typically observed, corresponding to the effect of a selective sweep.

after the ooa split , diversity slightly drops in the african population, due to the bottleneck, and then increases almost linearly until the end of the simulation. diversity for the ooa population decreases linearly during step  <dig>  approaching the equilibrium value of  <dig>  × 10- <dig>  the asian and european populations have the same size  during step  <dig>  but diversity in europeans is slightly higher than in asians, due to a fourfold higher migration rate between africa  and europe than between africa and asia. trends highlighted for the neutral model also generally apply to the selection simulation, but with reduced diversity due primarily to the effect of selective sweeps in reducing diversity.

assessing the effect of selection: analysis of populations a and b
mean diversity over the final  <dig> k generations , for populations a and b under the neutral and the selection scenarios.

under selection, there is a greater proportion of polymorphic sites with low aaf: for population a, 49% of polymorphic sites have aaf < 1%, compared with 44% in the neutral model. the impact of selection on the distribution of allele frequencies differs between panmictic  and subdivided  populations: sites with aaf < 5% are slightly less frequent in the subdivided population , while sites with aaf > 50% are slightly over-represented . the number of selected sites that went to fixation is  <dig> in population a, compared with only  <dig> in population b.

the rate of fixation of selected sites is reduced by subpopulation structure, and also because in our simulations of population b half of the selected sites are neutral outside the subpopulation in which they arose. thus, to reach fixation, a positively selected site will have to migrate out of the subpopulation in which it arose into every other subpopulation, where it may not be under selection. figure  <dig> shows the life-spans of selected sites and gives further clues to interpret the differential effect of selection in panmictic and subdivided populations.

the probability of a double hit mutation is proportional to the number of polymorphic sites, and hence these are more common in population b . the probability of a back mutation on a given site is an increasing function of the allele frequency on that site, and thus there were fewer back mutations in population a  than in population b . in figure  <dig>  we only represented back mutations occurring on selected sites . in both populations, back mutations mainly occur on sites that remain for a long time in the population, and thus often arise at balancing sites.

the impact of selection with or without subpopulation structure is summarized in figure  <dig>  which represents the time selected sites remain polymorphic as a function of the selection coefficient s. as discussed above, this time is greater in a subdivided population, regardless of s value. for positively selected alleles that reach fixation, the time required tends to reduce in both mean and variance with increasing s. as expected, the vast majority of selected sites at which the derived allele is lost had s <  <dig>  and the smaller s is the quicker the loss, but derived alleles with s <  <dig> do sometimes reach fixation. interestingly, time to fixation seems not to depend on the value of s for s <  <dig>  detailed tracking of the most negatively selected sites reaching fixation reveals that most were within  <dig> kb of a positively selected site that went to fixation at about the same time. thus hitchhiking appears to be responsible in large part for the fixation of sites with s <  <dig>  in population b,  <dig> such sites went to fixation, compared with only  <dig> in population a, reflecting the enhanced opportunities for hitchhiking created by the longer life-span of positively-selected sites in a subdivided population.

CONCLUSIONS
fregene incorporates many useful features for population biologists and genetic epidemiologists, and has already been used to assess methods for the analysis of genome-wide association studies  <cit> . an important feature that overcomes a limitation of other software for simulation under selection is that the combined effects of different forms of selection – adaptive, purifying and balancing – can be studied in a single fregene run. its flexibility could be improved further: for instance, users can define their own recombination model by altering the existing c++ object. moreover, structural variants, such as genomic inversions and copy number polymorphisms, could be incorporated into the model with further work. in contrast, accommodating structural variation within coalescent-based simulators presents a distinct challenge. individual variability in the recombination map could also be considered: for instance, each individual could have their own recombination map, with hotspot intensity/presence dependent on sequence-content for example, which is transmitted to their offspring with minor changes. fregene and sample are open source and as such users are free to contribute additional features, or make any other improvements.

availability and requirements
• project name: fregene

• project home page: 

• operating system: linux/unix – mac

• programming language: c++

• other requirements: gnu scientific library 

• license: gnu gpl

• any restrictions to use by non-academics: none

authors' contributions
mch contributed to the fregene code, including many of the new developments described here. he generated the datasets and the figures and led on the drafting of the paper. ch contributed to the fregene code, wrote the sample code and contributed to the writing of the manuscript. por, jw and mdi gave biological, statistical and computational advice to the project and commented on the manuscript. db led the project and edited the manuscript. all authors have read and approved the final manuscript.

supplementary material
additional file 1
fregene and sample codes. this file contains fregene and sample source codes, together with the extensive documentation, and example files to run fregene.

click here for file

 additional file 2
fregene recombination model in detail. this text describes in greater details the recombination model implemented in fregene.

click here for file

 acknowledgements
mch and ch were funded by the uk medical research council and por by the biotechnology and biological sciences research council. this work has been carried out within the bargen project, under the link scheme operated by the uk department of trade and industry. we thank will astle and ernest turro for testing fregene and sample, and for their constructive suggestions.

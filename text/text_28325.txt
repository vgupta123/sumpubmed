BACKGROUND
the b and t cells of the immune system of higher organisms create and express a vast array of different immunoglobulin  and t cell receptor  sequences, respectively, in order to target invading pathogens. during early stages of the cell maturation process, a set of v , d  and j  gene segments are chosen from a genetically encoded pool to create a typically unique receptor for each b and t cell, a process known as vj recombination . recent studies have used deep sequencing combined with sophisticated computational pipelines to study the contents of these repertoires  <cit> , and repertoire datasets have begun to proliferate in publicly available sequencing databases like sra, immport  <cit> , and vdjserver . however, although some groups have developed standardized terms for reporting and recording vj analysis results like vdjml  <cit> , there are relatively few widely available tools for analyzing data of this type.

a common task in the analysis of immune repertoire datasets is to examine the variation, or diversity, within an individual’s immune system. a number of metrics, including shannon diversity, species richness, simpson index, and the generalized hill diversity, have been previously used as methods for estimating diversity or quantifying the level of clonal expansion  <cit> . resampling strategies have also been used in order to compare diversity between sets of repertoires  <cit> . together, these methods have proved useful for understanding clonality, and for estimating and comparing the amount of clonal expansion between individuals’ repertoires. however, because individuals very rarely share overlap of specific rearrangements or specific receptor sequences, there have been few studies which directly compare the contents of b or t cell repertoires. in this paper, we present a tool for directly comparing sequencing repertoires, with the goal of quantifying the average difference in v, d, and j gene segment utilization between repertoires.

the problem of comparing the contents of a repertoire is not unique to studies of the immune system. methods for comparing prevalence of individual bacterial species have been widely used in the field of metagenomics , and well-established parametric methods for comparison of individual genes have long been used in rna-seq experiments  <cit> . however, these methods focus on comparison of individual species within a dataset, whereas direct sample-to-sample comparisons  rely on simple data transformations for normalization or subsetting to the most common species to remove bias from variation in sequencing depth. while such approaches are generally reliable for high-depth sequencing experiments, their performance will suffer as the effects of random sampling become more pronounced.

in our previous paper  <cit> , we demonstrated the power and utility of quantifying immune repertoires via deep sequencing of sorted b and t cell populations. we used the repertoire dissimilarity index  metric to compare v, d, and j gene usage within the naïve and memory repertoires of identical twins, and we showed that the contents of naive immune repertoires are determined primarily by heritable factors, and that observed biases in gene usage are carried over into the memory repertoire. here, we describe and extend the rdi, a non-parametric, computational approach for the estimation of repertoire differences. we show that the distance metric is an accurate approximation of the true difference between two repertoires, and that this method accounts for the various challenges associated with repertoire profiling, namely varying sequencing depth and gene prevalence. the code for calculating the rdi metric has been implemented as an r package, and is available for download at http://bitbucket.org/cbolen1/rdicore.

methods
there are a number of challenges associated with direct comparisons of gene segment prevalence among immune repertoires. first, variations in genotype and copy number of individual v, d, and j gene segments leads to high variability in segment prevalence, often resulting in missing gene segments and orders of magnitude differences in frequencies. in addition, the variable sequencing depth in individual samples can result in higher variance in repertoires containing small numbers of sequences, leading to increased error in the estimates of segment prevalence—and therefore inter-repertoire distance—as the number of sequences in a repertoire decreases .fig.  <dig> repertoire subsampling accurately controls for variance inflation. a simulated sequencing dataset was generated by drawing  <dig> replicate samples from a single pool containing  <dig> genes of varying prevalence. for each replicate, the number of sequences was chosen randomly, and the total count varied between  <dig> and  <dig> . a the frequency of each gene was tallied, and the euclidean distance between each pair of replicates was calculated. b each repertoire was subsampled to the size of the smallest repertoire , and euclidean distance was calculated based on normalized gene frequency in the subsampled dataset. the distance measurement was then averaged across multiple subsampling steps. all distance metrics are compared against the original repertoire size for the smaller repertoire




in order to account for these challenges and to make meaningful comparisons between repertoires of interest, we developed a multi-step process, the repertoire dissimilarity index , which controls for variance inflation by calculating distance after subsampling all repertoires to the same size. in addition, we use a novel simulation approach to directly quantify the average difference between elements of the repertoire. we demonstrate the utility of this method both for identifying repertoires that significantly differ, and for identifying subgroups of repertoires that are most similar to each other compared to the overall population.

the rdi calculation consists of five steps:
step 1: subsample the repertoire. when comparing two distinct repertoires, the larger of the two is randomly subsampled to have the same number of elements  as the smaller repertoire. when multiple repertoires are being compared simultaneously, all repertoires are subsampled without replacement to the size of the smallest repertoire.


step 2: count abundance of each feature. sequences within each repertoire are binned by feature of interest , and the number of elements representing each feature is counted.


step 3: normalize and transform counts. in order to improve the consistency of the rdi metric, the total number of clones in each repertoire are normalized to an arbitrary constant . optionally, the counts can then be transformed using the arcsinh function, which is approximately linear for values around zero and logarithmic for values greater than  <dig> 


step 4: calculate the root mean square deviation of repertoire counts. pairwise comparisons of all repertoires are made, and the root mean square deviation   between each pair of repertoires is calculated.


step 5: repeat steps 1– <dig> and average. the subsampling process is repeated  <dig> times, and the rmsd values from all realizations are averaged together to create the final rdi value.




by subsampling all repertoires to the same size, we account for variation due to sequencing depth, thus enabling direct comparison of rdi values regardless of the original repertoire size .

one caveat with the subsampling approach is that rdi values will increase as the smallest repertoire size decreases, meaning that the distances only have a defined meaning relative to rdi scores calculated at the same time. within a set of comparisons, rdi will increase as the differences in repertoire increase, either increasing linearly with the average percent change in gene frequency , or relative to the average log-fold change . the latter is recommended for cases where changes in prevalence of less-common genes is of interest, as these changes will otherwise be dominated by the large percentage changes in the most prevalent genes.

generation of simulated datasets
to provide a standard reference for the rdi calculation, we used a simulation approach to create datasets with fixed levels of variation. a baseline gene probability vector, p
base, was generated containing  <dig> features with probabilities based on the distribution of gene segments in the igh, tra and trb repertoires from publicly available data  <cit> . from these baseline vectors, variation was added using a random perturbation vector, r, such that: pfc=2log2pbase+r 


after perturbation, the resulting probability vector was normalized to sum to  <dig>  and the true deviation of the perturbation vector was calculated, either as the average absolute percent change , or the average absolute log2-fold change . the resulting vector was then used to create simulated datasets with known true fold changes.

sets of repertoires were generated from each vector by randomly drawing a set number of genes  with the given probability. perturbed repertoires were then compared to repertoires generated from the baseline vector, and the rdi metric was calculated as described above . although the variance in rdi metrics becomes much higher at smaller repertoire sizes, repertoires with 4-fold differences in gene frequency can easily be differentiated with as few as  <dig> sequences, and with  <dig> sequences it’s possible to identify repertoires with extremely small differences. similar results can be seen if the number of features is changed , where a combination of large repertoire size and large numbers of features results in the highest power to differentiate non-identical repertoires, while a small repertoire size with a large number of features is, conversely, the least powerful.fig.  <dig> the rdi metric scales with differences in gene frequency. simulated datasets were generated by randomly drawing genes from a set of fixed probability vectors. probabilities were generated by perturbing a constant baseline probability vector such that the absolute log-fold difference in each gene was between  <dig>  and  <dig>  relative to baseline. each perturbation vector was used to generate datasets containing varying numbers of sequences , and a set of equally-sized baseline datasets were generated and compared to the perturbed datasets using the rdi metric. a the average rdi score for each perturbed dataset  is shown against the true average absolute log fold change  of each perturbation vector . spline models were fit to the data . b mean and standard deviation of the rdi value was estimated from the spline model at multiple fold change values, and are plotted as probability density functions for a variety of different repertoire sizes 




conversion of rdi to fold/percent change values
to account for the rdi metric’s dependence on the input repertoire size, and to make it possible to intuitively understand the magnitude of the differences in two repertoires, we use the simulation approach described above to estimate rdi values for repertoires that vary by set fold changes. for each set of rdi calculations, simulated datasets were generated containing the same number of sequences and genes as the real data. a baseline vector was generated by calculating the average frequency of each gene across the entire dataset, and  <dig> distinct p
fc vectors were generated with average fold changes ranging from 1x  to 256x . a simulated sequencing dataset was drawn from each perturbed vector, as well as a total of  <dig> datasets from the baseline vector. for each simulated dataset, the rdi was calculated in comparison to each baseline dataset, and an average rdi was calculated for each initial perturbation vector. this was compared with the true percent change  or fold change , which was calculated as the difference between the probability vector and the baseline vector, and a spline model was fit in order to translate from rdi to true difference .

generation of the rdi ladder
as an alternative to directly converting rdi values to fold/percent change values, local estimates of mean and standard deviation were generated at a set of pre-specified fold/percent change values using the spline model. the calculated spline models were used to estimate the expected rdi value, and the residuals of the model were used to estimate local standard deviation. the mean and standard deviation were then used to generate an approximate distribution of rdi values at a specific fold change .

datasets
the t cell repertoire data from  <dig> pairs of identical twins was processed and normalized as previously described  <cit> . briefly, naïve and memory t cells were isolated using flow cytometry, and isolated rna was barcoded and amplified using a race based method and sequenced via illumina miseq. pre-processing of the sequencing data was done using the vdjpipe ngs processing software , and consensus sequences were generated for each barcode group using the presto toolkit  <cit> . for each processed sequence, v, d and j genes and alleles were identified using the imgt/highv-quest online tool  <cit> . for the clonally collapsed dataset, sequences were further grouped by clonality using change-o  <cit> , and each clone was only counted once in all analyses. shannon entropy was estimated for the v gene frequencies in each repertoire, and the difference in shannon entropy for naïve vs memory repertoires were calculated within each patient.

RESULTS
rdi accounts for heterogeneity in repertoire size and sequencing depth
in many cases, it is difficult to differentiate sampling bias during the sequencing process from actual variation in gene prevalence. using the rdi metric, we determined whether we could identify repertoires that are known to be identical. clonally collapsed trb sequences from a single donor were split into two ‘repertoires’, with each clone randomly assigned to one of two unevenly-sized groups. the v gene frequencies within each repertoire were then compared using the rdi metric, and the distribution from  <dig> random draws was examined for each repertoire size . as expected, while the average rdi—as well as the variance of the distance estimate—increase with smaller repertoire sizes, the distribution of rdi values align well with the distribution from simulated datasets.fig.  <dig> rdi accounts for repertoire size heterogeneity. trb sequences from a single donor in the rubelt et al. dataset were randomly assigned to one of two unevenly-sized groups. the smaller group contained  <dig>   <dig>   <dig>   <dig> , or  <dig>  total sequences, and all remaining sequences were assigned to the second group. v gene frequencies from the two repertoires were compared using the rdi method. the distribution of rdi values across  <dig> replicates  was compared with simulated data  with controlled levels of variance 




t cell repertoire differences are magnified by clonal expansion
to characterize the effects of clonal expansion, we chose to compare the v gene frequencies of naïve and memory cd4+ and cd8+ t cells. due to the effects of clonal expansion, a subset of t cell clones will be represented by multiple cells within an individual, increasing the prevalence of these expanded clones within the molecular dataset relative to the clonal dataset. in order to examine the effects of this clonal expansion, we characterized v gene usage within each repertoire both in terms of total number of molecules , or the total number of clones  containing each gene. rdi values were calculated for each dataset by comparing naïve cd4+ or cd8+ repertoires with memory repertoires from the same individual, and the rdi values were then converted to fold change values in order to compare across datasets . within each cell subset, the fold change values of the molecular repertoires were significantly higher than the clonal repertoires , reflecting the added variation resulting from clonal expansion. in addition, the fold changes in the cd8+ repertoire were significantly higher than the cd4+ fold changes, both in the clonal dataset , and in the molecular dataset . finally, the difference between the clonal repertoires and the molecular repertoires—i.e. the effect of clonal expansion on gene prevalence—was also slightly, but significantly, higher in the cd8+ repertoire than in cd4+, with fold-increases in dissimilarity of  <dig> -fold in the cd8+ repertoire compared with  <dig> -fold in the cd4+ repertoire . taken together, these findings suggest that clonal expansion introduces biases into the repertoires of both cd4+ and cd8+ repertoires, but that these biases are larger in the cd8+ repertoire than in the cd4+ repertoire.fig.  <dig> t cell repertoire differences are magnified by clonal expansion. individual naïve and memory cd4+ and cd8+ v gene repertoires were tallied based on either the clonally collapsed  dataset or the full  dataset from rubelt et al. naïve and memory repertoires were then compared within each individual donor , and log-fold change values were estimated from each rdi value. individual log-fold change values  and a kernel density plot  are shown for each group




given that the changes in the memory repertoire are most likely due to increased clonal expansion, it is likely that the changes in composition, as measured by rdi, will be associated with equivalent changes in the diversity of the repertoire. in order to measure this, we characterize the diversity within each naïve and memory repertoire using the shannon index, and calculated a fold change for each sample. as expected, the fold changes calculated by rdi were well-correlated with the fold changes in shannon entropy scores . however, the changes in the cd8+ diversity were not significantly greater than the changes in cd4+ diversity for the same patients, although the trend remained consistent .

discussion
direct comparison and quantification of genetic repertoires is a difficult problem, complicated by the high variance in prevalence of gene segments coupled with inconsistencies in sequencing depth between repertoires. in this paper, we present a novel method for quantifying repertoire gene abundance differences: the repertoire dissimilarity index . this method uses a non-parametric subsampling approach to account for variance in repertoire size, and, coupled with a data simulation approach, allows for direct quantification of the average variation between repertoires.

in this paper, we demonstrate that the rdi metric accurately accounts for the variance-inflating effects of low sequencing depth in a straightforward and easy-to-understand way. furthermore, using simulated datasets, we show that these distance metrics are directly proportional to the average fold change in gene prevalence, independent of total repertoire size. the ability to meaningfully quantify the variation between repertoires is important, as it enables an intuitive understanding of the differences between a pair of repertoires. additionally, the conversion of rdi values to standard units—in this case either log fold change or percent change—allows for comparison across datasets. we demonstrate the utility of this conversion here by calculating rdis within a molecular dataset and a clonal dataset separately, and then comparing the results.

an important feature of the rdi metric is that it is agnostic to the specific types or numbers of features being considered. we demonstrate that rdi can detect meaningful biological differences when used with anywhere between  <dig> to  <dig>  features, and it is likely that rdi will be equally useful in analyses of specific vj rearrangements . however, while there doesn’t appear to be any point at which the rdi estimates are incorrect, the variance of the metric can be quite high in experiments with low depth and a large numbers of features . a handy rule of thumb for these experiments appears to be that, in order to detect differences of 2-fold or greater with reasonable power, the number of sequences must be equal to or greater than the number of features.

the rdi has much in common with other repertoire diversity metrics, such as shannon entropy, species richness, and hill diversity. both types of metrics can be used to study the effects of clonal expansion within a repertoire, and both can be used to quantify the differences between a naïve and memory repertoire within an individual. however, diversity metrics are not designed to take into account the contents of a repertoire, and repertoires with equivalent levels of clonal expansion may still have the same overall diversity despite having entirely different contents. within an individual, the differences between the content of, e.g., naïve and memory repertoires are less drastic, and we saw that the change in diversity correlates well with the differences in content. however, this will most likely not be the case for comparisons between individuals, where differences in content will be the major factor affecting the rdi metric.

the repertoire dissimilarity index was developed to aid in the direct comparison of repertoires in a set of identical twins  <cit> . in rubelt et al., the rdi was used to identify striking differences in heritability of various immune compartments. using direct comparisons of b and t cell repertoires, among others we confirmed previous reports showing a mz twin bias in the choice of v-j combinations in naïve b and t cells, and extended this finding into the memory repertoire.

in this paper, we provide a follow-up to the analyses in rubelt et al., and examine the effects of clonal expansion among the memory compartments of cd4+ and cd8+ t cells. clonal expansion is the process by which antigen-specific b or t cell becomes activated and rapidly divides over multiple generations, and is an important step in the response to specific pathogens. as expected, we see that clonal expansion acts to increase the average variability in the memory repertoire, implying that clones are expanded in a targeted way, irrespective of their prevalence among naïve cells. although this is a well-known mechanism, the differences between the cd4+ and cd8+ repertoires are less expected. our results show that, compared to cd4+, more variation is introduced into the cd8+ memory repertoire during the antigen-driven selection process, and that clonal expansion further increases these differences by introducing more variation into the cd8+ repertoire. this is consistent with previous reports that cd8+ repertoires are subject to higher levels of clonal expansion, with greater proliferation of activated clones compared to cd4+ repertoires  <cit> .

while the differences in the molecular dataset can be primarily explained by differences in clonal expansion, the difference between cd4+ and cd8+ within the clonal collapsed dataset implies that cd4+ and cd8+ also vary in terms of clonal selection; i.e. the process by which a naïve t cell clone is exposed to antigen and transitions to the activated/memory t cell pool. when the naïve cd8+ repertoire was compared with the memory repertoire, we observed significantly higher levels of variation compared to the cd4+ repertoire. this implies that the cd4+ repertoire selects and expands a wider variety of clones from among the naïve repertoire, whereas cd8+ is more selective in which clones respond to antigens and subsequently transition to the memory compartment. this is further supported by observations by  <cit> , where the memory cd8+ repertoires of identical twins were less similar than those twins’ cd4+ memory repertoires. in addition, striking examples of the increased specificity of the cd8+ repertoire can be observed in responses to latent cytomegalovirus infection, where specific cd8+ cells often represent 10-20% of all cd8+ cells by peptide-mhc tetramer analysis, whereas cd4+ responses are more diverse and rarely comprise more than 1% of cd4+ cells . taken together, these results suggest that cd8+ t cell clones have to undergo a stricter selection process compared to cd4+, and that this process will result in a more specialized cd8+ memory repertoire within each individual.

although greater selective bias in the cd8+ repertoire is most likely the primary cause of the increased variance, several other factors may contribute to this increased variance. one possible source of variation is the presence of terminally differentiated t cells, a relatively uncommon subset of cd8+ t cells that are cd45ro− ccr7−, and were thus among the cells isolated in the naïve t cell population  <cit> . although we only expect them to make up a relatively small portion of the naïve cd8+ t cell population, these terminally differentiated t cells will have a unique repertoire of receptors, thus increasing the variance when compared to the memory repertoire. additionally, although the clonal dataset has been collapsed such that only one sequence from each clonal group was counted, the most expanded clones will still have a higher likelihood of recovery compared to the non-expanded clones, resulting in a slight but measurable skewing of the cd8+ repertoire towards these expanded clones. both of these factors would most likely have a slight, but non-zero, variance-inflating effect on the cd8+ memory repertoire.

CONCLUSIONS
immune repertoire profiling is still a relatively new field of research, and accepted tools for analysis of repertoires are still lacking. in this paper we present the repertoire dissimilarity index, a powerful and easy-to-interpret metric for the comparison of immune repertoires. this tool will be useful for all analyses of immune sequences, and can easily be extended for use in any repertoire experiment.

additional files

additional file 1: figure s <dig>  rdi values vary according to the number of genes. simulated datasets were generated by randomly drawing genes from a set of fixed probability vectors. probabilities were generated by perturbing a constant baseline probability vector such that the absolute log-fold difference in each gene was between  <dig>  and  <dig>  relative to baseline. each perturbation vector was used to generate datasets containing varying numbers of sequences , and were then compared against a set of baseline datasets containing the same number of sequences. mean and standard deviation of the rdi value was estimated from the spline model at multiple fold change values, and are plotted as probability density functions for a variety of different repertoire sizes . 


additional file 2: figure s <dig>  changes in repertoire content correlate with diversity changes following clonal expansion. individual naïve and memory cd4+ and cd8+ v gene repertoires were tallied based on the full  dataset from rubelt et al. shannon entropy was calculated for each repertoire, and the fold change in entropy between the naïve and memory repertoires of each patient/cell type. a) absolute log <dig> fold change values of shannon entropy are plotted against the estimated fold change in repertoire contents as calculated by rdi. b) individual log-fold change values  and a kernel density plot  are shown for each group. significance was determined using a paired t-test. 




abbreviations
igimmunoglobulin

ighimmunoglobulin heavy domain

racerapid amplification of cdna ends

rdirepertoire dissimilarity index

rmsdroot mean square deviation

tcrt cell receptor tra – t cell receptor, alpha chain

trbt cell receptor, beta chain

chris bolen and florian rubelt are co-first authors


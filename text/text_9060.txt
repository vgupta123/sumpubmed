BACKGROUND
single nucleotide polymorphism  genotyping arrays of continually increasing resolution allow unprecedented levels of genetic information to be captured in a single experiment. they enable the identification, on a genome-wide scale, of genetic markers that may be associated with various phenotypic traits, such as disease status and drug response. however, a genotyping experiment  <cit>  is a sophisticated and time consuming undertaking with many potential sources of systematic biases that are unrelated to the biological phenomena under study. these biases include variations introduced by chip manufacturing, dna sample processing, as well as experimental conditions. such unwanted effects can induce inflated dropped-call rates and/or genotyping errors, which in turn can compromise the statistical power of detecting association and, worse still, lead to the generation of incorrect biological hypotheses.

one form of systematic biases pertains to regional inhomogeneity of intensity measurements over the surface of a single array. these location dependent biases were first noted in two-channel microarray experiments  <cit> . various kinds of non-biological spatial artifacts have been reported by the user community since then  <cit> , including fibers, droplets and scratches that render measured intensity values useless, as well as uneven washing and temperature gradient that have a more subtle effect on intensity signals. importantly, many of them are expected to be present in fair abundance regardless of microarray platforms  <cit> . the normalization methods used in the current genotype calling algorithms do not specifically address such spatial biases even though these undoubtedly contaminate experimental data and might hamper subsequent analyses. older generations of affymetrix snp arrays use  <dig> perfect match  probe pairs scattered across the chip to interrogate each snp, so that spatial biases may be somehow mitigated by simple averaging. however, to make room for more snps, affymetrix  <dig>  chips reduce the number of pm probe pairs per snp to as few as  <dig>  and so are more susceptible to errors induced by these biases.

although not originally developed for the affymetrix snp  <dig>  arrays, many techniques can be adapted to reveal the most flagrant physical defects  <cit> . these techniques compare the intensity value of each location in an array to the corresponding signals aggregated across a set of replicated chips or a large collection of similar type of chips. regional accumulation of probe-wise outliers indicates the presence of physical artifacts. however, the approach is indirect and not capable of unveiling subtle to moderate spatial patterns and may overlook biases that are consistent across the chips.

in this publication, we report the development of an iterative method, designed to isolate both extreme  and subtle  spatial biases from actual biological signals within individual microarrays. our spatial bias removal procedure takes advantage of the technical replicate probes embedded in the affymetrix  <dig>  chips but is equally applicable to other experimental platforms with similar feature, for instance the illumina beadarrays. the procedure is independent of the downstream genotype calling algorithm. we focus on assessing the effect of spatial bias on genotype calls in this manuscript although the affymetrix  <dig>  arrays can also be used to determine genomic copy number variation.

methods
the design of affymetrix snp  <dig>  array
the latest affymetrix snp array  <dig>  chip is a  <dig> ×  <dig> oligonucleotide microarray, capable of simultaneously interrogating more than  <dig> k snps as well as over  <dig> k non-polymorphic  loci that are dedicated for the detection of chromosomal copy-number variation across the human genome  <cit> . snps and np sites are represented by clusters of identical 25-nucleotides oligomers immobilized at specific location on the microarray. a cluster of oligomers are commonly referred to as a probe. each probe is manufactured to perfectly match nucleic acid sequences containing the corresponding snp or np locus. because only two alleles are observed in nature for most snps, several pairs of snp probes are used to examine a specific snp. probes in a probe pair differ by just one nucleotide in the position that corresponds to the snp locus. probes targeting the same snps or np sites constitute a probeset.

our approach leverages two key features of the design of the array. first, in contrast to some previous generations of affymetrix snp chips in which probes in a probeset may have different orientation  and offset , probe pairs in the non-control snp probesets of the affymetrix  <dig>  arrays are strict technical replicates. in other words, all probes of a particular snp allele have the same nucleotide sequences and should therefore exhibit identical hybridization characteristics. these probes are deposited on the chip in either triplicate or quadruplicate. secondly, pairs in a probeset are distantly distributed on the chip, though the members of each probe pair are located in adjacent positions. these arrangements enable one to statistically identify location-dependent biases, and separate them from real biological information and noise. note that snp probe pairs used for quality control purposes and probes querying np sites are not replicated within the affymetrix  <dig>  array. strong heterogeneity in hybridization responses makes measurements of nonreplicated probes from the same probeset not directly comparable and less useful for within-array spatial biases detection. nonreplicated probes are, therefore, not utilized in our spatial normalization procedure.

datasets
we shall make use of three publicly available sets of affymetrix  <dig>  cell intensity files to train, test and validate our methods. the first set consists of  <dig> replicated chips for one of the hapmap phase i + ii sample  <cit> . these files will be used for demonstration and training purposes in the remainder of this manuscript. the second set includes  <dig> chips for all hapmap phase i + ii individuals. cel files for both set  <dig> and set  <dig> were obtained from affymetrix  <cit> . the last set, downloadable from the snp affycomp website  <cit> , refers to a single 'first-pass' experiment with  <dig> hapmap phase i + ii samples. sets  <dig> and  <dig> are considered to be of high quality whereas set  <dig> represents 'typical' quality. sets  <dig> and  <dig> will be utilized in the results section for testing and validation.

spatial normalization procedure
affymetrix snp  <dig>  arrays uses fluorescent labeling to quantify the amount of genomic dnas hybridized to each probe. the levels of fluorescent signals for each chip are stored in a separate cell intensity file  which is used as input to the proposed algorithm. our approach to spatial normalization relies on two assumptions:  <dig> ) that any discrepancies in intensity values between replicates are necessarily attributable to stochastic fluctuations in conjunction with spatial biases, and  <dig> ) that the same spatial artifact affects many probes in close vicinity in a similar fashion. for probesets with replication, we decompose the measured intensities ixy, or their transformation, at cell  for snp j with allele k  into   

where ajk is the intensity resulting from both specific and nonspecific hybridization. fluorescence emitted by the dna molecules represented by the probe is specific, while signals from other dna molecules and background are considered nonspecific. the second component sxy denotes the spatial bias effects. additional sources of experimental variation are captured by the spatially uncorrelated error terms εxy assumed to obey a zero mean symmetrical distribution.

model  is meant to be array-specific since both allelic intensities and spatial biases are likely to vary from sample to sample . our single-chip estimation and correction scheme is briefly described below. the motivation and justification of each step will be detailed in the coming sub-sections.

 apply a generalized logarithmic  transformation on ixy.

 for each snp allele, initialize Âjk with the median intensity of the replicates.

 estimate Ŝxy = e by a two-dimensional wavelet surface fitted to ixy - Âjk.

 update Âjk with the corresponding means of the bias-adjusted signals, i.e. ixy - Ŝxy.

 iterate steps  <dig> and  <dig> until convergence.

 remove outliers, i.e. probes with extreme local biases and revise Âjk.

glog transformation
as evidenced in figure 1a, the variance of εxy in model  is not constant across the value of Âjk if the very first step above is skipped. this implies that probes with more noisy intensity levels would have a relatively larger impact on the estimation of the spatial effects. the amount of systematic information that can be borrowed across neighboring probes would also be compromised. although the log transformation is often considered as a method for achieving constant variance, it tends to produce high variance at low regions of intensity. glog is a family of transformations  <cit>  that has been proposed for addressing the problem of heteroscedasticity that avoids this effect by bounding the logarithmic argument away from zero. following durbin and rocke  <cit> , it is defined as  

we adopt the algorithm suggested by the authors for estimating c. in order to reduce the computational burden, we perform the estimation using only  <dig>  randomly selected snp alleles. visual inspection of figure 1b indicates that a satisfactorily stabilized variability is achieved across the intensity range.

median or mean adjustment
dust particles, bubbles and scratches are typical contaminants that disturb intensity signals greatly but affect only limited areas of a microarray. hence it is reasonable to assume that most of the replicates that are constructed to be distant from each other on the chip are free from these strong perturbations. as a first approximation, we choose to calculate Âjk in step  <dig> using the median because of its robustness against outliers. however, once the fitting of sxy absorbs the spatial disturbances, we conjecture that inferring ajk with the mean intensity value will be much more efficient since the probes are duplicated only  <dig> to  <dig> times. this motivates the use of the mean in step  <dig> 

wavelet de-noising
step  <dig> intends to reconstruct the spatial biases robustly without assuming a particular structure for the underlying signal. the justifications for choosing wavelet-based methods  <cit>  rely mainly on their theoretical properties and computational efficiency. regional defects can show complex and discontinuous behaviors. wavelets, a family of nonparametric techniques, are particularly suited for capturing abrupt local changes as well as smooth global trends from noisy data. we utilize maximal overlap discrete wavelet transform  in this study. modwt is translation invariant , can compute all coefficients in just o multiplications, and does not require the number of probes along the x- or y-direction to be a power of  <dig>  however, as with other discrete wavelet transformations, it needs a complete data array. affymetrix  <dig>  chips have 'holes' for the locations that do not contain replicated snp probes. for example, probes allocated for alignment and control purposes or the np probes. as a solution, we fill in these 'holes' with the average of neighboring points . a large portion of the np probes are allocated into a horizontal and vertical stripes across the chip . rather than interpolate across these broad bands, the wavelet basis was fitted separately to each of the four corners.

the reconstruction of regional biases is performed using the 'denoise.mowdt.2d' function implemented in the r package 'waveslim', version  <dig> . <dig>  several parameters need to be specified. we use the simple haar wavelet and enforce the universal soft thresholding rule as a way of reducing the level of noise while preserving the significant features of the true signal. in light of the hierarchical nature of wavelet transforms, we select a decomposition level  that optimized the overall reproducibility of Âjk across the replicated samples in our training data, i.e. set  <dig>  to reflect the symmetrical role played by these training arrays, we measure reproducibility in a pairwise manner through  

in which λ <dig> denotes the major eigenvalue of each pairwise correlation matrix . notice that r <dig> is simply the coefficient of determination of a simple linear deming's model  <cit> : the higher the r <dig>  the better the reproducibility. we set the level of decomposition to  <dig> as additional resolutions did not lead to a better average r <dig> value - based on  <dig> possible pairings from set  <dig> . other wavelet functions were also used during the testing phase of the procedure but none gave better results.

an iterative procedure
outliers
an ideal experiment with no spatial bias would generate a zero theoretical value for all Ŝxy. non-balanced thermal conditions, uneven distribution of fluids and curvatures of chip surfaces would give rise to gradual perturbation of intensity measurements. conversely, extreme localized deviations of Ŝxy from  <dig> are indicative of the presence of physical artifacts such as debris, blobs and scratches. intensities of the areas affected by the latter may retain no or very little biological information thereby making a recovery of the original signals impossible. this suggests the potential need for detecting and eliminating aberrant probe signals. this can be achieved, for example, by considering Ŝxy lying n median absolute deviation  away from the median  as outliers. one could also refine the grouping approach by reinstating spatially isolated aberrations and discarding previously approved probes that were surrounded by ≥50% immediate outliers. the value of n was tested on set  <dig> over the range of  <dig> to  <dig> with the increment of  <dig>  on the basis of the reproducibility measure r <dig>  we estimated that n =  <dig> is sufficient to filter out 'unreliable' probes. a more comprehensive use of the neighborhood structure might improve the grouping of outliers even further. the reader is referred to suárez-farinãs et. al.  <cit>  for an example of this approach. Âjk can then be recalculated using all but these unreliable probes and serve as input for genotyping analyses. notice that the exclusion of probes with outlying Ŝxy from a certain region does not automatically lead to the elimination of the corresponding snps, on account of the scattered allocation of probe replicates on the array.

RESULTS
we illustrate the presence of chip-specific spatial bias via set  <dig> and evaluate the influence of spatial bias on genotype calling through the use of sets  <dig> and  <dig>  spatial and allelic effects are calculated individually for each array using the following parameters: haar basis, three levels of decomposition, universal soft thresholding and one iteration. relevant entries in the cel files are then updated with the glog-back-transformed estimates of ajk. conversion of intensity data into genotype calls is done by birdseedv <dig>  <cit> , a two-dimensional clustering algorithm using a gaussian mixture model. we use the default parameter settings of birdseedv <dig> in the following applications, as would most users. original and modified cel files are genotype-called separately. the results are compared in terms of call rate, call accuracy  or mendelian error. forasmuch as birdseedv <dig> cannot handle cel files with missing intensities, the outlier removal step  of our procedure is not implemented in these examples. so any potential alteration in genotype calls must be a direct consequence of spatial effect adjustment as opposed to the selection of 'well-behaved' probes. this provides a more appropriate basis for comparison, as removal of outlying probe intensities might create an unfair advantage for the proposed approach, by eliminating problematic snps from both the numerator and denominator of error rate calculations.

set 1: five replicated chips
the byproduct of our procedure, Ŝxy, facilitates exploratory visualization of potential systematic spatial bias. figure 2c and figure  <dig> show Ŝxy of  <dig> cel files arising from the same biospecimen that were treated exactly alike. the nonrandom trends suggest that all chips were affected to some extent by extreme, highly localized artifacts as well as subtle, more global biases. however, the spatial patterns are not consistent across the chips. since the cel files were generated from the same sample, these differences must be coming from extrinsic sources independent of the true biological signals. this justifies the need of a chip-specific normalization. although it is not the focus of this presentation, graphical illustration of Ŝxy may provide new insights about the root causes of biases which, in turn, facilitate the optimization of experimental protocols. figures 2c and  <dig> for instance demonstrate streaks that might indicate irregularities during the washing process.

set 2:  <dig> high-quality hapmap samples
genotype calls for many of the snps in the hapmap database were independently made by two or more platforms. concordant calls of these snps can be regarded as being close to the truth and, therefore, serve as a basis for calibration. we focused on snps that were typed by more than one non-affymetrix platform across all  <dig> hapmap samples. the exclusion of affymetrix calls would eliminate any potential platform-related bias. a strict rule of consensus was enforced: missing values were assigned to genotypes that were called differently or have at least one failed call. after filtering out snps with greater than 5% missing genotypes and not represented by affymetrix snp  <dig>  arrays, a total of  <dig>  snps  were retained as benchmark for accuracy assessment. spatial bias correction followed by the birdseedv <dig> algorithm changed  <dig>  genotypes in  <dig>  of these snps as compared to running birdseedv <dig> on the original cel files. among these genotypes, the failed call rate originating from the unadjusted intensities was considerably higher . specifically accounting for spatial biases improved the call rate among affected genotypes from  <dig> % to  <dig> %. furthermore, this improvement was achieved without inflating the number of calls discordant with the consensus hapmap calls. in other words, our method was able to restore a large fraction of the missing genotypes with good accuracy. narrowing the results of table  <dig> to  <dig>  genotypes that has a 'nonmissing' consensus hapmap call , spatial normalization converted  <dig>  discordant calls into agreement with hapmap,  <dig>  discordant calls into no-calls, and  <dig>  no-calls into concordances. the number of calls shifting to a better category was roughly twice the number moving to a worse category in all  <dig> cases .

entries are frequencies  out of the  <dig>  genotypes from set  <dig> . spatial bias normalization improved the call rate without inflating the number discordances with the consensus hapmap calls.

entries are frequencies  out of the  <dig>  genotypes. agreement and disagreement are with respect to the non-missing consensus hapmap calls. separate one tailed mcnemar's tests on the three pairs of discordant entries suggest significant improvement in favor of the use of spatial normalization: i.) z =  <dig>  for agree versus disagree; ii.) z =  <dig>  for agree versus missing; and iii.) z =  <dig>  for disagree versus missing.

another way of illustrating the effects of spatial biases is by exploiting family structure, as genotyping errors can induce mendelian errors. we directed our attention to the genotypes obtained from the  <dig> parent-offspring trios of the hapmap ceu samples. because a different cel file composition might influence genotype calling, birdseedv <dig> was reapplied to this subset of  <dig> of the modified and original cel files. out of all the  <dig>  snps interrogated by the chips, the fraction of snp trios available  for comparison based on calls from birdseedv <dig> with and without spatial normalization were  <dig> % and  <dig> %, respectively . the overall rates of mendelian inconsistency were  <dig> % for the standard birdseedv <dig> calls and  <dig> % for the birdseedv <dig> calls using spatially normalized cel files. the lower rate in the latter was partly due to the conversion of snp trios violating mendelian inheritance into indeterminate calls or ones that follow mendel's laws, but was best explained by the conversion of those with failed calls to calls showing no mendelian inconsistencies . thus our conclusion was in line with the above, i.e. spatial bias adjustment leads to higher call rate and lower rate of genotyping error.

entries are frequencies  of snp trios from  <dig> ceu samples of set  <dig> . separate one tailed mcnemar's tests on the three pairs of discordant entries suggest significant improvement in favor of the use of spatial normalization: i.) z =  <dig>  for consistent versus inconsistent; ii.) z =  <dig>  for consistent versus missing; and iii.) z =  <dig>  for inconsistent versus missing.

set 3:  <dig> first-pass hapmap samples
the examples above were based on high quality hybridization chips. here we demonstrate that the proposed methods can also be beneficial to cel files of typical quality with the use of data from the first-pass experiment. genotypes labeled as non-redundant by the hapmap project were downloaded for comparison. after excluding snps not present in dbsnp and those having dissimilar allelic forms , a total of  <dig>  snps were available for validation. upon correcting for spatial biases,  <dig>  genotypes of  <dig>  snps were reassigned. as in the examples above, the proposed procedure lowered the number of failed calls of birdseedv <dig> without incurring a greater degree of disagreement with results from the hapmap project . if the commonly used 95% snp-wise call rate threshold were to be enforced, spatial bias adjustment would have  <dig> more snps passing the quality control.

entries are frequencies  out of the  <dig>  genotypes from set  <dig> 

discussion
the quality of genotype calls will likely propagate to subsequent statistical analyses including genotype imputation  <cit> , haplotype estimation  <cit> , and inferences in linkage and association studies. consequently, it is critical to further develop analytical methods to improve the measurement of snps. we have designed an intra-chip normalization procedure to quantify and correct for undesirable systematic intensity biases that are linked to the spatial layout of the affymetrix snp  <dig>  array. although we took advantage of the design of this particular chip, the proposed approach is applicable to other array platforms given the presence of randomly allocated probe replicates.

the notion of using within-array replicated features for spatial normalization is certainly not new. it has been utilized in the context of tag  <cit>  and cdna  <cit>  microarrays. to the best of our knowledge, however, this is the first study of affymetrix snp chips that capitalizes on such technical duplicates for the purposes of localized signal correction. the proposed procedure basically followed yuan and irizarry  <cit> . nonetheless, their method is different from ours in two critical ways. first, in the same spirit as the use of a glog transformation, they adopted a model consisting of both additive and multiplicative bias terms so as to make neighboring 'features' comparable. the two components are estimated separately through an ad hoc subset selection of the features where the influence of other term can be regarded as negligible. however, this procedure is quite time consuming because it introduces more steps to the iteration and requires higher memory storage. secondly, they uncovered regional biases by using a fast fourier transform convolution. special treatment had to be applied on the prominent defects in an effort to avoid overshadowing the less obvious artifacts. the ability of wavelets in handling sharp local structures seen in the snp arrays is an advantage over the fourier methods. other smoothing techniques such as lowess and thin plate splines might also have been considered, but display drawback similar to the fourier transform while being even less efficient computationally.

affymetrix snp  <dig>  arrays are designed to interrogate snps along with genomic copy number changes. in its current form, the proposed approach only applies to snp probes. lack of technical replicates precludes explicit modeling of spatial effects on np probes. some sort of interpolation, such as a two-dimensional loess , is needed to extend the bias estimation to the entire microarray. we speculate that, because detection of copy number variation requires measurement of more subtle intensity changes, it may be even more affected by removal of spatial biases, an area that will be the focus of a future study.

CONCLUSIONS
our spatial normalization method operates independently on each array, making it possible to treat cel files in parallel on different processors. the usefulness of the approaches was demonstrated by the analysis of high- and typical-quality hapmap cel files. we showed that, even though only a small fraction  of all genotypes might be affected by spatial artifacts, adjusting for such biases can potentially rescue thousands of snps in a genetic study at the small cost of computational time. as mentioned above, the improvement in genotype call rate with equal or improved accuracy were achieved without omitting probes with outlying intensity. exclusion of these probes might enhance the outcomes further, but this awaits further investigation.

authors' contributions
hsc and jpak wrote the manuscript. hsc led the development, testing and validation of the statistical method with input and advice from tmt and krb. publication was authorized by jpak. all authors have read and approved the final manuscript.

supplementary material
additional file 1
the 'holes' filling procedure. additional text to describe the 'holes' filling procedure.

click here for file

 additional file 2
pairwise correlation matrix. additional text to define the pairwise correlation matrix.

click here for file

 additional file 3
relative gain in average r <dig>  additional graph to show the relative gain in average r <dig> of set  <dig> over  <dig> iterations.

click here for file

 additional file 4
mcnemar's tests on table  <dig>  additional text to provide more details on the  <dig> mcnemar's tests with table  <dig> 

click here for file

 additional file 5
mcnemar's tests on table  <dig>  additional text to provide more details on the  <dig> mcnemar's tests with table  <dig> 

click here for file

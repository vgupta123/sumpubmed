BACKGROUND
the evolution of dna, rna, and protein sequences is driven by mutations such as base substitutions, insertions and deletions , recombination, and other genomic rearrangements . thus far, analyses on substitutions have predominated in the field of molecular evolutionary study, in particular using the probabilistic  theory of substitutions that is now widely accepted . this is probably because evolutionary models describing residue substitutions are relatively easier to handle. however, it must be remembered that the study of indels is at least as crucial as the study of substitutions. there are two major reasons for this. first, it is indels but not substitutions that yield the skeletons  of the sequence alignments , which provide essential inputs to most homology-based analyses in computational biology. and second, some recent comparative genomic analyses have revealed that indels account for more base differences between the genomes of closely related species than substitutions . these circumstances make it imperative to develop a stochastic model that enables us to reliably calculate the probability of sequence evolution via mutations including insertions and deletions. since the groundbreaking works by bishop and thompson  <cit>  and by thorne, kishino and felsenstein  <cit> , many studies have been done to develop and apply methods to calculate the probabilities of pairwise alignments  and multiple sequence alignments  under the probabilistic models aiming to incorporate the effects of indels. such methods have greatly improved in terms of the computational efficiency and the scope of application. see excellent reviews for details on this topic . a majority of these studies are based on hidden markov models   or transducer theories . both of them calculate the indel component of an alignment probability as a product of inter-column transition probabilities or of block-wise contributions. and the study on these methods is still advancing, strengthening their mathematical and algorithmic bases . unfortunately, most of these methods have at least either of two fundamental problems, one regarding the evolutionary consistency and the other regarding the biological realism.  regarding the evolutionary consistency, it is a priori unclear whether or how a hmm or a transducer is related with any genuine stochastic evolutionary model , which describes the evolution of an entire sequence via indels along a time axis. regarding the biological realism, the standard hmms or transducers can at best handle mixed geometric distributions of indel lengths  , whereas many empirical studies showed that the real indel lengths are distributed according to power-laws . besides, very few studies thus far  addressed the issue of indel rate variation across regions.

in a previous study  <cit> , we presented a theoretical formulation that facilitates the ab initio calculation of alignment probabilities under a genuine stochastic evolutionary model, specifically, a general continuous-time markov model of sequence evolution via indels. our evolutionary model was created as a result of incorporating the idea of position-specific evolutionary rates  <cit>  into the most general “substitution/insertion/deletion model”  <cit> . thus, the model is naturally devoid of the aforementioned two problems. aided by some techniques of time-dependent perturbation theory in quantum mechanics , we formally expanded the ab initio probability of an alignment into a series of terms with different numbers of indels. this expansion gave an intuitively clearer representation of feller’s theorems  <cit> . and it theoretically underpinned the stochastic evolutionary simulation method of gillespie  <cit> , which provides the foundation for genuine sequence evolution simulators . and we also showed that, if the indel model parameters satisfy a certain set of conditions, the ab initio probability of an alignment is indeed factorable into the product of an overall factor and contributions from local alignments delimited by preserved ancestral sites , i.e., gapless columns. this suggested that the evolutionary models satisfying such conditions could provide a sort of generalized hmms, which extend the space- and time-homogeneous “long indel” model  <cit>  to some space- and time-heterogeneous situations.

in this paper, we focus on how to concretely calculate the contribution from each local alignment, assuming that the indel model satisfies the conditions for factorable alignment probabilities. , and briefly discuss extensions to more general cases near the end .) as noted in  <cit>  and section r <dig> of results and discussion of this manuscript, the contribution from each local alignment is a summation over an infinite number of local indel histories. thus it cannot be computed literally exactly within a finite amount of time. this makes it necessary to devise some approximation methods, each of which sums contributions from a finite number of indel histories . an auspice is that indel rates  are known to be at most around 1/ <dig> of the substitution rates  . and the probability of an indel history involving nid indels is roughly oλidtnid times the probability of a history with no indel, where t is a time scale characteristic of the system under consideration. in conjunction, these suggest that taking account only of histories with minimum and near-minimum required numbers of indels may provide a good approximation to each local alignment probability, as long as the sequence divergences  are within the scope of phylogenetic analyses  substitutions per site).

in section r <dig> of results and discussion, we briefly review the relevant portion of the theoretical basis that was established in our previous study  <cit> . we introduce simplified notation so that we can focus on a single local alignment. in sections r2-r <dig>  we demonstrate how our perturbative formulation can be concretely used to approximately calculate the contributions to the ab initio alignment probabilities from local alignments, i.e., alignment regions separated by gapless columns. we examine all types of local pairwise alignments  in section r <dig>  and some typical types of local multiple sequence alignments  in section r <dig>  for each local alignment type, we calculate the total parsimonious contribution and the total next-parsimonious contribution to its probability . in section r <dig>  we discuss two systems of integral equations that can be numerically solved to give practically exact solutions  for some common types of local pwas. there, we also study the behaviors of the “exact” solutions. then, by comparing the total parsimonious contribution with the total next-parsimonious contribution, or with the “exact” solution, we investigate the parameter regions in which the total parsimonious contribution can approximate the alignment probability quite accurately . in section r <dig>  we perform simulation analyses with a genuine evolutionary simulator, dawg  <cit> , to examine whether or not the conclusions from sections r2-r <dig> also apply to local msas of more general types. for this purpose, we developed an algorithm to calculate the “first-approximate” probability of a given msa under a given parameter setting  by multiplying the overall factor and the total parsimonious contributions from all local msas. and we examine the accuracy of the first-approximate multiplication factors calculated by the algorithm. in section r <dig>  we use our ab initio formulation as a “yardstick” to measure the accuracy of other indel probabilistic models. as a representative model, we chose the generalized hmm of  <cit> , which aims for the biological realism but not fully for the evolutionary consistency. in section r <dig>  we discuss some outstanding issues and possible improvements, extensions and applications of the presented algorithm and methods. the topics include the risks associated with the naïve application of our algorithm or methods to reconstructed alignments. the sections in methods describe the settings for numerical analyses  and simulation analyses . and the sections in supplementary methods in additional file  <dig> explain methodological details on concrete perturbation calculations and the first-approximate algorithm.

this paper basically uses the same conventions and notations as used in  <cit> . briefly, a sequence state s  is represented as an array of sites, each of which is equipped with an ancestry index . <dig>  and each indel event is represented as an operator acting on the bra-vector, 〈s|, representing a sequence state. more specifically, the operator m^ix,l denotes the insertion of l sites between the x-th and  th sites, and the operator m^dxb,xe denotes the deletion of a sub-array between  the xb-th and the xe-th sites. readers unfamiliar with the bra-ket notation ) can simply regard a bra-vector , a ket-vector  and an operator m^ as convenient reminders of a row vector, a column vector and a matrix, respectively, just as in the standard representation of a continuous-time markov model.  and, also as in  <cit> , the following terminology is used. the term “an indel process” means a series of successive indel events with both the order and the timing specified. and the term “an indel history” means a series of successive indel events with only the order specified.

as a last note, an “alignment,” a “pwa” and a “msa” in this paper will mean their homology structures  <cit> . briefly, the homology structure of an alignment is a set of alignment columns  that are spatially arranged in a looser way than in a usual alignment, i.e., constrained only by the spatial relationships between the sites within each aligned sequence.2

RESULTS


r <dig>  perturbation expansion of multiplication factor for local alignment
in this section, we briefly explain some results in  <cit>  that are essential for this paper. similarly to that of the probabilistic alignment methods in general, one of the main goals of our theoretical formulation  is to calculate the absolute occurrence probabilities of the alignments and to compare the calculated alignment probabilities. therefore, unless stated otherwise, the probabilities considered in this paper are not conditioned on a particular alignment .  could be obtained by dividing the absolute probabilities of the outcomes  by the absolute probability of the condition , similarly to eq.  in additional file  <dig> )

let p) | ] be the probability that a pwa ) between an ancestral sequence state  and a descendant  result from the evolution of a sequence during a time interval , given sa at ti. in  <cit> , we formally showed that p) | ] is given as a series:  <dig> pαsasd,ti,tfsa,ti=∑n=nminαsasd∞pnαsasd,ti,tfsa,ti 

here, nmin is the minimum number of indels required to create α. and p) | ] is the fraction of p) | ] contributed from all n-event indel histories that can yield α. a “preserved ancestral site”  is a site of sa that was hit by no indel and thus was preserved all through . now, using some  pass, we partition α into “local regions” , γ <dig> γ <dig> …,γκmax, in which all potentially causative indels are confined. in  <cit> , we derived the two conditions.condition : each indel rate parameter is independent of the portion of the sequence state outside of the local region where the indel occurred.

condition : the increment of the exit rate due to each indel event is independent of the portion of the sequence state outside of the local region where the indel occurred. 



under these conditions, the pwa probability, eq. , can be factorized as:  <dig> pαsasd,ti,tfsa,ti=p,ti,tfsa,ti∏κ=1κmaxμ˜pγκ;αsa,sd,titfsa,ti 

here p is the probability that the sequence underwent no indels during , given saat ti. and μ˜pγκ;αsa,sd,titfsa,ti is the multiplication factor contributed from the local region, γκ. because the multiplication factor is a summation of contributions over all local indel histories that can yield the local pwa confined in γκ , it can also be expressed as a series similar to eq. :  <dig> μ˜pγκ;αsa,sd,titfsa,ti=∑n=nminαsa,sd;γκ∞μpnγκ;αsa,sd,titfsa,ti 

here, nmin is the minimum number of indels required for the portion of α in γκ. and the term μp ) | ] is the portion of the multiplication factor contributed from all local-pwa-consistent n-indel local histories in γκ. <dig> 

it should be noted that the multiplication factor, μ˜p… ), is not a probability; actually, it is not even a conditional probability, and it can exceed  <dig>  in some cases  will always be less than  <dig> ). in this sense, the “generalized hmm” given by eq.  differs from normal hmms. the contribution of each local indel history to a multiplication factor is the ratio of the probability of the history  to the probability that the ancestral state underwent no indel.  in additional file  <dig> for the mathematical definition.) when comparing the contributions from two different sets of histories , the denominator  is usually identical. therefore, in general, the comparison of two multiplication factor contributions gives the same result as the comparison of the corresponding probabilities. 

similar arguments hold also for the probability, pαs <dig> s <dig> …,snxt, that a msa  of nx sequences, s <dig> s <dig> …,snx, results from the evolution along a given phylogenetic tree   <cit> . basically in line with the idea in  <cit> , we can build up the probability of a msa, first by multiplying the root state probability and the probabilities of ancestor–descendant pwas along branches, and second by summing such products over all msa-consistent ancestral states. the ab initio msa probability thus composed can be expressed as a series:  <dig> pαs <dig> s <dig> …,snxt=∑n=nmin∞pnαs <dig> s <dig> …,snxt 

here, nmin is the minimum number of indels required for creating the msa.  and pnαs <dig> s <dig> …,snxt is the portion of the probability contributed from all msa-consistent n-event indel histories. a msa-counterpart of a pas is a gapless column, which indicates that the corresponding site was hit by no indel throughout the evolution along t.  using some pass, we partition the msa into local regions, c <dig> c <dig> …,cΚmax. meanwhile, there are infinitely many possible root sequence states  consistent with the msa. among them, we choose one as the “reference” root state . then, in addition to the aforementioned conditions  and , we impose the following condition.condition : the  probability of each root state  is given by the probability of s0root multiplied by the product of factors over the local regions, where each factor depends only on the difference between sroot and s0root in a local region.



under these conditions, the msa probability is factorized as:  <dig> pαs <dig> s <dig> …,snxt=p0s0roott∏Κ=1ΚmaxΜ⌣˜pαs <dig> s <dig> …,snx;s0root;cΚt 

here, p <dig> is the probability that the root sequence state is s0root and that it was hit by no indel all across t. and Μ⌣˜pαs <dig> s <dig> …,snx;s0root;cΚt is the multiplication factor contributed from the local region, ck. as in eq. , the multiplication factor also can be expressed as a series:  <dig> Μ⌣˜pαs <dig> s <dig> …,snx;s0root;cΚt=∑n=nmincΚ∞Μ⌣pnαs <dig> s <dig> …,snx;s0root;cΚt 

here, nmin is the minimum number of indels required for the portion of the msa in ck. and the term Μ⌣pnαs <dig> s <dig> …,snx;s0root;cΚt is the fraction of the multiplication factor contributed from all local-msa-consistent n-indel local histories in ck. 

as agued above, under conditions  and   for a msa), the probability of a given alignment is factorized into the product of an overall factor and local contributions  and eq. ). this factorization could drastically speed up the computation of the probability. however, each local contribution is still a summation over an infinite number of indel histories  and eq. ), and its literally exact calculation would take infinitely long. this study examines two kinds of approximation methods. one is the “first approximation,” which approximates each multiplication factor with the “total parsimonious contribution,” i.e., the summation of contributions over all possible parsimonious indel histories. ) | ] with n = nmin or Μ⌣pnαs <dig> s <dig> …,snx;s0root;cΚt with n = nmin.) and the other is calculating a practically exact solution  of each local contribution from a local pwa of a certain type . especially, we examine the accuracy of the first approximation by comparing the total parsimonious contribution either with the total next-parsimonious contribution , with the “exact solution”  or with the results of simulations . here, the “total next-parsimonous contribution” is the summation of contributions over all next-parsimonious indel histories. ; γκ] +  <dig> or with n = nmin + 1).

in the following sections, we will work with a model that satisfies the conditions ,  and , and we will focus on calculating the multiplication factor that comes from a single local region  flanked by a pair of pass. as in  <cit> , we will work in the state space sii. this means that we will calculate the probability of the homology structure of each local alignment . let Δl be the number of sites that a sequence s ∈ sii has between the pair of pass. we will re-assign the site numbers so that the left- and right-flanking pass are numbered  <dig> and Δl +  <dig>  respectively, and the sites in between them are numbered  <dig>  …, Δl +  <dig>  this will make it easy to apply our theoretical formulation  <cit>  to the current situation. we will re-assign the ancestries υ = l and υ + 2) = r to the left- and right-flanking pass, respectively.  for a brief description of the ancestry.) and we will usually  re-assign the ancestries υ = x −  <dig> to the sites in between the pass, x =  <dig>  …, Δl +  <dig>  of the ancestral sequence, s = sa , or the root sequence, s = sroot . see fig.  <dig> for an illustration.fig.  <dig> notation and re-numbering of sites typical in this study. a an example msa. the c
κ’s  label the regions that actually or potentially accommodate local indel histories . as an illustration, we choose the local msa confined in the region c
 <dig> , and re-assign the ancestry indices  as shown in panel . ancestries l and r were newly assigned to the flanking pass. the ancestry indices in between the pass are just examples and not always assigned in this way.  could be regarded as hexadecimal numerals, if preferred.) c subsequences extracted from the local msa. shown above each site  is the site number  re-assigned to it. and the ∆l on the right of each sequence  is the count of sites in between the pass. in panels a and b, the boldface characters in the leftmost columns stand for the sequence ids. .) a dash  in a cell represents a gap. in panel b, triple dots  in a cell indicate that the alignment continues outwards. panel a was adapted from figure s <dig> b of  <cit> . panels b and c were adapted from figure  <dig> of  <cit> 



hereafter, we will often employ shorthand notations for the aforementioned  multiplication factors, e.g., μp ) | ] for a pwa and Μ⌣pnαs <dig> s <dig> …,snx;s0root;cΚt for a msa, either by omitting the arguments ” and “Μ⌣pn”) or by replacing the arguments with simpler ones representing more concrete situations ” or “Μ⌣pncaseii;Δld12”). unless stated otherwise, we consider the sequence evolution during time interval   or along a given tree, t .

for illustration, we will use the indel evolutionary model of dawg  <cit> , though the analyses could be extended with due modifications to more general models . <dig> its indel rates are space-homogeneous and time-homogeneous, and they are parametrized as follows. let l be the length of the sequence with state s. the rate of insertion m^ix,l is:  <dig> rixlst=λifilforx= <dig> ,…,ls;l= <dig> ,…lico 

here, λi is the total insertion rate , fi is the insertion length distribution, and lico is the cut-off insertion length. the rate of deletion m^dxb,xe is:  <dig> rdxbxe;st=λdfdl=xe−xb+1forxb≤ls;xe≥1;l= <dig> ,…,ldco 

here, λd is the total deletion rate , fd is the deletion length distribution, and ldco is the cut-off deletion length. consequently, the exit rate from state s is:  <dig> rxidst=∑x=0ls∑l=1licorix,l;s,t+∑xb=−ldco+2ls∑xe=maxxb,1xb+ldco−1rdxb,xe;s,t=λi+λdls+Δdawgλi,λd,fd.. 

here, Δdawgλi,λd,fd.≡λi+l¯d−1λd is a “universal” constant factor, and l¯d≡∑l=1ldcolgdlt is the average deletion length  <cit> . in this study, we use the power-law indel length distribution: fil=fdl=l− <dig> /∑k=1licok− <dig> , which is among the typical ones empirically observed . we also set λi = λd according to a genome-wide data analysis  <cit> , unless otherwise stated. as for the sequence state probabilities at the root, we assume a uniform sequence length distribution hereafter. <dig> see sections m <dig> and m <dig> of methods for more specific settings.

r <dig>  numerical comparison between parsimonious and next-parsimonious contributions : for local pwas
here, we examine how accurately the first approximation will estimate the multiplication factor from each local pwa by comparing the total parsimonious contribution with the total next-parsimonious contribution, both calculated via numerical computations of their analytical expressions . in this study, we are concerned only with the homology structures  <cit>  of alignments. hence, local pwas flanked by a pair of conserved ancestral sites  can be broadly classified into four cases, according to the sites between the pass:  no ancestral or descendant sites ;  some  ancestral sites but no descendant sites ;  some  descendant sites but no ancestral sites ; and  some  ancestral sites and some  descendant sites, but with no ancestor-descendant homology .  <dig> , and figure s <dig> for parsimonious histories in case .) our numerical analyses indicated the following. in case , the total next-parsimonious contribution ) was negligibly smaller than the total parsimonious contribution  ) for any realistic situation we likely encounter, as far as a single inter-pas region is concerned. in case  and case , the total next-parsimonious contribution  or μp) amounted to 1/ <dig> of the total parsimonious contribution  or μp), when the size of the local pwa  is equal to a threshold value,  <dig>  ≈  <dig> /e . here e ) is the expected number of indels per site during the sequence evolution. for example, in typical analyses of neutral genomic sequences from eutherian mammals, the branch length is around  <dig>  expected substitutions per site . and the total indel rate was estimated as 1/ <dig> of the total substitution rate  <cit> . using these values, e is approximately  <dig> /8 =  <dig> , which gives the threshold  <dig>  roughly equal to  <dig> sites. for the analyses of more closely related sequences, the threshold becomes longer. for example, in a comparison between primate sequences, a typical branch length would be  <dig>  expected substitutions per site . then,  <dig>  would be roughly equal to  <dig> sites. in case , the total next-parsimonious contribution ) did not substantially exceed 1/ <dig> of the total parsimonious contribution ) until the local pwa or the time interval became quite long . for more details on these analyses, see sm- <dig> of supplementary methods in additional file  <dig>   and  are given in sections a <dig>  and a <dig> , respectively, in  <cit> .)table  <dig> perturbation analysis on local pwa probabilities in case 

 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
each cell shows the ratio of the total next-parsimonious contribution to the total parsimonious contribution, when there are ∆l
a ancestral sites and ∆l
d descendant sites in between the pass. each column is labeled with the expected number of indels per site ). see section m <dig>  of methods for the parameter setting. because of the symmetry between probabilities under the time reversal, the ratio for  =  is identical to that for  =  when λ
i = λ
d. thus we only showed the results for Δl
a ≥ Δl
d. the ratios that are less than  <dig>  are shown in boldface. this table is identical to table  <dig> of  <cit> 



r <dig>  numerical comparison between parsimonious contribution and "exact solution" for local pwas
it is difficult to calculate the summed contributions from local histories involving more indels, especially in case . we could exactly calculate the contribution from a single local history involving any number of indels if we use the algorithm for a “trajectory likelihood” given by miklós et al.  <cit> . as we exemplified in appendix a <dig>  of  <cit> , however, it is already quite hard to enumerate even all the possible next-parsimonious local indel histories for case . nevertheless, if we consider only cases , , and  under a  space-homogeneous model, we can work out systems of exact integral equations that could in principle provide the numerical solutions for the total sum of contributions up to a desired level of accuracy, i.e., μ˜pnid≡∑n=nminnidμpn with a desired upper-bound indel count , at the expense of some time and memory.

applying the fundamental defining integral equations of our evolutionary model  in  <cit> ) to the local msas of cases ,  and , two systems of integral equations can be derived. one system is for cases  and  , and the other is for cases  and  .  <dig> these systems of integral equations can be numerically solved by iteration, and the results after nid iterations give the aforementioned μ˜pnid . a naïve implementation of this iteration  in additional file 1) would be very slow, with the time complexity of o22). here lco is the cut-off indel length and np is the number of equal-sized sub-time-intervals introduced for the numerical time integration. however, we devised a faster algorithm for this iteration  in additional file 1), with the time complexity of onp). and we implemented it in perl . typically, the computation finished in the order of an hour  in a macintosh computer with two quad-core  <dig>  ghz intel xeon processors and 8gb memory. one round of the computation provides the multiplication factors for all local pwa sizes  and for time-interval sizes of k /np with k =  <dig>   <dig>  …, np. our numerical analyses confirmed that nid =  <dig> would be enough to give the practically exact  solution for the local pwas of  <dig> sites or less in likely situations of phylogenetic-level sequence analyses . thus, we used the results of nid =  <dig> iterations as the “exact” multiplication factors, and compared the parsimonious contributions with them . we define another threshold value,  <dig> , at which the parsimonious contribution becomes 1/ <dig> of the “exact” solution. the results indicated  <dig>  ≈  <dig> /e . thus,  <dig>  is approximately 4/ <dig> of  <dig>  in the previous section, implying that  <dig>  actually gives a somewhat conservative criterion for the goodness of the first approximation. a fringe benefit of these iteration analyses is that we can also assess the “n-th approximation,” which is given by μ˜pn . we define  <dig>  as the local pwa size at which the n-th approximation becomes 1/ <dig> of the “exact” solution. it seemed that  <dig>  > n ×  <dig>  in general . this suggests the benefit of incorporating non-parsimonious local indel histories, especially when we deal with long local pwas resulting from a long time evolution.fig.  <dig> iterative solutions of integral equation system for local pwa probabilities. the results shown in this figure apply to both case  and case  local pwas. in both panels, the abscissa is the number of sites between pass  and ∆l
d for case ), with zero corresponding to case . each panel shows the ratio of the total contribution from histories with up to  n
id indels to the “exact solution” of the multiplication factor. see section m <dig>  of methods for the parameter setting. panel a is for  <dig>  expected indels per site, and panel b is for  <dig>  expected indels per site. panels a and b in this figure are modified versions of panels b and c, respectively, of figure  <dig> of  <cit> 



now that we have “exact” probabilities for local pwas of cases , , and , it would be interesting to examine their behaviors. panel a of fig.  <dig> shows the log-log plots of exact solutions for different time intervals . we see that even finite-time transition probabilities are well approximated by the power-law, with very high correlation coefficients for the log-log plots . and panel b of fig.  <dig> indicates that, as the time interval increases, the power-law exponent deviates gradually  from its value for the instantaneous indel rates . meanwhile, the coefficient seems almost proportional to the time interval . the slopes for these quantities differed for different values of the ratio, λi : λd.  these results may be useful for future data analyses on indels, e.g., when inferring the power-law exponents for the indel rate parameters from the comparison of relatively divergent homologous sequences.fig.  <dig> power-law behaviors of “exact” multiplication factors from case  local pwas. a log-log plots of the “exact” multiplication factors  against the local pwa size , showing nearly perfect power-law behaviors. although this panel shows the results under λ
i : λ
d = 1 :  <dig> only, the power-law approximation is actually very good also under λ
i : λ
d = 1 :  <dig> and λ
i : λ
d = 3 :  <dig> . panels b and c show the power-law exponent  and the coefficient , respectively, as functions of the distance  indels/site, abscissa) and the rate ratio . here, we assumed the approximate power-law relation, μpnid=200Δl≈aΔl−γ.  note that the results apply also to case  local pwas with due modifications



similarly to our ab initio formulation itself, these systems of integral equations can accommodate any practical indel length distributions. therefore, we could even examine cases where insertions and deletions follow different length distributions and/or models that incorporate transposon insertions  as well. such analyses should be interesting and important.

r <dig>  numerical comparison between parsimonious and next-parsimonious contributions : for local msas
we next studied some typical cases of local msas.  we only examined msas resulting from the evolution along a 3-otu tree . this is because a next-parsimonious indel history typically differs from its parsimonious counterpart in the sequence state at the internal node that phylogenetically delimits an indel event. we examined the following four cases, which differ in the sets of homologous sites in between the pass:  none of the three sequences has any site ;  two sequences share a homologous run of sites, but the third sequence has no site ;  one sequence has a run of sites, but the other two sequences have no site ; and  one sequence  has a run of sites, another sequence  has no site, and yet another sequence  shares the homologous sites with s <dig> except a contiguous subset of sites it lacks . in case , similarly to case  local pwas, the total next-parsimonious contribution Μ⌣p2casei was negligibly smaller than the total parsimonious contribution Μ⌣p0casei. the comparison in case  reduces to that in case  local pwas, thanks to the phylogenetic consistency condition that the ancestral sequence states must satisfy . the next-parsimonious local indel histories in case  are classified into two broad types:  those that have the same ancestral sequence state as the parsimonious history, and  those that have different ancestral states than the parsimonious history. the comparison of the total parsimonious contribution  to the total contribution from type  histories Μ⌣p2caseiii;a;Δld <dig> reduces to the comparison in case  local pwas. thus, we can focus on the total contribution from type  histories Μ⌣p2caseiii;b;Δld <dig>  our numerical analyses showed that this contribution is much smaller than the parsimonious contribution , even if the branch or the local msa is quite long. actually, the relative contribution decreased as the local msa got longer . in case , the total next-parsimonious contribution Μ⌣p3caseiv;Δld <dig> Δld <dig> did not substantially exceed 1/ <dig> of the total parsimonious contribution Μ⌣p2caseiv;Δld <dig> Δld <dig> until the local msa or the branches became quite long .8fig.  <dig> gap configurations of local msas examined in perturbation analyses. a the 3-otu tree used in the perturbation analyses. a node  is labeled n
i   or n
root . a branch is labeled b
i . in the following, ∆l
di denotes the number of sites that the sequence at node n
i has between the pass. b local gap configuration in case . c case  with Δl
d1 = Δl
d2 =  <dig>  d case  with Δl
d1 =  <dig>  e case  with Δl
d1 =  <dig> and Δl
d2 =  <dig>  the figure is a modified version of figure  <dig> of  <cit> 

fig.  <dig> perturbation analysis on local msa probabilities in case . the graph shows the ratio of the contribution of the type  next-parsimonious history to that of the parsimonious history. the former history consists of a deletion along each of branches  <dig> and  <dig>  and the latter consists of an insertion along branch  <dig>  the ratio is shown as a function of the length of the gapped segment  and the expected number of indels per site along each branch . the figure is a reduced and modified version of figure  <dig> of  <cit> 

 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
each cell shows the ratio of the total next-parsimonious contribution to the total parsimonious contribution. in each local msa, the first, second and third sequences have ∆l
d <dig> sites, ∆l
d <dig>  sites and zero site, respectively, in between the pass. each column is labeled with the expected number of indels per site along each of the three branches. the ratios that are less than  <dig>  are shown in boldface. this table is identical to table  <dig> of  <cit> . see section m <dig>  of methods for the parameter setting



taken together, the results in sections r2-r <dig> suggest that the first approximation by the parsimonious indel histories alone will estimate the multiplication factor for each local alignment fairly well, as long as the local alignment size and the branch lengths  are at most moderate.

r <dig>  simulation analyses to see goodness of first approximation for local msas
thus far, we examined all cases of local pwas and some typical cases of local msas. to study a much wider variety of local msas, we developed an algorithm that calculates the first approximation of the probability of a given msa under a given parameter setting including a phylogenetic tree. briefly, the algorithm first chops the input msa into gapped and gapless segments. second, it attempts to enumerate all parsimonious indel histories that can give rise to each gapped segment  via what we call a “local multi-path downhill search” algorithm. third, it computes their contributions to the multiplication factor for each gapped segment. and finally, it computes the first-approximate msa probability as the product of an overall factor and the total parsimonious contributions to the multiplication factors from all gapped segments. 

after manually validating the sub-algorithm to enumerate all parsimonious indel histories , we conducted simulation analyses using dawg  <cit> .  we created five homogeneous sets of simulated msas, namely, sets 1a, 1b, 3p, 3m and 3f. each of sets 1a and 1b consists of  <dig>  msas simulated along a three-otu tree that has equally long branches and is rooted at its sole internal node. the expected number of indels per site along each branch  is  <dig>   for set 1a and  <dig>   for set 1b. sets 3p, 3m and 3f consist of  <dig>  msas each, which are simulated along the trees of  <dig> primates,  <dig> mammals and  <dig> fast-evolving mammals, respectively . these sets were designed to mimic typically encountered msas of selectively neutral genome sequences whose sequence divergences are small, moderate and large, respectively.9

every simulation started with a random dna sequence that is  <dig> bases long. for reasons of computational time, we excluded local msas containing gaps longer than  <dig> bases. the numbers of subject local msas in sets 1a, 1b, 3p, 3m and 3f were  <dig> , <dig>   <dig> , <dig>   <dig> ,  <dig>  and  <dig> , respectively. among them,  <dig>  %,  <dig>  %,  <dig>  %,  <dig>  % and  <dig>  %, respectively, exhibited non-parsimonious ancestral sequence states. 

for each of sets 1a and 1b, we compared the absolute occurrence frequency of each of the homology structures of local msas with its first approximate prediction .  the approximation was pretty good for both set 1a  and set 1b , with correlation coefficients  <dig>  and  <dig> , respectively . the scatter plot for set 1b  showed a thin downward projection from around the middle of the main diagonal, indicating the underestimation of the frequency. however, it disappeared after removing the local msas in each of which one or more unobservable indels are expected . this extends the conclusions in sections r <dig> and r <dig> that the first approximation estimates the probability of a local pwa fairly well as long as its size is within a threshold  <dig>  or  <dig> ).fig.  <dig> simulation analyses on absolute alignment frequencies. each panel compares the predicted absolute frequency of each local homology structure  against the number of times that it actually occurred in a simulated dataset . the predicted absolute frequency was calculated using eq.  in additional file  <dig>  note the logarithmic scaling for both axes, which tends to exaggerate sampling errors on the lower-left region in each panel. panels a, b and c, respectively, show the results with the simulated sets 1a, 1b and set 1b after removing long gapped segments. the panels a-c are reformatted versions of panels a-c of figure  <dig> of  <cit> 



then, for each of simulated sets 1a, 1b, 3p, 3m and 3f, we first examined the relative frequencies of actual occurrences among different sets of parsimonious ancestral states consistent with each local msa. then we put the relative frequencies into  <dig> bins of width  <dig>  each. and, finally, we compared the average frequencies in the bins with their first-approximate predictions . the predictions were shown to estimate the actual relative frequencies quite well, with the correlation coefficients ranging from  <dig>  to  <dig>  . fig.  <dig> simulation analyses on relative frequencies among local indel histories. each panel compares the predicted relative frequencies  against the actual relative frequencies in simulations . the relative frequencies are among parsimonious local indel histories that potentially yield the same local msa. a blue diamond, a red ‘x’ and a black cross represent a bin of all parsimonious local indel histories, that of most likely  parsimonious histories, and that of least likely  parsimonious histories, respectively. panels a, b and c show the results with sets 1a, 1b and 3m, respectively. see section sm- <dig> in additional file  <dig> for how the analysis was performed. panels a and b are reformatted versions of panels d and e, respectively, of figure  <dig> of  <cit> 



the results in this section suggest that the first approximation would work fairly well also for a majority of local msas we are likely to encounter, as long as the local msa and the branches are at most moderately long.10

r <dig>  examining other indel models and methods in light of our formulation
one of the major merits of our ab initio perturbative formulation is that it can be applied to considerably realistic evolutionary models of indels  <cit> . therefore, it will enable us to examine, e.g., the parameter ranges where other indel probabilistic models can well approximate the ab initio alignment probability under a fairly realistic evolutionary model.

first we briefly study the goodness of approximation by the geometric indel length distribution, which most of commonly used indel models are based on. as in the previous sections, we use the power-law distribution of the indel length , f <dig> pl = l−  <dig> /, as a reference. then, we fitted the scaled geometric distribution, fsg = a  ql −  <dig>  to the power-law under a least-square criterion. the best-fit parameters were als =  <dig>  and qls =  <dig> . calculating the ratio, rls ≡ fsg/f <dig> pl, for different indel lengths, we find, e.g., rls =  <dig> , rls =  <dig>  and rls =  <dig>  × 10−  <dig>  the ratio decreases rapidly as the indel length increases. if, for example, we allow the ratio as small as 1/ <dig>  the geometric distribution is regarded as a decent approximation only for l ≤  <dig>  with f <dig> pl, the indels with l ≥  <dig> account for about 30 % of all indels. these mean that, for 30 % of actually occurring indels, the geometric distribution substantially underestimates their frequencies even according to the above lenient criterion. this reconfirms the importance of using biologically realistic indel length distributions, as pointed out, e.g., in  <cit> . 11

next, as an example of indel models that incorporate some biological realism, we investigate the hmm of kim and sinha  <cit> . their hmm can accommodate power-law indel length distributions. however, similarly to most other hmms and transducers, it cannot correctly handle overlapping indels along the same branch, although it can handle overlapping indels along different branches. another characteristic of their method is that it applies the same indel length distributions to all branches. the behaviors of the “exact” solutions  indicate that their hmm could approximate the probabilities of local pwas fairly well in cases ,  and , as long as branch lengths are reasonable for phylogenetic analyses. almost the same conclusions were drawn also from the analyses using up to next-parsimonious contributions in the perturbation expansion, eq. .  regarding case  local pwas, however, our analysis indicated that their hmm could substantially underestimate the ab initio probabilities, especially when long indels are involved .  this is because their hmm, like most hmms and transducers, neglects 1/ <dig> of the effects of non-overlapping indels , as well as most effects of overlapping ones , that can yield each case  local pwa.  these results suggest that a potentially effective way to improve the accuracy of the hmm of kim and sinha  <cit>  would be to modify the transition probabilities between a deletion-type block and an insertion-type block. this measure will enable to incorporate the effects of overlapping indels in case .table  <dig> comparison of kim-sinha’s probability with ab initio probability for case  local pwa

 <dig> 
 <dig> 
each row gives values for a local pwa with ∆l
a ancestral sites and ∆l
d descendant sites in between a pair of pass. see section m <dig> of methods for the parameter setting. when λ
i = λ
d, the ratio for  =  is identical to that for  = . thus, we only showed the results for Δl
a ≥ Δl
d. the ratios less than  <dig> are in boldface. this table is a modified version of table  <dig> of  <cit> 


a the ratio of the ab initio probability to the corresponding probability given by the hmm of kim and sinha  <cit> , in the limit where the time interval  approaches zero


b the portion of the ratio contributed by overlapping indels 



as exemplified above, our ab initio perturbative formulation provides other indel probabilistic models with a sound reference point, under which the models can be examined to improve their accuracy and evolutionary consistency. a related topic is the chapman-kolmogorov  equation, which must be satisfied by genuine stochastic evolutionary models. unfortunately, most of the currently common indel probabilistic models violate the ck equation . because our perturbative formulation satisfies the ck equation up to any desired order of the perturbation expansion , our formulation could also examine the effects of the violation of the ck equation. for example, under a geometric indel length distribution, the effects become conspicuous only when the indel lengths exceed a “critical value” of o, where the geometric distribution substantially underestimates the real indel frequencies.  this seems to explain the results of past studies , which did not detect remarkable effects of the violation of the ck equation .

r <dig>  outstanding issues and possible improvements, extensions and applications
here, we briefly discuss some outstanding issues and their possible solutions in the forms of methodological improvements and extensions, and also possible applications of the  methods to practical problems. 

r <dig> . possible improvements and extensions of our computational methods and algorithms
in this study, we successfully constructed two integral equation systems to calculate “exact” multiplication factors for case ,  and  local pwas. for case  local pwas , we only provided methods to analytically calculate the total parsimonious  and total next-parsimonious  contributions. although in principle we could calculate contributions from indel histories with more than  <dig> indels each, the question should be how we can do this within a reasonable amount of time. even if we can construct an integral equation system for case , it is expected to contain terms with complex gap configurations, and thus it would be difficult to solve it “exactly.” therefore, a key for this case should be how we can reasonably quickly obtain approximate multiplication factors each of which estimates the exact factor more accurately than the summation over all parsimonious and next-parsimonious contributions.

the main purpose for the current algorithm to calculate the first-approximate probability of a given msa  was to see whether or not the first approximation works also for local msas of general types. this algorithm merely constitutes the first step toward an automatic application of our ab initio perturbative formulation. consequently, the algorithm still has some rooms for improvements. for example, the algorithm could be very slow when applied to a local msa containing a long gap. roughly speaking, the length of time consumed by the algorithm applied to an input msa is the summation of the lengths of the consumed time over all local msas in it. we estimated that the algorithm applied to each local msa has the time complexity roughly greater than ob2nshg.  here, b is the number of blocks of distinct gap patterns in the local msa, and nshg is the number of short gaps that are spatially overlapping and phylogenetically neighboring the long gap. for example, if b = nshg =  <dig>  the time complexity is greater than o ≈ o. b should be roughly on the order of nshg. and nshg is roughly expected to be around e ≈  × Δl. here e and e are the expected numbers of indels per site along the two neighboring branches of the branch where the indel resulted in the long gap.  and ∆l is the size of the local msa. for example, if we assume a rather large value, e = e =  <dig> /8 =  <dig> , we have e ≈  <dig>  × Δl. in this case, we expect nshg ≈  <dig> almost always when Δl =  <dig>  thus, such local msas could virtually stop the current algorithm.  <dig> one way to quickly process a local msa containing long gaps should be to treat the gaps hierarchically, first long gaps alone and second the remaining short and medium gaps . if this strategy indeed works, the o2nshg component of the time complexity would reduce to o, because the short gaps that are phylogenetically neighboring the long gap can be handled independently of one another . another very similar strategy should be to narrow down the ancestral sequence states to be searched for, regardless of the presence/absence of gapless columns, by exploiting the “phylogenetic correctness” condition . the condition must always be satisfied by the ancestral sequence states consistent with msas, and thus it should be very powerful.

another possible improvement should be to incorporate non-parsimonious indel histories so that we can enhance the accuracy of the probability estimation. as in section r <dig>  we can classify non-parsimonious histories into two broad categories:  those each of which shares the set of all ancestral sequence states with a parsimonious history, and  those that share the set with no parsimonious history. each non-parsimonious history in category  yields the same ancestor-descendant pwas along all branches as a parsimonious history does . hence, we could easily incorporate the effects of category  histories by using local pwa multiplication factors that take account of non-parsimonious contributions, as we calculated in sections r <dig> and r <dig>  as the result in section r <dig>  indicates, this could considerably improve the accuracy relatively easily. incorporating histories in category  should require an algorithm to systematically enumerate such histories. some hints may come from the examples in section r <dig> and sm- <dig> of supplementary methods in additional file  <dig>  and the “branch-and-merge” operation . the real challenge, though, should be to devise a method to enumerate such histories efficiently. 13

in this paper, we presented the results of computing local alignment probabilities  under a space-homogeneous model implemented in dawg  <cit> , mainly in order to avoid excessive presentational complications. at least theoretically, however, the computational methods  could be extended to space-heterogeneous situations relatively easily. all we have to do is substitute space-heterogeneous counterparts for the space-homogeneous indel rates  in the final formulas in sm- <dig>  sm- <dig> and sm- <dig> , and replace multiplication by some integer factors  in eq.  and eq.  in additional file 1) with summation over possible positions . the time integration can be performed analytically  as long as the model is time-homogeneous. and the computation could be automated as long as the indel rates are specified according to some programmable rules. in some cases, tricks or approximations may be necessary so that the computation  can be finished quickly enough. it should be kept in mind, however, that such computation will make sense only if the probabilities of the entire alignments are factorable. this means that the indel rates  must satisfy the conditions  and   for msas) explained in section r <dig>  which may bring in some complications. for example, in the most general indel model we currently know to have factorable alignment probabilities , each locally heterogeneous set of indel rates is confined in a region that does not necessarily coincide perfectly with a gapped segment . when the region accommodates only one gapped segment , there should be no serious problem; although each position between contiguous gapless columns may experience some indels, the effects of such indels should be negligible , allowing us to focus on the single gapped segment. on the other hand, a serious problem may arise when the region accommodates two or more gapped segments. in this case, the contributions from the gapped segments  can no longer be factorized, and thus all possible relative orders will have to be considered among indels in different gapped segments overlapping the region . this could substantially slow down the computation, especially regarding non-parsimonious indel histories , and some new measures may be necessary for reasonably fast computation. in addition, it should be remembered that, in order to pursue further biological realism, one must also overcome some other hurdles, such as more realistic boundary conditions and mutations other than indels and substitutions .

r <dig> . risks associated with naive applications to reconstructed alignments
some readers may consider conducting some evolutionary analyses by applying the algorithm presented here to a msa reconstructed by one of the state-of-the-art aligners . we strongly caution the readers that it would be premature to conduct such analyses at this point. what we demonstrated here is that the algorithm estimates the probabilities quite accurately, provided that it is fed a correct msa. unfortunately, however, recent analyses  showed that reconstructed msas are considerably error-prone, even if they were reconstructed via state-of-the-art aligners. thus, a naive application of the algorithm to a reconstructed msa would likely lead to incorrect predictions. therefore, the readers should avoid such analyses whenever possible. even if they need to perform such analyses, the possibility of msa errors must be fully taken into account when interpreting the results.

r <dig> . possible applications
originally, we developed our theoretical formulation  <cit>  and the algorithm presented here for the purpose of comparing candidate msas in terms of their occurrence probabilities, i.e., their likelihoods. this purpose should be adequately fulfilled considering the accuracy of the predicted probabilities under moderate conditions, as demonstrated in this paper. if the algorithm can be coupled with a sampler that can preferentially explore quite likely regions of the msa space, we could obtain an approximate probability distribution of msas. such a distribution should be very useful, because a substantial fraction of alignment errors turned out to be due to the stochastic nature of evolutionary processes  <cit> . in the previous study  <cit> , we showed that the “long indel” model  <cit>  is virtually equivalent to our ab initio formulation under space-homogeneous indel rates. hence, their dynamic programming  could be applicable to the problem, possibly with some modifications. although the full version of their dp is quite slow, a device similar to those used recently  might speed up the msa space exploration. it remains to be seen if such a device could be successfully adapted to our formulation or not. most of currently available msa aligners, whether they implement probabilistic or single-optimum-search algorithms, are based on geometric distributions. because biologically realistic indel length distributions were shown to improve the accuracy of pairwise sequence comparisons , we expect that this will be the case also with multiple sequence comparisons. 

up to here, we assumed that the phylogenetic tree is given. in many cases, however, the phylogenetic trees must also be inferred from the input sequence data. a theoretically ideal way would be to infer the joint distribution of msas and phylogenetic trees, as it is expected to minimize possible prediction biases . a major problem is that such an analysis would be very time-consuming in general. in this sense, the traditional method of inferring the phylogenetic tree from an input msa  and the incorporation of indel information into the method  would still be useful. when trying to adapt our algorithm or formulation to any of these methods, we will have to further speed up the calculation of approximate alignment probabilities, especially under the moves in the tree space exploration, such as the nearest-neighbor interchange  and the sub-tree pruning and re-grafting . at present, it is a totally open question whether we can really do this without compromising the accuracy of the predicted probabilities. this should be a challenging, formidable yet crucial problem of phylogenetic-level molecular evolution.

CONCLUSIONS
in the previous study  <cit> , we proposed a theoretical formulation that facilitates the ab initio calculation of the probabilities of given pwas and msas under the general continuous-time markov model, which describes the evolution of an entire sequence along a time axis via indels. and we explicitly demonstrated that, under a certain set of conditions, each ab initio alignment probability is factorable into the product of an overall factor and multiplication factors originated from local alignments delimited by preserved ancestral sites, thus providing a sort of generalized hmms  and eq. ).

in this study , we provided some methods and an algorithm to concretely calculate the total parsimonious contribution and the total next-parsimonious contribution to the multiplication factor, eq.  or eq. , originated from each local alignment, under space-homogeneous situations for illustration purposes. our analyses indicated that even the total parsimonious contribution approximates the multiplication factor fairly well as long as Δl is within an o threshold. here,  is the expected number of indels per site and ∆l is the local alignment size. moreover, again under space-homogeneous situations, we deduced two systems of integral equations that can be numerically solved to give practically exact multiplication factors for local pwas of cases ,  and . an inspection of the practically exact factors indicated that the finite-time transition probabilities in these local pwas keep following the power-law, and that the exponent only slightly deviates from the original exponent for the instantaneous indel length distribution. equipped with these results and new methods, the theoretical formulation we proposed in  <cit>  is expected to provide other indel probabilistic models with a sound reference point, which could suggest necessary modifications to improve the accuracy of the models .

however, considering that the commonly used aligners are considerably error-prone , it would be very risky to naively apply the presented algorithm or methods to reconstructed msas. thus, it should be preferable to first develop programs that exploit the fruits of the previous study  <cit>  and this study to accurately estimate the uncertainties in, and rectify the errors of, reconstructed alignments under a genuine stochastic model of sequence evolution via indels that is biologically more realistic than almost all models studied in the past.


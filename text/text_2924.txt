BACKGROUND
 <dig>  structure elucidation utilizes nmr and ms
since more than  <dig> years mass spectrometric techniques are utilized to identify unknown compounds. pioneers of structure elucidation around carl djerassi  <cit>  or natural product researchers like satoshi omura  <cit>  or victor wray  <cit>  often used additional analytical techniques like nuclear magnetic resonance, fourier-transform infrared spectroscopy, ultraviolet spectroscopy or crystallographic data for initial proposition of structures of natural products which were subsequently confirmed by organic synthesis. the famous dendral project  <cit>  was one of the first concerted actions for structure elucidation approaches using computers which led to the term case . machine learning techniques , heuristic rules  <cit>  and other chemometrical methods were combined to investigate nuclear magnetic resonance  and mass spectrometry  data in order to find the correct structure of unknown chemicals in shorter time than manual investigation of all spectral data. although microflow-nmr  <cit>  was introduced recently using new capnmr probes or cryogenic probes, nmr still lacks sensitivity compared to ms. two dimensional nmr coupling experiments need measurement times up to hours. more importantly, complex mixtures cannot be fully resolved by nmr data acquisition only. for this purpose, nmr is coupled to high pressure liquid chromatography  to separate mixtures prior to data acquisition. data acquired solely by hplc-1h-nmr are insufficient for de novo structure elucidation purposes  <cit> . only if separation of co-eluting compounds is complete, resulting in a high enough mass of a pure compound, nmr couplings of protons, carbons and heteronuclei can in principle be used for a full structure elucidation, even without mass spectral data  <cit> . however, a rapid and automated annotation and structure elucidation of small molecules is still a challenge for complex mixtures. due to its universality and sensitivity, mass spectrometry is a method of choice as starting point for identification procedures. library search strategies using the fragmentation pattern of mass spectra of known and available compounds are well established  <cit> . however, small molecules can not be sequenced like peptides or proteins  <cit> ; hence there is no universal approach for de-novo structure elucidation utilizing ms/ms or msn techniques for unknown compounds or for the  <dig> million currently known isomeric structures that are not commercially available.

separation techniques like hplc or ultrahigh pressure liquid chromatography , capillary electrophoresis  or gas chromatography  are routinely coupled to mass spectrometry to separate and eventually detect and identify all components of complex matrices. yet reaching such comprehensive aims is far from reality. for the identification of an unknown compound by mass spectrometry, first and foremost a correct elemental composition of the native chemical must be computed. we have recently published an approach how to utilize isotopic abundance patterns of mass spectra for the reduction of formula candidates  <cit>  and how public databases can be searched and compounds can be annotated by their molecular formula. we here extend this approach by establishing and implementing chemical and heuristic rules that are used as constraints for finding the correct chemical formula, and we validate this approach on a large database consisting of  <dig>  molecular formulas which covered a chemical space of more than five million compounds.

several other programs have been suggested in the past for this purpose but none of them was validated on larger datasets like in this study. one program directly uses electron impact  spectra and performs a compatibility check of the molecular formula on ei mass spectra  <cit> . for that purpose fragmentation patterns are examined and molecular formulas are calculated for these fragments using additional constraints. another suite of programs used a test set of  <dig> compounds for interpretation of low resolution mass spectra and computation of highly probable elemental compositions  <cit> . subsequently, a set of empirical filter functions is used, but the validity of these filters was not thoroughly investigated due to the limited size of the molecular test sets.

 <dig>  compound identification requires high resolution and high accuracy of mass and isotope ratio measurements
in this paper we assume compounds to be completely resolved from co-eluting or isobaric compounds by the combination of chemical separation and high mass resolution  <cit> . ultrahigh mass accuracy  and high resolving power  can be obtained with fourier-transform ion cyclotron mass spectrometry   <cit>  or by orbitrap mass spectrometers  <cit>  . however, data acquired even by ultrahigh mass accuracy and mass resolution are insufficient for calculating unique elemental compositions without information about isotope ratios  <cit> . isotope ratios are measured since the very beginning of mass spectrometry  <cit> . natural occurring elements can be monoisotopic  or polyisotopic   <cit> . the calibrated abundance values of these elements are reported by the iupac  <cit> . using isotopic pattern generators  <cit>  one can calculate the contribution to the abundances of the m+ <dig>  m+ <dig>  m+ <dig> isotope ions in mass spectra, where m+• or m-• reflect the molecular ion. as the number of elements increase in complex and large molecules, the computation of correct isotope ratios becomes more complicated  <cit> . in fact, small molecule formulas can be calculated even from low-resolution quadrupole mass spectrometry data when isotope patterns and silylations were included as search constraints  <cit> .

 <dig>  raw data processing for complex samples involves peak picking, mass spectral deconvolution, and determination of molecular ions by adduct detection
even techniques with high peak capacities such as gcxgc/ms  or uplc/ms will lead to partially co-eluting peaks for complex mixtures. moreover, low abundant compounds may not be apparent by visual inspection of chromatograms. detection of single components from complex chromatograms is therefore performed by peak picking and mathematical deconvolution routines. the development of the freely available amdis program  <cit>  was a major milestone for gc/ms data analysis. the coda algorithm  <cit>  for lc/ms data analysis is now implemented into different commercial packages. such peak picking and mass spectrometric deconvolution routines are obligatory unless chemicals purified otherwise are directly introduced into the mass spectrometer via a probe or direct infusion.

the determination of the molecular ion from a given mass spectrum is one of the crucial steps during mass spectral evaluation. for electron impact spectra  this problem has been tackled  <cit>  and the corresponding algorithm is implemented in the nist ms-search program  <cit> . most often, gc/ms instruments are run under ei ionization. unfortunately, molecular ions observed in ei spectra frequently have very low abundances or are complete absent  which limit the use of molecular ion calculations. instead, soft ionization techniques like chemical ionization , field emission , field desorption  or other methods may be employed for ionizing compounds separated by gc. resulting from soft ionization, gc/ms spectra often comprise abundant molecular ions which may be utilized for assigning molecular formulas if an accurate mass spectrometer is used. lc/ms surveys almost exclusively use soft ionization procedures , both producing adducts of molecular ions such as + or + or multiple others. obviously, the nature of the adduct formation must be determined before accurate mass data acquisitions can be used for assigning elemental compositions  <cit> . although the problem is well known since several years, only recently a commercial program has been released to the market  <cit> . yet, routine recognition of adduct formation in lc/ms has not been validated on large datasets of diverse mass spectra.

RESULTS
developing rules for constraining formula generators
 <dig>  the rings-and-double-bond equivalent and the nitrogen rule are not instrumental for calculating sum formulas
atoms in chemical structures are connected by one or multiple chemical bonds. consequently, the rings-plus-double-bonds equivalent  or double-bond equivalent  concept was introduced in the 1950's  <cit> , and shortly later, the term of "degree of unsaturation" was introduced  <cit> . rdbe values can be calculated the following formula  <cit> :

rdbe = c+si - 1/ <dig> + 1/2+ <dig>     

each element symbol here represents the count of atoms of this element in the molecular formula. the elements oxygen and sulphur were not taken into account. this equation is still in use by organic chemists and mass spectrometrists, and it is frequently used in mass spectrometry software and common molecular generators. however, the equation is based on the lowest valence state for each element which therefore does not allow an exhaustive and correct calculation of the true rdbe values for a given accurate mass. so even if double bonds exist in the molecule, the formula does not count the number of double bonds correctly. due to this known problem a more general approach was suggested to calculate the degree of unsaturation which also includes excess localized electrons  <cit> . however, even this approach does not yield unique solutions. the elements nitrogen and phosphorous can have three or five valences, and sulphur atoms may have two, four or six valences. in organic compounds nitrogen has a valence of three. for molecules that contain these three atoms in different mixed combinations of their valence states, no single solution for rdbe can be calculated but an rdbe range would result.

moreover, negative rdbe numbers can not be excluded a priori, because normal valence state may be exceeded. more than  <dig> substances were found to have negative rdbe numbers when querying formulas in the nist and wiley mass spectral databases. most of these compounds contained either chlorine or fluorine atoms together with elements n, o, s or p. for example c12h36f6n6o2p4si <dig>  is a substance with phosphorous in the valence of five. ch2f10s <dig>  comprises sulphur at a valence state of six. organic sulphates contain sulphur at a valence state of six. for example, for dimethyl sulfate an rdbe value of zero is calculated although actually two double bonds are present in the molecular structure. due to these uncertainties, it cannot be automatically decided if the rdbe value for a specific formula is correct. therefore, rdbe values are of rather limited use as constraint in assigning chemically possible elemental formulas. however, a helpful application of the rings-plus-double-bonds equivalent is to detect formulas with an extremely high rdbe value. for example, rdbe values may be utilized to either exclude or include fullerenes, like c78h12cl2n <dig> with an rdbe of  <dig>  most of the compounds in our test set  were found to comprise an rdbe of less than  <dig> 

these results on assumptions and limitations of rdbe values exclude using rings-and-double-bond equivalents as constraint in calculation of molecular formulas. instead, we have assumed all chemically possible valence values be valid for all elements under investigation, in order to allow an exhaustive calculation of elemental compositions. consequently, the number of theoretically allowed molecular formulas is dramatically increased in the first instance, reflecting the chemical diversity of molecules that can be built from the scaffold of elements and their oxidation and valence states.

the nitrogen rule states that an odd nominal molecular mass implies also an odd number of nitrogens. this rule should only be used with nominal  masses. when using accurate mass measurements this rule becomes unreliable in mass ranges higher than  <dig> da. a test performed with  <dig>  formulas from 27– <dig> da resulted in 20% wrong assignments for the number of odd or even nitrogens. this is due to the fact that small non-nominal mass contributions from a large number of elements add up in higher mass regions. an example would be c38h64n <dig> . this rule can be helpful in lower mass ranges using unit resolution mass spectrometers or during assignment of elemental compositions to small fragments.

below, we demonstrate how a combination of heuristic and chemical rules reduces the number of theoretical formulas to a small set of the most likely compositions. the development and validation for each of the seven rules is shown in the following sections.

 <dig>  establishing heuristic and chemical rules
rule # <dig> – restrictions for element numbers
the restriction of element numbers is important to save computational time and disk space. if the research is aimed towards natural compounds  there is no reason to include chemicals with unreasonable high element counts. for developing this rule, the absolute element limits were calculated by simply dividing the mass range through the element mass  and are usually much lower. for natural products, the numbers for nitrogen, phosphor and sulphur are smaller than those of peptides. for example, in the range 960– <dig> daltons, peptides show a maximum nitrogen number of  <dig> but for natural small molecules, a maximum of only  <dig> is found.

rule # <dig> – lewis and senior check
in principle, elemental formulas can be calculated from accurate mass measurements for any species, ions, radicals or neutralized  molecules. since mass spectrometers can only detect ions , common formula calculators like chefoeg  <cit>  or hires ms  <cit>  calculate all combinations of elements that result in the correct  mass, disregarding advanced tests for the physical existence of chemical structures, because in gas phase chemistry of radicals and ion radicals, many uncommon and short-lived molecule species may exist  that would not be described as stable compounds under natural conditions. conversely, for the objective to determine the correct formula for natural products, it is reasonable to check if a molecular graph  can be built from a specific formula. two of the fundamental deterministic chemical rules are not obeyed by common formula calculators, the lewis and senior rules. these rules can best be tested for neutral compounds, hence ionic species detected in mass spectrometry first need to be neutralized by determining the adduct formation and correcting for it. for example, for obtaining the neutral structure from protonated compounds, a common adduct formed under positive electrospray mass spectrometry conditions, subtracting the proton mass of  <dig>  u from the accurate mass data would be required. without determining and neutralizing the molecular ion, species that are non-existent would be calculated by common calculators such as c6h16o <dig>  accordingly, any report on accurate mass measurements should at least detail the ion species  that were determined in order to enable post hoc validations.

in its simplest form, the lewis rule demands that molecules consisting of main group elements, especially carbon, nitrogen and oxygen, share electrons in a way that all atoms have completely filled s, p-valence shells . however, free radicals such as 5-hydroxy- <dig> -dimethyl-1-pyrrolidinyloxy , and in fact, all nitroso compounds, would not be allowed if the lewis rule would be strictly enforced. the lewis rule marks such compounds to be odd electron molecules, and the rdbe value would be a non-integer . if such radical components need to be checked, the rule has to be disabled within the source code of our script. furthermore, newer quantum mechanic ab-initio calculations have shown that certain hypervalent molecules do not obey the lewis rule  <cit> , and therefore we have combined it with a test for the extended senior rule. senior's theorem  <cit>  requires three essential conditions for the existence of molecular graphs  <cit> :

i) the sum of valences or the total number of atoms having odd valences is even;

ii) the sum of valences is greater than or equal to twice the maximum valence;

iii) the sum of valences is greater than or equal to twice the number of atoms minus  <dig> 

the senior rule is included in advanced molecular isomer generator such as the commercial molgen  <cit>  or the deterministic structure generator  <cit> , which was built with the help of the free chemistry development kit   <cit> . both calculators have free test-versions available online. however, certain radicals such as nitroso compounds should be excluded in molgen or need additional preparatory steps. more severe limitations are found that both calculators only take ground state valences into account, i.e. sulphur with two valences, phosphorous with three valences. these elements may have higher valences, and importantly, each element may have different numbers of valences in a specific, chemically allowed molecule. so far, calculators were unable to handle all combinations of mixed valences and higher valence states which would discriminate physically existent molecular formulas if directly applied or implemented into algorithms for filtering formulas by chemical rules. consequently, the algorithm presented here tests for lewis and senior rules by allowing maximum valence states for each element, and presence of mixed valence states for each element within molecular structures.

rule # <dig> – isotopic pattern filter
compounds that were synthesized by natural precursors comprise monoisotopic and isotope masses according to the natural average abundance of stable isotope abundances which are listed for each element  <cit> . previously, we have shown that applying isotopic abundance patterns removes most of the wrongly assigned molecular formulas from a certain mass measurement experiment  <cit> , and we proved that without isotope information, even a hypothetical spectrometer capable of  <dig>  ppm mass accuracy could not report unique elemental compositions in the range above  <dig>  dalton when elements c, h, n, s, o and p were included in the search list. therefore, isotope ratio abundance was included in the algorithm as an additional orthogonal constraint, assuming high quality data acquisitions, specifically sufficient ion statistics and high signal/noise ratio for the detection of the m+ <dig> and m+ <dig> abundances. mass spectrometers such as time-of-flight instruments are commercially available which report isotopic abundance patterns with a very low relative error  this rule has no impact. the relative impact of the isotopic ratio evaluations against the other rules is highlighted below.

rule # <dig> – hydrogen/carbon element ratio check
another important constraint for restricting formulas to those that are likely to exist is including element ratios, especially the hydrogen/carbon ratio . in most cases the hydrogen/carbon ratio does not exceed h/c >  <dig> with rare exception such as in methylhydrazine . conversely, the h/c ratio is usually smaller than  <dig>  and should not be less than  <dig>  like in the case of tetracyanopyrrole . figure  <dig> demonstrates that most typical ratios are found between  <dig>  > h/c >  <dig> , for example for long chain alkanes  or polycyclic aromatic hydrocarbons . frequency distributions were found to be not gaussian, so limit ranges could not be defined by 3σ or 4σ standard deviations which would cover  <dig> % and  <dig> %, resp., of all formulas in the data set. instead, cumulative percentages were used as range limits, given as table  <dig> for examining the wiley spectral database as development set. more than  <dig> % of all formulas were included with h/c ratios between  <dig> – <dig> . consequently, we call this range the 'common range'. however, a number of chemical classes fall out of this range, and we have hence enabled the user to select 'extended ranges' covering  <dig> % of all formulas in this development database . there are extreme cases for which rules of typical h/c ratios may be overridden, e.g. for the study of fullerenes  <cit>  which have an extremely low hydrogen/carbon ratio such as in c78h12cl2n <dig>  the implementation of our script enables researchers to exclude certain rules if needed for specific applications.

rule # <dig> – heteroatom ratio check
element ratio checks strongly reduce the number of candidate formulas. however, we found that heteroatom ratios distributions are even more skewed than h/c ratios, because many formulas comprise no heteroatom at all  or very few, and rare cases exist with high ratios of heteroatoms to carbon numbers. table  <dig> lists the common, the extended and the extreme ratios for small organic compounds comprised in the wiley mass spectral database.

rule # <dig> – element probability check
rule # <dig> only restricts unlikely high element ratios in molecular formulas, but it does not test for multiple high element counts like in the example of c26h28n17o1p3s <dig>  this formula would pass all rules so far including the element ratio checks; however, the combination of high element ratios would still be too improbable. therefore, an additional constraint "multiple element count"  was included. all combinations for nops and all triple combinations were included in this sub-rule. in order to have a sufficiently large basis for evaluating combinations of element ratios, this sub-rule was developed using the dictionary of natural products and the two mass spectral libraries nist <dig> and the wiley. for element combinations of n, o, p and n, o, s a high number of formulas was found with high element ratios, and specific thresholds were defined accordingly.

rule # <dig> – tms check
analysis of small molecules is often performed by gc/ms, frequently requiring chemical derivatization of the original molecules to enhance volatility, stability or sensitivity of detection. for applications in metabolomics or clinical chemistry, a commonly used derivatization step involves trimethylsilylation by mstfa  which exchanges acidic protons against tms  groups. if ionization conditions and molecular structures allow for the observation of molecular ions, tms groups  have to be subtracted for calculating the underivatized molecule. for example, accurate masses for c20h58n6o4si <dig> and c24h62o6si6differ only by  <dig> ppm, but after subtraction of tms groups, the residual  molecule c6h14o <dig> is much more likely according to rules #4– <dig> than c2h10n6o <dig>  both compounds would bear six tms groups which may mask differences in mass spectral isotope ratios given the high isotope abundances of silicon. nevertheless, the number of tms groups can easily be deduced by calculating isotope abundances, as we have shown in earlier work  <cit> . for tms derivatized molecules detected in gc/ms analyses, the rules on element ratio checks and valence tests are hence best applied after tms groups are subtracted, in a similar manner as adducts need to be first recognized and subtracted in lc/ms analyses.

 <dig>  combination of all rules
the application of all rules together is sufficient to derive the most likely elemental formula from accurate mass and isotopic ratio mass spectral measurements. in any case, adduct ions  or tms-derivatives  have to be determined  <cit>  in order to obtain the neutral form for each molecule. the seven rules are summarized below.

seven rules for molecular formula filtering for non-charged molecules:

1) apply heuristic restrictions for number of elements during formula generation

2) perform lewis and senior check

3) perform isotopic pattern filter

4) perform h/c ratio check 

5) perform nops ratio check 

6) perform heuristic hnops probability check 

7) perform -tms check 

the rules are implemented in an automated script written in visual basic and c++ which can also be used to calculate and subtract  <dig> usual adduct ions in lc/ms applications  <cit> . the adduct removal must be done manually before entering any values. the script performs all the filtering in an automatic mode, triggered by the user. if formulas are not obeying the rules, they are marked with "no", whereas allowed molecular formulas are marked with "yes". in addition, the isotopic pattern filter uses the experimental isotopic ratios to assign a score for each formula from 0– <dig> where higher numbers mean a higher probability of existence. mass accuracies should be determined for specific conditions, since mass errors are known to be depending on ion statistics, automated versus manual runs, or direct infusion of purified compounds versus lc/ms runs of complex samples. default values may be used as given by the instrument vendors. in addition to ranking formulas, these formulas are queried against internal target databases containing specific sets of molecular formulas.

the highest ranked molecular formula candidates are directly linked online to the freely available chemical structure lookup service   <cit>  which covers more than  <dig> million unique structures from  <dig> public and commercial databases at the time of writing. the csls also links to pubchem  <cit>  but has the advantage of a much faster response time. the dictionary of natural products and other copyrighted databases are searched in-house only.

we have validated the seven rules based on formula compilations downloaded from pubchem in early  <dig>  and additionally we downloaded and included a peptide database of  <dig>  molecular formulas  <cit>  comprising all combinations of the  <dig> proteinogenic amino acids for masses below  <dig> da.

 <dig>  validation and exemplary application of the seven rules
 <dig>  compounds in pubchem are covered by the rule constraints
as stated above, rules were evolved from the wiley mass spectral libraries and the dnp database . the nist <dig> mass spectral database was additionally used for special test cases. the mass spectral databases were selected for rule development because mass spectrometry is usually used for molecular formula determination. for validation, we have compiled a much larger database of  <dig>  unique molecular formulas that were derived from  <dig> million compounds from the pubchem database . at the time of writing the pubchem database has almost doubled to  <dig> million compounds. even if such queries were possible, online-query times would be rather slow. we have therefore downloaded or purchased the databases for in-house use and rapid access. the pubchem database was found to well represent the known molecular space of small molecules. 27% of all elemental compositions were found between 400– <dig> dalton . out of a total of more than five million chemical structures,  <dig> % of all formulas comprised less than  <dig> carbon or hydrogen atoms, rendering this number a reasonable cut off that we have utilized in our script implementation. interestingly, only  <dig> molecular formulas  failed to pass the set of seven rules we have developed. among them  <dig> molecular formulas did not pass the lewis and senior check, either because of conversion errors, wrong formulas or they were true radical containing compounds. most of the other failed candidates  did not pass rule # <dig> – the hnops probability check – due to the fact that they did not contain any hydrogen. the following largest group  did not pass rule # <dig>  the hydrogen/carbon ratio test. an overlap analysis revealed that  <dig>  molecular formulas  from wiley and dnp were not contained in the pubchem validation set. these results demonstrate the good performance of the set of rules, despite the comparatively small size of the development databases.

 <dig>  the space of chemically possible formulas is reduced 13-fold by rules #4–6
the next validation step aimed at assessing the ability of the seven rules to minimize the number of all molecular formulas with less than  <dig> da in mass. we have performed an exhaustive calculation of all formulas in this mass range containing the elements c, h, n, o, s and p which was just constrained by chemical consistency using the lewis and senior checks, allowing the maximum valence state for each element. table  <dig> lists the result of this validation effort. without any restrictions, i.e. by using the original hires formula generator and its count function, eight billion molecular formulas were generated in  <dig> hours computational time. conversely, when using the newly developed brute force formula generator hr <dig> applying the element count, ratio and probability restrictions, the computational time was reduced to  <dig> seconds resulting in only  <dig> million formulas. using the standard valence of three for nitrogen in organic compounds will slightly reduce the number to  <dig> million molecular formulas. this 13-fold reduction of formulas validates the use of elemental constraints, especially when novel molecules are to be annotated that are not included in the currently available databases. for example, from each of the most likely formulas, chemical structure generators may be utilized to evolve all structural isomers in either deterministic or stochastic manners, which may subsequently be sorted using other physicochemical constraints. such exhaustive isomer generations have previously been employed for small molecule research and drug screening  <cit> , and it might become a viable option for cluster computing as search tool in metabolomics. molecular isomer generators can generate a plethora of structural isomers from one single molecular formula  <cit> . obviously, such structure generators can only be successfully applied if the number of input formulas is very small, at best restricted to one single elemental composition.

 <dig>  validation by simulated mass spectral data of  <dig>  chemically diverse compounds
we have therefore further explored the validity of the seven rules by simulating data acquisition errors that were imposed on subsets of compounds from four important application databases: the dictionary of natural products, the open access drugbank database  <cit> , the toxic substances control act database  and compounds from the nist and wiley mass spectral libraries. compound subsets were selected randomly except for the mass spectral library entries which were chosen based on the constraint that formulas were absent from the pubchem, dnp or the peptide libraries. for each database subset, compounds were selected in a way that preserved the original distribution of isotope ratios and mass ranges. for all selected compounds, mass spectral measurements were simulated at ±  <dig> ppm mass accuracy and with ± 5% isotopic ratio errors. such performance values should easily be achieved by time-of-flight mass spectrometers. these data were imposed by assumed random errors reflecting mass spectrometric data acquisition, using the normal cumulative distribution in order to introduce noise into the selected datasets.

for each of these targets a ranking was performed applying the set of seven rules, and error rates were determined. statistics were based on the mass distribution of each of the target libraries. most of the formulas were found in the range between 300– <dig> da , and the effect of imposing assumed data acquisition errors is given in figure 4b and 4c. table  <dig> details the result of this validation experiment. it was found that when applying the set of seven rules and querying the correct target database, the correct molecular formula was ranked at the top of the list of potential other formulas in almost all cases . if the more general  pubchem database was queried, still the correct chemical formula would be retrieved as top candidate in 84–90% of the test cases, and only in 8–10% of the cases, a wrong formula was ranked highest . the residual 2–5% of the cases represents true negatives, i.e. no pubchem formula was retrieved to fit the data because the input formula from the target databases drugbank, dnp or tsca were indeed absent in pubchem. even without using any query of a formula data base, the correct input formula was ranked among the top three candidates in about 80% of the cases by the scoring function. in addition, we have deliberately selected  <dig> formulas from the wiley and nist mass spectral databases that were absent in pubchem. these truly 'unknown compounds' would be ranked mostly among the top three hits using the set of seven rules alone; however, when querying the pubchem database, a high number of false positive formula annotations would result.

this result emphasizes that our algorithm correctly annotates formula if these are present in small molecule databases, but such annotations should not be confused with unambiguous identifications. instead, genuine compound identifications require additional information such as ion fragmentations  <cit>  or verifications by pure reference compounds. we have further investigated this data set of  <dig>  target formula on the mass dependence of the number of generated formula  and the number of correct top hits , still assuming a  <dig> ppm error in mass accuracy and 5% isotope ratio error. figure  <dig> demonstrates the constraining power of the seven rules at this level of mass spectrometric accuracy. the well-known explosion of chemically possible formulas at higher mass ranges is restricted by around 80% even at  <dig>  da. however, the sole use of the seven rules does not generate unique elemental formulas. up to about  <dig> da, the scoring function alone is sufficient to rank the correct formula at the top without use of database queries with an accuracy of 80%. when querying the large pubchem database, the correct formula is ranked top with an accuracy of about 88% even at extended mass ranges, and when the  target libraries are applied, the correct formula was retrieved as top hit with a 98% rate even at high masses.

 <dig>  example applications of the seven rules
we exemplify a worst case scenario for molecular formula determination from  accurate mass spectrometry data: to annotate the pharmaceutical drug cangrelor comprising eight different elements . even within an error of +/- <dig>  ppm mass accuracy more than  <dig> elemental compositions are possible. more realistic data acquisition errors are, in fact, in the range of  <dig> ppm even with advanced mass spectrometers. for cangrelor,  <dig> ppm mass accuracy would result in  <dig>  molecular formulas to be generated by hr <dig> in  <dig> seconds. the isotope ratio rule alone would exclude  <dig>  elemental compositions if a 5% isotope accuracy could be assumed, marked by a red box in figure  <dig>  a score function which matches the experimentally obtained pattern against all theoretical calculated patterns can be used to further rank sum formulas. if an accuracy of 2% relative standard deviation is assumed, only  <dig> formulas are left when applying all seven rules. the correct formula is the only remaining elemental composition if this rank is queried against the target drug data base . in other cases, investigation of tandem mass spectra would need to be included as further constraint.

next, we have taken actual experimental results to validate the approaches using known compounds. first, gc-time-of-flight ms measurement data were taken for which a mass of  <dig>  was obtained for the + ion of the sugar alcohol sorbitol under chemical ionization  <cit> . the neutralized molecule would thus have an adjusted mass of  <dig>  which results in  <dig> elemental compositions if  <dig> ppm mass accuracy is assumed and the elements c, h, n, o, s, p and si are considered, based on calculation with the mwtwin smart hydrogen option and no restriction on element counts. even if time-of-flight instruments would be improved to empower  <dig> ppm accurate mass acquisitions, still  <dig> formulas would be obtained. for this example, the impact of each of the seven rules was investigated, and results are given in table  <dig>  isotopic pattern were calculated with a modified mercury <dig> version. none of the seven rules alone was efficiently removing wrong elemental compositions but altogether, the set of rules efficiently discarded more than 98% of wrong or unlikely formulas. among the rules, still rule # <dig> testing isotope ratios was most efficient, but rule # <dig>  the senior and lewis check and rule # <dig>  the tms check, also proved to be very powerful by alone rejecting 60% and 62%, respectively. finally the resulting ten formulas were sorted according to their score matching the experimental to calculated isotopic patterns, and the correct formula for sorbitol was ranked as top candidate.

in order to test a high resolution and high accurate mass instrument, a reference compounds was analyzed by ft-icr mass spectrometry under robotic nanoelectrospray ionization conditions, digitoxin . for digitoxin, at  <dig> ppm mass accuracy the seven rules would result still in  <dig> valid elemental formulas, and at  <dig> ppm accuracy, still  <dig> compositions would need to be considered. the experimental mass accuracy for digitoxin was  <dig>  ppm. if isotope errors are lower than 5% relative standard deviation, only  <dig> formulas would remain, with the correct formula ranked at the 7th position. isotopic ratio accuracies for digitoxin were  <dig> %  and  <dig> % . further reduction of likely compounds can be achieved by screening small molecule databases. only two formulas were found when screening the  <dig> possible compositions by the dnp and pubchem databases, with the correct formula c41h64o <dig> having the higher matching score comparing theoretical and measured accurate mass and isotope data. for this formula,  <dig> isomeric compounds would be found in the screened databases.

the anticancer agent paclitaxel ,  was measured on a time-of-flight instrument. assuming a mass accuracy of  <dig> ppm   <dig> possible elemental combinations were obtained. assuming an isotopic pattern error of 3% still  <dig> formulas were retained, ranking the correct one on the 25th score position. the low rank was mainly due to the influence of fluorine, which is a monoisotopic element and has no impact on the orthogonal isotopic pattern filter. when querying pubchem and dnp databases only one out of these  <dig> formulas was found to be known as physically existing compounds, and correctly annotated as c47h51n1o <dig> .

the last experiment to test the applicability of the seven rules aimed at low resolution mass spectra. with only 5% isotope ratio accuracy but even worse mass accuracy  we determined mass spectra for the natural product solanine  using a regular linear ion trap mass spectrometer, which resulted in a measured mass accuracy of  <dig> ppm; however, calculations were performed at the  <dig> ppm mass accuracy level. it is notable that the mass accuracy is still better than unit-mass resolution one would expect from an ion trap instrument. solanine isotope experimental errors were  <dig> %  and  <dig> % % . the program hr <dig> calculated  <dig> possible formulas in three seconds from the neutralized mass spectral data. the seven rules implemented in our excel script reduced these formulas to abundant  <dig> possible candidate compositions assuming a 5% error for isotopic abundances, but after querying pubchem, only twelve hits remained, with the correct formula being ranked top. on a dual-opteron pc  all steps together were performed in  <dig> seconds which is an acceptable time for such computations in practice. when testing the dnp library, only two hits were retained, again ranking solanine first. for this example, the set of seven rules removed more than  <dig> % of the false formula candidates when combined with pubchem and dnp checks and resulted in the correct compound, despite using low accurate mass data.

discussion
the seven rules have generally been developed based on a high cumulative percentage range and this range has ensured that very few existing formulas are rejected as demonstrated by the pubchem validation example. however, our element probability rules have some bias against low mass formulas at the common range  for which the rules are too strict, and on the other hand, certain unreasonable formulas like c23h6o <dig>  are allowed by the script. such senseless formulas need to be sorted out in subsequent steps by scoring the measured isotope ratios or by querying small molecule databases. developing rules for element ratio checks  were biased by the development database itself: the wiley mass spectral database itself was to be unequally distributed. it comprised compounds in the range of  <dig> da –  <dig> da with a maximum at around 400da. hence, more specialized databases might be useful to improve element ratio limits if needed for special applications. for example, the mdl drug data report  database might be better suited for generating rules for studies involving pharmaceutical drugs. nevertheless, even the rules developed on the basis of the wiley and dnp databases turned out to be instrumental as demonstrated by the examination of completely independent pubchem database and specialized examples.

any positive annotation through database queries must be regarded as preliminary hypothesis and not as ultimate identification. even if only one substance is retrieved, data might refer to a potential novel compound, since accurate mass and isotope data alone are too weak to positively confirm an individual compound. instead, further constraints can be added in order to rank formulas according to probability of correct annotations. for example, information on the taxonomy of the species under study may be used. solanine is a defence compound in potato tuber peels , which would specify the annotation not only to a formula but even to a single chemical compound. the same mass spectral data would lead to an antibiotic tylosin derivate if the sample was derived from streptomyces thermotolerans. hence, it is useful to utilize background meta-data and additional unrelated  information such as mass spectral fragmentations, volatility or lipophilicity to constrain formulas and rank probabilities for individual compounds. it will further be important to acquire data on a high numbers of pure compounds in order to assess confidence intervals for mass accuracies and isotope errors for specific mass spectrometers, which may then serve as input for lowering the  <dig> ppm error of mass accuracy and 5% isotope errors that we have taken for calculations in this study. any such limits will also be dependent on ion statistics, hence the abundance of signals.

the seven rules are currently implemented as an automated script within the excel program, which was particularly useful during development. however, several external programs  had to be embedded causing partial redundancies which could have been avoided if programmed in a single java or c++ application. in addition, excel  <dig> or excel xp are incapable of handling more than  <dig>  values in one column which is insufficient for mass ranges larger than  <dig>  da when up to several hundred thousand formulas need to be evaluated. the implemented batch function allows an easy check for several thousand single accurate masses from single chromatograms or mass spectral infusion data, if their relative isotopic abundances are included. the bottleneck for more accelerated computations is checking formulas via comparisons of strings. single compiled files  could speed up calculations using a binary representation of the molecular formula  <cit>  or other faster database search techniques. nevertheless, our current formula search implementation is already fast enough for checking  <dig>  formulas per second using a binary tree search. the internal molecular formula database is needed, because a direct online check of thousands of formulas would require a substantial amount of time if the service is not optimized for such requests. the directly linked chemical structure lookup service   <cit>  has the advantage of covering a large space of constitutional isomers  and links also to all free and most commercial structure databases which are currently not covered in pubchem. for comparison, the proprietary chemical abstracts service  currently has  <dig> million organic and inorganic substances.

we have largely improved the open-source brute-force formula generator hr <dig> to empower an evaluation speed of  <dig> million formulas per second. furthermore, hr <dig> could easily be linked to open source high speed algorithms for the calculation of isotopic mass and abundance patterns, such as those found in reference  <cit> .

there is a tremendous amount of information on small molecules. however, despite the rapid growth of pubchem, most data were inaccessible for the research presented here because such information is traditionally published in copyrighted  journals. so far, this wealth of data is only accumulated in databases by commercial providers such as the chemical abstract service or mdl  due to the associated high costs of database maintenance and curation. our approach might have been even more fruitful if molecules, their molecular formulas, molecular properties, spectral data  <cit> , toxicity data  <cit> , taxonomy of investigated species were freely accessible as meta-information which cold be harvested by software robots  <cit>  without infringing journal copyrights. techniques for storing and handling such data are well known since several years and used in the enhanced open nci database browser  <cit>  and other open-access services. the development of rules for generation of formulas as well as validation efforts would have been even more successful if there were open-access databases of molecular information  <cit>  using the inchi  <cit>  code.

CONCLUSIONS
development and application of the seven rules has demonstrated that mass spectra are most suitable with a low error for isotopic ratios , sufficient resolution  and mass accuracy between 1– <dig> ppm. in fact, mass accuracy was found less important than correct isotope ratio measurements. the most severe remaining bottleneck is validating the initial raw data processing  and subsequent determination of adducts to determine neutralized molecular masses. several algorithms have already been proposed for peak finding, however, further advances on automatic adduct detection must be accomplished  <cit>  in order to cope with the high number of components in complex chromatograms.

the set of seven rules have been shown to correctly annotate accurate mass spectra to elemental compositions for compounds consisting of the elements c, h, n, s, o, p, f, cl and br up to  <dig> da, if results are ranked by queries against databases of known molecular formulas. when specialized target libraries are used , the correct identification rate can be as high as 98%. for novel formulas that are not included in these libraries, the correct elemental composition will be among the top three matches at a probability of 65%. as a rule of thumb, the ranking function alone works well up to  <dig> dalton, but at higher masses a small molecule library is needed for correct annotation. additionally, the seven rules successfully restricted the molecular formula space  from  <dig> billions down to  <dig> million formulas. such a restriction is important for the subsequent database search of corresponding structural isomers  <cit> . specifically, this is the first algorithm that calculates formulas with maximal or mixed valence states of elements such as sulphur or phosphorous. the software scripts and programs, source code and all supplement development data are freely available from the fiehnlab projects site  <cit> .


BACKGROUND
microarray is one of the most successful techniques in the field of functional genomics. as a high throughput approach, it provides a global gene expression profile of a living cell under certain conditions. the affymetrix expression microarray is the most widely-used platform. it uses 11– <dig> probes which have  <dig> oligonucleotide bases, to represent one gene, and as a whole they are called a probe-set. associated with each perfect match  probe, a mis-match  probe that differs only in the middle  base is included in some expression arrays.

from each array, we get fluorescence intensity of each probe after image processing. the estimation of gene expression from probe intensities is a statistical problem where much effort has been made. among them are affymetrix's mas  <dig>   <cit> , li and wong's dchip  <cit> , and rma  <cit> . each method mainly consists of two modules: normalization and summarization. normalization aims to reduce non-biological variations that are introduced during sample preparation, hybridization and instrumental reading. summarization combines normalized signal values in each probe-set and produces a final abundance estimate for the corresponding gene.

normalization requires the specifications of reference and target arrays. we can normalize target arrays against a reference, no matter whether it is a raw microarray or an artificially-defined one. in the invariant-set normalization, which is part of the dchip software, the median intensity of each array is calculated, and the array with the median of these overall medians is chosen as the reference; however, other options are also allowed. the normalization is carried out according to the smooth curve fitted from the rank-invariant intensity set between the reference and target array  <cit> . the quantile normalization in rma uses complete data information and defines a pseudo-reference by the averaged quantiles. the normalization is carried out based on the quantile-quantile transformation  <cit> . in the sub-array normalization, once a reference and a target are given, it divides the whole array into sub-arrays and normalizes probe intensities within each sub-array using least trimmed squares  regression method  <cit> . however, the issue of reference selection has not been well addressed.

in this paper, we propose a probe-treatment-reference  model that takes into account the reference-effect. the method based on this model aims to streamline normalization and summarization by allowing multiple references. instead of one reference array, it uses a reference set to do microarray pre-processing. compared to the two-factor model in  <cit>  and  <cit> , which contains probe- and array-specific effect , we reformulate the array-specific factor by a treatment factor and a reference factor in the ptr model. we estimate the parameters in the model by the least absolute deviations  approach, which is robust in the sense of bounded influence  <cit> .

the proposed ptr method tries to integrate normalization with summarization in a unified framework. it can be applied to several existing normalization methods, and is particularly useful for the sub-array normalization which aims to reduce spatial variation. because the reference-specific effect is adjusted at the probe-set level, implicitly, from the reference set, our model defines an "optimal reference" for each probe-set, which may not come from the same raw array. we show that the fold-change estimates from the ptr method are resistant to a bad reference array. it reduces the variation of non-differentially expressed genes and thereby increases the detection power of differentially expressed genes.

RESULTS
microarray data sets
the affymetrix hg-u133a data set  <cit>  contains triplicates of  <dig> experiments with  <dig> spike-in genes. these spike-in genes are organized into  <dig> gene groups, each of which contains  <dig> genes of the same concentration. the concentrations range from 0– <dig> pm according to a  <dig> ×  <dig> latin square design. in this paper, we analyze experiment  <dig> and  <dig> particularly. experiment  <dig> contains the triplicate: exp03_r <dig>  exp03_r <dig> and exp03_r <dig> ; experiment  <dig> contains the triplicate: exp04_r <dig>  exp04_r <dig> and exp04_r <dig>  the concentrations of  <dig> spike-in genes in experiment  <dig> are two-fold higher; the concentrations of the remaining  <dig> spike-in genes are  <dig> in either experiment  <dig> or  <dig>  later we refer to these six arrays as data set "expt-3-4". besides, we generate a perturbed data set by adding noise to array exp03_r <dig> and keeping the other five arrays unchanged. the noise value is defined by δi = max, where xi is a normally distributed random variable with a zero mean and variance equal to that of the array exp03_r <dig>  we denote this perturbed array by exp03_r1*.

we use another data set, the "golden spike" data set of choe et al. in  <dig>  <cit> , to assess the detection power of differentially expressed genes. the data set contains six affymetrix drosgenome <dig> chips, three replicates for control and three for treatment. a total of  <dig> genes are differentially expressed with pre-defined fold changes from the set, { <dig> ,  <dig> ,  <dig> ,  <dig> ,  <dig> ,  <dig> ,  <dig> ,  <dig> }, between the treatment and control group.

the ptr method
the ptr method provides an integrative view of normalization and summarization. the scheme is shown in figure  <dig>  in what follows, we illustrate it by a typical treatment-control case, in which we have three replicates for control and three for treatment. the first step is the selection of references and their target arrays. we propose two simple and straightforward strategies as follows.

• the all-pairwise strategy: all arrays are included in the reference set; for each reference, all the other arrays are its targets.

• the cross strategy: all arrays are included in the reference set; for each reference from control, we take replicates from treatment as its target arrays; conversely, for each reference from treatment, we take replicates from control as its target arrays.

second, we use existing algorithms such as the invariant-set, sub-array and quantile, to do normalization between each reference and its target arrays. in this paper, we use the function normalize.affybatch.invariantset in the bioconductor's affy package  <cit>  to carry out the invariant-set normalization. we keep the default parameter settings but allow the reference to be selected manually. we use the procedure described in  <cit>  for the sub-array normalization. the window size is  <dig>  the overlapping size is  <dig> and the trimming factor is  <dig>  for the hg-u133a dataset.

we write a new r function for the quantile normalization. the algorithm is not identically the same as the one  <cit>  used in the rma package. that is, we normalize each target array against a raw reference array as follows: sort the reference and the target array respectively in the ascending order; replace the sorted intensity values in each target array with those in the reference array; rearrange intensities in each target array according to their original orders  <cit> .

finally, for each probe-set, we summarize the arrays from log-transformed pm intensities according to the three-factor ptr model:

 log <dig> = global term + treatment effect + probe effect + reference effect + error. 

the model states that the variation of logarithmic probe signal values could be sufficiently explained by treatments, probe affinities and references used in normalization. the global term and treatment effects are taken to be the final transcript abundance estimates; the reference effects and the probe effects could be used for diagnosis.

perturbed data set
because the ptr method uses multiple references and the robust lad estimation, we expect that the expression estimates are resistant to a single bad reference array. in figure  <dig>  we show the m-a plots of the perturbed data set obtained by different combinations of normalization and reference selections. in these m-a plots, m values of all probe-sets are the log-ratios of experiment  <dig> versus experiment  <dig> and a values are the average log-intensities of the two experiments.

the top, middle, and bottom row show the results from the invariant-set, quantile, and sub-array normalization respectively. in a1-b1-c <dig>  we take the perturbed array exp03_r1* as the reference; in a2-c <dig>  we take the array exp03_r <dig> as the reference, while in b <dig>  we take the average quantiles as the pseudo-reference; in a3-b3-c <dig>  we simply use the ptr method coupled with the reference set of all six arrays. we see that the invariant-set is more sensitive to the perturbed reference array exp03_r1*  and it performs well if an appropriate reference is selected . the quantile method shows a similar but less severe phenomenon when the quantile-quantile transformation is based on the array exp03_r1*. in contrast, the quantile normalization using average quantiles as the pseudo-reference is more resistant to this perturbation. for the sub-array normalization, the perturbation does not affect the ratio estimates, since the normalization transformations are done in each sub-window which greatly reduces the effects of this global noise.

the ptr method improves the performance of all three normalization algorithms. we see that the log-ratios of spike-in genes are closer to the expected log-ratio value m =  <dig>  and non-spike-in genes have smaller variations along m =  <dig>  the ptr method deals with the single perturbed reference array exp03_r1* well, and it estimates the final transcript abundance robustly.

variation reduction by the ptr method
it is shown that the ptr method achieves smaller variances for the non-spike-in genes in the m-a plots of the perturbed data set. to further measure the effectiveness of the ptr method in variation reduction, we compare it with other pre-processing methods using "expt-3-4" data set. the non-spike-in genes are expected to have the same expression in both experiment  <dig> and  <dig>  and the differences between them are due to the non-biological factors. we pre-process six arrays with different methods of normalization and summarization and estimate the expression values for both experiment  <dig> and  <dig>  in the m-a plots, we fit loess curves  <cit>  to the absolute values of m against a using non-spike-in genes only. the curves shown in figure  <dig> measure the variations of non-spike-in genes between two experiments. the left, middle, and right plot respectively show the results from the invariant-set, quantile, and sub-array normalization method. except for the ptr method, we summarize the normalized results using the expresso function in the affy package  <cit> , with either the li-wong's mbei  <cit>  or the rma's median polish  <cit>  method. from the plots, we see that the ptr method achieves the smallest variations for each normalization algorithm. in the left plot, we use the invariant-set normalization for both the ptr method and the other single-reference methods. the plot shows that the same pre-processing method results in different variation curves with different reference choices. the ptr method reduces the background noise significantly.

in the middle plot, we use the quantile normalization, taking each raw array as well as the average quantiles to be the reference. the plot shows substantial improvement by the ptr method, while the quantile normalization achieves a moderate performance using the average quantiles as the pseudo-reference. the ptr method provides an alternative to use the complete data information.

in the right plot of figure  <dig>  we use the sub-array normalization, and once again the ptr method improves the performance. furthermore, the curves from the single reference results can be clustered into two categories. each reference array from experiment  <dig> performs better at the low-intensity range but worse in the high-intensity range; whereas each from experiment  <dig> performs slightly better in the high-intensity range but worse in the low-intensity range. a similar yet less prominent pattern also exists in the results using the invariant-set and quantile normalization. replicates within either experiment  <dig> or  <dig> are similar, but arrays from two experiments lead to more different results. the ptr method takes reference arrays from both experiments, combines two types of expression results and gives the smallest variation in both low- and high-intensity ranges.

the loess assessment has demonstrated that the ptr method can reduce the variation significantly for the invariant-set, quantile and sub-array normalization method. this variation reduction, especially in the low-intensity range, is particularly valuable in the measurement of gene expressions.

improvement on detection of differentially expressed genes
in order to ensure that the detection of differentially expressed genes is not sacrificed at the effort of variation reduction by the ptr method in expression analysis, we compute the receiver operating characteristic  curves  <cit>  for the hg-u133a data set. we conduct two comparative studies on this data set. in the first study, we compare every two experiments which are next to each other in the latin square design. each pair of experiments have  <dig> spike-in genes with 2-fold change. in the second study, we compare every two experiments which are separated by one and exactly one experiment. each pair of experiments have  <dig> spike-in genes with 4-fold change. in total, we have  <dig> pairs of experiments in each study. the curves computed by the roc package from bioconductor  <cit>  are shown at the top of figure  <dig>  we compare the ptr method with various pre-processing combinations in the expresso function of the affy package  <cit> , which includes: invariant-set normalization plus li-wong's mbei or rma's median polish summarization; quantile normalization plus rma's median polish summarization with or without rma's background correction. we see that the ptr method does equally well with both the quantile and invariant-set normalization algorithm in this data set. the ptr method gives the best performance in the detection of the differentially expressed genes.

in addition, we make the similar comparisons on the "golden spike" data set. we set the differentially expressed genes using fold change threshold to  <dig>  or  <dig> . the roc curves are shown at the bottom of the figure  <dig>  we can see that the ptr method performs better with the invariant-set normalization than the quantile normalization. however, both of them outperform the other pre-processing methods.

the assessment on both data sets demonstrates the higher specificity and sensitivity achieved by the ptr method. the noise reduction improves the detection of deferentially expressed genes.

implicit reference selection in the ptr model-fitting
instead of selecting a single reference, we adjust for the reference effect of each probe-set by the ptr model. the final transcript abundances are obtained from normalized arrays using multiple references. in what follows we look in details how the three-factor model deals with the reference issue. on the one hand, we directly estimate the effect of each reference used in normalization at the probe-set level. it is interesting to consider the estimates of the reference-specific effect of all probe-sets after the summarization. in the box plots of figure  <dig>  we show the distributions of six reference effects in the perturbed data set. the variations of the reference-specific effect are quite small in the five unperturbed references compared to the perturbed exp03_r1* reference, which shows an abnormal pattern. this abnormal variation in the reference effect means that the transformation relations based on reference exp03_r1* are more different across all the probe-sets and indicates its relative worse status.

on the other hand, the three-factor ptr model provides better fit than the two-factor pa model in term of smaller residual deviations. we can categorize residuals according to their reference indices, and calculate the sum of absolute deviations  for each residual category. in a sense, the reference that achieves the minimum sae is the "implicit optimal reference" selected by the model-fitting. in figure  <dig>  we show the frequency of the "implicit" references across all the probe-sets selected from the pre-processing of the data set "expt-3-4". the three arrays in experiment  <dig> are selected more than those in experiment  <dig>  it is consistent with the results from variation  curve assessment which demonstrates that each single array from experiment  <dig> outperforms every single array from experiment  <dig>  the results shown in figure  <dig> and  <dig> are obtained by the ptr method coupled with the invariant-set normalization, and the same phenomenon is also observed using the other normalization methods.

discussion
we explicitly address the reference issue in pre-processing expression microarray and propose the ptr method to carry out normalization and summarization jointly. the ptr method can be applied to existing normalization methods such as the invariant-set, sub-array, and quantile. particularly, it is the first time we propose a practical scheme to implement the sub-array normalization. the sub-array takes into account the spatial pattern of hybridization, and can properly normalize the majority of probe intensities even in the presence of scratches or serious non-homogeneous hybridization. the ptr method enhances this ability using multiple references in normalization and implicitly selecting an "optimal reference" for each probe-set during summarization. in general, the ptr method is applicable to pre-processing biological measurements from array-type instruments such as exon arrays, beads arrays, pathway arrays, tissue arrays and other customized arrays.

the proposed ptr method primarily aims to measure expressions by affymetrix chips with technical replicates as in many designed microarray experiments. in the normalization step, the sample information is not required although the processing involves multiple pairwise comparisons. in the summarization step, the sample information is necessary for estimating expression differentiation. in some situations, especially the class discovery and class prediction in the cancer study, no technical replicates are available for each sample. to apply the ptr method, we need to assign different treatment labels to different samples that are not replicates in any sense. in this case, one microarray has served as two functional parts: array- and reference-specific effect. for now we could not rule out the possibility of partial confounding of array- and reference-specific effect in general. but we argue that, according to our scheme, normalization is carried out by pooling all probe-sets while summarization is carried out for each probe-set separately.

consequently, we expect that the reference-specific parameter in each probe-set reflects reference array's block effect in the present of other probe-sets. the association between array- and reference-specific effect should not be significant. it is particular true in the randomized designed affymetrix chips.

we have not discussed the background correction issue, but the existing background correction methods can be implemented before the normalization step of the ptr method. interestingly, we have shown that the ptr method reduces the variation of non-differentially expressed genes, especially in the low intensity range. as a consequence, we improve the signal-to-noise ratio and increase the detection power of the deferentially expressed genes. the improvement is achieved without any additional information.

we include all arrays in the reference set and use the cross strategy to select the corresponding target arrays for the data set in this paper. we are aware that they may not be the optimal strategy for reference and target selection. however, the ptr method can protect against and detect abnormal arrays. first, by using the robust lad method in the summarization, we can accurately estimate the transcript abundance as long as the majority of normalization results are right. second, we can evaluate the array quality by the reference effect distribution, as shown in figure  <dig>  the array showing distinct distribution from other arrays is likely to be a bad candidate for reference and may be excluded from the reference set in the next-round ptr processing.

the computational complexity of the ptr method can be decomposed into two parts: normalization and summarization. in an experiment with n arrays, at most we need to carry out n pairwise normalization. thus the complexity is approximately n times of that of single-reference normalization. the median polishing algorithm used in the summarization is an iterative procedure. compared to the algorithm used in rma, the median polishing in the ptr is three-way instead of two-way with approximately n times the memory. according to our experience, it does not need substantially more iterations to achieve the same accuracy.

the current implementation of the ptr method needs the r running environment for data input/output and visualization. the normalization part could be carried out by c++ or r depending on the selection of normalization methods. the core computation of the ptr summarization is written in c++ and is called by an r interface. take the "expt-3-4" for example, if we use the all-pairwise reference selection strategy, the normalization procedure costs about  <dig> minutes for the quantile algorithm and  <dig> minutes for the invariant-set algorithm in a computer with intel pentium  <dig>  ghz and  <dig> gb of ram. the summarization part takes about  <dig> minutes on the same machine. due to the specification of memory allocation in r, our current implementation can process a data set up to total  <dig> arrays in about one hour on the same machine mentioned above. this capability can be expanded if we code the ptr method entirely in c/c++. for a large dataset, we need to adopt algorithms that allocate memory more efficiently. we are now working along this direction to improve the implementation of the ptr method. we also notice that the examples we have examined in the article involve at most three replicates per treatment group. in the case of more samples per treatment group such as  <dig> or  <dig>  the reference selection may not be a serious issue due to the large sample size. the performance of the ptr method is unclear and the rma method is a safer choice.

CONCLUSIONS
we propose the probe-treatment-reference  model to deal with the reference-specific effect. the ptr method streamlines normalization and summarization by allowing multiple references in normalization. it can readily be applied to existing reference-dependent normalization methods. we evaluate the effectiveness of the ptr method on two affymetrix spike-in data sets. the method reduces the variations of non-differentially expressed genes whereas increases the detection power of the differentially expressed genes.


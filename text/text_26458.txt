BACKGROUND
empirical studies on the evolutionary history of sequences from multiple loci show strong evidence of incongruent gene trees across loci  <cit> . such incongruence challenges the appropriateness of traditional methods for estimating phylogenies, such as supermatrix approaches, which are based on the assumption that all loci have the same gene tree  <cit> . several methods have been developed to accommodate the variability among gene trees when estimating species trees  <cit> . consensus tree methods are commonly used to summarize a collection of gene trees  <cit>  and can be easily adapted for the purpose of estimating species trees. other approaches for combining multiple gene trees include supertree  <cit>  and reconciliation  <cit>  methods, which may capture important biological details through parameters without modelling it explicitly  <cit> . we here focus on species tree reconstruction methods developed in the context of the multispecies coalescent model  <cit> , which assumes that gene trees are generated from the coalescent processes occurring in each branch of a species tree.

the relationship between gene coalescence times and species divergence times under the multispecies coalescent model has motivated several approaches for estimating species trees based on summary statistics of gene coalescence times  <cit> . although the likelihood function of the species tree under the multispecies coalescent model has already been derived by rannala and yang  <cit> , research on the maximum likelihood  estimation of species trees under the coalescent remains limited  <cit> . under a simplified multispecies coalescent model in which population sizes are assumed constant across populations, liu et al.  <cit>  have shown that the maximum tree, a species tree with the largest possible branch lengths under the constraint that gene coalescence times across loci always predate species divergence times, is the maximum likelihood estimate  of the species tree.

previous studies have demonstrated, empirically and theoretically, strong evidence that species trees and gene trees should be considered as distinct quantities that describe two closely related evolutionary processes. a species tree represents the evolutionary pathway of species-usually the relevant goal in phylogenetic studies  <cit>  - while a gene tree represents the evolutionary history of a single gene. this insight on the relationship between gene trees and the species tree provides a biological foundation for building probabilistic models to estimate species trees from gene trees. in the multispecies coalescence model  <cit> , a gene tree is viewed as a coalescence process of genealogical lineages along branches in the species tree. specifically, rannala and yang  <cit>  showed that the probability distribution of the topology of gene tree k and the  coalescent time intervals tiknik+ <dig> ...,tikmik for population i reduced from mik to nik sampled lineages along a branch of length τi in the species tree is

  exp{−nikθi}×∏j=nik+1mik{2θiexpθitikj)}, 

where θi = 4αiμ and τi = μβi; μ is the number of mutations per site per generation, αi is the effective population size of population i, and βi is the number of generations that population i extended over history. the second term  in  is the probability of  coalescent time intervals  and the first term is the probability that nik genealogical lineages do not coalesce in population i. for a collection of gene trees g that are independent of each other given the species tree, we multiply  across gene trees to find the likelihood for population i  <cit> ,

  ∏k=1m{expθi)∏j=nik+1mik{2θiexpθitikj)}} 

in which m is the number of genes. the probability density function f of gene trees g given the species tree s is the product of  across all populations . the likelihood for population i in  can be simplified as

  aie−bi/θi 

where

  bi=∑k=1m{nik+∑j=nik+1mik{jtikj}} and ai=∑k=1m. 

here coalescence time intervals tikj s are fixed because gene trees g are given. in addition, bi is bounded because the branch length τi in the species tree is restricted due to the assumption that gene coalescence times always predate species divergence times.

we next show that the mle of the species tree  under the likelihood function f we just described does not exist. given a set of gene trees g, the mle of the species tree is obtained by maximizing the likelihood function f with respect to the topology, branch lengths, and population sizes of the species tree. consider an ancestral population Δ in which two lineages in a gene tree coalesce . let c denote this coalescence event . if multiple coalescence events involve in population Δ, c represents the first coalescence event occurring in population Δ let the branch length τΔ of population Δ go to zero while keeping the coalescence c within the population , then we have aΔ =  <dig> and bΔ →  <dig>  let θΔ= b, which implies θΔ →  <dig>  the likelihood of population Δ in  then becomes e- <dig> which goes to infinity as θΔ  <dig>  moreover, if we fix the population sizes for the populations other than Δ in the species tree, it follows from  that when the population size θi is fixed, the likelihood of population i is always greater than a positive number, because bi in  is bounded. thus the likelihoods of the populations other than Δ are always greater than a positive number. since the likelihood of the species tree f is the product of the likelihoods for single populations, it goes to infinity as the likelihood of population Δ goes to infinity, while at the same time the likelihoods for other populations are always greater than a positive number. note that for any gene trees we can always find an ancestral population Δ in a species tree such that the likelihood of the species tree goes to infinity as θΔ →  <dig>  bΔ →  <dig>  and θΔ = bΔ. the likelihood of the species tree is maximized . a) the species tree  has three ancestral populations. the ancestral population ap <dig> at the root of the tree is the common ancestral population of species a, b, c, and d. two internal branches with length τ <dig> and τΔ in the species tree represent the ancestral populations ap <dig> and Δ. population ap <dig> is the common ancestral population of species a and b, while Δ is the common ancestral population of species c and d. each population has a population size θ and branch length τ. the purple lines represent a gene tree, the evolutionary history of sequences sampled from species a, b, c, and d. the red arrow indicates the coalescence of the two sequences sampled from species c and d. the corresponding coalescence time interval is t, which decreases to  <dig> as branch length τΔ decreases to  <dig> in the direction indicated by the two blue arrows. b) the likelihood of the species tree given three gene trees. the species tree and three gene trees are ultrametric trees. the number on each branch represents the branch length. in the species tree, w is the length of the internal branch and y = x+w, θ <dig> is the population size for the root population, and θ <dig> is the population size for the ancestral population of species a and b.

as an example, we calculate the likelihood scores of species trees for three fixed gene trees : <dig> , c: <dig> ), : <dig> , b: <dig> ), and : <dig> , c: <dig> ) . the species tree is :w, c:y) where x is the divergence time of species a and b and y is the height of the species tree. note that y = x+w because the species tree is ultrametric . branch lengths in the species tree and gene trees are in mutation units. let θ <dig> be the population size of the root population and θ <dig> be the population size on the branch with length w in the species tree. due to the constraint that gene coalescence times should be strictly larger than species divergence times, we have x <  <dig>  and y <  <dig> . let  <dig>  <y <  <dig> . the likelihood of the species tree is

θ2×2θ1e−2θ1)︷gene tree   1×θ1×2θ1e−2θ1)︷gene tree   2×θ1×2θ1e−2θ1)︷gene tree   3=2θ2e−2θ2×32θ15e− <dig> −14yθ1

the second part of the likelihood, 32θ15e− <dig> −14yθ <dig>  is bounded because y <  <dig> . the first part of the likelihood, 2θ2e−2θ <dig>  goes to infinity as x increases towards  <dig>   and w decreases towards  <dig>  while θ <dig> =  <dig> -x + 2w. note that  <dig> -x+2w > <dig> because x <  <dig>  and w >  <dig>  thus we can set θ <dig> =  <dig> -x + 2w . the likelihood approaches to infinity at θ <dig> =  <dig>  but because population size θ <dig> must be strictly positive, the mle of the species tree for the three gene trees does not exist. moreover, for a species tree of an arbitrary size, we can always find a rooted triple in the species tree such that the likelihood of the population indicated by the internal branch in the triple goes to infinity as the length  of the internal branch decreases to  <dig> and species divergence time  approaches to the minimum gene coalescence time  and thus the mle of the species tree under the likelihood function f does not exist. for this reason, we develop a pseudo-likelihood approach for estimating species trees from gene tree topologies. as we describe below, our method delivers mles for species trees, yet it is a pseudo-likelihood approach because the likelihoods of different rooted triples in the gene trees are not independent of one another. nonetheless, we show that this method yields robust results that account for gene tree heterogeneity.

methods
the arguments in the previous section imply that the rannala and yang formula f can go to infinity as we change the values of branch length τ and population size θ. to overcome this problem, the species tree s is reparameterized such that branch lengths are measured in coalescent units, t = 2τ/θ  <cit> . for the rest of this paper, branch lengths in the species tree are in coalescent units unless otherwise noted. we here develop a pseudo-likelihood to estimate the reparameterized species tree s* using topologies of gene trees. since this method involves only topologies of gene trees, the term gene tree will be used to refer to the topology of the gene tree  unless otherwise noted. the construction of the pseudo-likelihood is based on the fact that a species tree is characterized by a set of rooted triples for all subsets of three taxa  <cit> . thus, estimating species tree s* is equivalent to estimating the set of rooted triples derived from s*. it motivates the rooted triple consensus method, an approach that utilizes rooted triples in gene trees to estimate the topology of the species tree  <cit> . following the suggestion of degnan et al.  <cit> , we develop a pseudo-likelihood approach to estimate the species tree s*, including the topology and branch lengths, from a set of gene trees.

throughout we assume that the species tree and gene trees are rooted trees. it is also assumed that the topologies of gene trees are known without error, although we show how to incorporate uncertainty in gene tree estimation into the estimate of the species tree. we assume that a single lineage is sampled from each species, as is common in phylogenetic studies  <cit> . since coalescence occurs for at least two lineages in a population in the species tree, the lengths of the external branches  in the species tree are not estimable for the case of single lineage per species. missing lineages in some gene trees are allowed if lineages are missing randomly, but a lot of missing lineages may dramatically reduce the performance of the pseudo-likelihood approach. for simplicity, we assume no missing lineages in gene trees. the theory developed in this paper can be easily extended to the cases where lineages in gene trees are missing randomly.

pseudo-likelihood of the specie tree
let n be the number of taxa and {ti, i =  <dig> ...,} be the lengths of internal branches in the species tree. an n-taxon species tree contains  rooted triples. for example, a four-taxon species tree contains = <dig> rooted triples . let {rtjs*,j= <dig> ...,}be the set of rooted triples in an n-taxon species tree s*. we use ab|c to denote the triple in which a and b are grouped . each triple has an internal branch with length bj which is the sum of one or several internal branches in the species tree. in figure 2a, the lengths of internal branches in the four triples are b <dig> = t <dig>  b <dig> = t <dig> +t <dig>  b <dig> = b <dig> = t <dig>  length t <dig> is involved in triples ab|c and ab|d, while t <dig> is involved in triples ac|d and bc|d. in general, an internal branch in the species tree is involved in several rooted triples in the species tree. consider an arbitrary rooted triple rtjs*= ab|c in the species tree and the length of the internal branch of rtjs* is bj. let a, b, and c be the alleles sampled from species a, b, and c. under coalescent, the probability that triple ab|c occurs in a gene tree randomly generated from species tree s* is 1−e−bj, whereas the probability is e−bj for triple ac|b or bc|a  <cit> . it indicates that the length bj of the internal branch of a species tree triple ab|c can be estimated by the proportion of gene trees containing triple ab|c. when the proportions of gene trees containing triples ab|c, ac|b, and bc|a are all equal to 1/ <dig>  it implies that the length of the internal branch of triple ab|c in the species tree is  <dig>  thus the method we develop here can be used to estimate trifurcations and polytomies in the species tree. let xj <dig>  xj <dig>  and xj <dig> be the counts of triples ab|c, ac|b, bc|a occurring in gene trees. it follows that xj <dig>  xj <dig>  and xj <dig> have a multinomial distribution

  f=m!xj1!xj2!xj3!e−bj)xj1e−bj)xj2e−bj)xj <dig> 

where m is the sum of xj <dig>  xj <dig>  and xj <dig>  note that m is equal to the number of genes  for all j. the mle of rtjs* under  is the most frequent triple among ab|c, ac|b, and bc|a occurring in gene trees with the length of the internal branch

  b^j=−log{3×/2} for x≠m. 

here x is the count of the most frequent triple among ab|c, ac|b, and bc|a occurring in gene trees. note that x >m/ <dig> and thus b^j is positive. because the proportion x/m in  converges to its expectation 1−e−bj, the mle b^j converges to the true length bj in probability, i.e.,

  b^j=−log{3×/2}→pbj, 

as m goes to infinity. this indicates that the frequencies of triples in gene trees can be used to consistently estimate both topologies and internal branch lengths  of triples in the species tree. the joint probability distribution of triples in the species tree is approximated by the product of marginal probabilities   <cit> . although the approximation ignores the correlation structure among interrelated triples in gene trees  when estimating species trees, the pseudo-likelihood has computational advantages as the joint probability distribution of triples is difficult to calculate and the mle under the full likelihood function  does not exist. in addition, we can show  that the estimate of the species tree obtained by maximizing the pseudo-likelihood is statistically consistent. the pseudo-likelihood of species tree s* given gene trees g is defined as the product of the multinomial distributions in  across all triples in the species tree:

  l=w×∏j=1{e−bj)xj1e−bj)xj2e−bj)xj3} 

where w=∏j=1{m!xj1!xj2!xj3!}, bj is the length of the internal branch of triple j in the species tree, and xj <dig>  xj <dig>  and xj <dig> are the frequencies of three types of triples in gene trees. the estimate of the species tree, including topology and internal branch lengths, is obtained by maximizing the pseudo-likelihood l. since w is a function of x and has no effect on the procedure of maximizing l, it can be ignored from the likelihood function l. we employ a heuristic search technique; nearest-neighbor interchanges , to find the maximum pseudo-likelihood estimate  of the species tree. we call this method maximum pseudo-likelihood for estimating species trees, or mp-est. when n =  <dig>   becomes  and the mp-est tree is the most frequent gene tree triple with an internal branch of length described in . note that the length bj of the internal branch of triple j in the species tree is the sum of one or several internal branch lengths {ti, i =  <dig> ...,} in the species tree. because the length ti of internal branch i in the species tree involves in many species tree triples, it is estimated by the combination of the frequencies of the gene tree triples corresponding to the species tree triples that involve ti. equation  implies that the estimate b^j of the length of the internal branch in the species tree triple rtjs* increases to infinity as the proportion x/m of the most frequent gene tree triple approaches to  <dig>  thus the length of an internal branch in the species tree is not estimable if all relevant triples in gene trees support the same topology. in this case, we assign "99" as the length of the branch to indicate that this branch length is not estimable.

as an example, we calculate the pseudo-likelihood for a four-taxon species tree with a fixed topology and two internal branches of lengths t <dig> and t <dig> . there are four rooted triples for this four-taxon species tree. let b <dig>  b <dig>  b <dig>  and b <dig> be the lengths of internal branches in triples ab|c, ab|d, cd|a, cd|b. it follows that b <dig> = b <dig> = t <dig> and b <dig> = b <dig> = t <dig>  suppose that the dataset contains three gene trees . to calculate the pseudo-likelihood in , we need to count the numbers of gene tree triples corresponding to each of the four species tree triples. there are  <dig> ab|c triples,  <dig> ac|b triple, and  <dig> cb|a triple in gene trees corresponding to triple ab|c in the species tree. the likelihood of triple ab|c with internal branch length b <dig> = t <dig> in  is

 e−t1)2e−t1)1e−t1) <dig>  

similarly, we can calculate the likelihoods of the other three triples in the species tree.

the pseudo-likelihood of the species tree for this dataset is equal to

 e−t1)2e−t1)1e−t1)0︷triple   ab|c×e−)2e−)1e−)0︷triple   ab|d×e−t2)1e−t2)2e−t2)0︸triple  cd|a×e−t2)1e−t2)1e−t2)1︸triple  cd|b 

the estimates of the lengths of internal branches in the species tree are obtained by maximizing the pseudo-likelihood with respect to t <dig> and t <dig>  note that t <dig> involves in the likelihoods of two triples ab|c, ab|d, while t <dig> involves in the likelihoods of cd|a and cd|b. thus t <dig> is estimated by the frequencies of gene tree triples corresponding to the species tree triples ab|c and ab|d and t <dig> is estimated by the frequencies of gene tree triples corresponding to the species tree triples cd|a and cd|b. due to the simplicity of this example, we can explicitly derive the estimates of t <dig> and t <dig> 

 t^1=−log{322k)}=−log{326)}= <dig> t^2=−log{322k)}=−log{326)}= <dig> 

where y <dig>  y <dig>  y <dig> and y <dig> are the counts of gene tree triples ab|c and ab|d, cd|a, and cd|b. the estimate of t <dig> is  <dig> because the proportions of gene tree triples cd|a and cd|b matching the species tree triples cd|a and cd|b are equal to 1/ <dig>  the log-likelihood of the species tree with t <dig> =  <dig>  and t <dig> =  <dig> is - <dig> . there are  <dig> possible topologies for a four-taxon species tree. similarly, we can calculate the log-likelihoods for the other  <dig> topologies and choose the one with the maximum log-likelihood score as the estimate of the species tree .

statistical consistency
we use Φ to denote the pseudo-likelihood of a species tree s* in  without w because w has no effect on the procedure of maximizing l.

  Φ=∏j=1{e−bj)xj1e−bj)xj2e−bj)xj3} 

the mpe of the species tree is s^*=argmaxs*{Φ}. it follows from the strong law of large numbers  <cit>  that as the number of genes m increases to infinity, the proportions of triples in gene trees converge to their expectations almost surely,

  {xj1m,  xj2m,  xj3m}→a.s{ e−wj),  e−wj),  e−wj) } for j= <dig> ...,. 

where wj is the length of the internal branch of triple j in the true species tree st. thus as m → ∞, Φ  converges to function h almost surely,

  Η=∏j=1{ e−bj)me−wj)e−bj)me−wje−bj)me−wj} 

because Φ  and h are bounded continuous functions  <  <dig> and 0< h < 1). in addition, the function h is maximized when bj = wj for all j, i.e., st=argmaxs*{Η}. thus as m → ∞, the mpe s^* converges to the true species tree st in probability, i.e.,

  s^*→pst, 

which shows that the mp-est method is statistically consistent in estimating species trees  as the number of genes increases.

we next derive the rate at which the probability p{s^*=topst} that the mpe s^* is topologically identical to the true species tree st converges to  <dig>  equations , , and  imply that the mpe s^* matches the true species tree st in topology if all the differences between the proportions of the most frequent gene tree triples and their expectations are very small, i.e.,

  |xj1m− e−wj)| <ε for j= <dig> ...,, 

where ε is a small positive real number determined by the true species tree st. thus,

  p{s^*=topst}>p>1−∑j=1p{ | xj1m−e−wj) |≥ε}>1−∑j=1varε2=1−∑j=1e−wj×e−wj)mε2>1−4mε <dig> 

this shows that the probability of s^* matching the true species tree st converges to  <dig> at o.

robustness to horizontal gene transfer 
consider an arbitrary triple ab|c in the species tree and the length of the internal branch is bj. under coalescent, the probability that a triple in the gene trees generated from the species tree topologically agrees with triple ab|c is 1−e−bj. although hgt events may occur between species a and b, species a and c, or species b and c, we here only consider the hgt events between species a and c, or b and c because these events can change the probability of observing a matching triple in gene trees and may thus result in a biased mp-est estimate of the species tree. suppose that the rate of horizontal gene transfer λ is homogeneous per gene per generation between extant species a and c  in triple ab|c . we assume that the probability distribution of the number of hgt events occurring between two species is a poisson distribution with mean λl where l is the divergence time  of two species. the probability that hgt events occur between species a and c or species b and c is 1-e-2λl . adding hgt events in the coalescent model, the probability of observing triple ab|c in gene trees becomes

  1−e−bj−=e−2λl−e−bj. 

it follows that the proportion of gene trees containing triple ab|c converges to the quantity specified in  and the mp-est estimate b^j of the length of the internal branch in triple ab|c does not converge to the true length bj when the rate λ of hgt is not  <dig>  it implies that some estimates t^is of the lengths of internal branches in the species tree do not converge to the true lengths ti s. otherwise if all estimated lengths t^is converge to the true lengths ti s, then all b^js will converge to bj s , which contradicts the previous conclusion that the mp-est estimate b^j of the length of the internal branch in triple ab|c does not converge to the true length bj. inconsistency of the mp-est estimates t^is of the lengths of internal branches in the species tree is due to the hgt events occurring among species a, b, and c. because an internal branch in the species tree is estimated by the combination of the proportions of the gene tree triples corresponding to the species tree triples that involve this branch, the effect of the biased proportion of gene tree triples  on the estimation of branch lengths is alleviated by the proportions of other gene tree triples that are not affected by hgt, especially when hgt events only occur in a small group of species.

although hgt events can result in biased estimates of the lengths of internal branches in the species tree, the topology of the species tree may still be consistently estimated when λ is small. previously, we have shown that the topology of the species tree can be consistently estimated if the conditions in  hold for some large m. thus we want to find a large m so that

   |xj1/m−e−wj)| <ε, 

where xj <dig> is the count of the most frequent gene tree triple. we know that the proportion xj1/m converges to e−2λl−e−bj ) when hgt occurs at rate λ. it implies that for any δ >  <dig>  there exists a large m such that |xj1/m−e−wj)+1−e−2λl| <δ, i.e., |xj1/m−e−wj) | <δ+1−e−2λl. thus  holds if 1-e-2λl < ε because α becomes very small and negligible when m is large. we conclude that  holds if λ <−log2l. it shows that if the rate  of horizontal gene transfer is smaller than −log2l, the mp-est method is still statistically consistent in estimating the topology of the species tree.

estimating species trees from multilocus sequences
the proof for the consistency of the mp-est method is based on the assumption that gene trees are known without error. in fact, gene trees are usually unknown and must be estimated from multilocus sequences. under general conditions, the ml gene tree g^ estimated from sequence data is a consistent estimator of the true gene tree g  <cit> . thus the mpe of the species tree s˜* based on the estimated gene tree is a consistent estimator of the species tree s*. the procedure of estimating species trees from multilocus sequences includes two steps; gene trees are first independently estimated from mutlilocus sequences using the ml method  <cit>  or any other method that is consistent, and rooted by an outgroup . although gene trees can be rooted by multiple outgroups, it requires that the outgroup sequences must form a monophyletic clade consistently in all gene trees, which rarely occurs in reality. thus when the appropriate outgroup includes multiple species and is comprised of a monophyletic group, then one must drop some sequences in order to estimate gene trees with a single sequence as the outgroup. however, multiple outgroups can be accommodated partially if they do not comprise a monophyletic group. in this case a single outgroup sequence is again used, and the additional outgroups are estimated as if they were part of the ingroup. multiple species cannot simultaneously be designated as outgroups  using mp-est.

the rooted gene trees are then used to construct the mp-est tree as the estimate of the species tree. although ml gene trees are usually binary trees, there may be some cases in which some internal nodes and relevant rooted triples in gene trees are unresolved . for an unresolved triple  in gene trees, we assign 1/ <dig> to each of the three possible topologies ab|c, ac|b, and bc|a. the estimation error in gene trees can be incorporated into the analysis using bootstrapping techniques  <cit> . specifically, columns  in the aligned sequences are resampled with replacement for each gene sampled  from the multilocus dataset  <cit> . the mp-est trees constructed for the bootstrapped samples are summarized by a consensus tree.

RESULTS
simulation
to evaluate the performance of mp-est, we simulated  <dig> ten-taxon species trees from a birth and death process with birth rate of  <dig> and death rate of  <dig>  from the phylogenetic program mesquite  <cit> . the population sizes  in the species tree were generated from a uniform distribution . branch lengths in the  <dig> species trees vary in the range of  <dig>  and  <dig> . to convert it to coalescent units, the branch length must be divided by the population size θ. gene trees were generated from the ten species trees using the phylogenetic program phybase  <cit>  and then used as data to estimate species trees by mp-est, star  <cit> , and rooted triple consensus   <cit> . we repeated the simulation  <dig> times. the performance of each method was evaluated based on the proportion of trials yielding the true species trees. we also evaluated the mean square error   <cit>  of the branch length between the true species tree and the mp-est estimate of the species tree. when calculating the mse of the branch length, we discarded the branches with length "99" because the lengths of these branches are not estimable.

the results  suggest that as the number of genes increases, the proportion of trials in which mp-est has successfully recovered the true species trees increases to  <dig>  and the mse of the branch length  appears to decrease to  <dig>  indicating that mp-est is statistically consistent in estimating the species trees  generated in the simulation. the results for star and rt show the same pattern that as the number of genes increases, the proportions of trials yielding the true species tree for both methods increase to  <dig>  overall, star performs slightly better than the other two methods, while mp-est and rt have the similar performance in recovering the true species tree . a low proportion in figure 4a does not necessarily imply a large topological difference between the true species tree and the tree estimated by a species tree reconstruction method. for example, the proportion of the mp-est trees matching the true species tree is  <dig>  for the case of  <dig> genes , but across all replicates the average robinson and foulds  topological distance  <cit>  between the mp-est tree and the true species tree is  <dig> , indicating that on average only one or two internodes  are not successfully recovered.

in the second simulation, we investigate the performance of mp-est, star, and rt in estimating species trees in the anomaly zone. the anomaly zone is a region of species tree space, one with very short branches in the species tree, in which the most common gene tree is different from the species tree  <cit> . one would not expect estimation of species trees in this case to be straightforward. gene trees were simulated from an anomalous species tree : <dig> , c: <dig> ): <dig> , d: <dig> ): <dig>  e: <dig> ) . the most probable gene tree has the topology ,),e) and the rf distance between the true species tree and the most probable gene tree is  <dig>  the generated gene trees were then used as data to infer the species tree using mp-est, star, and rt. the simulation was repeated  <dig> times and we calculated the proportion of trials yielding the true species tree for each species tree reconstruction method. we also calculated the mse of the branch length between the mp-est tree and the true species tree. the result for the mp-est method shows that the proportion of trials yielding the true species tree increases to  <dig>  while the mse of the branch length appears to decrease to  <dig>  as the number of genes increases . this confirms that mp-est can consistently estimate the true species tree even in the anomaly zone, as expected from the theory we developed above. similarly, the proportions of the star and rt trees matching the true species tree approach  <dig> as the number of genes increases. in this simulation, mp-est appears to outperform star and rt at  <dig> and  <dig> genes . in addition, the result suggests that all three methods require a large number of genes to accurately estimate anomalous species trees .

we next investigated estimation of species trees from alignments of dna sequences. in this simulation, a species tree was generated from a birth and death process: : <dig> , :  <dig> , f: <dig> ): <dig> ): <dig> ,: <dig> ): <dig> ,j: <dig> ): <dig> ): <dig> ) with population sizes generated from a uniform distribution . the branches in the species tree are in mutation units. gene trees were generated from this species tree assuming a molecular clock and then used to simulate dna sequences of  <dig> bp under the jukes-cantor model in phybase  <cit> . the average height and branch length of the simulated gene trees are  <dig>  and  <dig>  in substitutions per site. another set of dna sequences were simulated from the gene trees generated from a non-clocklike species tree model which assumes that the substitution rate is the same for all genes and sequences in the same population in the species tree, but the rates may differ across populations  <cit> . the terminal and internal branches  of the species tree were assigned with relative mutation rates generated from a dirichlet distribution with the shape parameter β =  <dig>  the branches of the gene tree entering a particular population in the species tree are multiplied by the relative mutation rate of that population. the simulated dna sequences were used to estimate the species tree. ml gene trees were first estimated independently and without a molecular clock for each gene in the phylogenetic program phyml  <cit>  with the jukes-cantor model  and rooted by species a. the mp-est, star, and rt trees were constructed from the estimated gene trees. the simulation was repeated  <dig> times. for the mp-est method, the proportion of trials yielding the true species tree appears to approach  <dig>  while the mse of the branch length goes towards  <dig>  as the number of genes increases , which suggests that mp-est is statistically consistent in estimating species trees from multilocus sequences, not just when gene trees are given as in the first simulation. overall, star slightly outperforms mp-est and rt . in addition, star, mp-est, and rt perform better for the sequences generated from the clocklike species tree than those generated from the non-clocklike species tree, especially when the number of genes is small . nevertheless, the proportions of star, mp-est, and rt trees matching the true species tree increase to  <dig> as the number of genes increases to  <dig>  regardless the sequences were generated from a clocklike species tree or a non-clocklike species tree. it suggests that mp-est, star, and rt can consistently estimate the species tree in the absence of a molecular clock. the robustness of the methods to violating the clock is due to the fact that all three methods use only the topologies of gene trees to estimate species trees. in this simulation, we have demonstrated that mp-est is statistically consistent for the cases of violating the clock randomly throughout the species tree and gene trees. there might be other ways of violating the clock for which mp-est may not be consistent. for instance in long-branch attraction types of scenarios where gene trees can not be consistently estimated from molecular sequences, mp-est may consistently estimate a wrong species tree due to the bias in the gene tree reconstruction. we observed that nearly half  of the gene trees generated from the species tree across replicates were rooted incorrectly and species a was not located on the branch between  and . yet in these cases and in the simulation generally, the correct species tree was always consistently estimated. this result suggests that mp-est  can consistently recover the true species tree even when estimated gene trees are misrooted frequently. the theory we developed assumes that the roots of the gene trees are known without error, yet our simulation suggests that this assumption can be violated and still yield a solid result under the coalescent model.

concatenation approaches have been frequently used to infer species trees from multilocus sequences  <cit> . to compare mp-est with concatenation, we simulated dna sequences from an anomalous species tree : <dig> , c: <dig> ): <dig> , d: <dig> ): <dig> , e: <dig> ) with a constant population size θ =  <dig>  for all populations in the tree. the lengths of branches are in mutation units. species e is used as the outgroup to root gene trees in the mp-est analysis. gene trees were generated from this species tree assuming a molecular clock and then used to simulate dna sequences of  <dig> bp under the jukes-cantor model in phybase. species trees were estimated from the simulated sequences using the mp-est and bayesian concatenation methods. for the bayesian concatenation method, the species tree was estimated by the consensus tree constructed from the posterior distribution of the species tree estimated in the bayesian phylogenetic program mrbayes  <cit>  with the jukes-cantor model. the chains  ran for  <dig> generations and we saved every 100th trees after a burnin period of  <dig> generations. the simulation and baysian concatenation analysis were repeated  <dig> times. we selected a sample of simulation repetitions to check convergence of the mcmc algorithm and found that all mcmc algorithms converged at the 10000th generation . mp-est trees were constructed as described in the previous simulations. the result for the mp-pest method shows that the proportion of trials yielding the true species tree approaches  <dig>  as the number of genes increases . in contrast, the proportion of the concatenation trees matching the true species tree goes to  <dig> . this result suggests that mp-pest outperforms the bayesian concatenation method in the anomaly zone.

although all results suggest that mp-est is statistically consistent in estimating species trees, the ranges of genes required for mp-est to recover the true species tree with a high probability are largely different across simulations. in the first simulation , it requires at least  <dig> genes for the proportion of trials yielding the true species tree to reach  <dig> . it increases to  <dig> genes in the second simulation , but decreases to  <dig> genes in the third simulation . the number of genes needed depends on the true species tree. in general, it requires more genes to accurately estimate the species tree with short internal branches  than to accurately estimate the species tree with long internal branches . this explains why it needs a large number of genes in the second simulation where the species tree is in the anomaly zone and has very short internal branches .

mammal data analysis
springer et al.  <cit>  used mutilocus dna sequences to estimate the phylogenetic relationship among placental mammals. the dataset contains dna sequences from  <dig> genes for  <dig> placental mammals and  <dig> marsupial outgroups , totalling  <dig>  sites. because the four outgroup sequences do not consistently form a monophyletic group for all genes, we reduced the original data set from  <dig> to  <dig> species so that a single outgroup  rather than multiple outgroups is included as required by mp-est. in the mp-est analysis,  <dig> bootstrap samples were produced using a nonparametric bootstrapping technique  <cit> . ml gene trees were estimated for  <dig> bootstrap samples in phyml and rooted with outgroup opossum. the rooted ml gene trees were used to construct  <dig> mp-est trees. a consensus tree  was built from the  <dig> mp-est trees using majority-rule-extension  in consense from the phylip package  <cit> . the mp-est tree with branch lengths  was plotted in additional file 1: figure s <dig> 

since the mp-est method can accommodate only a single outgroup sequence , it suffers from of its inability to utilize multispecies outgroups, which are widely thought to help stabilize the roots of the estimated gene trees  <cit> . to investigate the problem of multispecies outgroups, we repeated the mp-est analysis for the original mammal data set including the four marsupial outgroups . ml gene trees were still rooted with outgroup opossum. the phylogenetic relationships of placental mammals in the mp-est consensus tree for the full mammal data set are consistent with those constructed from the reduced data set . in addition, the other  <dig> outgroup species  in the mp-est consensus tree form a basal clade with a high bootstrap proportion  <dig>  . however, we note that if the opossum outgroup is included, this results in a lack of monophyly for marsupials, which is clearly incorrect. ultimately mp-est is unable to accommodate multiple outgroups when the outgroup clade is monophyletic. therefore we are forced to use a single outgroup and to drop other species that are more closely related to that outgroup than to the ingroup.

unlike the highly supported bayesian concatenation tree, most bootstrap proportions in the mp-est consensus tree are less than  <dig>  . it may be inappropriate to compare bootstrap supports with posterior probabilities because the relation between bootstrap values and posterior probabilities are highly variable  <cit>  and no studies have been conducted to assess the correlation between bootstrap supports and posterior probabilities at the species tree level. neither bootstrap values nor posterior probabilities are measures of accuracy of the estimated phylogenetic trees. however, separate analyses for  <dig> gene segments of the mammal data set produced poorly supported gene trees . approximately 80% of the bootstrap values in the estimated gene trees are less than  <dig> . in addition, most bootstrap values for deep phylogenetics relationships are less than  <dig> . the poorly supported gene trees suggest that the mammal data set does not contain much information about the phylogenetic relationship of placental mammals. nevertheless, most posterior probabilities in the bayesian concatenation tree are equal to  <dig> , indicating that the bayesian concatenation method may have overestimated the posterior probabilities. in contrast, the low bootstrap supports in the mp-est consensus tree have reasonably reflected uncertainty in the estimated gene trees. there are in general two types of genetic variations among multilocus sequences; genetic variation among loci and genetic variation within each locus. in the mp-est analysis, both variations are considered in the nonparametric bootstrap technique. as a result, the bootstrap supports in the mp-est consensus tree reflect the level of uncertainty of clades within and among gene trees. for example, the mp-est consensus tree for the mammal data set has high bootstrap supports for the branches close to the terminal tips and low bootstrap supports for the branches close to the tree root, which is consistent with the pattern of bootstrap values in gene trees . in contrast, the bayesian concatenation method assumes congruent gene trees. the spuriously high posterior probabilities, as those in the bayesian concatenation tree for the mammal data set, are probably due to the assumption of congruent gene trees, along with the fact that bootstrap values are more conservative than posterior probabilities as the measure of the reliability of phylogenetic trees  <cit> .

despite the molecular and genomic consensus of the four-clade classification of placental mammals , the relationship among the four major groups is highly controversial. three different hypotheses regarding the topology of the four clades were supported by different phylogenetic markers  <cit> . morphological markers and retroposons data favored the topology ))  <cit> . the second topology , ) was supported by phylogenetic studies of the full mitochondrial genome  <cit> , while the analyses of protein-coding and non-coding sequences supported the topology ))  <cit> . more recently, the genome-wide analysis and large scale sequence data provided evidence for a clear trifurcation at the root of placentals  <cit> . nishihara et al  <cit>  came to the same conclusion based on the retroposon analysis and recent geological data. the ancestral relationship for the four major groups in the mp-est consensus tree is , ) with bootstrap support  <dig> , while the second most supported relationship is )) with support  <dig> . moreover, the bootstrap support for the relationship )) is  <dig> . the very low support at the deep branches may be caused by the lack of information about deep relationships of placental mammals in the molecular dataset. it may also be caused by an unreliable placement of outgroup opossum. this unsolved relationship reflects the controversies over the relationship of four major groups of placental mammals. in contrast, the bayesian concatenation tree predominantly favors the hypothesis )) with a support of  <dig>   <cit> . the mp-est consensus tree contains a highly improbable group of human and strepirrhines to the exclusion of tarsius. because the bootstrap support for this group is just  <dig> , adding more data may be able to more accurately resolve the relationship among human, strepirrhines, and tarsius.

CONCLUSIONS
our maximum pseudo-likelihood method, mp-est, can consistently estimate the topology and branch lengths  of the species tree including those in the anomaly zone. although the pseudo-likelihood is derived from coalescent theory, and assumes no gene flow or horizontal gene transfer , we have shown that the mp-est method is robust to a small number of hgt events. unlike hgt, in which only one or a few genes might be affected, gene flow between species necessarily affects all genes in the genome, and hence potentially all trees in a data set. thus gene flow will likely have a bigger impact on species tree estimation than will hgt. however, this situation is no different from traditional phylogenetic analysis, in which hgt and gene flow are both complicating factors  <cit> .

mp-est allows missing sequences for some genes. it can be used to infer species phylogenies for phylogenomic data in which it is quite common to have a substantial fraction of missing sequences. however, mp-est may poorly perform in the presence of missing sequences in some genes. the relationship between the performance of mp-est and the amount of missing sequences is complicated and needs further studies. the pseudo-likelihood is a function of the triplet frequencies summarized across gene trees. since the summarized frequencies are calculated prior to the algorithm, increasing the number of genes does not increase the computational time of the algorithm for maximizing the pseudo-likelihood . on the other hand, the computational time for calculating the likelihood function is o where n is the number of species, because the pseudo-likelihood involves  terms. thus increasing the number of species will certainly increase the time for finding the maximum of the pseudo-likelihood function. we tested the execution time and memory consumption for running mp-est on a linux machine . the execution time  for finding the mp-est tree of  <dig> species is about  <dig> hours . meanwhile, it requires at least  <dig> gb memory . the mp-est method can quickly obtain the mpe of species trees for datasets of moderate size . for example, using a dell poweredge m <dig> with dual xeon e <dig>  <dig>  ghz quad core processors and  <dig> gb ram, it took about  <dig> minutes to calculate the mp-est tree  for the reduced mammal dataset which contains  <dig> species and  <dig> genes. however, there is tremendous increase in running time for mp-est compared to rt and star when more taxa are used  although the difference in performance among the three methods is small .

gene trees were generated from a 20-taxon species tree and used as data to reconstruct species trees using mp-est, star, and rt. the analyses were conducted on a linux compute machine .

twenty gene trees were generated from 20-taxon, 80-taxon, and 160-taxon species trees and used as data to reconstruct species trees using mp-est, star, and rt. the analyses were conducted on a linux machine .

since mp-est can estimate both the topologies and branch lengths of species trees, gene trees simulated from the mp-est tree can be used to approximate the distribution of gene trees expected from the multispecies coalescent model. by comparing the lineage patterns in the estimated gene trees with those in the distribution of gene trees expected from the coalescent model, we can identify the lineages in the estimated gene trees that significantly deviate from the lineage patterns expected from the multispecies coalescent model. for example, if hgt occurs in the dataset, the distances among the lineages from distant species in the estimated gene trees should be significantly smaller than those expected from the multispecies coalescence model which assumes no hgt.

with regards to branch lengths, mp-est is unable to estimate the lengths of external branches in the species tree because only one allele is sampled from each species. in addition, the internal branch length of a triple in the species tree is not estimable when all gene triples support the same topology. these internal branches are indicated with length of "99". users should be cautious about the interpretation of length "99". it is not the actual length of the branch. the value "99" suggests that the corresponding branch length is not estimable due to the lack of topological variation among gene triples. in the cases where all genes support a single tree, mp-est will fail to estimate any branch length.

strategies for sampling genes are important for all species tree reconstruction methods. biased representation of genes on the genome may introduce systematic error in species tree estimation. for example, if we would split mitochondrial genomes of placental mammals in single genes and use only these genes to estimate the species tree, mp-est would find with bootstrap support  <dig>  a species tree placing the flying lemur within primates, challenging this group paraphyletic. the mp-est method assumes that given the species tree, the evolutionary histories of genes, i.e., gene trees, follow a coalescence process, but in practice this assumption may not always be satisfied. although mp-est is, to some extent, robust to the violation of the coalescent assumption, serious divergence from coalescent can certainly result in inaccurate mp-est estimates of species trees.

our algorithm is able at this stage to accept only a single allele per species. in addition, our algorithm yields species trees whose branch lengths are in coalescent units, rather than substitutions per site as most with most phylogenetic trees. however, such trees are still of practical use in phylogenetics. the topology of phylogenies is usually of primary interest and we have shown that the topology is consistently estimated by mp-est. even when we recover species trees with branch lengths in coalescent units, under certain assumptions we can obtain reasonable estimates of species divergence times in generations or years. working in units of mutations, for example, if we assume that ancestral population sizes  of lineages in our estimated species tree are similar to those of extant species , we can easily convert coalescent units in a species tree to branch lengths in units of substitutions per site . or, when faced with variation in θ among extant species, one could reconstruct ancestral population sizes using any number of algorithms for phylogenetic comparative methods. despite the fact that branch lengths are estimated in coalescent units, our algorithm is able to accommodate branch length variation in gene trees and can yield non-ultrametric species trees. in contrast, most species tree methods either ignore branch lengths in gene and/or species trees  <cit>  or estimated ultrametric species trees  <cit> . although it would be highly desirable to estimate branch lengths of species trees directly in units of substitutions per site as in traditional phylogenies and some species tree algorithms , such an estimation procedure would require properly modelling the mutation rate variation within and among genes. our efforts are currently directed toward this end.

availability and requirements
project name: a maximum psudo-likelihood approach for estimating species trees under the coalescent model 

project home page: http://code.google.com/p/mp-est/

operating system: platform independent.

programming language: c

other requirements: no

licence: gnu gpl.

authors' contributions
ll and ly developed the method and conducted the analyses. sve obtained funding. ll, ly, and sve drafted the manuscript. all authors read and approve the final manuscript.

supplementary material
additional file 1
figure s1: the mp-est tree with branch lengths for the mammal data set. branches with length "99"  are indicated with *.

click here for file

 additional file 2
figure s2: the consensus mp-est tree for the original mammal data set including the four marsupial outgroups .

click here for file

 additional file 3
figure s3: the consensus gene trees for the reduced mammal data set. we constructed a consensus tree for each of the  <dig> genes in the reduced mammal data set. the numbers on the branches of the consensus trees are bootstrap values based on  <dig> replicates. gene trees were rooted by opossum.

click here for file

 acknowledgements
we thank dennis pearl for the helpful suggestion on the first draft of the manuscript. we thank bruce rannala for constructive discussion on the likelihood function of the species tree. we thank four anonymous reviewers for their constructive comments on the manuscript. this research is supported by the grant nsf deb- <dig> 

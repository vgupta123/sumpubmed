BACKGROUND
an increasing body of evidence suggests that the dynamic reorganization of lipids in cellular membranes can compartmentalize membrane proteins, influencing a cell’s response to extracellular stimuli and its membrane permeability  <cit> . it follows that drug-carrying agents, such as liposomes or gas microbubbles, with optimized lipid compositions can exploit these processes for enhanced drug-delivery via membrane fusion or membrane permeabilization . to facilitate the characterization of such drug-delivery devices and to deepen our understanding of the fundamental biology of the cell membrane, a non-destructive method for evaluating intrinsic membrane physicochemical properties is required. as an example, packing or molecular order of membrane lipids can be sensed by fluorescent polarity-sensitive probes such as laurdan or di-4-aneppdhq, whose emission spectrum shifts in response to changes in the molecular order of the membrane environment, usually quantified by a parameter denoted generalized polarization  . with the advent of commercial microscopes equipped with spectral detectors, shifts in the fluorescence emission spectra, and thus the gp parameter, can now be determined with much higher spatial accuracy using spectral imaging  <cit> . owing to the internalization of many polarity-sensitive fluorescent probes in living cells, however, membrane segmentation must be performed to accurately measure membrane lipid packing and to remove cytosolic contributions  <cit> . membrane segmentation is often performed using a secondary fluorophore which increases experimental cost and complexity.

to this end, we have developed the spectral imaging toolbox, a toolbox for spectral analysis with reliable membrane segmentation without the need for a secondary imaging probe. in the spectral imaging toolbox, we have included batch and hyperstack processing as well as 3d reconstruction of confocal z-stacks to facilitate processing of large datasets and experiments with multiple exposures. we demonstrate the utility of this tool with images of giant plasma membrane vesicles  labelled with either polarity-sensitive laurdan or di-4-aneppdhq, images of live cancer cells and microbubbles labelled with carboxyl-modified laurdan , and giant unilamellar vesicles  labelled with di-4-anepptea . in addition to the more commonly employed laurdan and di-4-aneppdhq dyes, we chose fe and c-laurdan for their superior photostability and emission spectrum range  <cit> .

implementation
the spectral imaging toolbox was designed for spectral analysis of high magnification images of single or sub-confluent cells, vesicles and microbubbles in matlab  <cit> .

inputs and outputs
in spectral imaging, a stack of images of a sample region is recorded with each image in the stack monitoring a different wavelength range, such that the information from the whole stack discloses the spectrum of emitted fluorescence for each image pixel  <cit> . the spectral imaging toolbox is designed for batch processing and 3-4d stacks. using the spectral imaging toolbox, we were able to process and analyze a dataset containing over  <dig> cells in a few hours  <cit> . to our knowledge, this is the largest study using the gp parameter of cell membranes as a metric for membrane lipid order, highlighting the utility of our toolbox. for an input directory of spectral image stacks, the spectral imaging toolbox outputs pseudo-colored gp maps, fitted gp histograms, and plotted spectra at the whole image, whole object, and segmented membrane levels for each image in the folder, as well as a spreadsheet summarizing the results. input images and metadata are automatically converted to the ome-tiff data standard using the bio-formats library   <cit> . options for automatic 3d reconstruction of confocal spectral z-stacks  <cit>  and plotted size distributions of spherical vesicles are also available.

graphical user interface 
a graphical user interface  guides the user through the analysis such that no programming skills are required. the gui has a three panel design whereby the left panel displays instructions and menu items, the center panel allows for navigation through the images and user interaction , and the right panel displays a gallery of images providing an overview of the results. the processing allows for user interaction at three steps. first, the user selects settings for which to run the spectral imaging toolbox, such as whether to include membrane segmentation or a gp correction factor. then following automatic object detection, the user has the option to segment each detected object further using one or more of several segmentation routines. finally, the user can review the results and remove unwanted objects from the analysis as necessary.

segmentation
spectral image stacks are thresholded using an intensity threshold determined automatically by otsu’s method  <cit> . objects of interest are then segmented and cropped using connected-component labelling of the binary thresholding mask  <cit> . the resultant cropped images are displayed for the user to discard off-target cropped images as necessary.

if a cropped image contains connected objects, such as fused guvs or touching cell membranes, the user can readily separate them using a watershed-based segmentation approach. prior to taking the watershed transform which identifies objects as catchment basins separated by watershed lines  <cit> , a series of operations are conducted to improve performance. namely, the distance transform of the complement of the binarized image is computed. the watershed transform of the negated distance transform is then taken. this process is demonstrated in fig. 1d. by our method, the threshold level for suppressing shallow minima in this image is chosen such that the watershed transform labels n objects for segmentation, where n is input through the gui. in other words, if the user specifies that a cropped image contains n cells, n cells are segmented. owing to the sensitivity of this method to non-convex shaped cells and intracellular intensity variations, the user also has the option to segment manually using lasso-segmentation. furthermore, lasso-segmentation can be used to conduct spectral analysis on any user-defined region of interest, including intracellular vesicles.fig.  <dig> the spectral imaging toolbox. a an auto-thresholded spectral image stack containing images of c-laurdan fluorescence emission from labelled a- <dig> cells collected at wavelengths ranging from  <dig> to 528 nm. b generalized polarization  is then calculated at each pixel using the intensities  from the images collected at λb and λr  using the equation . pseudocolored gp maps can then be generated . segmentation can then performed on the gp maps using lasso-based segmentation , where the user draws a region-of-interest   used to generate a segmentation mask . segmentation can alternately be performed using a watershed-based approach . from left to right in , the distance transform, the negated distance transform, and the labelled components following the watershed transform. either segmentation routine will result in the segmented objects , from which a given number of border pixels are taken as the segmented membranes 




since the cropped images contain only a single object, the membrane segmentation is simple and reliable. the objects in the binarized cropped images are filled and the membranes detected using sobel edge detection . the membranes are then segmented using the edge-detected pixels following dilation with a horizontal line element  <cit> . the spectral imaging toolbox also has a spherical object mode designed for microbubbles and spherical vesicles, where objects are segmented by finding circles using the circular hough transform  <cit> .

generalized polarization 
as highlighted before, the gp parameter is introduced for quantification of the spectral shift in emission of a polarity-sensitive probe due to differences in lipid membrane order. gp is commonly calculated using fluorescence intensities collected at two emission wavelengths, λb and λr, occurring at the emission maxima of the probe in a liquid-ordered and liquid-disordered reference solution respectively  <cit> . gp, which varies from - <dig> to  <dig>  is calculated for each pixel in the spectral image from the following equation,  <dig> gp=ib−irib+ir, where i
b and i
r correspond to the fluorescence intensity at λb and λr emission wavelengths, respectively. consequently, low gp values indicate more disordered environments.

to clarify, only the intensities of the images at λb and λr are required for gp calculation, even with spectral image stacks consisting of images collected at many wavelengths . thus, the spectral image stack is reduced to two images at λb and λr, and these two images are reduced to the single-valued gp parameter at each pixel .

the calculated gp values are then visualized using a pseudo-colored map with a look-up table scaled from - <dig> to  <dig>  <cit> . finally, the distribution of gp values is fitted to either a one or two-peak gaussian chosen by the lower root-mean squared error. the resultant gp histogram can be used to calculate changes in mean lipid order or, for a well-defined two-peak gaussian, to indicate the presence of two phases  <cit> . to facilitate additional spectral analysis, spectra are generated from the mean intensities of images at each wavelength of the stack.

generalized polarization  correction factor
as gp is an intensity-based measurement, it is strongly influenced by microscope settings including detector gain and filter settings. when gp is calculated using intensities ib and ir from two channels detecting at wavelengths λb and λr, respectively, the relative intensities of the two channels must be calibrated to obtain absolute gp values. by acquiring an image of a reference solution with corresponding gp also measured with a fluorimeter , a correction factor, g, can be introduced,  <dig> g=ib,ref×1−gprefir,ref×1+gpref, where ib,ref and ir,ref correspond to the fluorescence intensity of the microscope image at λb and λr emission wavelengths, respectively  <cit> . gp is then calculated as follows,  <dig> gp=ib−g×irib+g×ir. 


in the spectral imaging toolbox, gpref and a reference image can be specified in order to determine g for subsequent gp calculations.

RESULTS
here we present several examples of spectral imaging data processed with the spectral imaging toolbox.

spectral imaging by confocal microscopy
spectral imaging was performed on a zeiss lsm  <dig> confocal microscope equipped with a 32-channel gallium arsenide phosphide  detector array, as reported previously  <cit> . laurdan, c-laurdan, fe, and di-4-aneppdhq were excited at  <dig>   <dig>   <dig> and 488 nm respectively and the lambda detection ranges set between 410 nm and 695 nm, 415 nm and 691 nm, 500 nm and 650 nm, and 490 nm and 695 nm respectively. the resulting spectral image stacks were processed and analyzed using the spectral imaging toolbox.

sample preparation
a- <dig> cells, immortalized human alveolar adenocarcinomic epithelial cells, were grown in standard culture conditions with dulbecco’s modified eagle medium  containing 10% fetal bovine serum  and 1% penicillin/streptomycin. giant unilamellar vesicles  made of dioleoyl phosphatidylcholine , brain sphingomyelin , and cholesterol from avanti polar lipids were produced in a 2:2: <dig> molar ratio by electroformation by a modification of the protocol proposed by angelova et al.  <cit> . phospholipid shelled microbubbles with a 9: <dig> molar ratio of  <dig> -distearoyl-sn-glycero-3-phosphocholine  and polyoxyethylene  stearate  were produced using a batch sonication protocol previously reported  <cit> . samples were labelled with either c-laurdan  or di-4-anepptea   in phosphate-buffered saline . giant plasma membrane vesicles  were isolated from rat basophilic leukemia cells labelled with  <dig> nm laurdan or  <dig> nm di-4-aneppdhq as described by sezgin et al.  <cit> . briefly, cells were exposed for 1 h at 37 °c to gpmv buffer  containing 25 mm paraformaldehyde and 2 mm dithiothreitol for inducing vesiculation. after vesiculation, the gpmv-rich supernatant was collected by pipetting and resuspended in gpmv buffer for imaging. for all samples, spectral imaging was performed with samples on 170 μm thick glass coverslips.

segmentation of cells, guvs, and microbubbles
image segmentation and spectral analysis using the spectral imaging toolbox are demonstrated in fig.  <dig>  pseudo-colored generalized polarization  maps, fluorescence spectra generated from the mean intensities of images at each wavelength of the spectral image stack, and histograms of gp values fitted with either a single or double peak gaussian are provided for each example. spectral analysis is demonstrated with images of cells stained with c-laurdan  and segmented by either the watershed method  or manually by lasso-segmentation . the value of membrane segmentation in spectral analysis is highlighted by comparing the spectra and gp distributions of the segmented cells in fig. 2b and d with the pre-segmentation results in fig. 2a and c. the segmented spectra are blue-shifted and the gp increased reflecting the higher lipid order of cell membranes compared to the intracellular milieu. this is also indicated by the double-peak gaussian gp distributions in the pre-segmentation results in fig. 2a and c. spectral analysis is also demonstrated with images of guvs composed of a mixture of dopc, brain sm, and cholesterol  labelled with fe . the presence of dopc, brain sm, and cholesterol clearly give rise to phase separation as indicated by the distinct peaks in the gp histogram and in the pseudo-colored gp map. the spectral imaging toolbox was used to auto-crop the fused guvs and remove background objects for spectral analysis. in this case, membrane segmentation was not necessary because the interior of the guvs was not fluorescent like in the examples with cells. the lower lipid order region on the gp map , however, is thicker due to this region having higher fluorescence intensity. membrane segmentation could be used to take an equal-thickness sampling of pixels around the guv, for consistency of analysis across a population of multiple guvs. vesicles derived from cell membranes  and labelled with laurdan  or di-4-aneppdhq  also exhibit phase separation as indicated by their respective gp maps. the gp histograms from the guvs and gpmvs illustrate a key difference between these two constructs. the phases present in gpmvs are much closer in lipid order than those present in guvs. spectral analysis with the spherical object segmentation mode of the spectral imaging toolbox is demonstrated in fig. 2f with an image of c-laurdan-labelled microbubbles. the automated segmentation of a microbubble from a cluster of microbubbles is demonstrated.fig.  <dig> segmentation and spectral analysis with the spectral imaging toolbox. each panel contains from left to right: a pseudo-colored gp map, the spectra calculated from all pixels of the spectral image stack with significant signal values, and a histogram of gp values fitted with either a single or double peak gaussian. a a- <dig> cells stained with c-laurdan, labeling both the plasma membrane and the cytosol. scale bar 27 μm. b the same cells from  but now surface-segmented for plasma membrane only using the watershed method. c a- <dig> cells stained with c-laurdan, labeling both the plasma membrane and the cytosol. scale bar 33 μm. d the same cells from  but now surface-segmented for plasma membrane only using lasso-segmentation. in  and  the gp histograms and spectra are for the images indicated with an asterisk. e guvs composed of dopc, brain sm, and cholesterol  labelled with fe epptea). unsegmented , cropped and isolated guvs in the adjacent image. scale bar 17 μm. f gp image of c-laurdan-labelled microbubbles  was auto-segmented using the spherical object mode of the spectral imaging toolbox. scale bar 13 μm. one of the microbubbles, indicated by the arrow in the far left image, is shown post-segmentation in the adjacent image. due to few pixels in the segmented microbubble, the gp distribution is shown for the unsegmented image. g gpmv labelled with laurdan. scale bar 5 μm. h gpmv labelled with di-4-aneppdhq. scale bar 5 μm. color bar legend gives gp values and is valid for all images




3d reconstruction of pseudo-colored gp maps
a 3d reconstruction of pseudo-colored gp values calculated from a spectral z-stack of fe-labelled guvs is demonstrated in fig.  <dig>  a single slice of the stack can be seen in fig. 2e. the two phase-separated guvs in the foreground are connected at their lower end through more lipid-ordered domains .fig.  <dig> 3d reconstructed gp image calculated from a spectral image stack of fe-labelled guvs using the spectral imaging toolbox. axes give spatial dimensions along all three dimensions and color bar legend indicates gp values




microbubble size distribution
ten spectral image stacks of dspc-peg 9: <dig> molar ratio microbubbles labelled with c-laurdan were analysed with the spherical object segmentation mode of the spectral imaging toolbox. the resultant pseudo-colored gp maps, size distribution of segmented microbubbles , and distribution of mean gp values for the segmented microbubbles  are displayed in fig.  <dig> fig.  <dig> spectral analysis and size distribution of microbubbles. a pseudo-colored gp images from  <dig> spectral image stacks of microbubbles labelled with c-laurdan. microbubbles were auto-segmented and analyzed using the spherical object mode of the spectral imaging toolbox. scale bar 30 μm. color bar legend gives gp values. b size distribution  of the segmented microbubbles . c distribution of mean gp values for the segmented microbubbles 




discussion
novel aspects
the spectral imaging toolbox is the first free and open-source software to accurately measure cell membrane lipid packing without cytosolic contributions using a single dye. furthermore, by implementing batch and hyperstack processing as well as 3d reconstruction of confocal z-stacks, it addresses a growing need to process large spectral imaging datasets and data from experiments with multiple exposures. it is also the only spectral imaging software to our knowledge to leverage different processing routines for vesicles, for adherent cells, and for regions of interest  respectively. finally, while the algorithms used are not individually novel, their implementation for spectral imaging is not available elsewhere to our knowledge.

comparison with existing software
without using membrane segmentation, it is common to decompose the gp histogram into two gaussian components whereby the lower gp component corresponds primarily to the intracellular regions and the higher gp component to the cell membrane  <cit> . while this technique is valuable for localizing high and low lipid order regions, it is not appropriate for determining plasma membrane lipid order. low lipid order domains in the membrane and high lipid order vesicles inside the cell, for instance, could not be attributed to their respective sub-cellular components without some form of segmentation. thus, more advanced software is required for accurately determining membrane lipid order.

existing tools of note for processing spectral imaging data with the gp parameter include the imagej plugins of sezgin et al. and owen et al., and simfcs developed by professor enrico gratton  <cit> . these tools all provide adequate means of calculating gp, generating gp visualizations, and histograms for a single spectral image.

the plugin of owen et al. provides batch processing and enables membrane segmentation with the requirement of a secondary image acquisition and fluorescent membrane label. the spectral imaging toolbox does not require an additional membrane label or image acquisition step to achieve membrane segmentation.

sezgin et al. allow for fitting the spectra of each pixel with either a gaussian or gamma-variate function to interpolate the intensities, ib and ir, for reducing noise in the gp calculation. we found that the gamma-variate fit is most appropriate for spectral imaging data but was too computationally expensive for batch and hyperstack processing. the spectral imaging toolbox instead allows for optionally smoothing the intensity images using a median filter prior to gp calculation, much like simfcs.

the power of simfcs is its ability to process many types of advanced imaging data with one software suite. simfcs does not, however, support batch processing, roi segmentation, membrane segmentation, or z-stack gp analysis and visualization - core features of the spectral imaging toolbox.

regarding availability, imagej is free  <cit> , as is simfcs  <dig> from globals software . most research institutions have matlab licenses and without a site license, students can purchase matlab with the necessary add-ons for only $ <dig> 

another benefit of our software is the ease of customization. simfcs is not designed for user modification of the source code, and imagej provides only a limited macro language and plugin facility. conversely, the spectral imaging toolbox can be readily extended using matlab vector operations well-suited to rapid and complex image processing and analysis. the open-source code will be maintained on the matlab central file exchange at the url provided where updates and feature requests can be publicly discussed.

CONCLUSIONS
the spectral imaging toolbox provides an easy-to-use means of analyzing large spectral imaging datasets. it requires no programming experience, outputs publication-quality figures, enables reliable membrane segmentation without the requirement of a counter stain, and incorporates batch and hyperstack processing. it is our intention to continue to develop this free and open-source toolbox with input from the community to further facilitate ambitious research with spectral imaging.

availability and requirements
project name: spectral imaging toolbox

project web page: https://ora.ox.ac.uk/objects/uuid:4375842f-3598-418d-8aa3-9b31f5023401


operating system: tested on windows 7

programming language: matlab 2015+

other requirements: image processing toolbox https://uk.mathworks.com/matlabcentral/fileexchange/62617-spectral-imaging-toolbox


license: gpl

any restrictions on use by non-academics: none


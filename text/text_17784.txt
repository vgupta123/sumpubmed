BACKGROUND
sequencing based technologies such as chip-seq and dnase-seq  have revolutionized our understanding of chromatin structure and function, yielding deep insights in the importance of epigenomic marks in the basic processes of life. the emergent picture is that gene expression is controlled by a complex interplay of protein binding and epigenomic modifications. while histone marks  can be measured in a high throughput way, exploratory data analysis techniques for these data types are still being developed. epigenomic marks exhibit characteristics that distinguish them fundamentally from e.g. mrna gene expression measurements: they are spatially extended across regions as wide as several kilobases within which they often present interesting local structures, such as the presence of multiple peaks and troughs  <cit> , and intriguing asymmetries  <cit>  . the shape of epigenomic marks across replicate data sets appears to be highly conserved, and has recently been exploited for statistical testing  <cit> . while the biological reasons for such conservation are not entirely clear, recent studies have suggested that both architectural and regulatory aspects may be at play. bieberstein and colleagues showed intriguing patterns of accumulation of the histone marks h3k4me <dig> and h3k9ac at splice sites  <cit> , hinting at an architectural origin of the shape of the marks. more recently, benveniste et al showed that histone marks can be very well predicted genome-wide by the binding patterns of transcription factors   <cit> . the shape of the peak may therefore be a readout of additional chromatin-related events and genomic regions which are similarly marked may therefore hint at common regulatory or architectural features. excellent visualisation tools  enable researchers to appreciate such features for individual enrichment peaks. however, while automatically grouping such marks based on shape similarity may be a valuable tool for hypothesis generation, it has remained a non-trivial task.
fig.  <dig> the epigenomic marks h3k4me <dig>  and h3k9ac  accumulate around transcription start sites often showing a bimodal peak with a valley over the tss. shown are two biological replicates for each mark and the input signal. y axis corresponds to read counts. annotated genes and the enriched regions called by macs <dig> are shown in grey below each profile




current approaches to clustering regions based on chromatin signatures can be broadly split into two camps: global approaches, such as the celebrated hmm-based reconstruction of the “colours of the chromatin”  <cit> , try to find a segmentation of large genomic regions based on histone signatures. these approaches usually rely on the presence vs absence characterization of histone marks at genomic loci, such that the clustering is primarily based on combinatorial patterns of multiple histone marks, as opposed to spatial patterns emerging within individual peaks. another interesting segmentation approach was recently introduced by knijnenburg and colleagues  <cit> . here, signal enrichment is considered across a wide range of scales spanning several orders of magnitude. while this constitutes a significant improvement compared to earlier approaches, signal patterns within segments are again not taken into account. on the other hand, local approaches attempt to cluster short genomic regions at particular loci based on the quantitative binding or modification pattern measured at the loci . examples of these approaches include the encode cluster aggregation tool   <cit> , or the clustering of genes based on polii binding profiles performed in  <cit> . local approaches have to address two challenging problems: aligning the peaks to a reference, and standardising the peaks so that they can be represented as vectors of equal dimensions. to align regions, both, the method by taslim and colleagues as well as the cagt tool, rely on anchor points   <cit>  or transcription factor binding sites from auxiliary chip-seq experiments  <cit> ). the regions are then standardised either by rescaling to a fixed gene length  <cit>  or by applying windows of fixed length either side of the anchor points  <cit>  irrespective of the true extent of the local enrichment. these strategies may be plausible for certain applications. however, the shape and extent of histone marks for instance, appear to be determined by many factors  <cit> , such that a uniform rescaling may be inappropriate. in particular, if one made the assumption that epigenomic marks are directly or indirectly influenced by the underlying dna sequence, it becomes clear that more flexibility in the comparison and alignment of these marks is needed: for example, ortholog genes may share similar sequence features but their sequence length may vary. sequence comparisons therefore in general do not require the considered sequences to be of equal length, they allow for insertions, deletions, shifts. similar local variations should therefore be allowed when comparing epigenomic marks.

in this work, we address the problem of aligning and clustering epigenomic data in a completely unsupervised way: as input data we use chip-seq enrichment measurements within peak regions identified by a peak finder such as macs  <cit> . the alignment and the standardisation problems are solved simultaneously without the use of additional information, such as transcription start sites or gene annotation. we introduce a local rescaling which allows to match epigenomic marks based on maximum similarity between shapes. our method, dynamic genome warping , is based on the classical dynamic time warping algorithm  <cit> , which enabled computer scientists to construct robust speech recognisers undeterred by the variability in pitch and speed of enunciation. in dgw we have implemented multidimensional alignment and clustering, such that multiple epigenomic tracks can be analysed simultaneously. this feature can also be used to control for local sequencing bias as dna inputs or igg controls can easily be added to the analysis. we first test dgw in a simulation study. subsequently, we demonstrate that dgw can align genomic landmarks such as tsss and first splicing sites  on real epigenomic data from the encode project  <cit> , thus effectively and automatically solving both the alignment and the standardization problems. dgw is freely available as a stand-alone, platform-independent and fully documented python package.

methods
we will first motivate and illustrate our method on a particular data set of histone modifications from the encode project  <cit> , measuring tri-methylation of histone  <dig> at lysine  <dig>  and acetylation of histone  <dig> at lysine  <dig>  in human leukaemia cell line k <dig>  the reason for choosing these two specific marks is that they are known to be characteristically enriched in the flanking regions of tsss  <cit>  and they were recently shown to accumulate at fsss  <cit> , hence providing direct evidence of the biological relevance of both the alignment and standardisation problems.

aligned fragments  of both epigenomic marks were processed with the macs <dig> peak caller  <cit>  to identify regions which showed enrichment relative to a input control sample; we then merged the two sets by considering every region called for either mark. we stress that the method is independent of the specific marks chosen, or the choice of peak caller, and is readily extendable to other types of genomic and epigenomic data.

enriched regions normally have very different lengths, nevertheless visual inspection of peaks can reveal similarities between the shape of the peaks. these similarities are often visualised through a global averaging  of the marks as in  <cit> , nevertheless there are strong arguments that global averaging may also mask more subtle patterns. a useful motivating example is given in fig.  <dig>  this shows four regions which are enriched in the h3k4me <dig> as well as h3k9ac marks. they all overlap with genes and exhibit broadly similar shapes: a bimodal peak with a trough over the tss. however, the total lengths of the enriched regions vary, and so does the extent of the two individual sub-peaks, which could be governed by the underlying gene structure. therefore, the position of the tss relative to the start of the enriched regions varies.

dynamic genome warping
to automatically quantify the similarities between peaks such as the ones shown in fig.  <dig> we use the classic dynamic time warping  algorithm  <cit> . a modern review of the basic concepts of dynamic time warping can be found e.g. in  <cit> . it was originally introduced in the speech recognition community to robustly recognize speech independently of speech speed. there, the problem was to match waveforms of similar shape but potentially different duration. likewise, our aim is to be able to associate peaks which exhibit similar local structure  regardless of their spatial extension.

specifically, let a= and b= be two sequences with values ai,bi∈s, where s is a metric space equipped with local distance d:s×s→ℝ . dtw uses dynamic programming to construct a warping path
p=p <dig> p <dig> …,pi <dig> pi <dig> …,pk <dig> pk <dig>  i.e. two sets of indices identifying the elements of the two sequences which are mapped to each other in order to minimise the sum of the local distances. in formulae, 
  <dig> p=argmin∑i=1kdapi <dig> bpi <dig> 


subject to the following constraints 

p10=p11= <dig>  the first points of both sequences are mapped to each other;


pk0=n, pk1=m, the end points of both sequences are mapped to each other;


0≤pi+1j−pij≤ <dig> for all i= <dig> …,k and j= <dig> , each index set is non-decreasing with maximum step one. this ensures that every point in each sequence gets mapped to at least one point on the other sequence.




algorithmically, dtw is very similar to the classical alignment algorithms such as needleman-wunsch and smith-waterman: it assumes an optimal alignment between subsequences, iterates by selecting the optimal next move and recovers the optimal global alignment by backtracking. as such, it entails constructing a matrix of size m×n, which determines the computational complexity of the algorithm: computing pairwise dtw distances between all peaks is therefore the computationally most expensive step, as it involves computing onpeaks <dig> dtw distances, each of which is o. in fig.  <dig> we show how the first two peaks in fig.  <dig> are aligned onto each other using dtw. notice that the pure dtw algorithm allows arbitrarily long stretches to be compressed to a single point. this behaviour may be undesirable, and simple modifications are implemented such as an upper limit on the length of compressed regions , or an exponential penalty on compressing/stretching. by applying the sakoe-chiba band constraint we can also reduce the run-time to o), where k is the width of the band, that can be chosen to be small. novel strategies to reduce the computational load are however emerging  <cit> , and it would be interesting to integrate such ideas in the epigenomic context.
fig.  <dig> dgw alignment of two h3k4me <dig> profiles. a shown is the distance density matrix for two peaks . colour coding corresponds to local euclidean distances from small  to large . optimal path is shown in blue. b mapping between the two profiles. c dynamically aligned profiles and total distance d between the two peaks




dgw readily extends to multi-dimensional data if more than one epigenomic track is analysed: in this case a and b become sequences of vectors, e.g. , that each contain the coverage of each mark at time point i. in this way, the different epigenomic marks are given equal weight, however other weighting schemes can easily be implemented.

in addition to the optimal path between two sequences we also report their total distance under the optimal warping which will subsequently be used for the clustering of peaks. note, when using squared euclidean distance as local distance measure, both, differences in peak shapes as well as in enrichment levels contribute to the overall dtw distance. if this is not desired the peaks can optionally be normalized by the respective peak heights, and the cosine distance can be used as local distance. to account for potential strand specificity of epigenomic marks we compute two distances for every pairwise peak comparison: one with the two sequences unchanged, and one with one of them reversed. the smaller distance between the two is then returned as the true distance between the patterns.

clustering
after aligning all pairwise distances between peaks, we next aim to cluster them into groups which share similar shapes. implementing k-means clustering within a dtw framework, however, would require the ability to define an average of all potentially possible warped profiles, which is not an easy task. instead we take advantage of the pre-computed pairwise distances between peaks and perform agglomerative hierarchical clustering, using complete linkage to avoid chaining  <cit> . the resulting dendrogram contains n
peaks− <dig> nodes, each of which represents a possible clustering of the data. as in any hierarchical clustering method, the number of clusters can be adaptively chosen by the user. this is both a strength and a weakness of the methodology. principled methods for choosing a cutoff exist  <cit>  and implementing them in the context of dgw will be a future direction of improvement. dgw computes a prototype for each node, i.e. a sequence representative of all sequences attached to the node . prototype computation is a non-trivial problem in dtw; here we use the scaled prioritised shape averaging algorithm of  <cit> .

pre-processing pipeline and implementation
here we briefly describe the dgw software package; a more thorough description, including installation instructions and examples, is given in the vignette at the dgw home-page  <cit> . dgw consists of two modules: a worker module, which performs the computationally intensive tasks, and an explorer module, which allows visual exploration of the results. dgw-worker takes as input a set of genomic regions  and a set of data files  for different epigenomic marks. single-end reads are extended to the estimated fragment lengths. to alleviate the computational burden and to reduce spatial noise, coverage within peak regions are binned into non-overlapping windows spanning  <dig> bp. this is an adjustable parameter which should reflect the scale at which local changes are expected in the data. for each peak, we thus construct a sequence a=, which contains as values a
i the coverage within each bin i. at this point, we do not normalize with the input sample but use simple read counts. a practical reason for this is that most input samples still have a relatively low coverage. as there is no enrichment for binding sites, input samples cover the whole genome. input library sizes therefore need to be significantly larger than their ip sample counterparts, which in practice is rarely the case. a simple correction, which uses enrichment over input is in most applications counterproductive as it adds additional noise to the signal. however, our method allows to add input samples for multidimensional clustering offering a convenient way to incorporate the additional information which is conveyed in a sufficiently sequenced input sample if it is available. the dgw-worker then computes the warping distances, the hierarchical clustering dendrogram, and the prototype sequences associated with each node; this is computationally intensive and the tasks will be automatically distributed across multiple cores if available. a typical run of dgw worker on the chip-seq data set takes  <dig> mins of cpu time distributed across six cores, for a total execution time of just over one hour.

once these computations are completed, the lightweight explorer module can be launched. this opens a window displaying a heat-map of the peaks and the clustering dendrogram. the dendrogram can be cut at any desired level. the information about which peaks are clustered is returned as a series of bed files  to enable subsequent analyses. individual clusters can be further analysed and additional functionalities are provided at this level, e.g. histograms of the positions of specific regions of interest pre and post warping  and warpings of individual peaks onto prototypes can be obtained.


RESULTS
simulation study
as a proof of correctness, we constructed a simple simulation study that mimics as best as possible a real biological data set. we considered the initial  <dig> kb of five genes from the ucsc known genes data set, and extracted h3k4me <dig> data for these five regions from the encode human leukaemia cell line k <dig> . the first three of which showed bi-modal peaks, the remaining two exhibited a single peak. we ensured that the first splicing site of these five genes fell within the  <dig> kb region considered. we generated modified versions of the five seed regions using the following procedure : a multiplicative gaussian noise with variance v was applied to the read counts in each bin of a seed region. further, each bin was removed or duplicated with probability p producing a shrinkage or a stretch of the peak. bin duplication was allowed also for duplicated bins resulting in local stretching of varying length. additionally, the orientation of the simulated peak was switched with probability fp in order to simulate anti-sense transcription. for each set of parameters  we produced  <dig> simulated peaks starting from each seed thus obtaining a  <dig> peak dataset .
fig.  <dig> generation of simulated data sets: shown in blue are five seed regions, i.e. original encode h3k4me <dig> read counts at the start of five known genes. for each of the seed regions we show  <dig> simulated modifications which are created by multiplying gaussian noise to each bin , by introducing insertions and deletions  and by flipping the orientation of the peak with probability fp:  <dig> . individual panels  represent the different seed regions




the clustering results are shown in fig.  <dig>  both for a standard hierarchical clustering, as well as for dtw clustering. figure 4
a and b show resulting dendrograms for the simulation experiment with parameters . in contrast to standard hierarchical clustering dgw identifies  <dig> clusters with approximately  <dig> members each, corresponding well to the initial five seed patterns. we reproduced the data simulation and clustering phases varying the parameter sets in order to investigate a grid of increasing modifications of peak patterns. we quantitatively assess the accuracy of the clustering using the matthews correlation coefficient  with the generalization for multi-class classification problems  <cit> . the results are presented in fig.  <dig> and table  <dig>  the mcc ranges from - <dig> to  <dig>  the extreme values represent completely incorrect and completely correct classifications, respectively and  <dig> the result of a random classification. standard hierarchical clustering is able to correctly group the simulated peaks according to the pattern they are originally derived from only if the added noise and modifications are small . with dgw optimal clustering can be achieved even if the extent of local modifications to the patterns is large .
fig.  <dig> simulation results for parameter set . a left panel shows the dendrogram of clustered peaks using hierarchical clustering only. peaks assigned to each of five different cluster are shown in yellow, pink, blue, red and green. x axis represents the pairwise distances d. right panel shows clustered peaks. colour coding corresponds to normalized read counts. x axis represents original  bins from start of the peaks. c matthews correlation coefficient for hierarchical clustering based on a set of simulations with varying parameters  and fp fixed to  <dig> . b and d as a and c but for dgw alignment followed by hierarchical clustering



p\v

p\v



dgw automatically aligns genomic landmarks
to assess the biological significance of dgw alignment and clustering, we considered two histone marks  from the encode data sets. these marks were chosen as they were shown to accumulate at transcription start sites as well as first splicing sites   <cit> . given that first exon length is highly variable, this provides a strong motivation for the local rescaling applied by dgw. for this experiment, enriched regions identified by the macs <dig> peak caller were used for clustering such that no anchoring was provided. using a bin size of  <dig>  we restricted the analysed set of peaks to those that had a length larger than  <dig> and smaller than  <dig> bins. also we filtered out peaks with less than  <dig> counts. we used squared euclidean distance for the local distance measure between the scaled reads and constrained the dtw with a sakoe-chiba band of width  <dig> 
a and b show the original and warped heat-maps for the two epigenomic marks within one particular cluster. tss and first splice site positions are shown with red and orange dots, respectively. the heat-map of the warped data shows a well defined bimodal pattern of h3k4me <dig> with tss aligning in the valley between the two sub-peaks. this is in good agreement with the known pattern of these marks around gene starts. it can be seen that these genomic landmarks or points of interest  are approximately aligned, without the usage of any prior knowledge of their position in the clustering. this is corroborated by considering the histograms of tss and fss positions in the raw and aligned data . computing the change in entropy between the histograms shown in fig.  <dig>  after rescaling the raw data to have the same length, we observe a decrease of  <dig>  % for tss and  <dig>  % for fss location distributions in the selected cluster after warping. on average, across all clusters, this effect is less pronounced, but still significant:  <dig>  % decrease on average  for tss and  <dig>  %  for fss respectively, quantitatively demonstrating the ability of dgw to align these genomic landmarks.
fig.  <dig> encode data: dgw clustering of the h3k4me <dig> and h3k9ac marks in the k <dig> cell line. shown are dendrogram and heat-maps. tss are shown as red dots in the heat-maps


fig.  <dig> encode data, a sample dgw cluster. a heat-maps of the raw and b aligned data. red dots indicate transcription start sites, orange dots first splice sites. c histograms of the positions of tsss in raw  and aligned  data. d histograms of the positions of first splice sites in raw  and aligned  data




dgw clusters are enriched for co-factor binding sites
to probe further the biological significance of the dgw clusters, we asked whether the cluster membership could be explained in part by considering shared binding co-factors. to test this hypothesis, we considered chip-seq data sets for  <dig> transcription factors  assayed by encode in the k <dig> cell line . several tfs have been mechanistically associated with histone modifying enzymes, and indeed tf binding has recently been reported to be very strongly predictive of histone modifications  <cit> . we extracted peak information from these data sets, and then questioned the distribution of individual tfs binding sites across clusters. under a reasonable null hypothesis of no relation between clustering and tf binding, one would expect the number of tf peaks falling into the genomic region corresponding to a cluster to be simply proportional to the size of the genomic region, i.e. a uniform distribution.
fig.  <dig> cumulative levels of normalized overlap between each tf and the determined clusters. each sub-plot corresponds to one tf. for each tf, clusters are ranked by their relative overlap with this tf. each bar corresponds to the cumulative level of normalized overlap between the tf and the considered cluster plus all clusters to the left of it. the null hypothesis of uniform distribution corresponds to the red lines. the area between the red line and the cumulative plots is indicated below the tf name




CONCLUSIONS
data exploration and visualisation tools have played a central role in bioinformatics, and have contributed in no small part to the success of high-throughput methods in the last decade  <cit> . extending these methodologies for the complex next generation sequencing data sets poses computational and methodological challenges, yet the potential for hypothesis generation is considerable. chip-seq data sets, in particular, yield high dimensional, structured marks associated with genomic regions. the reproducibility of the spatial structure in the chip-seq signal has already inspired the development of shape-based statistical tests for chip-seq  <cit> . in this paper, we addressed the natural question of whether spatial structures in chip-seq data can also be used to group genes with similar epigenomic marks. we have proposed a novel method, dgw, which aims to address these problems using ideas from signal processing and speech recognition. our results show that dgw can be a practical and user friendly tool for exploratory data analysis of high throughput epigenomic data sets. dgw’s ability to recover in an unsupervised manner the observed accumulation of h3k4me <dig> and h3k9ac at transcription start sites and first splicing sites  <cit> , and to associate clusters with groups of transcription factors, also demonstrates its potential as a useful tool for biological hypothesis generation. we hope that dgw may become a valuable addition to the growing toolkit for epigenome bioinformatics.


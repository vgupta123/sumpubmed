BACKGROUND
dna methylation, the addition of a methyl group to the 5’ position of the cytosine, is one of the major epigenetic control mechanisms for gene regulation, cellular differentiation, embryogenesis, x chromosome inactivation, genomic imprinting, and tumor genesis  <cit> . the methylated cytosine  is resistant to bisulfite treatment while the treatment converts unmethylated cytosine residues to uracil, which subsequently changes to thymine  in pcr reaction. this property  is used to interrogate the cytosine methylation status at base level for quite some time but it was not until the advent of next generation sequencing technology that methylome-wide studies have become possible in recent years  <cit> . bisulfite methylation sequencing  can be conducted for all cpgs in the genome  or for selected regions of interest to reduce cost and complexity such as reduced representation bisulfite sequencing  and agilent sureselect methyl-seq kit . rrbs is the most commonly used approach, which applies msp <dig>  a restriction endonuclease, to cut dna at ccgg motif sites into fragments and then sequence the regions enriched with cpg sites in the genome. although the approach only targets ~ <dig> million or 7-10 % of cpgs in the genome, these cpgs are highly enriched in the most important regulatory regions of the genome such as cpg islands, cpg island shore, promoters, and gene body, which makes it one of very cost-effective approaches to analyze dna methylation .

a number of tools have been developed to analyze rrbs or bisulfite sequencing data. bsmap  <cit>  is a bisulfite sequencing alignment tool that aligns a bisulfite read to the reference genome directly without reference genome conversion through enumerating all c-to-t combinations within a user-defined seed length of the read. bismark  <cit>  uses bowtie  <cit>  or bowtie  <dig>  <cit>  as an aligner. both reference genome and sequence reads are converted mimicking bisulfite-treated dna, i.e., changing c to t for forward and g to a for reverse strands. sequence reads that produce a unique best alignment from the four alignment processes against the bisulfite genome are then compared to the normal genomic sequence and the methylation state of all cytosine positions in the read is determined. similarly, bs-seeker <dig>  <cit>  aligns the converted reads to the four pre-built indexes built separately from a three-letter converted genome. it uses bowtie  <dig>  <cit>  or soap as the aligner of choice. last  <cit>  is an enhanced aligner that uses seed extension approach similar to be the one used by ncbi blast  <cit> . it has three steps to get the reads aligned to the reference genome, which includes indexing the genome, finding alignments, and then resolving multiple mapping reads through estimating the probability that each is the correct one so that only alignments with low mismatch probability are retained. methylcoder  <cit>  uses gsnap  <cit>  or bowtie  <dig>  <cit>  to do a primary mapping of in-silico converted reads  onto a converted reference genome. the reads that fail to map onto the converted genome will be remapped again in their original forms onto the original reference genome. novoalign  basically uses the statistical model from soap, which is designed for heterogeneous samples and uses a traditional  <dig> base model to call the consensus sequence and then for each cytosine it reports the % of bases that are methylated . brat-bw  <cit>  uses the same strategy as bismark and bs-seeker <dig>  to align the data, two fm-indexes are built from the original reference genome: one converted from all cs to ts for the forward strand and another from gs to as for the reverse strand. original reads with cs converted to ts are mapped to the first index, and the reverse-complements of the reads with gs changed to as are mapped to the second index. it also uses a multi-seed approach by attempting to align a read starting from different locations within the read. the further details and feature comparisons of these tools are summarized in additional file 1: table s <dig> 

in spite of these multiple tools, their relative performance of analyzing rrbs data is not well established. additionally, several issues unique to rrbs have not been addressed adequately:  rrbs reads are generated from known regions in the genome  and aligning rrbs reads to whole genome is less efficient and more likely to have misalignment as the reduced complexity of both reference and reads from  <dig> to  <dig> letters.  significant amount of rrbs reads  may be contaminated by sequence adapters as the selected fragments range from  <dig> to  <dig> bases to accommodate the shorter fragments with rich cpgs . this makes adapter trimming an indispensable step before alignment. all above tools need this pre-processing well conducted for good alignment  <cit> . however, when adapter sequence within a read is short , adapter trimming gets difficult and true biological bases can be trimmed off inadvertently.  msp <dig> cuts dna between two cs at ccgg motif. this is followed by end repair, a-tailing, and adapter ligation before bisulfite conversion. the end repair incorporates artificial cg at the end of a read. when a rrbs fragment is shorter than a sequence read, the incorporated cs  can remain and become part of dna fragment sequence , which can bias a methylation estimate at these positions.

to deal with the aforementioned issues, we have developed a unique rrbs analytical tool called “trace-rrbs” . unlike other methods, trace-rrbs first creates a reference genome by digitally digesting reference sequence by msp <dig> into dna fragments and only the fragments that are within rrbs size selection range are kept, mimicking a true rrbs experiment. the targeted alignment increases alignment speed and accuracy. adapter sequences are attached to the ends of the digital digested fragments for later removal so no adapter trimming is needed during alignment. furthermore, artificial end repair c bases are recorded for exclusion during methylation data extraction.

RESULTS
trace-rrbs algorithms
aligning reads to their origin of the genome
the unique characteristic of rrbs is to cut the genome between two cs of the motif ccgg using the msp <dig> enzyme. the fragmented genome is then bisulfite treated and sequenced. each of the sequenced fragments begins with cgg and the resulting sequenced reads contain at least one cpg, i.e. the leading two base pairs of the read . in the alignment step, all the cytosines on the reference genome are converted into thymines . this in-silico bisulfite conversion of the genome results in a three-letter genome and the reverse complementarity of the two strands is lost. the cytosines on the reads are also converted into thymines before aligning against the in-silico converted genome. since we already know where rrbs fragments come from the genome, we can use this information to improve the accuracy of the alignment step for two simple reasons: first, c/t conversion in the reference genome and reads reduce sequence complexity and the chance of aligning to multiple or incorrect locations increases if we align reads to whole genome. however, if we create a reference genome only from the regions the rrbs reads arise from, this chance would be significantly reduced and alignment accuracy would be increased. secondly, msp <dig> fragments appropriate for rrbs only account for about 1 % human genome. aligning reads to this small subset of the genome significantly reduces alignment space and increases alignment speed.fig.  <dig> rrbs concept and workflow. genomic dna is first digested by msp <dig> which cuts at ccgg sites. these fragments are end-repaired, a-tailed, and adapter-attached and then bisulfite treated. the unmethylated c is converted to u  and methylated c is unchanged. the blue bases are from media and are not real biological signal that needed to be removed



dealing with adapter sequence and end-repair incorporated cytosine
a critical preprocessing step is the adapter trimming for rrbs as a significant number of fragments can be shorter than sequence reads. to cut adapter sequence, we need to specify a minimum number of bases in a read that matches to an adapter sequence. setting this number high would leave partial adapter sequence intact and reduce alignment rate and possibly introduce non-biological bases. specifying a too small number  is less specific and may remove biological signals. additionally, the artificial trailing cs are incorporated into sequence reads during the end repair and a tailing step  and these need to be removed during alignment or methylation level estimation step to avoid biased measurement. trim galore  and bseqc  <cit>  are the tools that can conduct end repair base removal. the former is a wrapper script for cutadapt  <cit>  and fastqc  before alignment, which is a separate process and adapter trimming can be difficult for short sequence as discussed above. removal of additional bases for pair-end sequencing can be tricky as it can affect subsequent rrbs read alignment. for example, removing two additional bases from the beginning of the read  <dig>  would remove cgg tag that is used to search for indexed ccgg motif in the reference genome causing the reads to remain unaligned in rrbsmap. bseqc is a quality control tool only for aligned bam file of bisulfite sequencing for potential bias removal including the end repair base. trace-rrbs deals with all the issues in a single pipeline where no adapter trimming and explicit end repair c removal are needed as detailed below.

trace-rrbs implementation
trace-rrbs  has three different major components. in the first part it takes an input reference fasta file and conducts an in-silico digestion for the msp <dig> motif . all the genomic positions containing a ccgg motif are clipped which results in a collection of variable sized dna fragments. an artificial cg is added to the ends of each fragment. this corresponds to the end repair step of the library preparation protocol. the fragments are then size selected based on user input as per rrbs protocol , followed by the attachment of sequencing adapters. they are then in-silico bisulfite converted by replacing cs to ts for the forward and gs to as for the reverse strand. these “post-bisufite” fragments are indexed using bowtie  <dig>  <cit>  and used for the alignment step. the positions of added artificial cg and adapter sequences are tracked for later removal as they are not biological sequences.fig.  <dig> trace-rrbs flowchart. the reference genome in fasta is first digitally digested into fragments mimicking a real rrbs experiment. these fragments are size selected, end repaired, a-tailed and an adapter annealed. they are further indexed using bowtie  <dig>  both sequence reads and the reference fragments are converted fully from cs to ts for forward and gs to as for reverse strand before alignment by bowtie  <dig>  after alignment trace-rrbs parses the bam, removes an adapter and incorporated cs, and compares with unconverted sequence for methylation calculation



the second part is the alignment of rrbs reads against the reference genome created from the previous step using bowtie  <dig>  <cit> . for this step we convert the rrbs reads into a 3-letter code by converting cs to ts for forward reference alignment and gs to as for reverse reference alignment. similar conversion is performed for the second read if it is pair-end sequencing. by converting an rrbs read to a 3-letter code we lose its methylation information, but gain the ability to align it against the 3-letter “post-bisulfite” converted fragment. once the read is aligned to the “post-bisulfite” fragment we know its exact origin, we can then traverse the overlap of the read and the fragment, looking for positions that correspond to a c on the corresponding “pre-bisulfite” fragment. for such a position we can look into the corresponding pre-converted read to see whether the base is a c  or a t . this strategy is used to determine the methylation state of a cytosine in the next step.

the final part is the methylation-calling step for genomic cytosines using the aligned rrbs reads. all the reads that align to multiple fragments are discarded. for the case of a read aligning to a single fragment, maybe multiple times, we look if there is an alignment where the beginning of the read is aligned with the beginning of the fragment. we use this particular alignment of the read in the subsequent steps. for each cytosine of a fragment we construct a pileup of the aligned pre-converted reads and report the fraction of cs observed in it as the methylation ratio. noted is that the adapter and incorporated sequences are ignored in this step.

trace-rrbs is implemented using platform independent java language for digital reference genome digestion, rrbs fragment reference genome preparation with annealed adapter, post-alignment processing and methylation estimation. the alignment tool incorporated is bowtie  <dig>  <cit> . some libraries from picard  are used and incorporated in the trace-rrbs package.

performance comparison for the simulated rrbs data
tables  <dig> and  <dig> summarize the alignment and methylation call statistics for the  <dig> tools, respectively. trace-rrbs demonstrated as the fastest aligner among all using less than  <dig>  h, with bsmap  the second. trace-rrbs also aligned the highest percentage of reads  with the highest accuracy .table  <dig> alignment performance comparison of simulated rrbs reads 


aalignment time doesn’t include the genome preparation time


anumber of cpgs with at least 1x coverage divided by total expected cpgs


btime and memory for chromosome  <dig> as bsmap script takes a huge amount of memory for whole genome


na no available script to extract methylation data for the comparison; -- the tools have their methylation extraction script but was not able to be used in this case and an in-house script was used



we further compared the estimated methylation ratio with the truth for each of the tools using the square of the pearson correlation  for measurement accuracy. trace-rrbs achieved the highest r <dig>  <dig>  while all other tools were below  <dig> . the recall rate  of trace-rrbs was also the highest  and methylcoder was the lowest .

performance comparison for mcf <dig> cell line and illumina  <dig> data
for this dataset, we compared the execution time, memory usage, mappability and correlation with illumina infinium human45k microarray. the run time  and uniquely aligned reads  of trace-rrbs were comparable with bsmap rrbs module and bs-seeker  <dig>  novalign and bismark also had the similar aligned reads; however, the alignment times were  <dig> to  <dig> times more . at 10x coverage, trace-rrbs captured  <dig>  million cpgs, the third highest after methylcoder and last but significantly higher than bismark , bs-seeker <dig> , bsmap , and novoalign . in correlation comparison with 450 k microarray data, trace-rrbs data has the highest correlation along with bs-seeker <dig> . identical correlation was obtained for bismark, bsmap and novoalign . however, the correlation for methylcoder was the lowest at  <dig>  even though it had the highest number of cpgs at 10x coverage. this low correlation was partly contributed by the methylation extraction script within the package as when we used our extraction method this correlation was significantly increased  although it was still lower than others. this may also explain the low correlation for the simulated data.table  <dig> performance comparison of mcf <dig> rrbs reads

run time a

aalignment time only


na no associated script to extract methylation data



trrace-rrbs corrects the end repair c bias
from the simulated and the real data, trace-rrbs achieved the highest correlation with the simulated true methylation and the illumina 450 k platform, partly as a result of end c removal as it is an integral part of analysis by trace-rrbs. to further demonstrate the improvement, we conducted the methylation auto-correlation analysis as performed previously  <cit>  for cpgs at distance from  <dig> to 100 bps before and after the end repair c removal. the closer the nearly cpgs are, the higher correlation are expected as cpg methylation in the genome is in cluster fashion. as seen in fig.  <dig>  the methylation level without the end repair c removal had higher variability and lower correlation ; however, this was significantly improved after the end repair c removal .fig.  <dig> methylation ratio auto-correlation of cpgs at fixed distances before and after end repair c removal. autocorrelation plot shows the correlation among neighbouring cpg sites  dependents on the distance between two sites compared . the red dots represent the case where the artificially added cpgs are included in the cytosine methylation calculation. the blue dots represent the case when they are excluded. significantly improved auto-correlation is observed after artificial cs are removed



discussion
rrbs is the most commonly used bisulfite sequencing application in biological and medical research because of its affordability and significant enrichment in the genic and regulatory regions in the genome. many tools have been developed; however, the performance data are often inconsistent. as rrbs reads come from known genomic regions, it is less effective and error prone to align them to whole genome. we hypothesize that aligning rrbs reads to the msp <dig> cut fragments and conducting end repair c removal improve alignment speed, accuracy, and methylation measurement. as shown from our evaluation and comparison, these have been demonstrated the case. trace-rrbs performs on the top among most measures. it does not need an adapter trimming step yet conduct end repair c removal to avoid data bias. on the other hand, as the tool creates rrbs reference with sequence adapter attached, users may need to recreate the reference again if different adapter sequences are used, although not common. this is fairly easy with the enclosed setup script.

trace-rrbs is not library preparation dependent. to confirm this, we further downloaded a rrbs and infinium 450 k microarray data for mcf <dig> from the encode project  and conducted the similar analyses as the presented real data. unsurprisingly we obtained very similar results . again, trace-rrbs took the least amount of time for alignment along with bsmap, had intermediate memory usage, and obtained the highest methylation correlation with the methylation microarray data.

adapter trimming is almost mandatory for rrbs data processing as per routine rrbs protocol dna fragments range from  <dig> to 220 bps and sequence reads are generally greater than  <dig> bases. the longer reads than sequenced fragments means a certain percentage of sequence reads are contaminated with adapter sequences that need to be trimmed off for better alignment. there are several ways to deal with adapters.  dynamic trimming of sequence reads according to adapter sequences to remove adapters.  hard trimming to remove a fixed length of sequence from read ends. both are evaluated previously by chatterjee et al.  <cit>  and they validated that adapter trimming is a critical step. however, they also found that if adapter trimming is not done correctly, it can affect alignment and methylation ratio estimation. for example, older version of bsmap  has –c option in alignment that led unexpected 5’ single-base truncation and a  <dig> bp 3’ truncation, which affected alignment dramatically. although the option is removed in the later versions of the tool, it illustrates the detrimental effect of improper adapter trimming. hard trimming too aggressively may remove useful sequences and result in a slight change of methylation estimate. trace-rrbs takes a very different approach to handle adapter sequences. instead of trimming adapter sequences from sequence reads, adapter sequences are attached to each msp <dig> digested reference sequence fragment at both ends allowing reads with adapters to correctly align. as the exact attaching locations of adapter sequences are known, trace-rrbs can ignore them precisely , which can contribute to its better methylation estimate.

as introduced in background section, most rrbs analysis tools create two converted reference genomes for converted read alignment. the conversion reduces sequence complexity from  <dig> to  <dig> letters and the chance of multiple mapping due to less uniqueness of reference genome increases. aligning rrbs reads to converted whole genome with high repetitive regions for species like human has a higher chance of multiple mapping than aligning to limited msp <dig> digested regions. we assessed the uniqueness of the dna fragments in the range of  <dig> to 250 bps generated from msp <dig> digestion  and found  <dig>  % have exact sequences even before converting all cs to ts but after the conversion, the increase is very minimal to  <dig>  %. when sequence reads come from these regions, they would have additional chance to align to other genomic regions  as multi-mapping.

CONCLUSIONS
in summary, we have developed a new method and software package, trace-rrbs, for fast and accurate mapping of rrbs reads and determination of the cpg methylation status of each cytosine locus. it is easy to use and the output of our tools is the standard bam format for alignment. the methylation calls are in an easy-to-interpret format. our comparisons with respect to other popular bisulfite sequencing tools have showed that trace-rrbs outperforms in most measures on the real and simulated data.


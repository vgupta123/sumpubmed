BACKGROUND
since their introduction, microarrays have become an essential technology to measure the expression of thousands of genes in a single experiment. the widespread use of microarray technology required solutions to a number of challenges related to the analysis, storage and organisation of the data. previous reports have detailed considerable progress in genomic scale analysis of complex gene expression data  <cit>  the federation and warehousing of large amounts of data  <cit> , the reproducibility of experiments across platform and laboratory  <cit>  and the definition of standards for presenting and exchanging such data  <cit> .

recently, attention has been focused on improving the annotation of probes and probesets  <cit> . this has been driven by the combination of improved genome assemblies  <cit> , more accurate genome annotations  <cit> , new results describing the extent of transcription in the genome  <cit>  and the recent availability of the actual dna sequences on standard microarrays. indeed since the time of initial probe design on most microarrays, updated genome assemblies and refined transcript structures based on data sources such as full length cdnas, cage  and ditags  <cit>  have made updated probeset annotation critically important. as an example, between ensembl release  <dig> http://oct <dig> archive.ensembl.org and ensembl release  <dig> http://nov <dig> archive.ensembl.org the human genome assembly was updated twice and the number of evidence-based protein-coding transcripts identified by the ensembl genebuild increased by approximately 27% . this increase is especially significant considering that the number of annotated protein coding genes in ensembl actually decreased during this same time frame . accurate knowledge of what expression products the probes and probesets are measuring is fundamental for all downstream analysis in order to ensure accurate biological interpretation of the results.

affymetrix genechips use a variable number of pairs of  <dig> mer oligonucleotide probes to form a probeset representing a target transcript or gene. these pairs consist of a perfect match  probe identical to target transcript sequence and a mismatch  probe where the 13th  nucleotide differs. for a given target transcript or gene, the number of pm-mm pairs varies from  <dig> to  <dig> depending on the genechip. several attempts have been made to either reannotate the existing probesets or redefine probesets from the full set of probes. in both cases, these results are presented in various databases  <cit> . these previous studies are based on the same fundamental assumption that we make, namely that accurate genome annotation leads to better interpretation of gene expression data, and focus on the use of various mapping strategies to investigate ways of accurately matching probesets to the latest genomic knowledge. for example gautier et al have reannotated the affymetrix hg-u133a probesets by mapping the probes against human refseq mrna using the bioconductor package matchprobes  <cit> . most reannotation efforts addressing genechip microarrays have remapped probes, or target sequences to external public databases of expressed sequence. one exception to this approach is dai et al who aligned probes to the genome of the corresponding species as well as to external references for their updated probesets definitions  <cit> .

in this paper, we present and assess our method to map and annotate gene expression arrays, using the affymetrix genechip arrays as an example. in contrast to other methods, we employ direct mappings to both the reference genome and the ensembl gene sets as the basis for the probeset annotation. this feature makes our annotations easily accessible for use with expression of protein coding genes and also with the more complex expression patterns such as antisense or pervasive transcription that have been observed in other studies  <cit> . moreover, the ensembl annotations are conducted in a consistent way across all supported species, and thus do not rely on the completeness of external data resources which are necessarily less complete for some species. ensembl is updated approximately five times each year assuring that probeset annotations incorporate the most recently released datasets.

in the following sections we  describe exactly how probes are mapped and assigned to transcripts,  demonstrate the quality of these annotations and  present the bioinformatics resources to publicly access this information.

RESULTS
the mapping pipeline
annotation of gene expression arrays and associated probesets with an ensembl transcript is a two-step procedure. in the first step individual probe sequences are aligned to the corresponding genome sequence and in the second step probesets having at least half of their probes matching a transcript are annotated with the associated transcript. the ensembl analysis and annotation pipeline uses the exonerate alignment tool  <cit>  and tolerates only  <dig> base pair  mismatch between the probe and the genome sequence assembly. this is justified by previous work which has shown that the perfect match-mismatch  model is a poor model for estimation of non-specific hybridisation and pm-mm intensities should be considered and treated equally  <cit> . descriptions of the probe to genome alignments are stored in the database as either perfect 'full match' alignments or 'mismatch' alignments for those probes that align with only a single base pair difference between the probe and the genome sequence assembly. probes with more than  <dig> bp mismatch are not stored and not used for the second step of the pipeline. finally, probes that align to more than  <dig> locations in the genome, e.g. alu repeats, are discarded even if these are full match alignments. with these simple mapping rules most of the probes are mapped to the genome; on average 94% of probes across all human affymetrix genechips are aligned to the genome with a maximum of one mismatch, the rest of the probes being excluded by one of the above mapping filters . some of the affymetrix genechips show a lower number of probes mapped, although these arrays are generally the "b" chips that contain probesets designed to target est  clusters or other genes with less extensive experimental support at the time of the microarray design  <cit> . indeed, using est clusters as targets could lead to aberrant probesets, for instance ests from distinct genes could be falsely clustered together leading to unusual genomic mapping  <cit> . the alignment results give a first glimpse on the quality of the probes and provide an upper limit on the extent to which probesets can be annotated. the additional file  <dig>  figure s <dig> describes the distribution of the number of probes per number of mappings to the genome. this distribution shows that a majority of probes have few alignments on the genome, generally one or two. probes that map more than twice, but less than  <dig> times  are more likely to be in repetitive regions .

it is important to note that this first step in the ensembl probeset mapping pipeline is independent of the completeness or quality of the genome annotation, but dependent on the quality of the genome assembly. for example, ensembl release  <dig> http://oct <dig> archive.ensembl.org contained both an updated build of the finished mus musculus assembly   <cit>  and a combined ensembl-havana genebuild compared to ensembl release  <dig>  the new assembly alone results in some noticeable differences in the probe mapping as the number of probes mapped to the new assemblies tend to decrease, for example for the mouse430a_ <dig> array the number of probes mapped decreased by  <dig> %  between the ncbim <dig> and ncbim <dig> assemblies. in general, for genomes with multiple assembly updates, such as human and mouse, we observe fewer probes mapping to improved assemblies, which may indicate that correcting assembly errors enhances probe mapping by removing probes designed against lower quality regions of the assembly.

the annotation pipeline
in the second step, we associate probes and probesets from commercial arrays with ensembl transcripts. this step uses the mapping of the individual probes by associating those probes that are part of a defined probeset to a specific transcript. for successful transcript annotation, we require that at least half of the probes of a probeset match the underlying transcript sequence and 3' untranslated regions  if available. the probeset sizes are calculated dynamically using the data available from the array design as for a given array the number of probes for a distinct probeset can vary. in cases where a transcript has a 3' utr predicted based on experimental evidence we use the transcript and we double the length of the 3' utr sequence for the probeset annotation. if a transcript has no 3' utr annotated we extend the 3' most exon. the lengths of the extensions are computed as the greater of either the mean or median of all 3' utrs in the given species. in future ensembl releases, the extension will also be limited to avoid probesets being annotated to genes in close proximity unless there is independent evidence that the utrs overlap. these extensions of transcript sequences are used to compensate for the absence of utrs in some of the ensembl transcript predictions. these occur because each ensembl transcript utr is based on experimental evidence from cdnas, which in some cases can be incomplete leading to shorter or missing utrs. affymetrix probes and microarray probes in general tend to be designed against 3' ends of transcripts  <cit> , mostly on the basis of est evidence from ncbi's unigene. since for most species in ensembl full length cdna sequences are limited, extending the transcript length using a species-specific utr size is a consistent means to successfully map probe sets to ensembl transcripts.

mapping probes to the transcript set - effects on the probeset annotation
in addition to mapping the probes to the genome, we investigated the effect of mapping the probes directly to the set of ensembl transcripts represented as cdnas. mapping probes this way allowed us to assess the extent to which the probes are mapped across exon boundaries. the mapping of probes to cdnas defined by ensembl transcripts adds ~ <dig>  new alignments which corresponds to a ~ <dig> % increase, representing ~ <dig>  distinct probes . indeed some probes map at multiple locations on different genes, such as the probe 39540_at:245: <dig> from the hg_u95av <dig> chip which maps to the ensembl transcript enst <dig> on 19:3999238: <dig>  as well as enst <dig> on 18:43810276: <dig>  on the other hand some probes map to multiple transcripts of the same gene across different exon junctions, for instance the probe 61492_at:216: <dig> on the array hg_u95c maps to two different transcripts enst <dig> and enst <dig> from the same gene ensg <dig> but in slightly different locations. for the transcript enst <dig> the probe maps to the boundaries of exons  <dig> and  <dig>  at the location of 1:242847609: <dig> and for enst <dig> maps to the boundaries of exons  <dig> and  <dig>  at the location of 1:242840250: <dig>  other rare examples are probes mapping across three exons where the central exon is generally a short exon, for instance the probe 207136_at:1089: <dig> from the array hg_u133_plus_ <dig> maps to the transcript enst <dig> on three exons,  <dig> bp on ense <dig>   <dig> bp on ense <dig>  and  <dig> bp on ense <dig>  this  <dig> bp exon has strong supporting evidence from external protein identifiers p <dig>  nm_ <dig> and p36575- <dig> .

mapping probes to transcripts consolidates the probeset annotation description by 18% on average . in other words, for a given probeset more probes are mapped to the genome and used in the annotation. typically, one or two probes map to the boundaries of exons and are used to strengthen the probeset annotation on the genome. however, the probes mapping to transcripts do not generally lead to new probesets being annotated. no additional probesets would pass required 50% transcript-level annotation rule. these results indicate that probes mapping across exon boundaries do not add new probeset annotation to transcripts but consolidate the existing annotations.

effect of updated array designs on probe annotation
the ensembl probeset annotation pipeline is optimised to create a comprehensive gene expression array annotation based on the most current genome sequence and species-specific supporting data. to determine the quality and consistency of our annotation methods we have investigated the reasons why some probesets were not annotated by our pipeline. using our annotation methods and the latest ensembl genebuild, the transcript-level probeset annotation produces diverse results depending on the combination of genome sequence and genechip used. as seen in figure  <dig>  the percentage of annotated probesets seems to be dependant on the probeset design quality. indeed in the latest generation of human expression arrays we annotate about 90% of the probesets, whereas for the "b" chips the percentage drops to about 40%. the design of the human genome u <dig> arrays were represented in  <dig> chips  with the a chip containing probesets designed against full-length transcripts, and the others probesets designed against ests from unigene  <dig>  due to the evolving nature of the biological databases our results indicate that the old generation genechips or "b" chips have a lower annotation quality. for example, the hg_u95b/c/d/e chips have between 30% to 60% of their probesets annotated . interestingly the latest human affymetrix chips hg_u133_plus_ <dig>  do not necessarily have the highest fraction of mapped probesets, as probesets from previous chips have been incorporated in these new arrays.

effect of new assemblies and genebuilds
we examined the effects a new genebuild and genome assembly could have on the probeset annotation  by comparing two gene sets based on the same human assembly as well as gene sets built on two versions of the mouse assembly. both gene sets were released at the same time for ensembl release  <dig> and slightly corrected for ensembl release  <dig>  which allowed us to attempt to separate the difference between updating a gene set on an improved genome assembly and simply updating the gene set without any underlying improvements to the genome assembly. the comparison is especially valid for human and mouse since both assemblies are now of "finished" quality and the amount of supporting information for the genebuilds such as species specific expressed sequences is similar.

the improved human genebuild focused on accurate transcript placement and utr extensions, using both new methods and new data such as ditag information. for mouse, the new genebuild was created on the updated ncbi m <dig> mouse assembly. somewhat unexpectedly our results indicate that increasing the accuracy of the transcript placement in human without a new assembly does remove some probeset annotations as some genes have had their structures improved. between ensembl release  <dig> and ensembl release  <dig> the number of protein coding transcripts in human increased by about  <dig> % , while the number of protein-coding genes decreased . as dai et al described, at the time of the hg-u <dig> design, unigene contained  <dig>  million cdna/ests but now contains  <dig>  million sequences  <cit> . our results show that improved assemblies have a less striking impact on the annotation than do updated gene sets as the new mouse assembly had an average  <dig> % decrease in coverage across microarrays. however, this is potentially modulated by the addition for the first time in the ensembl mouse genebuild  of a combined gene set featuring both the ensembl automatic gene predictions and the havana manual annotations  <cit> . these manual annotations include more than  <dig>  full-length protein-coding transcripts for the mouse annotated by the havana team in addition to the ensembl automatic genebuild. the new ncbi m <dig> mouse assembly is the first update of the finished mouse assembly, and has been a focus of annotation for the consensus coding sequence  project, a collaborative effort to produce a common set of cds annotations of transcripts  <cit> .

comparing ensembl annotation with affymetrix annotation
since the affymetrix annotation is the most widely used probeset definition in numerous gene expression analysis packages including bioconductor, we compared our probesets annotation with the latest affymetrix genechip annotations. the affymetrix annotation includes information from a number of sources depending on the array including sequence information collected at the time of array design, information updated from public databases such as unigene and protein matches from public and affymetrix-created sources  <cit> .

additional file  <dig>  table s <dig> presents how ensembl and affymetrix compare using external accession identifiers common between these two annotations. when using the entrezgene identifiers, the human, mouse and rat chips have between 65% and 95% of entrezgene ids in common between ensembl and affymetrix annotations. these differences could be explained by the specificity of our rigorous external identifier reference mapping procedure that assigns ensembl genes to external references. given that ests from distinct genes could be falsely clustered together, some probesets could target genes with few or non-consistent external experimental references leading to separate annotations between ensembl and affymetrix. however comparing probeset annotation using external identifiers may not be the best approach to assess the performance of different reannotation methods when procedures for mapping external identifiers from public databases to probesets or genes are not common between affymetrix and ensembl. for example affymetrix explains that unigene identifiers are determined using the probeset's representative sequence  <cit> . in the case that the sequence is not found in the current unigene database the most common unigene identifier of the sub-cluster sequences is used. therefore, the unigene identifier detected using such procedure may not be what ensembl uses in the external reference mapping procedure.

probesets annotated to multiple genes
probeset annotation is complicated especially when a probeset may intentionally or unintentionally target multiple genes or transcripts. this multiple gene targeting may be the result of probesets designed against erroneous cdna sequence or chimeric est clusters containing ests from closely related genes or overlapping genes. these probesets may be more likely to exhibit cross-hybridization from splice variants or closely related genes .

to establish the extent to which probesets target multiple genes, we investigated this multiple annotation problem with our pipeline. the results  show that on average about  <dig> % of probesets target multiples genes in human,  <dig> % and  <dig> % in mouse and rat. of the probesets annotated to multiple genes, the vast majority are annotated to only two genes . to investigate this we looked to see if these genes were paralogues or in close proximity to each other, or both. our results in show that for about 60% of cases we can explain why these probesets end up annotated to multiple genes, by targeting paralogous genes or close tandem gene clusters . however for the remaining 40% there is no obvious biological explanation why these probesets are annotated to multiple genes, as those genes are not located in close proximity and are not paralogous . these results demonstrate that probesets targeting multiple genes can be separated in two groups, a major group targeting genes with strong sequences similarities or close proximity, and a group of probesets targeting genes without clear biological evidence.

allele-specific probes and mismatches
previous reports have suggested that the response of 30% to 40% of probesets on human genechips could be affected by single nucleotide polymorphisms  creating allele specific probes  <cit> . we investigated the proportion of allele specific probes in human, mouse and rat genechips using the ensembl variation databases  <cit>  . for all the probes mapped by our pipeline, and across all human, mouse and rat affymetrix microarrays, our analysis indicates that about  <dig> %,  <dig> % and  <dig> % respectively map at a genomic location where one or more snps are located . this corresponds to approximately  <dig> %,  <dig> % and  <dig> % probesets being affected by one or more snps for the three species, which confirms dai et al findings. this fraction is certain to be a lower bound on the number of probesets with potential allele specific responses as ultra high throughput sequencing technologies enable rapid genome resequencing and variation discovery  <cit> . although our mapping pipeline aligns affymetrix pm probes to the genome allowing one mismatch, all pm probes should theoretically align to the genome without a mismatch. interestingly our results suggest that 20% of the affymetrix pm probes hit the genome with a mismatch . these pm probes have the potential to represent a mm probe if the mismatch is on the 13th base pair of the probe. as our pipeline allows a mismatch in the entire length of the pm probe, it may be possible that corresponding mm probes could have two mismatches. with these probes it became difficult to differentiate functional differences between mm and pm probes. for example, harbig j et al  <cit>  have found the presence of  <dig> mm probes in the hg_u133_plus_ <dig> array that are a perfect match for some human transcript. further work has analysed differences in pm and mm probe intensities, and some background adjustment algorithms such as rma or gcrma have been developed for using pm intensities only, hence omitting problems associated with mm probes  <cit> . here our results provide further evidence that some pm probes include one mismatch base pair, that the corresponding mm probes could contain more than a mismatch and thus mm intensities should be carefully considered in the array background correction.

data access
updated array annotations are provided as necessary with each ensembl release  <cit> . whenever a new assembly becomes available or a new gene set is produced, the probeset mapping and annotation is recomputed to present the most up-to-date and consistent probeset annotations. all gene expression array probes and probeset annotations are publicly accessible through a range of tools described below.

web display
the individual probes that are mapped to the current assembly for a given species are displayed along the genome assembly . if not displayed by default, microarray probeset tracks can be switched on in the "detailed panel" tab from the configuration popup menu available from "configure this page" link on the left panel. clicking on a particular probe in a probe set track displays a pop-up window, which reports the 'probe length', the 'match length', as well as the 'match status'. the 'featureview' page displays in detail the probe mapping and probeset annotation data using three panels, a karyotype panel showing the genomic locations of individual probes, an information panel with probe mapping details including genomic coordinates, mismatch status, array name and finally the probeset annotation panel with the ensembl gene and transcript associated with this probeset. finally for or more detailed information, the gene and transcript pages display a comprehensive list of probesets and arrays associated with the given gene/transcript.

data mining: ensembl biomart, biomart.org and biomart
biomart  <cit>  is a data-mining tool to efficiently extract information from structured databases. ensembl's biomart includes the probeset annotations and is updated along with each ensembl release. this can be used to access ensembl genes and associated probeset annotations according to the user's specifications without any programming knowledge  <cit> . an example biomart query to fetch affymetrix genechip hg_u133a_ <dig> probesets annotation is as follows:

 start: select the ensembl gene database then the species of interest, for instance homo sapiens.  filter: apply the filter "with affy hg u133a  <dig> id: only" in the id list limit panel.  attribute: select the output needed, for example ensembl gene id, ensembl transcript id, and the name of the microarray of interest affy hg u133a  <dig>   results: hit the button "results" to overview of the output before final export. not using the id list limit filter will output genes linked to probesets and also genes without probesets annotation.

for r/bioconductor users, the package biomart  <cit>  connects to the biomart databases to fetch the latest ensembl annotation directly into the r console. an example of a biomart query to fetch affymetrix genechip hg_u133a annotation would be:

>library

>human_mart <- usemart

> affy_hg_u133a_ensembl_annotation = getbm, filters = "with_affy_hg_u133a", values = c, mart = human_mart)

> affy_hg_u133a_ensembl_annotation 

   affy_hg_u133a hgnc_symbol ensembl_transcript_id

350   205486_at   tesk2   enst00000372084

351   215662_at   mmachc   enst00000401061

352   211774_s_at   mmachc   enst00000401060

353   211774_s_at   mmachc enst00000372082

354   219843_at   enst00000401059

355   215903_s_at   mast2   enst00000372009

the ensembl perl api
ensembl maintains a comprehensive set of perl apis, which permit the programmatic retrieval of data from the databases. using the api, there are different routes to access our probe mapping and probeset annotations. one is to retrieve genomic mappings using the probefeatureadaptor which will fetch all the probes aligned to a given region . an ensembl perl api example script is available as an additional file  where other methods are described. also we store in the database the reasons why a particular probe was not considered for a transcript annotation .

discussion
recent studies have shown the need to regularly and automatically re-annotate gene expression probes and probesets  <cit> . we show that aligning probe sequences to reference genome assemblies followed by association of mapped probes to the latest ensembl genebuild leads to precise and consistent microarray annotation across species, with differences largely due to the quality of the underlying genome sequence assembly. the strength of the ensembl probeset annotation pipeline lies in its simple genomic mapping rule rather than mapping consensus sequences to external databases  or relating probe identifiers to public database identifiers. with our non-restrictive probe alignment procedure, we keep and show probes located in non-coding regions, but also probes and probesets mapping to multiple locations. this is done to illustrate the potentially complex nature of annotating or designing a probeset. we believe researchers should be able to access the most comprehensive set of gene expression array annotation in additional to information suggesting a probe or probeset incorrectly targets a region or another gene.

in most of the published studies, probes or reference sequences were mapped against external databases or transcripts using strict alignment rules  <cit> . for example, to generate reorganized probesets based on unigene, dai et al applied a list of seven mapping steps, including steps for removing probes mapping to multiple cdna/est sequences, probes mapping to more than one location on the genome, and probes mapping in non-coding regions  <cit> . in order to understand the problems encountered for some probesets, researchers should be able to access the quality of probe mappings for their downstream analysis.

while a majority of probesets are perfectly mapped to the genome and annotated to one gene and a few transcripts , a substantial number of probes and probesets present some difficulties in the mapping and annotation to transcript. in their studies dai et al described in detail numerous problems confronted in the genechip probeset annotation; probeset redundancy, non-specificity of probes, genomic location issues and unreliable consensus sequences. a potential cause of these problems could be erroneous unigene clusters used in the probeset design, for example old merged unigene clusters. our mapping pipeline retains genomic mappings with one mismatch regardless of the location on the genome, or multiple mappings . in spite of our fairly non-restrictive mapping procedure, our results reveal that not all probes of a microarray align to the genome  as some are non-specific with mismatches greater than one base pair whilst others have significant mapping to multiple locations .

while some probesets potentially target multiple genes , some probesets have been designed to specifically target a single gene. sometimes these target a neighbouring gene as well and lead to ambiguous annotations. stalteri et al examined in detail the problem of multiple probesets mapping to the same gene  <cit> . they specifically studied a single case, the affymetrix moe <dig> chip and the genes surf4/surf <dig>  which are located in a tail-to-tail conformation on mouse chromosome  <dig> . for this microarray, affymetrix identified eight probesets targeting the surf <dig> gene. however, after careful alignments stalteri et al found that five probesets actually target the surf <dig> gene, two probesets target the gene surf <dig> on the opposite strand, and one probeset maps to a different chromosome. for these eight probesets, ensembl essentially replicates the manual annotation of stalteri et al. we correctly annotate the five probesets to surf <dig> and the probeset found to be targeting chromosome  <dig>  the remaining two probesets, which stalteri et al annotate to surf <dig> are mapped in the same genomic location by our procedure, but we annotate only one of the two probesets to surf <dig>  this difference is due to stalteri et al's reliance of an alternative splice acceptor site on exon  <dig>  where one of the probeset mapped. this alternative splice site is not included in the current ensembl gene set because is not supported by the protein evidence we used.

some studies  <cit>  have brought probeset mapping into another level in redefining complete probesets based on where probes aligned on transcripts. new probeset definitions regroup probes that consistently map to a set of transcripts or a single transcript variant. in their example with the probeset "33631_at" from hg_u95av <dig>  lu, et al demonstrates how a set of  <dig> probes could be redefined in two distinct probesets, a probeset of  <dig> probes and another of  <dig>  <cit> . their probeset redefinition is then be used to measure specific transcript differential expression. the ensembl probeset annotation pipeline does not produce probeset redefinitions, but use the manufacturer's original design. however, using the ensembl api, researchers could use the genomic probe mapping information and the ensembl transcript predictions to redefine probes into new custom probesets.

while this paper focused on the affymetrix genechip probesets to describe our procedure to map and annotate gene expression arrays, our pipeline is also implemented to annotate arrays made by other manufacturers, including both illumina and codelink expression arrays.

CONCLUSIONS
our method to map microarray probes and annotate probesets to the latest ensembl gene sets provides a consistent annotation of gene expression arrays available to researchers. for some arrays a substantial number of probesets cause problems but these issues have been identified and are taken into account by our annotation methods. however, with the recent advances in functional elements identification and the massive parallel sequencing technologies our understanding of the genome and transcriptome is evolving. consequently, regularly updating our probe set annotation based on the latest genome assembly and gene predictions will continue to improve the analysis and understanding of gene expression arrays.


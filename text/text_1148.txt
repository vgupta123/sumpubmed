BACKGROUND
the connections from the retina are topographically organised into maps in the brain, meaning nearby cells in the retina project to neighbouring cells in each target structure  <cit> . to study the connectivity of the retina and its targets we need a reliable system to specify retinal locations precisely. this is complicated by a lack of visible retinal landmarks that are consistent between individuals. furthermore, the curvature of the eye means we cannot simply represent a location on the retina in cartesian coordinates, as this would lead to distortions.fig.  <dig> example mouse eye at postnatal day p <dig> with a retinal injection. a, b bright-field images of the intact retina, view from top and the side.  <dig> retinal rim.  <dig> optic disc.  <dig> dye injection. c flattened retina. four nasal, temporal, dorsal and ventral cuts  were made to flatten the retina. the injection site is visible as a claret-coloured mark  on the retina. scale bar 1 mm. nasal  and dorsal  directions are marked



the retinal projections to the brain have been studied extensively as a model system for self-organisation of the brain . the most widely-used technique to analyse retinotopy is to inject a dye into a small region of the eye to label a region of the retina . the dye is then transported through retinal axons to label target structures . although this method is over twenty five years old  <cit> , it is still commonly used today  <cit> . a common alternative for assessing retinotopic map order is to use imaging techniques  <cit> . however, these imaging methods require the retina to generate visual responses, around postnatal day  <dig> in mouse, by which time the mouse retinocollicular map has already been established.fig.  <dig> illustration of projection method. the two end points of the nasal cut  are connected by a line, the centre of which is defined as the nasal pole . the same procedure is repeated on the temporal side, and the nasal  and temporal  poles are connected by a line . the centre of the injection site  is projected onto the nasotemporal axis, and the fraction of the distance is calculated as |na|/|nt|, where |na| is distance between n and a, and |nt| is distance between n and t. scalebar 1 mm. nasal  and dorsal  directions are marked



to determine the location of the dye injection in the retina, it is dissected out and flattened so that it can be imaged   <cit> . this is a delicate procedure and the flattening causes distortions and tears in the retina. the retinal location of the injection is then estimated from the image using the projection method  <cit>  or retistruct  <cit> . in the projection method the location of the nasotemporal axis is first estimated based on the vestigial nictitating membrane at the nasal pole, and then the location of the injection site is projected onto the nasotemporal  axis. the injection location is reported as a fraction of the nt axis, measured from the nasal pole . the dorsoventral axis is calculated by orthogonal projection of the nt axis. this projection method uses a cartesian coordinate system to describe a curved surface, which leads to distortions. to address this issue, the retistruct program  <cit>  was developed recently independently from earlier work using relaxation techniques  <cit> . retistruct refolds the retina back onto a sphere to try and recover the original geometry. internally it minimizes an energy function such that the stretching of the surface is as small as possible. using retistruct’s mapping of the flat image onto the sphere the injection site can be specified in the native three dimensional coordinates of the eye without distortions due to incompatible coordinate systems.

retistruct is a significant improvement over the projection method, however, it still requires the retina to be dissected out and flattened. it also requires manual labelling of the outline of the retina. here we propose a method that bypasses the need to dissect out the retina from the eye. instead of using one image of the flattened retina, the intacteye method uses two orthogonal images of the intact retina. with the help of two user-placed wire-frame spheres that are aligned with the pictures of the eye, intacteye can calculate the location of the marked injection site in the 3d coordinate frame of the eye. the accuracy of the intacteye method compares well with both the projection method and retistruct. by avoiding the retinal ex vivo flattening, the acquisition is faster and we also reduce measurement artefacts and increase reproducibility and reliability. the intacteye method is developed with the retina in mind, but we solve a general problem of locating a point in a three dimensional sphere from two images, which could have applications outside neuroscience.

implementation
in the first section we describe how to use the intacteye method. we then describe the animal procedures used, and describe two other approaches of analysis that we compare to the intacteye method. we also describe the new wedge coordinate system used to define the location of the retinal injection. the last section describes the verification of the intacteye method using both known experimental retinal landmarks and synthetic data.

installation
intacteye is free to download from  <cit> . an archived version of our program is also available from http://dx.doi.org/ <dig> /m <dig> figshare. <dig>  the zip file contains the source code and some example images. this article acts as the main documentation for the program. unpack the zip file, then start matlab. in the matlab gui click the “set path” icon, and add the intacteye directory to the path. alternatively this can be done from the command line by executing addpath; savepath.

preparation of images
to localise a retinal injection using intacteye two images of the intact retina, with the injection site visible, must be prepared. we suggest one taken from the top looking down at the iris, and a second one taken from the side. for mouse we recommend a small cut at the vestigial nictitating membrane as a nasal marker. make sure this cut is visible in at least one of the two images. the two images can be loaded separately or as a part of a composite image. the software reads images in tiff, png and jpeg format. the images need to have the same magnification and either have the same height or width so they can be automatically merged.

how to use the software
a video of the following four-step procedure can be found on youtube  <cit> .

step  <dig> open up matlab and type intacteye to start the program. in the user interface click “load image”. this brings up a dialog box to select which composite file to load. alternatively, “load images” allows you to load the two views from two separate files. the images of the eye are displayed with two wire-frame spheres overlaid. the “left eye”/“right eye” button lets the user select if it is a left or right eye that is being analysed; this switches the dorsoventral  axis accordingly.fig.  <dig> screenshot of intacteye being used used to mark up the eye and injection. the two images have a wire-frame overlaid such that the axes can be reconstructed.  <dig> load image.  <dig> reload a previously saved file.  <dig> toggle left and right eye coordinate system.  <dig> slider to rotate the eye around the centre axis in top view.  <dig> hide wire-frame for top view.  <dig> reset top view. 7– <dig> same as 4– <dig>  but for side view.  <dig> slider to adjust rim angle .  <dig> mark injection in top and side views.  <dig> estimate area of injection side from top or side view. slider adjusts threshold.  <dig> save results to mat file and export figures.  <dig> controls to generate synthetic data and verify user accuracy on the synthetic data.  <dig> flat view of injection site location, showing spherical coordinates. the red dot is centred on the location and drawn to scale to reflect the approximate area of the injection.  <dig> retinal rim.  <dig> injection location. coordinate axes of the nasal and ventral axis are shown. as a visual guide the axes lines are shown as solid if they are above the image plane, and dashed if below it. the optic disc is visible close to the centre of the eye in the top view. a thin white line just under has been drawn by the experimentalist in the image to mark the nasal injection site, barely visible under the nasal axis in the top view




step  <dig> using the computer mouse, the wire-frame spheres can be interactively resized and repositioned . the left mouse button is used when the sphere is resized  or moved . the right mouse button is used when rotating the wire-frame sphere. there are also two sliders to adjust the rim angle and rotate the eye around its central axis. if a nasal cut was made, it must be aligned with the nasal marker. the wire-frame spheres can be temporarily hidden by clicking the “hide” button. clicking the button again shows the wire-frame spheres. if the nasal cut is only visible in the top view, then the injection can sometimes be used to help align the second sphere.

step  <dig> once the spheres match the images of the eye, the next step is to mark the injection site. start by marking it in the top view by clicking “mark top” and then clicking on the injection location. a line is then displayed in the side view with the possible locations. click “mark side” and place a mark in the side view and the program computes the nasal and dorsal positions.

step  <dig> click “save” to create a mat file with the eye image as well as the location of the wire-frame and injection. this information can be accessed by using the “reload” button to return to a previously saved state. the “export figure” button saves a 2d picture of the injection location  in polar coordinates, as well as an image with the wire-frame spheres overlaid on the original images.

experimental protocol
to test the intacteye method we collected two sets of retinal images from mouse. first we dissected out and imaged the intact retina, then we performed additional dissection to acquire images of the flattened retina that could be analysed for comparison.

c57/bl6j mice were housed at the chronobiotron, cnrs ups  <dig>  strasbourg, under a 12/12 h light/dark cycle. all procedures were in accordance with european community  guidelines. official agreement number for animal experimentation was  <dig>  . standard laboratory rodent food and water were available ad libitum.

neuronal lipophilic tracer injection and dissection procedure were performed as previously described  <cit> . small volumes  of  <dig> -dioctadecyl- <dig> , <dig> -tetramethylindocarbocyanine perchlorate  were injected in the left retina of p7-p <dig> c57/bl <dig> mice. dii was dissolved in dimethylformamide, loaded into a pulled glass pipette, and pressure injected into the retina using a picospritzer. after  <dig> to 18 h, animals were euthanized by a lethal dose of pentobarbital , perfused with 4 % pfa and decapitated. the head skin was removed and a cut was made at the level of the nictitating membrane  indicating the nasal pole of the retina. oculomotor muscles were then cut and fine tilted forceps were used to enucleate the eye. cornea, sclera and pigmented epithelium were then delicately removed using tweezers, revealing the retina. the intact retina was then photographed from a top-down and a side view, showing the injection site  using a zeiss binocular coupled to digital camera. these can then be analysed using intacteye.

the projection method  and retistruct both require additional steps to be performed. for flat-mount dissection , cardinal cuts  were performed according to the original nasal cut. the retina was then flattened on a coverslip and mounted onto a glass slide. a picture at low magnification of the full flat-mounted retina was taken using zeiss axioskop  <dig>  these flattened images can then be used with the projection method or retistruct.

projection method
the projection method  <cit>  is a standard method used to estimate the location of the nasotemporal axis based on the nasal cut and the optic disc . in the image of the flattened retina, the two nasal points  that were separated by the cut are reconnected by a straight line. the middle of this line is defined as the nasal pole . the same procedure is applied to find the temporal pole . a second line is drawn from n to t. this line , which runs from the nasal pole to the temporal pole via the optic disc, defines the nasotemporal axis. the injection location is projected onto this line and the position  reported as a fraction of the whole nasotemporal axis .

retistruct method
the retistruct method  <cit>  is used here as a control to evaluate our method. retistruct’s starting point is a flattened retina. the user provides the algorithm with a mark-up of the periphery of the retina indicating where the cuts and tears were. this information is used to fold the flattened retina back onto a sphere. the refolding takes into account the rim angle and is done so as to minimize the amount of stretching and compression of the retinal image. the location of the injection is then calculated in the native 3d space of the eye.

intacteye method
fig.  <dig> the wedge coordinate system. the coordinate of each point can be found by taking a plane through the nasal pole , temporal pole  and the point of interest . the intersection of the plane and the sphere forms an arc . the nasotemporal coordinate is the fraction  of the distance along the arc from the nasal to the temporal pole. the rim angle  is used when calculating the wedge coordinates. the dorsoventral coordinate is defined analogously



by using two images taken from different angles, the location of an injection mark in an eye can be found without flattening the retina. to estimate the view angle for each of the images, the user needs to indicate where the eye is positioned and which way it is turned. this is done by placing a wire-frame eye-ball over the image of the intact retina. the controls in the program allow the user to rotate the eye along the three axes and to adjust the lengths rx, ry and rz of the semi-axes of the ellipsoid. the rim angle  of the eye-opening is manually adjusted to improve the fit between the wire-frame model and the image of the eye. by marking the position of the injection in the top image , the location of the injection site can be narrowed down to a line segment between p1= and p2= perpendicular to the imaging plane, where rmax is the largest radius of the ellipsoid. the view transform is  <dig> t=trota+ttrans, where for rotation ϑx,ϑy,ϑz around the x, y, z-axis the rotation matrix is  <dig> trot=1000cosϑx-sinϑx0sinϑxcosϑxcosϑy0sinϑy010-sinϑy0cosϑycosϑz-sinϑz0sinϑzcosϑz <dig> and ttrans is a vector. the inverse transform is  <dig> t-1=trot- <dig> and the line representing possible locations for the injection in the eye frame runs from q1=t- <dig> to q2=t- <dig>  by plotting this line in the second view overlaid on the eye, we can quickly establish which point in 3d space corresponds to the injection. this method relies on accurately placing the two wire-frame eyes on top of the real images.

internally the program stores the coordinates of the injection  in cartesian coordinates in the coordinate frame of the eye . the program also stores the viewing transforms for each of the two views, which tracks the 3d rotation and the translation of the spheres.

wedge coordinate system
a coordinate system which defines arcs running from the nasal to the temporal poles, along which the fractional distance f from nasal to temporal can be measured. a fractional distance from the dorsal to the ventral poles can be defined analogously. this section is presented for information only; the user can use the program without studying the new coordinate system.

assume the retina is oriented as shown in fig.  <dig>  with the rim lying at a colatitude of ϕ <dig> measured from the south pole. each point on the surface of the curtailed sphere can be reached by a system of coordinates  where ψ is the angle to the vertical made by a plane passing through the nasal and temporal poles and f is the fractional distance along the circle defined by the intersection of this plane and the curtailed sphere. assuming a sphere of unit radius, the forward transformation from wedge coordinates  to cartesian coordinates  is:  <dig> x=ρsin)y=y0-ρsinψcos)z=z0+ρcosψcos) where  <dig> ρ=sin2ϕ0+cos2ϕ0cos2ψy0=-sinψcosψcosϕ0z0=-sin2ψcosϕ0α0=-arcsincosϕ0ρ here ρ is the radius of the circular arc whose centre is , and α <dig> is the value of the angular parameter along the circle at the rim.

to invert  back to  the following equations are used:  <dig> ψ=atanv=-sinψ+cosψα=atanf=/ where  <dig> atan=arctan-πifx> <dig> y<0arctan+πifx> <dig> y>0arctanotherwise internally, intacteye uses cartesian coordinates, and the inverse transformation  is used to generate the output. the forward transformation  is given as reference.

injection area estimation
as well as reporting the location of the centre of the retinal injection, the area can also be estimated from either the top view or the side view, as long as the entire injection site is visible. intacteye automatically converts the image from rgb into the l*a*b* colour space, which has one value for lightness and the other two for colour hues. the lightness value is discarded. if the injection centre in the image is located at  then the distance in colour space for a pixel at  is calculated as  <dig> dijpq=2+ <dig> where aij, bij, apq, bpq are the hue values. the image is thresholded  so that only the parts with similar colour hue to the injection centre are selected. to find the corresponding points on the sphere, intacteye takes a line through each injection pixel, perpendicular to the image plane, and finds its intersection with the eye ellipsoid. this is done by calculating  <dig> v=absx2/rx2+y2/ry2+z2/rz2- <dig>  for  <dig> points on the line, and picking the one with the smallest v. the fraction of the total area of the eye is reported as the injection size. the injection area is calculated using matlab’s built in alpha hull  <cit>  function ; this functionality requires matlab version 2014b or newer; older versions of matlab will not calculate the area of injections, but can still calculate the location.

synthetic data
we generated a set of synthetic data to train the user, and also to verify the accuracy of the method. the length of the semi-axes of the ellipsoid representing each eye are drawn from a normal distribution , corresponding to a p <dig> mouse eye  <cit> . the rim angle defining the opening was sampled from a normal distribution . for the top and side views, the view angle and location was varied approximately within a range of ±20∘ around the x and y axis  and freely rotating around the z-axis. the nasal cut was marked with a m. the location of the injection centre  was randomized from a uniform distribution. the injection site was represented by  <dig> points, with spherical coordinates sampled from a normal distribution centered on the injection centre, and with standard deviation 6∘. any points placed above the rim were discarded. three observers were asked to estimate the location of the centre of the injection site in synthetic data. the user-provided location and the known location were then compared.

locating the optic disc
by using the location of the optic disc as a known landmark close to the geometric centre of the eye  <cit>  we can estimate the accuracy of the retistruct and intacteye. images where the optic disc was not clearly visible were excluded from this verification step.

RESULTS
we have created a software package named “intacteye” to calculate the location of a retinal injection from two orthogonal pictures of an intact retina. intacteye lets the user manually place two reference wire-frame spheres on the images of the eye. the program reports the nasotemporal and dorsoventral coordinates of the injection as a fraction along the respective axes using our wedge coordinate system . the injection size is reported as a fraction of the area of the retina.fig.  <dig> comparison of nasotemporal and dorsoventral coordinates for retinal injections derived from three different methods. a the coordinates on the flattened retina from the projection method are shown on the x-axis and the nt coordinates on the spherical eye from both retistruct and the intacteye method are shown on the y-axis. b as in a, but for the dv axis. points estimated from the same eye are shown in the same colour and connected by a thin grey line. the diagonal line shows the case when the coordinates in the flat and spherical coordinate system agree






to compare intacteye with the projection method and retistruct, a set of wild type mouse retinas  which had been imaged both before and after flattening was analysed. fig.  <dig> compares the position estimates from the three methods, for the nasotemporal axis  and the dorsoventral axis . we see that there is a good correspondence between all three measures, but there is a larger variation in the dorsoventral coordinates than in the nasotemporal coordinates . for the projection method the nasal cut and flattening will cause a larger distortion of the dorsoventral axis than the nasotemporal axis due to the direction of the cut.fig.  <dig> estimating the precision of the intacteye method by locating the optic disc. the optic disc is located in the centre of the eye and was visible in  <dig> out of  <dig> retinas. for each of the six retinas, the optic disc location was estimated in polar coordinates using intacteye  and retistruct . lines connect two estimates from the same retina. in all six cases, the optic discs were located within 2∘ of the geometric centre; by comparison the rim is located at 127∘ and so the error in locating the optic disc was under 2 %



we assess the accuracy of the intacteye using two methods. first we used the location of the optic disc, a known retinal landmark. the optic disc was visible in six out of eleven images investigated. by marking the optic disc in the images using intacteye we estimated the location as 49±1%  nasotemporal and 49±2% dorsoventral . this is comparable to the results from retistruct when applied to the same retinas: 48±1% nasotemporal and 51±2% dorsoventral .fig.  <dig> verification of intacteye using synthetic data. a example of synthetic data used in the test. the injection site is represented by  <dig> randomized points sampled from a normal distribution centred around the injection site. the nasal cut is marked with the letter m. b, c known nt/dv coordinates of synthetic injections plotted against user-estimated nt/dv coordinates from intacteye. vertical black lines indicate deviation from correct location



we also created synthetic images of eyes with label injections where the exact location was known. this allowed us to assess the variability with the intacteye method that comes from fitting the spheres to the image of an idealised eye. three observers each marked a unique set of synthetic data. figure  <dig> shows the known nt  coordinates on the x-axis and the corresponding estimates on the y-axis. we see a good correspondence between the true location and the estimated position in the synthetic data . these images are relatively clean, lacking deformations of the eye and imperfections such as debris and limited depth of field. however, it provides us with images where the centre of the injection is known and allows us to test misalignment of the wire-frame spheres onto the images of the eye.

limitations
each point that is localised using intacteye must be uniquely identified in both images of the retina. because of this limitation the intacteye method is best suited for finding single injections and other distinct landmarks. if more than one distinct region is labelled with the same dye, it may be difficult to uniquely identify the same region in the two different images. this is known as the correspondence problem in stereo vision  <cit> . this may limit the use to anterograde injections where the retinal marking is focused. for retrograde injections in animals where the label is spread over a large region of the retina , it is currently better to dissect the retina and then use a program like retistruct, which analyses the entire retina and can generate density estimates.

future work
by using the intacteye method we can locate the centre of a single injection from images taken from any two distinct views where the injection is visible. the program currently only tracks one injection, but could be extended to handle multiple injections of different coloured dyes. this, together with the area estimation, might allow the processing of focal retrograde injections as well, as long as they are wholly visible in the images, potentially by allowing for additional views of the retina.

the manual placement and alignment of the wire-frames takes a few minutes, and is a candidate for automisation. however currently the time-intensive part is the data acquisition; for example dissecting out the retina and flattening procedures takes 10–15 min.

an alternative method to our current problem of locating an injection site might be to image the entire eye to generate e.g. a z-stack of images. although this would avoid the need for any retinal dissection, it does not in itself solve the subsequent problem of registering the retinal location in a standard coordinate space. therefore, generating volumetric images of eyes would not allow the injection sites to be compared meaningfully with each other. by contrast, if a z-stack is already available for an eye, it should be possible  to extract two orthogonal images suitable for our program.

CONCLUSIONS
we have developed a method that uses two images of an intact retina to derive the location of a retinal injection. this bypasses the need to cut and flatten the retina, improving the accuracy of the localisation as the tissue undergoes less distortion, and saving the experimentalist time. by analysing the data in a coordinate system native to the shape of the eye, we avoid the problem of representing a spherical structure in a flat coordinates. to verify our results we analysed the data in three different ways. we found good correspondence between the coordinates of our intacteye method and of retistruct, which uses flattened images and then folds them back onto a sphere. both methods produce coordinates in the native curved space of the eye. we have solved the abstract problem of deducing the location of a point on a spherical object from two images, and implemented it for our use analysing mouse retinae, where there are no discernable landmarks for orientation within the retina. it can however be used in other species where retinal landmarks are available, such as the corneal marks in goldfish. furthermore, this technique might have clincial applications to human retinas, where a reliable coordinate system is required for describing retinal locations, based for example on mri images. finally, as our approach is to treat the retina as a simple geometrical, rather than neuronal object, we imagine this technique can be applied straightforwardly to a wide range of fields outside of neuroscience.

availability and requirements
project name: intacteye. project home page: http://github.com/hjorthmedh/intacteye. archived version available at: http://dx.doi.org/ <dig> /m <dig> figshare. <dig>  operating system: any platform that runs matlab 2014b or later . programming language: matlab. other requirements: none. any restrictions to use by non-academics: gpl/mit.

abbreviations
nnasal

ttemporal

ddorsal

vventral

ntnasotemporal axis

dvdorsoventral axis

michaël reber and stephen j. eglen contributed equally to this work

authors’ contributions
jjjh and dcs designed the algorithm. jjjh wrote the code. es and mr performed the experiments. jjjh, es, mr, sje evaluated the technique. jjjh, dcs, es, mr, sje wrote the manuscript. all authors read and approved the final manuscript.


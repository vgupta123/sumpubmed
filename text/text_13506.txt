BACKGROUND
one of the great challenges facing the omics community is that posed by intra-sample heterogeneity   <cit> . molecular profiles derived from complex tissues such as blood or breast represent averages over many different cell types. since cell-type composition of complex tissues varies in response to phenotypes such as cancer or age, correcting for changes in tissue composition could be crucial if one wishes to identify potentially causal alterations in individual cell-types  <cit> . this is particularly relevant for epigenome-wide association studies  where the effect sizes of interest could be small compared to changes in tissue composition  <cit> . because of this, a number of different ish deconvolution algorithms for genome-wide dna methylation data have recently been proposed . as with the analogous tools developed for mrna expression data  <cit> , these algorithms can be classified as either “reference-free”  <cit>  or “reference-based”  <cit> , depending on whether they use an a-priori database of cell-type specific dna methylation  reference profiles to perform the deconvolution. although reference-free methods have the advantage that they don’t require such a dnam database and are therefore applicable, in principle, to any tissue-type, these algorithms have only been tested in blood and don’t provide sample-specific absolute estimates of cellular proportions. obtaining absolute estimates of underlying cell-type proportions in a tissue is an important task, as shifts in specific cell subtypes within the tissue could be used for diagnostic or prognostic purposes  <cit> , as well as providing useful mechanistic insight into systems medicine  <cit> . a further problem with reference-free methods is that they often rely on the assumption that the top components of variation correlate with cell-type composition, an assumption which may not always hold, and which if violated could lead to loss of biological signal. indeed, a clear example of this can be seen in a study which used a reference-free method called ewasher  <cit> , concluding that only a handful of cpgs are differentially methylated between breast cancer and normal breast tissue, clearly contradicting all the available evidence that dna methylation differences between breast cancer and normal tissue is widespread and largely independent of changes in tissue composition  <cit> . thus, reference-based approaches appear to be the safest option provided one can construct a reference dnam database for the tissue of interest. as representative dnam profiles for all human normal cell types accrue  <cit> , reference-based methods are therefore more likely to become the framework of choice for tackling the ish problem.

so far however, only one reference-based algorithm  has been proposed for dnam data  <cit>  . houseman’s algorithm performs inference using a quadratic programming technique known as linear constrained projection , where non-negativity and normalization constraints on cellular proportions are imposed during inference. interestingly, in the gene expression context, a recent comparative study concluded that cp is outperformed by a non-constrained reference-based approach which relies on the technique of support vector regressions   <cit> . another technique based on robust partial correlations   <cit>  has also not yet been explored in the context of dna methylation data. thus, there is an urgent need to conduct a comprehensive comparative evaluation of different reference-based deconvolution algorithms. here, we perform such a comparison using experimental as well as computationally generated cellular mixtures, and including epithelial cell-types as well as leukocytes.

the importance of the reference database itself for the quality of the inference has also been noted before  <cit> . motivated by this, we here present a novel approach for the construction of a reference dnam database, which integrates prior biological knowledge of cell-type specific sites with cell-type specific dna methylation. specifically, given that dnase hypersensitive sites  are highly cell-type specific  <cit> , we use such dhs data from the nih epigenomics roadmap  <cit>  and encode  <cit> , to improve the quality of the reference database. sample-specific cell-type proportions can then be estimated using either houseman’s cp algorithm or a non-constrained approach such as svr or rpc.

we show that incorporation of such prior biological knowledge can improve inference, and that houseman’s algorithm is only optimal in the scenario of very noisy data. for realistic noise levels, we discover that non-constrained methods like rpc generally perform better. hence, we propose an improved novel framework for reference-based inference of cell-type composition, called epidish , which uses  dhs data from the nih roadmap and encode to construct a reference dnam database, and  rpc for estimation of cell-type proportions.

methods
reference-based algorithms for deconvolution of intra-sample heterogeneity
we considered a total of  <dig> different reference-based algorithms. reference-based means that each of these algorithms models a dnam profile of any given sample as a linear combination of a given set of reference dnam profiles representing underlying cell-types present in the sample. given a number c of underlying cell-types, each with a dnam profile b
c, and denoting by y the dnam profile of a given sample, the underlying model is y=∑c=1cwcbc+ε the general idea is to estimate the weight coefficients in a least squares sense, but restricting to a subset of cpgs that are highly discriminative of the underlying cell subtypes. assuming that the reference database contains the major cell-types present in the sample y, one may assume that ∑c = 1c
w
c =  <dig> . the  <dig> algorithms differ in how the normalization constraint is implemented:

for  <dig> algorithms, the constraint that weights have to be non-negative and add to  <dig>  is implemented a posteriori, i.e. after inference of the weights themselves. specifically, we follow the procedure implemented in  <cit>  and set any negative weight estimates to zero, followed by a scaling to ensure that the non-zero positive weights add to  <dig>  the  <dig> algorithms which enforce the constraints a posteriori are  multivariate linear regression or partial correlations ,  robust multivariate linear regression or robust partial correlations  and  support vector regressions , an advanced form of robust penalized multivariate regression. in the case of svr, we used the implementation called cibersort  <cit> . for lr and rlr/rpc we used the lm and rlm r-functions , to perform the multivariate regressions.

the 4th algorithm performs the inference of the weights in a least squares sense but imposes the positivity and normalization constraints as part of the inference process. this technique is known as linear constrained projection  and weights can be inferred using quadratic programming   <cit> . in implementing cp/qp there are in principle two options for the normalization constraint: one can implement a strict equality which requires the weights to add to  <dig>  or one can implement the normalization as an inequality constraint, in which case the weights are only required to add to a number less or equal to  <dig>  here we implement the cp algorithm using the normalization as an inequality constraint. in effect, modulo the reference database, this algorithm is the reference-based houseman algorithm  <cit> . differences between the two implementations of cp are relatively minor since in this work we evaluate methods in tissues where all the major cell subtypes are known and for which reference dnam profiles exist.

construction of integrated dhs reference dna methylation databases
below we give a brief summary of the datasets used in the construction of the reference databases .table  <dig> main illumina 450k dnam datasets used. we list the main datasets used in this study, the cell-types/tissue profiled, whether the data was used for reference database construction , whether the data was used for validation/evaluation purposes  and the reference/citation

abbreviations: dnam = dna methylation, wb = whole blood, pbmc = peripheral blood mononuclear cells, hmec = human mammary epithelial cells, hrce = human renal cortical epithelia, imr <dig> , scm2 = stem-cell-matrix compendium- <dig>  dmcs = differentially methylated cpgs, nk = natural killer cells, b = b-cell, monoc = monocytes, neutro. = neutrophils, eosino = eosinophils, cd4t = cd4+ t-cells, cd8t = cd8+ t-cells




blood tissue
in the case of blood tissue we used the purified blood cell illumina 450k data from reinius et al.  <cit> . specifically, we used the purified cell data of monocytes, neutrophils, eosinophils, cd4+ t-cells, cd8+ t-cells, natural killer  cells and b-cells. there were  <dig> samples for each cell-type coming from  <dig> different individuals. we used a well-known empirical bayes framework of moderated t-statistics  <cit>  to derive differentially methylated cpgs  between one of the  <dig> cell types and the rest using a false discovery rate  threshold of  <dig> . separately to this, we also identified all illumina 450k probes that mapped to a dnase hypersensitive site  in any of the considered blood cell subtypes using data from the nih epigenomics roadmap. dhs data was available for monocytes, b-cells, t-cells and nk-cells. for each cell-type we then filtered dmcs to include only those mapping to a dhs, which we call dhs-dmcs. this resulted in  <dig> b-cell,  <dig> nk-cell,  <dig> cd4+ t-cell,  <dig> cd8+ t-cell,  <dig> monocyte,  <dig> neutrophil and  <dig> eosinophil dhs-dmcs. we then ranked these dhs-dmcs according to the mean difference in dnam, thus favouring dhs-dmcs with large mean differences . for each cell-type we picked the top  <dig> dhs-dmcs. across all  <dig> cell subtypes, there were  <dig> unique dhs-dmcs. dnam reference centroids were then calculated as the average over the  <dig> samples of each purified blood cell subtype and for each of these  <dig> cpgs, resulting in a blood dna methylation reference database of  <dig> dhs-dmcs and  <dig> blood cell subtypes.

mixed epithelial cells
as a means of testing the statistical algorithms in an epithelial context, we sought to identify at least  <dig> human epithelial cell subtypes for which illumina 450k dnam data was available, generated as part of at least  <dig> independent studies, in order to use one study for reference database construction and another for validation . in addition, we also required dhs data from encode or the nih epigenomics roadmap for these cell-types. we identified dhs data from the nih roadmap for breast and pancreatic cells, whilst from encode we obtained dhs data for human renal cortical epithelial  cells. for human mammary epithelial cells  and hrce cells, illumina 450k data was available from encode, whereas for pancreas we used corresponding 450k data from slieker et al.  <cit> . in this case, because in some cases we only had  <dig> representative sample for each cell-type, we selected dmcs according to a difference in dnam beta-value being larger than  <dig> . this differential dnam analysis was only performed for cpgs that mapped to a dhs in either hmecs, hrces or pancreas. thus, this procedure is extremely stringent as we select dhs cpgs whose dnam varies as much as possible between cell-types. this resulted in  <dig> dmcs between hmecs and hrces,  <dig> cpgs between hmecs and pancreas, and  <dig> dmcs between hrces and pancreas. in total, there were  <dig> unique dmcs, resulting in a dnam reference database of  <dig> cpgs and  <dig> cell-types .

mixed epithelial and non-epithelial cells
we identified dhs data from the nih roadmap for a fetal lung fibroblast cell-line  and for b-cells, whilst from encode we obtained dhs data for hepatocytes. for imr <dig> and hepatocytes illumina 450k data was available from encode, whereas for b-cells we used the data from reinius et al.  <cit> . in this case too, because in some cases we only had  <dig> representative sample for each cell-type, we selected dmcs according to a difference in dnam beta-value being larger than  <dig> . this differential dnam analysis was only performed for cpgs that mapped to a dhs in either hepatocytes, imr <dig> or b-cells. thus, this procedure is extremely stringent as we select dhs cpgs whose dnam varies as much as possible between cell-types. this resulted in  <dig> dmcs between imr <dig> and liver,  <dig> cpgs between imr <dig> and b-cells, and  <dig> dmcs between liver and b-cells. in total, there were  <dig> unique dmcs, resulting in a dnam reference database of  <dig> cpgs and  <dig> cell-types .

non-dhs based reference databases
for the two previously described scenarios, we also derived reference dnam databases without restriction to dhss, but ensuring that reference databases were of approximately the same size as the dhs-based ones. in the case of breast, pancreas and hrces, this resulted in a  <dig> dmc x  <dig> cell-type reference dnam matrix. in the case of imr <dig>  liver and b-cells, the reference dnam matrix was of dimension  <dig> dmcs and  <dig> cell-types. in the case of blood, the corresponding “non-dhs” reference database was defined over  <dig> dmcs.

validation datasets
in what follows we briefly describe the illumina 450k datasets used to validate and compare the different algorithms .

blood tissue
one dataset profiling whole blood for over  <dig> samples  cases and controls) was available from liu et al.  <cit> . for this dataset, there were average flow-cytometric estimates for all major blood cell subtypes for ra cases and controls. another dataset  profiled  <dig> whole blood  and  <dig> experimentally reconstructed “whole blood” mixtures  <cit> . in the former case, flow-cytometric estimates for the different blood cell subtypes were available for each of the  <dig> wb samples. in the latter case, the mixing proportions were determined by the experimentalist and therefore known without error. we also considered an additional illumina 450k dataset from zilbauer et al., which profiled  <dig> blood cell subtypes  with  <dig> replicates of each  <cit> .

other cell types
for validating and assessing the algorithms in the context of the mixed epithelial cell type scenario, we used as validation, illumina 450k dnam data for hmecs from lowe et al.  <cit> , and illumina 450k data for hrces and adult male & female pancreas from the stem-cell-matrix compendium- <dig>   <cit> . for the case of the mixed epithelial/non-epithelial cell types, we used illumina 450k dnam data of imr <dig>  from scm <dig>  for liver cells from slieker et al.  <cit> , and purified b-cells from zilbauer et al.  <cit> .

validation and evaluation strategy based on in-silico mixtures
for evaluation and comparison of the statistical algorithms, we generated  <dig> different in-silico mixtures of the purified cell dnam profiles, with weights chosen randomly from a uniform  distribution, subject to the constraints that weights add to  <dig>  performance of each algorithm was then assessed using the root mean square error  between the estimated and true weights for each cell-type, as estimated over the  <dig> different mixtures. r <dig> values between estimated and true weights for each cell-type were also computed over the  <dig> different mixtures. average rmse and r <dig> values over cell-types were also calculated. finally, this procedure was repeated for a total of  <dig> monte carlo runs, yielding a total of  <dig> average rmse and r <dig> values. this overall strategy was used for validation/testing purposes in the zilbauer dataset, as well as for testing the methods in the mixed epithelial and mixed epithelial/non-epithelial scenarios.

noise analysis
we note that in this work we always test methods on data which is independent from the data used to construct the reference database. this already implicitly assesses the performance of the algorithms under noise levels which one may encounter between two similar experiments performed by different labs and personnel. however, in order to assess the algorithms under increasing levels of noise, we also added gaussian noise of increasing variation to the mixtures. the addition of gaussian noise was done in the m-value basis, with data subsequently transformed back to the beta-valued basis for application of the algorithms. specifically, we considered  <dig> increasing levels of standard deviation noise: sd =  <dig>   <dig>   <dig>   <dig>   <dig>   <dig>   <dig>  for a dmc that differs between  <dig> cell-types by an amount of  <dig>  , this corresponds roughly to a difference in the m-value basis of approx.  <dig>  thus, the case sd =  <dig>  can be seen as an extreme case of noise. the case sd =  <dig> corresponds to a typical deviation in the beta-value basis of approximately β /, i.e. an approx. 5% change for a cpg which is say unmethylated , and an approx. 16% change for a cpg which is partially methylated . thus the case sd =  <dig> is a fairly realistic scenario given known noise levels in illumina 450k data.

definition of a gold-standard list of smoking-associated dmcs and of a true negative list
smoking and whole blood is the ideal scenario in which to compare methods for cell-type correction, since many whole blood ewas have reported strong consistency of smoking-associated dmcs . hence, to define a gold-standard list of sdmcs and associated genes, we used the curated table of gao et al.  <cit> . specifically, we defined a gold-standard list of sdmcs defined by illumina 450k probes which have been associated with smoking in at least  <dig> independent studies. this resulted in a total of  <dig> gold-standard sdmcs, implicating a total of  <dig> unique genes. using this gold-standard list to declare a list of true positives, we then assessed sensitivity of the methods in an independent whole blood ewas of  <dig> samples  <cit> . we note that this ewas was not among the ones reviewed by gao et al. and hence is truly independent.

definition of a true negative cpg  is much harder. however, to construct an approximate set of true negative cpgs, we used the intersection of 450k probes not associated with smoking in  <dig> independent ewas studies. these ewas studies were a  whole blood set of  <dig> samples from tsaprouni et al.  <cit>  ,  a set of  <dig> whole blood samples from healthy controls and  corresponding  <dig> whole blood sample from rheumathoid arthritis cases, all from liu et al.   <cit> . for all  <dig> sets, smoking status information was available. in the case of tsaprouni et al., processed data was downloaded from geo. in the case of liu et al., we processed raw data with minfi  <cit> . all 450k data was corrected for type- <dig> probe bias using bmiq  <cit> . p-values of association with smoking  was determined by linear regression in each set. we then defined cpgs as not associated with smoking if their p-value >  <dig>  in each of the  <dig> datasets, resulting in  <dig> true negative  cpgs.

software availability
the blood reference dnam database for  <dig> dhs-dmcs and  <dig> blood cell subtypes is provided . a user-friendly r-script implementing epidish is available . epidish is also freely available as an r-package from github: https://github.com/sjczheng/epidish


RESULTS
the epidish algorithm and validation in blood using flow-cytometry
we collected dhs and illumina 450k dna methylation data from the nih epigenomics roadmap  <cit>  and encode  <cit> , as well as from other illumina 450k studies profiling individual cell-types  <cit>  and normal tissues  <cit>  . given a tissue of interest, and with prior knowledge of which cell subtypes might be present in the tissue, epidish first constructs a dna methylation reference database, by integrating dhss from the corresponding cell subtypes with a supervised selection procedure, to identify cell subtype specific differentially methylated cpgs  which localize to open chromatin . once the reference database is constructed, epidish then infers sample-specific cellular proportions using robust partial correlations .fig.  <dig> epigenetic dissection of intra-sample heterogeneity: the epidish algorithm. a given a tissue of interest and with knowledge of the main underlying cell subtypes, epidish constructs a reference dna methylation  database for these cell subtypes using  dnase hypersensitive sites  and dnam data for these cell types from existing public databases and  a supervised selection procedure which identifies differentially methylated cpgs  among each pair of cell-types. the resulting reference dnam database is defined only over dmcs that map to a dhs in at least one of the underlying cell-types. b given a tissue sample of interest, epidish next infers underlying cell type proportions/weights using robust partial correlations, with non-negativity and normalization constraints imposed a-posteriori. having estimated cellular proportions for each sample, feature selection against a phenotype of interest is then performed using these proportions as covariates




we first considered the case of blood tissue, a complex tissue for which the main constituent cell types are well known and which is being used extensively in ewas  <cit> . we constructed a blood reference database using illumina 450k dnam profiles for a total of  <dig> purified blood cell subtypes  obtained from  <cit> , integrating it with blood cell subtype specific dnase hypersensitive sites , as obtained from the nih epigenomics roadmap  <cit> , and further filtering the 450k probes for differential methylation between every pair of blood cell subtypes, resulting in an integrated blood reference dnam database of  <dig> cpgs and  <dig> blood cell subtypes . as a sanity check, we verified that the original purified samples segregated according to cell subtype when clustered over these  <dig> cpgs . blood cell subtype proportions obtained with epidish on whole blood  and peripheral blood mononuclear cells  from the same study were also in line with known proportions, i.e. strongest enrichment for neutrophils in wb and with lymphocytes making the dominant component of pbmcs .

in order to validate the epidish algorithm, we first applied it to an independent 450k data set of  <dig> whole blood samples from an ewas in rheumatoid arthritis, for which facs  estimates of  <dig> purified blood cell subtypes , averaged separately over  <dig> cases and  <dig> controls, was available  <cit> . we observed excellent agreement between epidish and facs estimates, for both cases and controls, with a root mean square error  of only 4% . agreement was even better for the actual difference in mean blood cell subtype proportions between cases and controls, with a rmse of 1% . to further validate epidish, we applied it to another set of  <dig> whole blood samples, for which independent flow-cytometry estimates of blood cell subtype fractions was available  <cit> . in this set too, epidish achieved a rmse of approximately  <dig> to 4%, with a reasonably high average r <dig> value of  <dig>  .fig.  <dig> validation of epidish in independent data with facs and known mixture estimates. a left panels: barplots of the average weight proportions of each major blood cell subtype according to facs and epidish, in  <dig> rheumatoid arthritis  cases and  <dig> controls. right panel depicts the difference between cases and controls. b left panel: barplots of the average weight proportions of each major blood cell subtype according to facs and epidish in  <dig> whole blood samples from koestler et al. root mean square error  is given. right panel: scatterplot of the corresponding estimated cell fractions vs the facs estimates for all  <dig> samples and each cell subtype. r <dig> values  for each cell subtype are given, as well as the average value over all cell subtypes. c scatterplots comparing the estimated cell fractions using epidish to the true known fractions for  <dig> experimentally reconstructed “whole blood” samples, where the mixing proportions were known. one scatterplot is shown for each blood cell subtype used in the reconstructions. in each case, we give the rmse and r <dig> value 




epidish correctly infers blood cell subtype proportions in reconstructed whole blood samples
flow cytometric estimates of blood cell subtype proportions are also subject to error. hence, we further assessed epidish in its predictions to correctly infer cell subtype proportions from  <dig> reconstructed whole blood samples where the exact mixing proportions are known  <cit> . for all those cell subtypes whose proportions exhibited a reasonable dynamic range in the experimental mixtures, epidish obtained r <dig> values above  <dig> , with an average rmse of  <dig> %, confirming that epidish can accurately quantify blood cell subtype proportions .

using dhs information marginally improves the quality of the reference database
in order to demonstrate that statistical inference is improved by using relevant cell-type dhss when constructing the reference dnam database  <cit> , we conducted a comparative analysis using two different references: one using dmcs that map to cell-type specific dhss, and another where we only use dmcs . we performed the analysis for three different scenarios. in the first, we generated  <dig> random in-silico mixtures of  <dig> purified blood cell subtypes from zilbauer et al.  <cit> , and compared epidish’s r <dig> value for the estimated cell-type proportions between the two different reference databases. performing this analysis for  <dig> different monte carlo runs, revealed significantly higher r <dig> values for the database that used dhs information . we next repeated this analysis for another scenario where we generated mixtures from  <dig> epithelial cell-types  for which dnam profiles were available from at least  <dig> independent studies, and for which dhs information for each individual cell-type was also available from either the nih roadmap or encode . dnam data from  <dig> independent studies is necessary to separate out the process of reference construction  and evaluation . confirming the previous analysis, improved r <dig> values was observed for the dhs-based reference database . finally, we considered a third scenario where we mixed together epithelial and non-epithelial cell-types . for each of these cell-types, dhs data and dnam profiles generated by two independent studies were available . confirming the previous results, r <dig> values were distinctively improved upon using dhs information . using rmse as performance measure, the dhs-based reference was best in 2/ <dig> studies . however, we note that in all cases improvements were only marginal.fig.  <dig> dhs information improves quality of the reference database. a using  <dig> in-silico mixtures of  <dig> purified blood cell subtypes from zilbauer et al., we compare the r <dig> values  of the estimated cell proportions as obtained using epidish between the two different reference databases: one which uses cell-type specific dhss to select dmcs when constructing the dnam reference centroids , and another which only uses dmcs regardless of dhs status . the average r <dig> value over all cell-types is being shown. a total of  <dig> different monte carlo runs were performed to obtain  <dig> average r <dig> values  for each reference database. p-value is from a one-tailed paired wilcoxon-rank sum test.  as  but now  <dig> in-silico generated mixtures of  <dig> epithelial cell subtypes  for which dhs data was available.  as , but now for  <dig> other cell subtypes  with available dhs information and dnam profiles from two independent studies




epidish compares favorably to other reference-based methods
having validated epidish, we next performed a detailed comparison to competing reference-based methods. specifically, we compared epidish to the linear constrained projection technique  used by houseman and others  <cit> , to an algorithm called cibersort , which uses support vector regression and which has been shown to perform best on gene expression data  <cit> , and finally to a non-robust variant of epidish based on simple multivariate regression . in order to objectively compare the  <dig> algorithms, we first considered the case of blood tissue, for which several datasets profiling purified blood cell subtypes were available. for each algorithm we used the same blood reference database of  <dig> dhs-dmcs and  <dig> blood cell subtypes, as constructed previously using the purified blood cell data from reinius et al.  <cit> . using the known reconstructed whole blood mixtures  from koestler et al.  <cit> , we compared the algorithms in terms of the rmse and r <dig> values of the estimated mixing proportions. interestingly, we observed that robust partial correlations  outperformed both cp and cibersort in terms of the rmse, with similar performance as assessed using r <dig> . in an independent dataset of  <dig> purified blood cell subtypes from zilbauer et al.  <cit> , where we generated in-silico mixtures, cp underperformed while epidish/cibersort performed optimally . in order to further compare performance in the context of other cell-types, we applied all  <dig> algorithms to the  <dig> epithelial cell type and  <dig> epithelial/non-epithelial cell type mixture scenarios considered earlier . once again, epidish compared very favorably relative to the other methods, specially relative to cp which overall showed the weakest performance . we note however that epidish did not outperform cibersort in one of these two studies .fig.  <dig> comparison of epidish to other reference-based algorithms. a barplots of rmse and r <dig> values for the estimated cellular proportions for the four different algorithms as applied to the reconstructed blood mixtures of koestler et al. all estimates were obtained over the  <dig> reconstructed samples. right panels show the average values over all blood cell subtypes.  as , but now for the in-silico generated mixtures of  <dig> blood cell subtypes from zilbauer et al. all rmse and r <dig> estimates were obtained over  <dig> randomly generated in-silico mixtures, averaged over the  <dig> cell-types, and this experiment was repeated a total of  <dig> times . p-values comparing epidish to each of the other  <dig> methods are from a paired one-tailed wilcoxon rank sum test.  as , but now for in-silico generated mixtures of  <dig> epithelial/non-epithelial cell types: fetal lung fibroblast, liver and b-cells. all rmse and r <dig> estimates were obtained over  <dig> randomly generated in-silico mixtures, averaged over the  <dig> cell-types, and this experiment was repeated a total of  <dig> times . p-values comparing epidish to each of the other  <dig> methods are from a paired one-tailed wilcoxon rank sum test




constrained projection reveals added robustness under higher levels of noise
since the reconstructed and in-silico mixtures from the previous analyses were generated from cell-type specific dnam profiles that are independent from the cellular dnam profiles used to build the reference databases, these analyses already implicitly assess the robustness of the algorithms to natural levels of noise, as encountered for instance between different labs or different experimental protocols. however, in order to improve our understanding of the noise performance characteristics of the different methods, we next investigated their relative performance under increasingly higher levels of noise . adding increasing levels of noise to the reconstructed mixtures of koestler et al., we observed that while epidish was optimal for low levels, that the relative performance of other algorithms, notably constrained projection , improved as noise levels increased . we observed a similar pattern using in-silico mixtures of purified blood cell subtypes from zilbauer et al., with epidish optimal at low levels of noise, but cp emerging as the more optimal method at higher levels . in the context of in-silico mixtures of  <dig> epithelial cell subtypes, we once again observed a cross-over in rmse performance between cp and epidish, with epidish performing better at lower levels of noise, but cp and cibersort emerging as the more optimal methods under larger levels . in terms of r <dig>  cp emerged as the best performing method in this set. cp also emerged as the better performing method  for larger levels of noise in the context of in-silico mixtures of epithelial/non-epithelial cell subtypes . in summary, these data indicate that the relative performance of constrained  vs non-constrained  approaches for estimating cell proportions in heterogeneous mixtures is dependent on cell-type and the levels of noise in the data.fig.  <dig> evaluation of epidish under increasing levels of noise. a rmse  and r <dig>  values for the estimated cellular proportions for the four different algorithms as applied to the  <dig> reconstructed whole blood mixtures of koestler et al. under increasing levels of noise . b as a, but for  <dig> in-silico randomly generated mixtures of purified blood cell subtypes, profiled in zilbauer et al.  as a), but for  <dig> in-silico randomly generated mixtures of  <dig> epithelial subtypes . d) as a), but for  <dig> in-silico randomly generated mixtures of  <dig> epithelial/non-epithelial cell subtypes . in all panels , rmse and r <dig> values represent the averages over  <dig> repeated monte carlo runs




epidish improves sensitivity in an ewas of smoking in whole blood
in order to further validate epidish and to illustrate its application to ewas, we applied it to an ewas of smoking in a cohort of  <dig> women, all aged  <dig>  for which whole blood samples were taken and for which dnam profiles using the illumina 450k technology were generated  <cit> . smoking in whole blood tissue provides the ideal scenario in which to test epidish, since a gold-standard list of  <dig> smoking-associated dmcs , as derived from an extensive survey of independent smoking ewass, exists  <cit>  . hence, we applied epidish to our  <dig> samples to obtain sample-specific weights for the different blood cell subtypes. the resulting estimates were in line with what is expected for whole blood samples, with granulocytes/neutrophils making up ~50% of the samples and with lymphocytes/monocytes making up the rest . svd analysis confirmed that the top component of variation correlated strongly with changes in blood cell-type composition . not adjusting for variation in blood cell subtype composition, we observed  <dig> sdmcs at genome-wide significance . adjusting for cell-type proportions, as estimated using epidish, we observed a doubling of sdmcs . importantly, among the additional sdmcs identified with epidish, there were probes that mapped to  <dig> genes within our gold-standard set of  <dig> smoking-associated genes  . for instance, an additional probe mapping to ahrr was observed after adjustment, and probes mapping to ptk <dig> and lrp <dig> were obtained only after adjustment . in contrast, only one probe in the unadjusted analysis was not found after adjustment . to investigate this further we estimated the sensitivity for an unadjusted analysis, epidish , cibersort and cp, at two different fdr thresholds  . this confirmed that epidish improves the sensitivity over an unadjusted analysis, although cp performed marginally better . to check that the improved sensitivity is not at the expense of a much lower specificity, we also defined a set of true negative cpgs, i.e. cpgs not associated with smoking  as assessed in  <dig> independent ewas cohorts . this resulted in a true negative set of  <dig> cpgs, allowing the relative specificity of the methods to be assessed. using the same fdr <  <dig>  threshold, we observed that all methods achieved comparably high relative specificity values , although cp exhibited a 3-fold higher type- <dig> error rate  than epidish or cibersort . at a more relaxed threshold , cp exhibited a  <dig> times higher type- <dig> error rate than epidish or cibersort . thus, overall, epidish improves inference over an unadjusted analysis and compares favorably to cp.fig.  <dig> epidish improves sensitivity of a smoking ewas in blood. a distribution of cellular proportions  for the main blood cell subtypes in the  <dig> whole blood samples from teschendorff et al., as inferred using epidish. b heatmap of p-value associations between significant principal components  and various factors, including smoking status, bisulfite conversion efficiency , sentrix id and position, and cellular proportion for  <dig> blood cell subtypes . c quantile-quantile plot of all 450k probes passing quality control from a supervised analysis against smoking-pack-years only adjusted for sentrix id . the number of cpgs passing an fdr <  <dig>  threshold are given, and defined to be smoking-associated differentially methylated cpgs . d quantile-quantile plot of all 450k probes passing quality control from a supervised analysis against smoking-pack-years adjusted for sentrix id and blood cell subtype proportions as estimated using epidish ”). the number of cpgs passing an fdr <  <dig>  threshold are given, and defined to be smoking-associated differentially methylated cpgs . e among the  <dig> and  <dig> sdmcs identified in c and d, respectively, we indicate the numbers of these that map to a selected set of  <dig> well-known and validated smoking-associated genes. this subset derives from a set of  <dig> gold-standard smoking-associated genes, as curated by a review of the literature by gao et al.  <cit> 


methods are: noadj = no-adjustment, epid  = adjustment with rpc using reference with no dhs info, epid = adjustment with rpc and a reference with dhs info, cbs = adjustment with cibersort, cp = adjustment with constrained projection. sensitivity was estimated as the fraction of the  <dig> gold-standard true positives  found among the sdmcs. in the case of specificity, this was estimated as the fraction of true negatives  among sdmcs measured relative to a gold-standard set of  <dig> true negative  cpgs




discussion
the aim of this study was to compare different reference-based methods in order to establish whether there is an optimal approach. this is particularly pertinent given that only one reference-based approach  has been applied to dna methylation data. as our study has demonstrated, houseman’s algorithm, which relies on the cp technique, is in fact not the most robust method. while we did not identify a single method which always outperformed all others, we found that non-constrained techniques such as partial correlations and support vector regression provided a more robust inference framework than cp, particularly for more realistic noise levels. this is consistent with the results obtained by newman et al. on gene expression data  <cit> . in our study, cp only emerged as the optimal choice if data was subjected to a large amount of noise, typically larger than what is encountered in real data. hence, our study advances upon the state-of-the-art, and proposes the use of rpc or cibersort as a more robust means for inferring cell-fractions in complex tissues.

another important novel insight of our study is that inference can be improved, albeit only marginally, by incorporating cell-type specific dhs information when constructing the reference dnam database. we demonstrated this not only in the context of blood tissue, but also for mixtures involving epithelial cell subtypes. to understand why the improvement is only marginal, we note that supervised selection of dmcs from a training set, for instance, by selecting dmcs that show big  differences in dnam between cell-types, will almost always identify true dmcs. supervised selection tends to favour dmcs with larger differences in average dnam which serve better for the statistical deconvolution problem. thus, while prior biological knowledge can help remove a few false positives, this leads to only a relatively minor improvement in the quality of the inference. it will be interesting to explore if further improvements are possible, for instance, using predicted cell-type specific dmcs  <cit> , although we anticipate that such prior information will turn out to be more fruitful in the context of “semi-reference-free” approaches such as ruv  <cit> .

we further showcased epidish in an ewas of smoking, where it was found to identify twice as many smoking-associated dmcs than an unadjusted analysis. importantly, some of the additional sdmcs mapped to genes  which are well-known to be associated with differential methylation in smokers  <cit> , thus confirming that epidish leads to an increase in sensitivity. although similar improvements were possible with cibersort and cp, cp suffered from a higher fdr. thus, our detailed analysis on experimental and in-silico generated mixtures, which suggests improved modelling with a non-constrained technique such as rpcs, appears to also hold true on real data, although we caution that analyses in more smoking-ewas will be needed to reach a robust conclusion.

our analysis focused entirely on illumina 450k data. while this may be seen as a limitation, in light of the recent arrival of the newer 850k version  <cit> , the overwhelming majority of the 450k probes are present in the new beadarray version, rendering the extension to 850k data relatively trivial. likewise, given the relatively good agreement between illumina 450k and wgbs/rrbs data  <cit> , and given that in both cases dnam data can be treated in the beta-value basis, we would envisage that application of epidish will carry over to such data, although studies demonstrating this will be needed.

CONCLUSIONS
in summary, we have presented a novel reference-based algorithm, epidish, for in-silico deconvolution of dna methylation data, which compares very favorably in relation to the current gold-standard. we recommend the use of epidish for dissection of intra-sample heterogeneity in ewas, and to this purpose we provide the community with an r-package , freely available from https://github.com/sjczheng/epidish.

additional files

additional file 1: contains all supplementary figures and supplementary tables plus their captions: figure s <dig>  clustering validation of reference blood database. figure s <dig>  validation of epidish. figure s <dig>  improvement of inference using dhs data in  <dig> independent data sets. figure s <dig>  comparison of reference-based methods. figure s <dig>  comparative performance of reference-based methods in an ewas of smoking. table s <dig>  the blood reference database. table s <dig>  gold-standard list of  <dig> smoking-associated dmcs . table s <dig>  smoking-associated dmcs with no adjustment for cell-type composition. table s <dig>  smoking-associated dmcs as obtained using epidish. 


additional file 2: an r-script implementing epidish with either robust partial correlations , cibersort  or constrained projection . 




abbreviations
dhsdnase hypersensitive site

dmcdifferentially methylated cpg

dnamdna methylation

ewasepigenome-wide-association study

fdrfalse discovery rate

ruvremoving unwanted variation

sdmcsmoking-associated differentially methylated cpg.


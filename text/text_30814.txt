BACKGROUND
vibrational spectroscopic imaging, or chemical imaging, data is composed of a series of absorption or scattering measurements taken across the electromagnetic spectrum. materials exhibit a characteristic spectral signature that is indicative of their molecular composition. the speed and versatility of vibrational techniques offer the most potential for label-free microscopy by providing micron-scale resolution and significant molecular detail.

in this paper we focus on mid-infrared spectroscopic imaging  <cit> , which is a form of vibrational spectroscopy with a data rate that is currently viable for clinical applications. we will also show that our methods are applicable to other techniques, such as raman spectroscopy, which show promise for future in vivo imaging. recent advances in optical detector technology allow the rapid acquisition of spectral signals that are spatially specific, producing multidimensional images that can be extensive in size . these techniques have shown promise in biomedicine for cell type classification  <cit>  and cancer analysis  <cit> . however, the interpretation of a spectral signature is a complex task, requiring a significant amount of pre-processing before identifying spectral features that correspond to chemical information.

while the acquisition of data is relatively rapid, there are limited options at present to assist researchers in visualizing data. in this paper, we propose a method for interactively exploring the chemical composition of a tissue sample. the proposed software allows a user to quickly identify spectral features corresponding to specific tissue types within a sample. the results are then applied to other samples in order to identify tissue types without the use of histological labels. this allows us to overcome several disadvantages of current histology methods by using quantitative information that is collected non-destructively. this makes our methods repeatable and provides an array of useful quantitative information that can be used by a pathologist to aid in diagnosis.

in section ‘mid-infrared spectroscopy’, we provide an overview of mid-infrared spectroscopic imaging. section ‘morphological effects’ describes the coupling between tissue morphology and chemistry, which makes the characterization of tissue difficult. our method and implementation details are described in section ‘methods’ and section ‘visualization’. section ‘results and discussion’ provides validation using chemical phantoms and demonstrates our results on breast cancer biopsies.

our specvis software is open-source and 32-bit windows binaries available online .

mid-infrared spectroscopy
mid-infrared spectroscopy is used to identify molecular content in a sample by determining the fraction of incident light absorbed. broadband mid-infrared electromagnetic radiation is transmitted through the sample and the absorbed light at each wavelength is quantified . the most common technique for measuring absorption spectra is fourier transform infrared  spectroscopy  <cit> , which uses an interferometer to encode optical frequencies in time. the recorded data is then decoded using a fourier transform. the resulting data consist of a spectrum representing the intensity of light transmitted as a function of frequency ν¯. the frequency domain is generally recorded in units of wavenumber . the absorbance at each wavelength is computed using 

  a=−log10ii <dig> 

where a is the absorbance, i is detected light through the sample, and i <dig> is the light detected without the sample present. molecular bonds are identified by their characteristic pattern where a is non-zero.

recent advances in ft-ir spectrometry allow the use of focal plane arrays  for acquiring spatially-resolved mid-infrared absorbance spectra at high speeds  <cit> . this allows the facile collection of hyperspectral images, where each pixel provides the corresponding spatially resolved absorption as a function of wavenumber.

morphological effects
the increasing availability of imaging systems now permit the analyses of non-homogeneous samples, where structural changes accompany changes in chemical composition. however, these samples introduce additional spectral characteristics due to the sample morphology. these effects can dramatically affect the ability to differentiate between chemical constituents. morphological characteristics can affect the spectrum in two ways:  increased absorbance as a function of density and thickness, and  scattering affects. changes in tissue thickness and density result in well-understood spectral changes characterized by the beer-lambert law, while scattering is significantly more difficult to characterize.

scattering
light transmitted through non-homogeneous samples is subject to scattering as it transitions between material interfaces exhibiting different indices of refraction, n. these effects are prominent in mid-infrared spectroscopy, where the re-direction of light is indistinguishable from absorbance  <cit> , resulting in wavelength-dependent changes in the absorbance spectrum that make the determination of the actual tissue absorbance, a, extremely difficult  <cit> . the study of scattering effects in ft-ir imaging is an active area of research  <cit> . current work suggests that a significant portion of scattering through tissue samples is the result of interaction with microscopic structures, such as cell bodies and nuclei  <cit> . empirical methods have been proposed for correcting spectra based on mie theory  <cit> , however these techniques are time consuming and do not provide interactive feedback. in addition, mie theory is not generally applicable to scattering effects and the prior information required for these estimations is not always available. while computational methods have been proposed for eliminating scattering effects for known structures such as spheres  <cit> , no automated techniques have been proposed that compensate for spectral features introduced by elastic scattering, which accounts for a large amount of variance in mid-infrared spectroscopic images  <cit> .

an alternative method presents a first-order approximation to remove the non-chemical effects of scattering  <cit> . for each feature, a corrected absorption spectrum Â is determined by subtracting a piecewise-linear function b: 

  Â=a−b 

however, the process requires manual specification of points that represent b as well as either detailed knowledge of the chemical compound under consideration or extensive exploration of the data set. this makes the selection of spectral features representing chemical information extremely time-consuming, particularly when the chemical composition of the tissue sample is unknown.

beer-lambert law
variations in tissue thickness and molecular density cause linear scaling of the absorbance spectrum according to the beer-lambert law: 

  Â=κℓn 

here, Â is the scattering-corrected absorption as a function of the wavenumber ν¯, κ is the absorption coefficient, ℓ is the path length through the specimen , and n is the molecular density. the absorption coefficient κ is the desired material property that defines the chemical composition of the specimen.

note that there are no methods for separating the path length ℓ and density n in the general case. however, the function κ can be estimated using a reference band ν¯r within the spectrum. one example of a useful reference is the amide i peak found in biological tissue at ν¯r≈1650cm − <dig>  by normalizing amide i absorption across chemical species = <dig> ), the combined contributions of path length and density are estimated in terms of the relative protein composition, using a=ℓn, and determining the normalized spectrum: 

  an=ÂÂ 

while a single reference feature is useful, it is not generally applicable to samples containing several unique components, therefore several references are used for classifying multiple chemical species.

methods
in this section, we describe our methods for interactive exploration of hyperspectral data. the chemical composition of a sample is identified by finding features, such as absorbance peaks, that can be used as references and to differentiate individual compounds. for example, the biological compound collagen exhibits several absorbance peaks between 1235cm − <dig> and 1265cm − <dig>  however, these peaks are difficult to distinguish in a raw spectrum, due to morphological characteristics of the sample .

given a measured absorption spectrum from a non-homogeneous sample composed of a single chemical constituent, equations  <dig> and  <dig> indicate that the normalized, corrected spectrum can be computed using: 

  a^n=a−ba−b 

where ν¯r is the location of a spectral feature used for normalization and b is an estimate of the spectral contribution due to scattering.

for an unknown sample, both the normalization feature and baseline function must be estimated. in addition, if the sample is composed of several unique chemical constituents, multiple normalization features and baseline functions must be utilized for classification. this is an extremely difficult problem to solve computationally, requiring detailed knowledge of both the sample and the relationship between spectral bands and molecular characteristics.

the specvis software addresses this problem by allowing interactive visualization of the data set. our software allows a spectroscopist to specify the baseline function b , dynamically select reference features , and visualize the chemical characteristics. this is done by allowing the user to specify changes in the distribution of spectra, as reflected using a dynamic 2d histogram. the user then selects chemical features in this histogram, exploring the results through an interactive 2d visualization of the tissue sample. computing the changing distribution of spectra as well as visualization of user-selected features is computationally expensive, making interactive feature selection impossible on current cpu-based desktop systems. we therefore demonstrate that this problem can be well-formulated for implementation on programmable graphics hardware. in the following sections, we first describe the types of metrics used to identify features in hyperspectral images. we then discuss how spectra in an image are adjusted to remove scattering artifacts and other distortions, based on a histogram describing the distribution of spectral information.

metrics
we first identify measures of spectral features, or metrics, that quantify, for example, characteristics in forensic spectroscopy  <cit>  and differentiate cell types in biological samples by acting as features for more complex classification systems  <cit> . the user specifies parameters for these measurements in the spectral domain. once specified, a metric is immediately applied to all pixels in the image. the metrics described in this paper include the peak height, which is the most basic measure of chemical composition, as well as peak integral and centroid. while these are not all of the possible types of metrics, we limit our study to these as this is an active area of research and they allow us to identify several important chemical differences in biological tissue samples. additional types of metrics can be readily added as our approach is general. for each metric, the function s represents a generic spectral value, where  is the spatial position and nu^ is the wavenumber. in the case of absorbance measurements, s can be either the raw or corrected absorbance spectrum.

peak height
this metric is highly sensitive to peak shifts. this is particularly noticeable for the amide i peak at 1650cm − <dig>  which is narrow and composed of multiple chemical contributions that make it prone to shift. absorbance is particularly useful for detecting broad peaks and the density of well-known and localized molecular bonds.

peak integral
while the peak absorbance is indicative of the presence of species, the total area under the peak is indicative of the total concentration. hence, another useful metric is the definite integral of the spectrum on a user-specified interval  that provides the area under the peak: 

  mi=∫ν¯0ν¯1sdν¯ 

this metric provides a robust measure of absorbance within a spectral region and is relatively insensitive to noise and peak shifts. this robustness makes it an ideal candidate for use as a spectral reference. it is insensitive, however, to subtle spectral changes that are often found in biological tissue samples.

centroid
the centroid of a bounded region of the spectrum is computed using: 

  mc=∫ν¯0ν¯1ν¯sdν¯∫ν¯0ν¯1sdν¯ 

the resulting value is the wavenumber for the center of mass in the specified region. this metric is useful for measuring shifts in single peak positions as well as the distribution of multiple species’ absorption among multiple neighboring peaks. this metric is dependent on the distribution of absorption and therefore does not require a reference. however, it is incapable of detecting the height and is of limited utility for peaks that do not shift as a function of spatial position.

interactive histogram
the first step in visualization is to display the distribution of spectra in the image using a 2d histogram. this allows the user to identify chemical compounds by approximately removing morphological effects and selecting metrics. chemical features are selected using the joint histogram of wavenumber and absorbance for all spectra in the image. the user selects features in this domain that correspond to the structural and chemical components of the tissue sample. however, the data processing required to separate structural and chemical features is currently time consuming and the results are difficult to visualize. we implement a dynamic approach, which allows the user to explore the data set via interactive feedback in both the spatial and spectral domains, which facilitates meaningful feature selection. our framework allows the user to interactively adjust points for baseline correction and select reference features. data processing is performed dynamically on the gpu using cuda  <cit>  and provides interactive feedback for multi-gigabyte data sets. the unprocessed data set is stored on the gpu as a three-dimensional texture map represented as 32-bit floating point values. the user explores the data in two ways:  the insertion of baseline points to build the scattering approximation b and  the selection of a reference metric. the histogram is computed interactively and dynamically as the user changes parameters for the baseline and reference. this is done using a cuda device kernel. a block of threads is assigned to process each band . we specify a 2d block size of wxw threads, where w is the maximum warp size supported by the gpu. therefore, each block consists of one warp that executes data in a single-instruction multiple-data  fashion. each block b is responsible for computing the complete one-dimensional histogram for a single band νb¯. the threads within each block are responsible for evaluating a spatially coherent square of pixels, initially positioned at the upper left-hand corner of the image. each thread then iterates across the image to the lower-right corner at intervals of w. note that all threads within the block are part of the same  warp, therefore they will be spatially coherent at each iteration across the spatial domain of the image. this spatial coherence is used to perform faster fetches using texture units, which is particularly useful for fast evaluation on gpus with compute capability lower than  <dig> .

computing the processed spectrum at each spatial location within a band requires a maximum of four memory fetches:  the raw data value at a,  the raw values at the baseline points a and a, and  the reference value r. computing the reference value ar also requires its neighboring baseline points at a and a. however, an image of the reference values at each spatial location is pre-computed whenever the reference is changed.

as each thread traverses the image at ν¯, the resulting histogram is accumulated in shared memory allocated for the block. accurate computation of the histogram, however, requires the use of atomic operations for incrementing the counters for each bin. this can reduce performance when multiple threads encounter similar absorbance values – a common occurance, given the close spatial proximity of all threads in the ν¯ image. in addition, the simd execution within a warp will cause the entire block to pause while atomic adds are resolved. we address this issue by allocating a separate shared histogram for each thread and summing the results when the entire ν¯ image has been processed. the resulting histogram is then displayed using a log-scale intensity filter.

visualization
the chemical composition of the tissue sample is visualized by building a 2d image based on user-selected metrics. each metric is assigned a color value, where the intensity is based on the value of the metric. the metrics are then evaluated for each pixel, and the resulting colors are combined to create a spatially-resolved chemical visualization of the sample. this color-mapping technique is similar to a transfer function, which is commonly used in volumetric visualization. we first provide an overview of this technique and describe how it is applied to our algorithm.

transfer functions
transfer functions are used in volume visualization to assign color and opacity values to pixels based on features defined in a separate domain  <cit> . these techniques generally use spatial features such as gradient magnitude  <cit> , curvature  <cit> , size  <cit> , and orientation  <cit>  to assign color values. while these techniques have been applied to gigabyte-scale data sets  <cit> , they are difficult to generalize to spectroscopic images since each pixel represents a spatially-resolved absorbance function. the principle behind using spectra to apply transfer functions has been previously explored through contour spectra  <cit> , where spatial characteristics are used to highlight geometric features in the data set. more flexible methods using spatially local statistics have also been proposed  <cit> . both contour spectra and spatial statistics may be applicable for extracting spatial characteristics in heterogeneous samples. in this paper, we focus on visualizing chemical features, and therefore each pixel is considered to be an independent component with a corresponding chemical signature.

very few techniques currently exist for visualizing spectroscopic images. li et al.  <cit>  propose a technique for visualizing astrophysical data imaged at various wavelengths. they propose the use of transfer functions for defining opacity when rendering the image stack volumetrically. however, the number of bands in a single image is small and the samples are discontinuous, which limits the amount of chemical information in the data set. more recent work demonstrates a visualization framework for near-infrared spectroscopic images of historical documents sampled regularly in the spectral domain  <cit> . this technique allows relighting of images, interactive selection of individual bands, and metrics for evaluating similarity between user-specified spectra. however, similarity is difficult to measure for vibrational spectra because of the coupled structural and chemical contributions to the spectrum. unsupervised techniques, such as principal component analysis  and vertex component analysis   <cit> , have been proposed to perform spectral unmixing. however, these techniques assume homogeneous samples and also make specific assumptions about the data, such as the existence of orthogonal chemical signatures, which are not generally applicable. comprehensive data maps  have been proposed to examine data  <cit> , but do not provide imaging visualizations.

color values are assigned to spectra based on metric results. the user specifies a bounding range for a metric value using a lasso tool in the spectral histogram. for all three metrics, the lasso bounds are indicated by a line segment. for metrics that are computed across a specified wavenumber interval, a shaded region highlights these boundaries . when the result of a spectral metric falls within these bounds, a color value is assigned based on the point of intersection using a ramp shader. our framework allows the user to assign colors using a constant, linear, and gaussian ramp , as available in most image analysis software. in order to make selection intuitive for the integration metric mi, color is assigned based on the average peak height 

  m~i=miν¯1−ν¯ <dig> 

rather than the integral. this allows the widget to be placed in the vicinity of the selected spectra.

computing metrics
metrics are computed independently for each spectrum, requiring the appropriate baseline points and reference bands. the data set is partitioned spatially into wxw blocks, where each thread is assigned an independent spectrum. the baseline bands and reference are applied using a gpu kernel . if the metric requires integration, summation occurs along the spectral axis. note that a binary search for the neighboring baseline bands is only necessary when a thread is created. if a baseline band is crossed within an interval of integration, the next band ν¯n in the list is acquired. the metric result is saved to a 2d grid, which can be used as a source for color-mapping to produce the final display image or as a reference for additional metrics.

RESULTS
rendering time is dominated by the computation of the histogram as the user changes processing and visualization parameters. however, the frame rate is interactive for our largest sample image , requiring <32ms for complete evaluation of the histogram  using a geforce gtx  <dig> with  <dig> gb of global memory. we use the developed software to identify characteristics in mid-infrared spectroscopic images. we first demonstrate the visualization of structural and chemical components from images of synthetic polymer targets that are often used to assess image quality. we then show how these techniques can be used to extract similar information from mid-infrared images of tissue biopsies, including the visualization of chemical components useful for breast cancer diagnosis. finally, we demonstrate that these techniques can be extended to other forms of spectroscopy by visualizing raman images of tissue samples.

infrared images of tissue
biological tissue samples pose a unique problem in spectroscopic imaging, since each pixel contains a complex combination of chemical species. spectral features that correspond to different tissue types are subtle and difficult to identify, making interactive exploration a valuable tool. we first demonstrate the structural and chemical characteristics that can be visualized using the developed techniques. we obtain a tissue sample and place it on a barium fluoride substrate for imaging. the same sample is then stained using a commonly-used clinical dye, hematoxylin and eosin , in order to identify structural and chemical features .

the developed method is used to find similar features from the hyperspectral image data. since the unprocessed spectra are dominated by scattering in the high-wavenumber regions, we are able to visualize pixels containing edges and boundaries, where scattering is more prominent . we then select baseline points and use a linear gradient to visualize the tissue thickness and density based on amide i absorption . using amide i as a reference, features in the spectra are now dominated by chemical differences between cell types in the tissue. this allows the user to visualize the distribution of tissue types, such as epithelial cells , in which 97% of cancers of the breast arise. the facile delineation of epithelial cells is a desirable, but unmet need, as reported in recent studies using automated computerized analysis of pathologic images  <cit> . we further demonstrate the possible use of the presented techniques for tissue pathology. several breast cancer biopsies were commercially obtained and stained using h&e. adjacent tissue samples were imaged using mid-infrared spectroscopy. we then designed transfer functions to identify tissue characteristics that are useful for cancer diagnosis. this includes structural features, such as tissue density, as well as labeling of various tissue types. these types include epithelial cells, connective tissue , and necrotic  cells . the spatial distribution of these features are commonly used in pathology to identify the presence of a tumor.

once the transfer function is created, it is then applied to other tissue samples . note that these tissue types are difficult to separate using chemical staining. often, mutiple stains are necessary for diagnosis and these methods are difficult to quality-control. however spectroscopic imaging provides quantitative data that can be used to characterize chemical information reliably across multiple samples. the ability to identify tissue types by interactively exploring the hyperspectral data provides several advantages over existing techniques. unlike chemical staining, mid-infrared imaging does not perturb the tissue sample in any way. in addition, the effects of scattering on tissue samples are not well understood, and previous methods for classification of tissue types require extensive pre-processing and the application of machine learning  <cit> . though an extensive comparison between the more complex machine learning methods and the method reported here must be undertaken to quantify advantages, the results seem to be comparable and significantly faster for our method by facilitating interactive analysis. an experienced user was able to separate, visualize, and evaluate the utility of the extracted tissue characteristics useful for tumor diagnosis in a few minutes, given interactive feedback. using our older methods, simply computing a metric took several minutes on a cpu.

raman spectroscopy
the methods that we propose in this paper can also be extended to hyperspectral imaging in other areas. we demonstrate that transfer functions can be created to effectively visualize the distribution of chemical compounds in raman images. we collected raman images of prostate biopsy cores and built a transfer function to discriminate between epithelial and stromal cells . some advantages of raman spectroscopy include the ability to choose the excitation frequency, easy coupling to fiber-optic probes, and little to no signal from water in a sample. these features make it useful for taking in vivo measurements  <cit> . however, the raman spectral signal is extremely weak and requires long acquisition times that effectively limit the signal-to-noise ratio  and the size of image that can be obtained in a reasonable amount of time. our method is robust and can thus be generally applied.

CONCLUSIONS
the ability to acquire spatially resolved information using hyperspectral imaging is strongly emerging as a promising avenue across a variety of areas, especially biomedical analyses. vibrational spectroscopy has the potential to provide quantitative histology for disease diagnosis, without the use of chemical stains in an objective and automated manner. recent work has shown that mid-infrared spectroscopic imaging provides sufficient chemical detail for differentiating between tissue types. researchers have reported very high accuracy after rigorous scattering correction  <cit>  and classification algorithms  <cit>  are applied. these studies demonstrate the potential for applying vibrational spectroscopy to cancer diagnosis.

however, computational methods must be developed to visualize the data quickly and reliably. the size and complexity of the data contained in hyperspectral images makes this a difficult problem, requiring the separation of physical and chemical characteristics from underlying spectra. in this paper, we demonstrate an interactive method for building transfer functions for visualizing hyperspectral images. our method allows users to dynamically assimilate large collections of spectra using algorithms designed to separate structural and chemical features in real time. these features are then selected using transfer functions which allow the visualization of these characteristics in a spatial image of the sample. to our knowledge, the reported methods are the first to allow interactive processing and visualization of hyperspectral images at this level of spectral and structural detail, and we have demonstrated their usefulness in biological samples. applying these features to tissue provides a method for label-free identification of tissue types that is quantitative, non-destructive, and can be performed in a time frame that is clinically viable.

future directions include applying these techniques to three-dimensional samples, which can be acquired using raman spectroscopy in combination with a confocal microscope, for example.

our proposed technique also has several advantages over unsupervised methods, such as pca and vca. in particular, the metrics that we use for visualization have finite support, requiring only a narrow band of information within the spectrum. once useful metrics are identified, the number of collected bands can then be reduced, allowing faster imaging, for example using narrow-band filters for ir  <cit> . finally, since the separation of structural and chemical characteristics from an ir image is so difficult, many algorithms for the classification of hyperspectral images rely on the use of user-defined metrics  <cit> . our method may provide an efficient method for selecting features for use in more complex classifiers for ir-based clinical histology.

competing interests
the authors declare no competing interests.

authors’ contributions
dm designed the algorithm and developed the software. mw collected mid-infrared images and identified spectral and chemical features corresponding to cell types. ms collected raman images and identified spectral and chemical features corresponding to cell types. rb designed the experiments and identified chemical and spectral features corresponding to cell types in cancer biopsies. all authors read and approved the final manuscript.


BACKGROUND
one of the great contributions of genomic studies to human health has been to dramatically improve our understanding of the biology of tumor formation and the means by which it can be treated. our understanding of cancer biology has been radically transformed by new technologies for probing the genome and gene and protein expression profiles of tumors, which have made it possible to identify important sub-types of tumors that may be clinically indistinguishable yet have very different prognoses and responses to treatments  <cit> . a deeper understanding of the particular sequences of genetic abnormalities underlying common tumors has also led to the development of "targeted therapeutics" that treat the specific abnormalities underlying common tumor types  <cit> . despite the great advances molecular genetics has yielded in cancer treatment, however, we are only beginning to appreciate the full complexity of tumor evolution. there remain large gaps in our knowledge of the molecular basis of cancer and our ability to translate that knowledge into clinical practice. some recognized sub-types remain poorly defined. for example, multiple studies have identified distinct sets of marker genes for the breast cancer "basal-like" sub-type, which can lead to very different classifications of which tumors belong to the sub-type  <cit> . in other cases, there appear to be further subdivisions of the known sub-types that we do not yet understand. for example, the drug traztuzumab was developed specifically to treat the her2-overexpressing breast cancer sub-type, yet her <dig> overexpression as defined by standard clinical guidelines is not found an all patients who respond to traztuzumab, nor do all patients exhibiting her <dig> overexpression respond to traztuzumab  <cit> . furthermore, many patients do not fall into any currently recognized sub-types. even when a sub-type and its molecular basis is well characterized, the development of targeted therapeutics like traztuzumab is a difficult and uncertain process with a poor success rate  <cit> . clinical treatment of cancer could therefore considerably benefit from new ways of identifying sub-types missed by the prevailing expression clustering approaches, better methods of finding diagnostic signatures of those sub-types, and improved techniques for identifying those genes essential to the pathogenicity of particular sub-types.

more sophisticated computational models of tumor evolution, drawn from the field of phylogenetics, have provided an important tool for identifying and characterizing novel cancer sub-types  <cit> . the principle behind cancer phylogenetics is simple: tumors are not merely random collections of aberrant cells but rather evolving populations. computational methods for inferring ancestral relationships in evolving populations should therefore provide valuable insights into cancer progression. desper et al.  <cit>  developed pioneering approaches to inferring tumor phylogenies  using evolutionary distances estimated from the presence or absence of specific mutation events  <cit> , global dna copy numbers assayed by comparative genomic hybridization   <cit> , or microarray gene expression measurements  <cit> . more involved maximum likelihood models have since been developed to work with similar measurements of tumor state  <cit> . these approaches all work on the assumption that a global assessment of average tumor status provides a reasonable characterization of one possible state in the progression of a particular cancer sub-type. by treating observed tumors as leaf nodes in a species tree, desper et al. could apply a variety of methods for phylogenetic tree inference to obtain reasonable models of the major progression pathways by which tumors evolve across a patient population.

an alternative approach to tumor phylogenetics, developed by pennington et al.  <cit> , relies instead on heterogeneity between individual cells within single tumors to identify likely pathways of progression  <cit> . this cell-by-cell approach is based on the assumption that tumors preserve remnants of earlier cell populations as they develop. any given tumor will therefore consist of a heterogeneous mass of cells at different stages of progression along a common pathway, as well as possibly contamination by healthy cells of various kinds. this conception arose initially from studies using fluourescence in situ hybridization  to assess copy numbers of dna probes within individual cells in single tumors. these studies showed that single tumors typically contain multiple populations of cells exhibiting distinct subsets of a common set of mutations, such as successive acquisition of a sequence of mutations or varying degrees of amplification of a single gene  <cit> . these data suggested that as tumors progress, they retain remnant populations of ancestral states along their progression pathways. the most recent evidence from high-throughput resequencing of both primary tumors and metastases from common patients further supports this conclusion, showing that primary tumors contain substantial genetic heterogeneity and indicating that mestastases arise from further differentiation of sub-populations of the primary tumor cells  <cit> . the earlier fish studies led to the conclusion that by determining which cell types co-occur within single tumors, one can identify those groups of cell states that likely occur on common progression pathways  <cit> . pennington et al.  <cit>  developed a probabilistic model of tumor evolution from this intuition to infer likely progression pathways from fish copy number data. the pennington et al. model treated tumor evolution as a steiner tree problem within individual patients, using pooled data from many patients to build a global consensus network describing common evolutionary pathways across a patient population. this cell-by-cell approach to tumor phylogenetics is similar to methods that have been developed for inferring evolution of rapidly evolving pathogens from clonal sequences extracted from multiple patients  <cit> .

each of these two approaches to cancer phylogenetics has advantages, but also significant limitations. the tumor-by-tumor approach has the advantage of allowing assays of many distinct probes per tumor, potentially surveying expression of the complete transcriptome or copy number changes over the complete genome. it does not, however, give one access to the information provided by knowledge of intratumor heterogeneity, such as the existence of transitory cell populations and the patterns by which they co-occur within tumors, that allow for a more detailed and accurate picture of the progression process. the cell-by-cell approach gives one access to this heterogeneity information, but at the cost of allowing only a small number of probes per cell. it thus allows for only relatively crude measures of state using small sets of previously identified markers of progression.

one potential avenue for bridging the gap between these two methodologies is the use of computational methods for mixture type separation, or "unmixing," to infer sample heterogeneity from tissue-wide measurements. in an unmixing problem, one is presented with a set of data points that are each presumed to be a mixture of unknown fractions of several fundamental components. unmixing comes up in numerous contexts in the analysis and visualization of complex datasets and has been independently studied under various names in different communities, including unmixing, "the cocktail problem," "mixture modeling," and "compositional analysis." in the process, it has been addressed by many methods. one common approach relies on classic statistical methods, such as factor analysis  <cit> , principal components analysis   <cit> , multidimensional scaling   <cit> , or more recent elaborations on these methods  <cit> . mixture models  <cit> , such as the popular gaussian mixture models, provide an alternative by which one can use more involved machine learning algorithms to fit mixtures of more general families of probability distributions to observed data sets. a third class of method arising from the geosciences, which we favor for the present application, treats unmixing as a geometry problem. this approach views components as vertices of a multi-dimensional solid  that encloses the observed points  <cit>  making unmixing essentially the problem of inferring the boundaries of the solid from a sample of the points it contains.

the use of similar unmixing methods for tumor samples was pioneered by billheimer and colleagues  <cit>  for use in enhancing the power of statistical tests on heterogenous tumor samples. the intuition behind this approach is that markers of tumor state, such as expression of key genes, will tend to be diluted because of infiltration from normal cells or different populations of tumor cells. by performing unmixing to identify the underlying cellular components of a tumor, one can more effectively test whether any particular cell state strongly correlates with a particular prognosis or treatment response. a similar technique using hidden markov models has more recently been applied to copy-number data to correct for contamination of healthy cells in primary tumor samples  <cit> . these works demonstrate the feasibility of unmixing approaches for separating cell populations in tumor data.

in the present work, we develop a new approach using unmixing of tumor samples to assist in phylogenetic inference of cancer progression pathways. our unmixing method adapts the geometric approach of ehrlich and full  <cit>  to represent unmixing as the problem of placing a polytope of minimum size around a point set representing expression states of tumors. we then use the inferred amounts by which the components are shared by different tumors to perform phylogenetic inference. the method thus follows a similar intuition to that of the prior cell-by-cell phylogenetic methods, assuming that cell states commonly found in the same tumors are likely to lie on common progression pathways. we evaluate the effectiveness of the approach on two sets of simulated data representing different hypothetical mixing scenarios, showing it to be effective at separating several components in the presence of moderate amounts of noise and inferring phylogenetic relationships among them. we then demonstrate the method by application to a set of lung tumor microarray samples  <cit> . results on these data show the approach to be effective at identifying a state set that corresponds well to clinically significant tumor types and at inferring phylogenetic relationships among them that are generally well supported by current knowledge about the molecular genetics of lung cancers.

RESULTS
algorithms
model and definitions
we assume that the input to our methods consists primarily of a set of gene expression values describing activity of d genes in n tumor samples. these data are collectively encoded as a d × n gene expression matrix m, in which each column corresponds to expression of one tumor sample and each row to a single gene in that sample. we make no assumptions about whether the sample is representative of the whole patient population or biased in some unspecified way, although we would expect the methods to be more effective in separating states that constitute a sufficiently large fraction of all cells sampled across the patient population. the fraction of cells needed to give sufficiently large representation cannot be specified precisely, however, as it would be expected to depend on data quality, the number of components to be inferred, and the specific composition of each component. we define mij to be element  of m. note that it is assumed that m is a raw expression level, possibly normalized to a baseline, and not the more commonly used log expression level. this assumption is necessary because our mixing model assumes that each input expression vector is a linear combination of the expression vectors of its components, an assumption that is reasonable for raw data but not for logarithmic data. we further assume that we are given as input a desired number of mixture components, k. the algorithm proceeds in two phases: unmixing and phylogeny inference.

the output of the unmixing step is assumed to consist of a set of mixture components, representing the inferred cell types from the microarray data, and a set of mixture fractions, describing the amount of each observed tumor sample attributed to each mixture component. mixture components, then, represent the presumed expression signatures of the fundamental cell types of which the tumors are composed. mixture fractions represent the amount of each cell type inferred to be present in each sample. the degree to which different components co-occur in common tumors according to these mixture fractions provides the data we will subsequently use to infer phylogenetic relationships between the components. the mixture components are encoded in a d ×k matrix c, in which each column corresponds to one of the k components to be inferred and each row corresponds to the expression level of a single gene in that component. the mixture fractions are encoded in an n × k matrix f, in which each row corresponds to the observed mixture fractions of one observed tumor sample and each column corresponds to the amount of a single component attributed to all tumor samples. we define fij to be the fraction of component j assigned to tumor sample i and  to be vector of all mixture fractions assigned to a given tumor sample i. we assume that ∑i fij =  <dig> for all j. the overall task of the unmixing step, then, is to infer c and f given m and k.

the unmixing problem is illustrated in fig.  <dig>  which shows a small hypothetical example of a possible m, c, and f for k =  <dig>  in the example, we see two data points, m <dig> and m <dig>  meant to represent primary tumor samples derived from three mixture components, c <dig>  c <dig>  and c <dig>  for this example, we assume data are assayed on just two genes, g <dig> and g <dig>  the matrix m provides the coordinates of the observed mixed samples, m <dig> and m <dig>  in terms of the gene expression levels g <dig> and g <dig>  we assume here that m <dig> and m <dig> are mixtures of the three components, c <dig>  c <dig>  and c <dig>  meaning that they will lie in the triangular simplex that has the components as its vertices. the matrix c provides the coordinates of the three components in terms of g <dig> and g <dig>  the matrix f then describes how m <dig> and m <dig> are generated from c. the first row of f indicates that m <dig> is a mixture of equal parts of c <dig> and c <dig>  and thus appears at the midpoint of the line between those two components. the second row of f indicates that m <dig> is a mixture of 80% c <dig> with 10% each c <dig> and c <dig>  thus appearing internal to the simplex but close to c <dig>  in the real problem, we get to observe only m and must therefore infer the c and f matrices likely to have generated the observed m.

the output of the phylogeny step is presumed to be a tree whose nodes correspond to the mixture components inferred in the unmixing step. the tree is intended to describe likely ancestry relationships among the components and thus to represent a hypothesis about how cell lineages within the tumors collectively progress between the inferred cell states. we assume for the purposes of this model that the evidence from which we will infer a tree is the sharing of cell states in individual tumors, as in prior combinatorial models of the oncogenetic tree problem  <cit> . for example, suppose we have inferred mixture components c <dig>  c <dig>  and c <dig> from a sample of tumors and, further, have inferred that one tumor is composed of component c <dig> alone, another of components c <dig> and c <dig>  and another of components c <dig> and c <dig>  then we could infer that c <dig> is the parent state of c <dig> and c <dig> based on the fact that the presence of c <dig> or c <dig> implies that of c <dig> but not vice-versa. this purely logical model of the problem cannot be used directly on unmixed data because imprecision in the mixture assignments will lead to every tumor being assigned some non-zero fraction of every component. we therefore need to optimize over possible ancestry assignments using a probability model that captures this general intuition but allows for noisy assignments of components. this model is described in detail under the subsection "phylogeny" below.

cell type identification by unmixing
we perform cell type identification by seeking the most tightly fitting bounding simplex enclosing the observed point set, assuming that this minimum-volume bounding simplex provides the most plausible explanation of the observed data as convex combinations of mixture components. our method is inspired by that of ehrlich and full  <cit> , who proposed this geometric interpretation of the unmixing problem in the context of interpreting geological data to identify origins of sediment deposits based on their chemical compositions. their method proceeds from the notion that one can treat a set of mixture components as points in a euclidean space, with each coordinate of a given component specified by its concentration of a single chemical species. any mixture of a subset of these samples will then yield a point in the space that is linearly interpolated between its source components, with its proximity to each component proportional to amount of that component present in the sample. interpreted geometrically, the model implies that the set of all possible mixtures of a set of components will define a simplex whose vertices are the source components. in principal, if one can find the simplex then one can determine the compositions of the components based on the locations of the vertices in the space. one can also determine the amount of each component present in each mixed sample based on the proximity of that sample's point to each simplex vertex. ehrlich and full proposed as an objective function to seek the minimum-size simplex enclosing all of the observed points. in the limit of low noise and dense, uniform sampling, this minimum-volume bounding simplex would exactly correspond to the true simplex from which points are sampled. while that model might break down for more realistic assumptions of sparsely sampled, noisy data, it would be expected to provide a good fit if the sample is sufficiently accurate and sufficiently dense as to provide reasonable support for the faces or vertices of the simplex. there is no known sub-exponential time algorithm to find a minimum-volume bounding simplex for a set of points and erhlich and full therefore proposed a heuristic method that operates by guessing a candidate simplex within the point set and iteratively expanding the boundaries of the candidate simplex until they enclose the full point set.

we adopt a similar high-level approach of sampling candidate simplices and iteratively expanding boundaries to generate possible component sets. there are, however, some important complications raised by gene expression data, especially with regard to its relatively high dimension, that lead to substantial changes in the details of how our method works. while the raw data has a high literal dimension, though, the hypothesis behind our method is that the data has a low intrinsic dimension, essentially equivalent to the number of distinct cell states well represented in the tumor samples. to allow us to adapt the geometric approach to unmixing to these assumed data characteristics, our overall method proceeds in three phases: an initial dimensionality reduction step, the identification of components through simplex-fitting as in ehrlich and full, and assignment of likely mixture fractions in individual samples using the inferred simplex.

for ease of computation, we begin our calculations by transforming the data into dimension k -  <dig> . for this purpose, we use principal components analysis   <cit> , which decomposes the input matrix m into a set of orthogonal basis vectors of maximum variance, and then use the k -  <dig> components of highest variance. this operation has the effect of transforming the d × n expression matrix m into a linear combination pv + a, where v is the matrix of principal components of m, p is the weighting of the first k -  <dig> components of v in each tumor sample, and a is a d × n matrix in which each element aij contains the mean expression level of gene d across all n tumor samples. the matrix p then represents a maximum variance encoding of m into dimension k -  <dig>  p serves as the principal input to the remainder of the algorithm, with v and a used in post-processing to reconstruct the inferred expression vectors of the components in the original dimension d.

note that although pca is itself a form of unmixing method, it would not by itself be an effective method for identifying cell states. we would not in general expect cell types to yield approximately orthogonal vectors since distinct cell types are likely to share many modules of co-regulated genes, and thus similar expression vectors, particularly along a single evolutionary lineage. furthermore, the limits of expression along each principal component are not sufficient information to identify the cell type mixture components, each of which would be expected to take on some portion of the expression signature of several components. for the same reasons, we would not be able to solve the present problem by any of the other common dimension-reduction methods similar to pca, such as independent components analysis   <cit> , kernel versions of pca or ica  <cit> , or various related methods for performing non-linear dimensionality reduction while preserving local geometric structure  <cit> . one might employ ica or other similar methods in place of pca for dimensionality reduction in the preliminary step of this method. however, since our goal is only to produce a low-dimensional embedding of the data, there is some mathematical convenience to deriving an orthogonal basis set with exactly k dimensions, something that is not guaranteed for the common alternatives to pca. it is also of practical value in solving the simplex-fitting problem to avoid using dimensions with very little variance, an objective pca will accomplish.

once we have transformed the input matrix m into the reduced-dimension matrix p, the core of the algorithm then proceeds to identify mixture components from p. for this purpose, we seek a minimum-volume polytope with k vertices enclosing the point set of p. the vertices will represent the k mixture components to be inferred. intuitively, we might propose that the most plausible set of components to explain a given data set is the most similar set of components such that every observed point is explainable as a mixture of those components. seeking a minimum volume polytope provides a mathematical model of this general intuition for how one might define the most plausible solution to the problem. the minimum volume polytope can also be considered a form of parsimony model for the observed data, providing a set of components that can explain all observed data points while minimizing the amount of empty space in the simplex, in which data points could be, but are not, observed.

component inference begins by chosing a candidate point set that will represent an initial guess as to the vertices of the polytope. we select these candidate points from within the set of observed data points in p. we use a heuristic biased sampling procedure designed to favor points far from one another, and thus likely to enclose a large fraction of the data points. the method first samples among all pairs of observed data points  weighted by the distance between the points raised to the kth power: || - ||k. it then successively adds additional points to a growing set of candidate vertices. sampling of each successive point is again weighted by the volume of the simplex defined by the new candidate point and the previously selected vertices raised to the kth power. simplex volume is determined using the matlab convhulln routine. the process of candidate point generation terminates when all k candidate vertices have been selected, yielding a guess as to the simplex vertices that we will call k, which will in general bound only a subset of the point set of p.

the next step of the algorithm uses an approach based on that of ehrlich and full  <cit>  to move faces of the simplex outward from the point set until all observed data points in p are enclosed in the simplex. this step begins by measuring the distance from each observed point to each face of the simplex. a face is defined by any k -  <dig> of the k candidate vertices, so we can refer to face fi as the face defined by k/{ki}. this distance is assigned a sign based on whether the observed point is on the same side of the face as the missing candidate vertex  or the opposite side of the face . the method then identifies the largest positive distance from among all faces fi and observed points pj, which we will call dij. dij represents distance of the point farthest from the simplex. we then transform k to enclose pj by translating all points in k/{ki} by distance dij along the tangent to fi, creating a larger simplex k that now encloses pj. this process of simplex expansion repeats until all observed points are within the simplex defined by k. this final simplex represents the output of one trial of the algorithm. we repeat the method for n trials, selecting the simplex of minimum volume among all trials, kmin, as the output of the component inference algorithm.

once we have selected kmin, we must explain all elements of m as convex combinations of the vertices of kmin. we can find the best-fit matrix of mixture fractions f by solving for a linear system expressing each point as a combination of the mixture components in the k - 1-dimensional subspace. to find the relative contributions of the mixture components to a given tumor sample, we establish a set of constraints declaring that for each gene i and tumor sample t:  

we also require that the mixture components sum to one for each tumor sample:  

since there are generally many more genes than tumor samples, the resulting system of equations will usually be overdetermined, although solvable assuming exact arithmetic. we find a least-squares solution to the system, however, to control for any arithmetic errors that would render the system unsolvable. the ftj values optimally satisfying the constraints then define the mixture fraction matrix f.

we must also transform our set of components kmin back from the reduced dimension into the space of gene expressions. we can perform that transformation using the matrices v and a produced by pca as follows:  

the resulting mixture components c and mixture fractions f are the primary outputs of the code. the full inference process is summarized in the following pseudocode:

given tumor samples m and desired number of mixture components k:

 <dig>  define kmin to be an arbitrary simplex of infinite volume

 <dig>  apply pca to yield the k - 1-dimension approximation m ≈ pv + a

 <dig>  for each i =  <dig> to n

a. sample two points  and  from p weighted by || - ||k

b. for each j =  <dig> to k

i. sample a point  from p weighted by volumek

c. while there exists some pj in p not enclosed by k = 

i. identify the pj farthest from the simplex defined by k

ii. identify the face fi violated by pj

iii. move the vertices of fi along the tangent to fi until they enclose pj

d. if volume <volume then kmin ← k

 <dig>  for each tumor sample i

i. solve for the elements ftj of f defined by the constraints:

∑j ftjkij = pit ∀i, t

∑j ftj =  <dig> ∀ t

 <dig>  find the component matrix c ← kminv + a

 <dig>  return  as the inferred components and mixture fractions

phylogeny inference
once we have inferred cell states and their mixture fractions in each tumor sample, we can use those inferences to construct a phylogeny suggesting how the states are evolutionarily related. the sharing of states within individual tumors provides clues as to which cell types are likely to occur on common progression pathways. imprecision in the mixture fraction assignments, however, will tend to create a spurious appearance of cell-type sharing due to tumors being assigned some non-zero fraction of each cell type whether or not they truly contain that type. to overcome the confounding effects of this noise in the mixture fractions, we pose phylogeny inference as the problem of finding a tree that maximizes cell-type sharing across tree edges and thus implicitly minimizes the assignment of edges to cell-type pairs that appear to co-occur due to noisy mixture fraction assignments or more distant evolutionary relationships. we define a measure of sharing of any two cell types i, j as follows:  

where t sums over tumor samples.

one can conceive of this measure as a log likelihood model, in which we are interested in explaining the frequency with which any given pair of states would be sampled by picking two independent cells from a given tumor. the numerator describes the hypothesis that a given pair of states are sampled from correlated densities, with the frequency of the pair derived by summing over the product of the two types' frequencies in individual tumors. the denominator describes the hypothesis that the states are independent of one another and thus sampled independently from some background noise distributions, with the two independent frequencies estimated by summing each cell type's frequency individually over all tumors. seeking a tree that maximizes the log sum of this measure across all tree edges is then equivalent to seeking a maximum likelihood bayesian model in which each child is presumed to have frequency directly dependent on its parent and independent of all other tree nodes. intuitively, this distance function will tend to assign high sharing to cell types that generally have high frequencies in common tumors and low sharing to cell types that generally occur in disjoint tumors. the set of sij values thus provides a similarity matrix for a phylogeny inference.

the model makes several assumptions about the available data. we assume that we have inferred all states present in the data and that our states therefore represent both internal and leaf nodes of the phylogeny. this assumption follows from the evidence that tumor samples maintain remnant populations of their earlier progression states  <cit> , leading to the conclusion that our model should be able to explain some states as ancestors of others. while it is possible that some ancestral states are lost or preserved at levels too low to detect, we do not attempt to infer the presence of missing  states. we further assume that the evolutionary relationships among the states are in fact a tree, i.e., connected and cycle-free. finally, we assume that all observed states are in fact related to one another. it is indeed possible that any of these assumptions could be violated. our prior work on phylogenetics from single-cell fluoresence in situ hybridization  data suggests that there may be multiple pathways from healthy cells to particular tumor states  <cit> , which would imply that the true evolutionary pathways may form a cycle-containing phylogenetic network rather than a phylogenetic tree. it is also reasonable to suppose that different tumors may originate from distinct cell types and thus form a multi-tree forest, rather than a single tree. for the present proof-of-concept study, though, we have chosen to exclude these possibilities in order to avoid the greater uncertainty we would incur by seeking to fit to a richer class of models. furthermore, we would expect that tumor samples will contain contamination from stromal cells that might not be ancestral to any of the tumor cells. we again choose not to build in an explicit correction to our model to distinguish tumor from healthy cells in our model. rather, we allow the model to treat contaminating healthy cells as one or more tumor states, expecting that healthy cells in the mixtures will be inferred as ancestral states to the tumor whether or not the tumor actually arose from the same population of healthy cells as those it has infiltrated. thus, we model our phylogeny problem strictly as the problem of inferring a maximum-similarity tree connecting all of our observed states without the introduction of additional  nodes. for this model, we can pose the problem as a minimum spanning tree  problem in which each edge  is assigned weight -s. we solve this problem with the matlab graphminspantree routine.

testing
validation on simulated data
we first validated the method using two protocols for simulated data generation. simulated data is essential for validation because the ground truth components and their representation in particular tumors are not known for real tumor data sets. in addition, it allows us to explore how performance of the method varies with assumptions about the data set. we began by applying a simple simulation protocol for generating uniformly sampled mixtures, in which each component is simulated as an independent vector of unit normal random variables and each observed tumor passed as input to the data set is simulated as a uniformly random mixture of this common set of components . we developed a second simulation protocol meant to better mimic the substructure expected from true tumor samples due to the evolutionary relationships among sub-types. in this protocol, we assume that mixture components correspond to nodes in a binary tree and that each observed tumor represents a mixture of components along a random path in that tree . in both protocols, we add log normal noise to all simulated expression measurements.

fig.  <dig> shows a few illustrative examples of simulated data sets along with their true and inferred mixture components. fig.  <dig> shows a trivial case of the problem, a uniform mixture of three components without noise, resulting in a triangular point cloud. the close overlap of the true mixture components  and the inferred components  shows that method could infer the mixture components in this case with high accuracy. fig.  <dig> shows a tree-embedded sample of three components in the presence of high noise . performance was somewhat degraded, apparently primarily because the simplex produced by the true mixture components was a poorer fit to the noisy data. fig.  <dig> shows a more complicated evolutionary scenario consisting of five tree-embedded mixture components, with low  noise. the scenario models two progression lineages, with each sample consisting of a component of the root state and zero, one, or two states along a single progression lineage. the result is a simplicial complex consisting of two triangular faces joined at the root point. while there was a clear correspondence between true and inferred mixture components, performance quality was noticeably lower than that for the simpler scenarios.

fig.  <dig> quantifies the performance quality across a range of simulated data qualities and evolution scenarios. fig.  <dig> assesses accuracy on uniform mixtures by the error in inferred components and fig.  <dig> by the error in inferred mixture fractions. figs.  <dig> reveal that mixture components could be identified with high accuracy provided there were few mixture components and low noise. accuracy degraded as component number or noise level increased. errors appear to have grown superlinearly with component number but sublinearly with the noise level. accuracy of mixture fraction inference appears sensitive to component number but largely insensitive to noise level over the ranges examined here. it should be noted that the high accuracy regardless of noise level likely depended on the assumption that noise in each gene is independent, allowing extremely accurate estimates when noise could be averaged over many genes. correlated noise between genes or systemic sample-wide errors would be expected to yield poorer performance.

figs.  <dig> provide a comparable analysis for tree-embedded samples. the tree-embedded data yielded qualitatively similar trends to the uniform mixtures. component inference degraded with increasing noise or increasing number of components while mixture fraction inference degraded with increasing number of components but appears insensitive to noise level. compared to uniform samples, tree-embedded samples led to substantially better inference of components but generally slightly worse inference of mixture fractions.

fig.  <dig> plots accuracy of tree inference on tree-embedded simulated data, measured as the fraction of true tree edges correctly inferred over ten replicates per data point. accuracy ranged from 100% for three-component inferences to approximately 75%-80% for seven-component inferences. accuracy appears to have been insensitive to noise in expression measurements over the ranges examined. the fraction of edges one would expect to correctly predict by chance for a k-node tree is /, which ranges from 67% for k =  <dig> to 29% for k =  <dig>  we can thus conclude that the performance, while not perfect, was substantially better than would be observed by chance.

application to real data
in order to demonstrate the applicability of the methods to real tumor data, we next examined a dataset of lung tumor expression measurements from jones et at.  <cit> . this dataset is particularly useful for the present validation because it includes normal lung samples, which allow us to root phylogenies and look for expected mixing of normal cells in tumor samples; because it is well annotated with regard to clinically significant tumor subtypes, which provides a partial basis for validating the success of the unmixing; and because it includes both primary tumor samples and cell lines for a single tumor type, which allows us to compare inferred mixture fractions between "pure" and "mixed" samples. the authors of this study classified tumors into one of eight categories: normal lung cells , primary adenocarcinoma , primary large cell carcinoma , primary carcinoid , primary small cell , small cell lines , primary large cell neuroendocrine , and primary combined small cell/adenocarcinoma . these categories are used for validation and visualization purposes below.

fig.  <dig> visualizes the results of the four-component inference on the jones et al. data  <cit> . fig.  <dig> shows the full set of data points, each visualized as a red point, and the set of mixture components, shown as blue x's. the positions of the mixture components in relative gene expression space are provided in additional file  <dig>  table s <dig>  we have added numerical labels  to the inferred mixture components to allow unambiguous reference to them below. we will subsequently refer to these four inferred mixture components as , , , and . while the three-dimensional fit of the data points into the simplex is difficult to visualize from two-dimensional projections, it can be roughly described as a dense central point cloud from which three "arms" project to form a tripod shape. mixture component  was placed above the central cloud on the opposite side from the arms and , , and  each fell roughly along the vector of a distinct arm, somewhat beyond that arm's end.

fig.  <dig> provides three additional views with the individual tumors marked to indicate clinical subtypes. fig.  <dig> shows a view of the three "arms" seen from above the central cloud. normal lung cells  clustered near the top of the central cloud, with adenocarcinoma  and large-cell neuroendocrine tumors  nearby.  appears near the middle of the figure in this view, near the central cloud but above and somewhat off-center. the first arm extends to the lower left towards  and appears to consist exclusively of carcinoid tumors. the second arm extends upward towards  and consists primarily of small cell lung cancers, both primary and cell line. a third arm, apparently consisting primarily of large cell carcinomas, extends towards . fig.  <dig> shows an alternative view approximately down the axis running from  to the central cloud. this view makes it more apparent that  was positioned just beyond the central cloud and its cap of normal cells, although somewhat skewed towards the small cell tumors. this view also reveals that large cell neuroendocrine tumors lie between normal and small cell tumors and that small cell lines lie further towards  than do small cell primary samples. fig.  <dig> provides one additional view, meant to highlight the large cell axis towards . in this view, adenocarcinomas appear to lie along the vector from normal cells to large cell carcinomas. on the basis of these observations, we could approximately associate the four components with the clinical subclasses as follows:  with normal cells,  with carcinoid,  with small cell and large cell neuroendocrine, and  with large cell carcinoma and adenocarcinoma.

columns correspond to mixture components from a four-component inference. rows correspond to distinct tumor types, as annotated by jones et al. .

we next examined performance of the method with six components, which we label , ..., . while we cannot easily visualize the resulting five-dimensional simplex, we can interpret the results in terms of mixture fraction assignments  and gene expression levels assigned to the components . table  <dig> suggests that  predominantly marks the normal cells ; that  predominantly marked the large cell carcinoma, adenocarcinoma, and combined small cell/adenocarcinoma ; that  predominantly marked the small cell lines, followed by small cell primary tumors and neuroendocrine tumors ; and that  was specific for the carcinoid tumors .  did not have an easy interpretation in terms of tumor types, as it most strongly marked the small cell cancers but was strongly associated with normals and assigned as a high fraction for all but the combined tumors.  showed high frequency only for combined small cell/adenocarcinomas; in fact, a closer examination of the data showed it to be strongly associated with only one of the two combined tumors  and only minimally with the other .

columns correspond to mixture components from a six-component inference. rows correspond to distinct tumor types, as annotated by jones et al. .

comparing gene expression vectors from additional files  <dig> and  <dig>  tables s <dig> and s <dig>  can help us interpret these observations. table  <dig> shows pearson correlation coefficients between the inferred expression vectors of the two component sets. the table suggests that  has been largely captured by  and  by .  has been split into contributions of  and .  was split into contributions of , , and .

entries show the pearson correlation coefficients between inferred relative gene expression levels for components inferred from a 4-component versus a 6-component inference. rows correspond to mixture components from a four component inference and columns from a six component inference.

fig.  <dig> shows the phylogeny inferences derived from the lung cancer data. for ease in interpretation, we have labeled nodes of the trees by the tumor types with which they are most strongly associated. the 4-component phylogeny ) showed lung tumors following two distinct pathways from normal cells. the first pathway moved first towards a small cell/large cell neuroendocrine state. carcinoid tumors appeared as a later branch off that first state. there was, however, uncertainty about the order of those two states, with a substantial fraction of trials placing carcinoid above small cell/large cell neuroendocrine or placing the two states as independent branches off normal cells. the second pathway led into the large cell carcinoma/adenocarcinoma state. the 6-component phylogeny ) likewise showed two major pathways, one passing through small cell/large cell neuroendocrine and terminating in carcinoid tumors, the other passing through large cell carcinoma/adenocarcinoma. if we use the correspondence of states suggested by tumor type associations  then the 4-component tree could be seen to be a subgraph of the 6-component tree. one of the two additional states () was inserted as an early step along the small cell/large cell neuroendocrine/carcinoid pathway. the other (), which showed preference for the combined scc/ad tumors, appeared as a later state along the large cell carcinoma/adenocarcinoma pathway. the greatest uncertainty in the tree concerned the placement of , which was most often a child of  but was found with moderate probability as children of the three normal and small cell states. the 6-component tree, like the 4-component tree, also showed uncertainty in the placement of the carcinoid state, which was most often placed as a descendant of the small cell/neuroendocrine states but was often placed higher in that lineage or in a separate lineage out of the normal cells.

the application to real lung cancer data provides a further opportunity to evaluate the approach, in addition to suggesting some novel hypotheses about the molecular evolution of lung cancers. both 4- and 6-component inferences suggest that the tumor types examined here evolve into two major groups early in their progression: one consisting of large cell neuroendocrine, small cell, and carcinoid tumors and the other consisting of adenocarcinoma and large cell carcinoma. this subdivision is supported by many lines of evidence on specific genetic abnormalities frequently found in the different sub-types, which suggest that small cell and large cell neuroendocrine carcinomas arise from common progenitors  <cit>  and that carcinoids are closely related to neuroendocrine and small cell tumors but not to other carcinomas  <cit> . this conclusion thus appears to provide validation for the method. both trees also suggest that carcinoid cells represent a later stage of progression than large cell neuroendocrine and small cell tumors along a common lineage. while the literature does support a close relationship between these sub-types, it also suggests that carcinoid tumors likely represent a less advanced state of progression than small cell tumors. several genetic abnormalities characteristic of both types show higher frequency in small cell than in carcinoid tumors  <cit> . furthermore, small cell tumors are more aggressive than carcinoids  <cit> . it thus appears that while the close placement of these states provides further validation for the present approach, it has most likely inverted the order of those states along the lineage. the fact that the method relies on sharing of states within common tumors to make phylogenetic inferences may make it particularly vulnerable to this sort of inversion of states along a single lineage absent higher-quality assignments of mixture fractions.

the 6-component tree appears to be an elaboration on the 4-component tree, supporting a common model of the two major pathways but adding some additional features beyond that. one intriguing feature is the insertion of the  component at the top of the neuroendocrine/small cell/carcinoid lineage. the method appears to have sub-divided the normal cells into two populations: a more specifically normal state () and a state more strongly shared with the tumors and especially the small cell lineage (). it is possible this split represents some axis of variation independent of mutational state of a cell. it could also, however, suggest the hypothesis that the separation into the two tumor lineages corresponds to a genetic or epigenetic heterogeneity present within normal lung cells. in particular, the phylogeny predicts that the small cell lineage specifically branches from  and the large cell lineage from . the other elaboration is the introduction of , which is most specifically associated with a single combined small cell/adenocarcinoma tumor. the existence of such combined tumors would appear incompatible with the conclusion that small cell and adenocarcinoma lie on unrelated lineages. examination of molecular abnormalities in specific cases is contradictory on this point, though, with some studies reporting combined tumors that arise through the independent appearance of distinct cancer lineages in a single patient  <cit>  but others showing evidence of common clonal origin  <cit> . the inferred phylogeny suggests that this new state is most likely a later progression of an adenocarcinoma state, with the combined tumors seemingly acquiring their small cell component independently. given the high uncertainty of the phylogeny step in placing  in the tree, though, we might alternatively suggest that  is simply a spurious inference that cannot be confidently placed because it does not correspond to a true progression state of lung tumors. the two combined tumors included in the jones et al.  <cit>  dataset used in the present study show very different expression patterns and mixture assignments from one another. the geometric approach chosen here would be expected to be sensitive to outlier points and it may be that aberrant expression in even a single unusual tumor could have forced incorrect inference of a new progression state.

implementation
all code for this project was written in matlab and executed with matlab v. <dig> on a linux pc. matlab was also used for visualization of component inferences. the validation code also required hungarian.m, a third-party matlab routine for performing weighted bipartite maximum matching  <cit> . unmixing and phylogenetics code implementing the algorithms described in the present work are available from

http://www.cs.cmu.edu/~russells/software/unmixing/

as matlab ".m" files. other custom code used in data analysis and generation of simulated data sets will be provided upon request.

discussion
we have developed a novel approach to tumor phylogenetics combining unmixing methods with a cell-by-cell strategy for phylogeny inference. the method is an attempt to gain the advantages of both intratumor heterogeneity information available to cell-by-cell methods and the large probe sets available to tumor-by-tumor methods. the application to simulated data sets suggests that the method is effective at making component and mixture fraction inferences from large, noisy datasets for limited numbers of components. the method does, however, degrade in performance quickly with increasing numbers of mixture components. phylogeny inference, which depends on the quality of the mixture fraction inference, similarly shows high tolerance for noise, although a loss of quality with increasing numbers of components. nonetheless, phylogeny inferences show good reconstruction accuracy for as many as seven components on simulated tree-embedded samples. the methods are generally more effective at component inference from these tree-embedded samples, suggesting that they can effectively exploit some features of the geometric substructure we would expect an evolutionary process to produce. application to a real lung cancer data set shows the method to be effective at inferring components consistent with known lung cancer sub-types and with grouping these components into phylogenies generally consistent with the prior literature on the evolution of lung tumors. the method does, however, make some apparent mistakes and provide low confidence to some seemingly correct predictions, suggesting room for improvement.

the approach, at least as presently realized, does make a number of assumptions about the data and tumor progression in general that one might reasonably question. the primary purpose of this paper is to lay out the general concept of how unmixing methods can inform tumor phylogenetics and this concept in itself implies certain assumptions. some assumptions concern the biology of tumor development: that there are reproducible cancer sub-types that co-occur in the population, that tumors accumulate remnant cell populations as they progress, that these remnant progression states are themselves reproducible across patients, and that these remnant states persist at high enough levels to measureably influence overall expression. there is considerable literature supporting all of these points, as discussed in the introduction, although they might reasonably be debated. a further assumption is that the states we wish to observe differ sufficiently in expression profile as to be separable by unmixing methods. while there is strong evidence in the literature that distinct sub-types can be separated by their expression profiles, there is no direct experimental basis from which to argue that individual cell states along a single progression pathway are similarly separable. it remains to be seen how precisely one can sub-divide a progression pathway and which mutations or combinations of mutations will or will not lead to discernible changes in expression profile.

the specific implementation of the model in the present work adds additional assumptions that underlie the results here but might conceivably be relaxed in future work. the present model assumes that individual components of a mixture contribute linearly to the mixture, i.e., that the expression level of each gene in a tumor sample is a derived from the weighted sum of the expression level of the gene in each component of the sample. this assumption might break down due to limitations of the microarray technology or for biological reasons, e.g., if intracellular communication leads to radically different expression in mixtures of cell types than in the cell types independently. we would expect the dimensionality reduction step to partially correct for such problems by extracting a linear subset of the full expression space. non-linear dimensionality reduction methods  <cit> , however, might be more effective at making use of the available data if the linearity assumption is poorly satisfied. a second assumption of the present work is that we can unmix a sufficient number of states to produce a useful picture of progression. any unmixing method will have difficulty separating rare states or states with very similar expression profiles, especially in the presence of noisy data. more sophisticated methods for noise-tolerant learning would seem to be a possible solution, such as the gaussian mixture models used by etzioni et al.  <cit> . our current approach also assumes that we can do a reasonably good job of fitting a tight simplex to the point set. there is no known method sub-exponential in dimension for optimally solving the simplex-fitting problem and we must therefore use heuristics that provide no guarantees of the quality of our solutions. nonetheless, improved simplex fitting might lead to a better ability to detect and reliably separate similar or rare states. our current approach might be improved by post-processing with a local optimization method, such as the "simplex shrink-wrap" algorithm of fuhrmann  <cit> . another key step for improvement will be making better use of the geometric form of the data points expected. as both the lung data and the synthetic tree-embedded tumor data show, point sets derived from evolutionary processes are not uniform simplices, but rather more complicated simplicial complexes characterized by lower-dimensional elaborations branching from the ancestral states. taking better advantage of this class of geometric structure provides a possible avenue for improving inference in the face of sparse and/or noisy data and avoiding the "curse of dimensionality" that leads to poor scaling in component number. uncertainty in the predictions also suggests that more data may be needed to reliably learn the underlying structure. even absent improvements in the methods, more or better data may lead to more nuanced and reliable predictions about tumor phylogenetics by this approach.

there are also several potentially debatable assumptions underlying our current phylogeny methods. the most obvious assumption is that all of the cell types we detect are in fact evolutionarily related. the ultimate product of our method will be a phylogeny connecting all of the inferred cell types, which will not in general be a meaningful outcome if the cell types are not related. at some level, of course, all cells in a given individual are related. distinct tumors may, however, arise from different populations of healthy cells. furthermore, stromal contamination will in general lead to tumor samples containing mixtures of healthy cells that may not be ancestral to any of the tumor types. we chose to accept this assumption in the model, even knowing it to be imperfect, in the belief that it is better to have the predictions of the method about ancestry available and account for the assumptions after the fact in interpreting the meaning of the inferred ancestry relationships. one might alternatively seek to explicitly separate healthy from cancerous cells prior to phylogenetic inference, using the mixture model to remove stromal contaminants as in etzioni et al.  <cit> . a related assumption is that there are no missing states that need to be considered in the model. it is indeed possible that there are missing ancestral states that are present at too low a level to infer directly. in particular, if one accepts the cancer stem cell hypothesis  <cit>  then it would be reasonable to infer that the observed states should all be leaf nodes of the phylogeny, with cancer stem cells comprising the internal nodes of the trees. one could adapt the method to that alternative model by replacing our minimum spanning tree step with any standard species tree phylogeny method, which would treat all observed samples as leaf nodes and all internal nodes as unobserved states. general steiner tree inference methods might allow an intermediate solution, allowing for the assumption that observed states can be leaf or internal nodes but that additional internal nodes may be unobserved. a further assumption is that the output should be a tree. prior studies on cell-by-cell data  <cit>  show that single states may be reachable from multiple pathways, suggesting that a more general phylogenetic network model might be preferable. one final implicit assumption is that the only evidence available to us for phylogeny inference is the frequency with which states are shared in tumors, excluding information available to us in the expression vectors themselves. we might have alternatively posed the phylogeny inference step to operate on the assumption that cells with similar expression profiles are likely to be related, as was done by desper et al. in examining expression profiles of whole tumors  <cit> , or by combining the two sources of information.

a related question raised by these assumptions is whether we can tell, either in advance or post-hoc, whether the assumptions of the model are in fact satisfied by a given data set. one can in principal assess how well the raw input data is explained by a linear mixture of a small number of components, for example by examining the rate at which singular values of the matrix decay. such a validation does not tell us whether information not accounted for by the linear model reflects genuinely non-linear contributions, the need for a more complex linear model, or noise in the true expression data or the experimental measurements. neither does it tell us whether the linear model extracted carries sufficient information to characterize the cell states and their relationships. one can also apply a generic post-hoc validation based on how reproducible the results are to sub-sampling, as in our bootstrapping for the lung phylogenies. if the assumptions of the model are violated, then we would expect the data to only weakly support a defined tree topology. the lung cancer example suggests mixed success, with some features of the inferred trees strongly supported across subsamples but others nearly arbitrary. we can also, after the fact, examine the degree to which the inferred mixture fractions conform to the phylogeny. healthy cells, when available, should be assigned minimal fractions of non-healthy components and tumors on a given progression pathway should exhibit minimal contamination with components characteristic of other pathways. while the lung data does show a clear partitioning of mixture components by sub-type, it nonetheless shows frequent contamination suggestive of poor fitting of the simplex. all of these measures suggest room for improvement in the model and algorithms and will provide a basis for determining whether any alternative methods do in fact improve on those proposed here. perhaps the ultimate test of the method is how well it recapitulates what we already know about a given real data set. our comparison of the lung cancer results to prior knowledge again suggests that the method works sufficiently well to recapitulate our prior understanding about the classification and origin of the major lung tumor classes, but with less precision than we might like and with some apparent mistakes. further post-hoc validation might also be conducted directly on the derived components by testing whether they meet the expression signatures of known tumor sub-types or healthy cell populations.

CONCLUSIONS
we have presented a novel method for identifying likely pathways of tumor progression using computational unmixing methods to interpret expression measurements from tumor samples as mixtures of fundamental components. validation on simulated data demonstrates good effectiveness at inferring mixture components, assigning mixture fractions to samples, and inferring phylogenies provided noise levels and numbers of components are sufficiently small. the prototype methods presented here do appear to suffer from insufficiently precise fits of polytopes to the data, especially as the number of components increases, which can in turn result in spurious identification of components in samples that lack them and inaccurate phylogeny inferences. nonetheless, the effectiveness of the models across a variety of scenarios and in the presence of relatively high levels of noise suggests that the approach has good promise for improving our ability to identify phylogenetic relationships among tumor cells. likewise, application of the method to real lung cancer microarray data shows that the method to be effective at identifying components corresponding to known clinical sub-types and at inferring progression pathways largely consistent with current knowledge about the molecular evolution of lung tumors. these inferences also suggest some novel hypotheses about the genesis of lung cancers. the methods developed here thus represent a promising new computational model for phylogenetic studies of tumors that can provide many of the competing advantages of the two major paradigms for tumor phylogeny inference: tissue-wide and cell-by-cell. this new model is likely to benefit in the future from further methodological insights from both the unmixing and the phylogenetics fields.


BACKGROUND
phylogenetic trees are an important component of a wide variety of biological analyses, from genome annotation to community ecology. much attention has been paid to the problem of estimating accurate phylogenies from dna and amino acid sequence data, including the development of statistical methods to quantify support for each bifurcation in a tree. until recently, phylogenetic methods have largely been applied to sequence data obtained through genome projects and targeted sequencing of individual genes using pcr. for these reasons, bacterial phylogenetics has been constrained to studies of specific genes or to cultured organisms, which represent a small and biased portion of the bacterial tree of life.

shotgun metagenomics, the high-throughput sequencing of fragmented total dna from a sample, gives an essentially random collection of dna sequences from the genomes of the organisms present in a sample. these data provide an opportunity to analyze the full taxonomic and functional diversity encoded in the genomes of microbial communities. metagenomic studies of natural environments, built environments, and the microbiomes of plants and animals have identified thousands of novel proteins and organisms. in order to annotate and interpret these discoveries, it is important to place them in the context of current knowledge using phylogenetic techniques. for example, unifrac analysis of gene-family phylogenies identified convergent evolution of carbohydrate-active enzymes in human gut communities  <cit> . another study showed that blooms of closely related species cause the phylogenetic diversity of marine microbes to be much lower in surface waters compared to below the photic zone at the hot/aloha study site, despite the fact that communities at different depths have similar numbers of operational taxonomic units   <cit> . similar insights have been gained by comparing protein abundance and phylogenetic diversity. for instance, relative abundance of common metabolic pathways is relatively stable across human microbiomes, whereas the phylogenetic diversity of the protein families encoded in these and less common pathways is more variable and possibly associated with host phenotypes  <cit> . testing hypotheses about diversity requires a reliable technique for quantifying the phylogenetic relationships amongst shotgun metagenomic sequencing reads.

in contrast to the well-resolved approaches to analyze pcr-targeted small-subunit ribosomal rna  sequences  <cit> , new techniques are needed for phylogenetic analysis of more complex shotgun metagenomic data. one goal of such methods is to leverage what is already known about gene families in order to exploit the information in short, non-overlapping read fragments, while taking into account the bias and potential error they introduce. shotgun sequencing reads can often be identified as homologues of a gene family if there are a reasonable number of diverse sequences from the family in existing databases . nonetheless, integrating reads into alignments and phylogenetic trees of full-length gene sequences, or generating alignments and trees for reads alone, remains a major bioinformatics challenge. if high quality trees could be built from shotgun metagenomic data, they would greatly expand our ability to characterize and compare microbial communities.

phylogenetic methods typically depend either on the ability to assess evolutionary distance between sequences, e.g., based on computing percent identity, or to fit an evolutionary model to a sequence alignment  <cit> . the first approach is not possible using only the random pieces of each sequence present in a shotgun metagenomic sample. in the second case, likelihoods can be computed for models that include missing data, but the results have not been studied for situations in which missing data is as widespread as is observed in shotgun metagenomes. one solution is to analyze metagenomic reads via fragment recruitment  <cit> , whereby a full-length gene sequence is identified as being the likely source of a shotgun-sequenced read or being closely related to the source, due, for example, to their blast-based similarity. the full-length sequence is then used in place of the read in downstream analysis. to work well, this approach requires a very complete reference database for the gene family, as well as reads that are long enough to be identifiable. another approach to applying phylogenetic analysis to shotgun-sequenced data is to require the use of longer sequences assembled from reads  <cit> . but if the community sampled is complex and the read sequences are short, both common conditions, assembly is prone to producing chimeras  <cit> . recent phylogenetic “placement” and “phylotyping” methods  <cit>  place each read independently in a fixed phylogeny, with the aim of classifying reads with respect to a set of reference sequences. these methods have been tested for their accuracy in classification, rather than their effectiveness in creating phylogenetic trees of sequence reads.

in this paper, we evaluate an approach that enables the direct phylogenetic analysis of shotgun metagenomic reads. the method uses a reference database of full-length sequences to guide construction of a phylogeny composed solely of the metagenomic reads from a gene family  . phylogenetic triangulation enables non-overlapping reads to be related to each other via their relative distances from full-length sequences. the aim of this approach, and the basis on which we evaluate it, is to provide an estimate of the mutual relationships among all reads. while it has already proved successful for generating a phylogenetic distance measure to cluster 16s rrna gene sequences into otus  <cit>  and for quantifying the phylogenetic diversity of microbial communities  <cit>  there are clearly limits to this approach. extremely short reads and a low-coverage reference database are likely to result in very inaccurate trees. most phylogenetic methods were not designed for and have not been evaluated on data sets that contain such an extent of missing data over random positions.

in silico simulations of metagenomic data provide a means to perform these evaluations in the absence of gold-standard data sets and fully characterized communities. metagenomic simulation programs have been released  <cit> , but none of these includes the automated processing of sequencing reads necessary for phylogenetic analysis. to address this problem, we extended the metasim software package  <cit>  into a software workflow, called metapassage, for streamlined creation and processing of metagenomic simulations. metapassage enabled us to perform rigorous statistical assessments of metagenomic phylogenies . we quantified the effects of reference database composition, mean read length, number of reads, and phylogenetic algorithm on the accuracy of metagenomic read trees for 16s rrna and four proteins. to contextualize our results, we included a limited investigation of the effect of sequencing error. we also explored the accuracy of statistical tests based on read trees through a simulated analysis using fast unifrac  <cit> , which measures distance between communities using phylogenetic information. the results of our study show that reasonably accurate read trees can be constructed in many situations, although the magnitude of topological and branch-length error varies widely as a function of the parameters we explored. nonetheless, it appears that statistical tests that use cumulative information from the whole read tree have low false positive rates and similar power to tests performed on phylogenies of full-length sequences, even when the read tree contains many errors.

RESULTS
metapassage: software for simulation and alignment of shotgun metagenomic reads
we developed metapassage , i.e., metagenomic pipeline for automated simulations and analysis of gene families. this software is a workflow for simulating metagenomic data sets that permits streamlined statistical evaluation of the capabilities of metagenomic methods in variable conditions, including high-novelty communities and short-read sequencing. the workflow is structured as a sequence of perl modules that enable automated  community modeling,  simulations of metagenomic sequencing,  orientation or translation of reads, and  alignment. the second module extends the functionality of metasim by adding simple, automated community modeling capabilities, simplifying its command-line use, and adapting it to work better with gene sequences. metapassage is the first simulation software to include automated translation of reads and alignment, and it has options to leverage the amphora  <cit>  sequence database and alignment masks by integrating them directly into the workflow. by combining community modeling, metagenomic simulation, and downstream data processing in a single pipeline, metapassage enabled our statistical assessment of the accuracy of metagenomic phylogenies in a range of scenarios that accounted for environmental and technological variables, such as phylogenetic algorithm, read length, number of reads in the metagenomic sample, gene family characteristics, and novelty in the metagenomic sample with respect to reference sequences.

phylogenetic triangulation enables construction of metagenomic read trees
in order to perform evolutionary analysis of shotgun metagenomic samples without relying on genome or gene assembly, we use an approach to build phylogenetic trees so that each leaf is a short sequencing read from a gene family  . our method leverages full-length sequences of the gene  to build a profile model to which reads are aligned. this multiple sequence alignment enables the application of standard phylogenetic methods, which essentially treat reads as examples of full-length gene sequences with a great deal of missing data, as well as placement-type phylogenetic methods. the phylogenetic relationship between two non-overlapping reads is inferred via each of their distances to the full-length sequences. by pruning full-length sequences from the resulting tree, we produce a tree consisting only of reads. the key question is whether the tree is accurate; if read trees reflect the true phylogenetic relationships between shotgun sequences, they open the door to analyses of microbial communities that go beyond enumerating which taxa or genes are present in the sample by relating these individual entities through their evolutionary history.

many branch lengths and bifurcations are accurately estimated in metagenomic read trees
to evaluate the accuracy of our approach to constructing read trees, we conducted a simulation study that compares read trees to trees built with the corresponding full-length gene sequences . all simulated datasets are available by request from the authors. we simulated reference databases and samples of metagenomic reads from five gene families, built read and source trees, and quantified phylogenetic errors. we used the normalized robinson-foulds   <cit>  distance as a measure of topological error and the quantiles of the distribution of branch distortion factors  as a measure of branch-length error . the nrf score is very sensitive to mistakes in estimated evolutionary relationships, without regard for branch lengths , while the df distribution reflects over- and under-estimation of branch lengths.

we quantified the impacts of read length , number of reads , reference database size , reference database diversity , gene family characteristics , phylogenetic algorithm , and sequencing error  on nrf and df distributions. we studied five gene families: 16s rrna, the most well characterized microbial gene family, as well as three well-conserved, single-copy protein families covering a range of gene lengths , and lolc, a transmembrane protein family from the atp-binding cassette  transporter super family.

each family of gene sequences was limited to its unique representatives among amphora taxa . rate of amino acid evolution was determined by summing all branch lengths in a phylogenetic tree inferred via raxml from the protein sequences; smaller values indicate fewer substitutions and greater conservation. the 16s rrna gene requires a nucleotide model of evolution and hence has an incomparable value; it is well known to be highly conserved, with variable regions. 16s rrna sequences were obtained from the ribosomal database project   <cit> . a larger set of  <dig>  16s rrna sequences was used only for the fast unifrac analysis . amino acid sequences for rpob, rpsb, and dnag families were obtained via amphora  <cit> , while corresponding dna sequences were downloaded from ncbi genbank  <cit> . for lolc, family members were determined by phylofacts  <cit>  ; amino acid sequences were downloaded from uniprot  <cit> , and corresponding dna sequences were downloaded from embl-ebi  <cit> . additional file 1: table s <dig> provides download dates and sequence accession numbers.

as expected, both topological  and branch-length  errors tend to be largest in simulations that combine a shorter read length, smaller reference database, and larger number of reads. while minimum and maximum dfs were typically extreme , indicating that some branch lengths were very inaccurate, the first and third quartiles of the df distribution were much closer to  <dig>  and more stable across simulations . quantifying error using normalized branch-score distance , which accounts for both topological and branch-length errors, showed very similar trends to those seen with the nrf measure . these results show that for realistic experimental scenarios, bifurcations and branch lengths in shotgun metagenomic read trees can be reasonably estimated.

minimum and maximum dfs were orders of magnitude away from the ideal value of  <dig> , indicating that the most poorly estimated branch lengths in each simulation were typically very inaccurate. values were somewhat smaller for simulations with  <dig> reads . the mean and standard deviation values of the minimum and maximum dfs are over  <dig> simulations for each parameter combination. similar trends were observed for the other gene families.

many variables affect read tree accuracy
nearly every parameter we evaluated in our simulations had an impact on the accuracy of read trees in at least some settings. the most important variables were the reference database, the read length, and the number of reads.

effect of reference database
the simulated reference database allowed us to model how read-tree accuracy is influenced by the extent that annotated full-length gene sequences cover the diversity in a gene family. we purposely removed some sequences from the simulated reference database, while still allowing reads to be sampled from these sequences, in order to simulate the commonly encountered situation that a community contains uncharacterized organisms. comparing simulated reference databases of different sizes and phylogenetic diversity, we found that these variables consistently affect both types of error. the larger reference databases, which contain 43–48% of the sequences in a gene family, result in significantly less topological error  and branch-length error  than do smaller reference databases, which contain 11–12% of sequences. pplacer and raxml particularly capitalize on the larger reference databases to reduce error. when simulated reference databases of the same size were compared, databases designed to be phylogenetically diverse resulted in slightly less error than random ones . this relatively minimal effect may be due to the phylogenetic diversity already present in random databases. in practice, existing reference sequences for gene families may be fewer and less diverse than those considered here, so error levels may be higher than those we report. finally, the trends we observed in the influence of reference database composition on error rates were generally consistent across simulations with different numbers of reads, although the results were most variable in simulations with small numbers of reads . this finding indicates that it is not merely the proportion of reads relative to reference sequences that determines error rates and patterns.

effect of read length
read length has a pronounced effect on the accuracy of topological  and branch-length  inference in all scenarios. read trees built from 100-bp reads generally have more error and greater variability in error across gene families, regardless of other simulation parameters. in many scenarios, increasing the read length to 400 bp cut the mean topological error by 25–50%. even when a larger reference database and  <dig> reads were used, lengthening reads to 400 bp drove mean nrf from as high as  <dig>  to below  <dig>  for raxml and pplacer. branch-length error is also affected by read length; for example, rpob simulations with  <dig> reads had mean df first quartiles close to  <dig> for 100-bp reads, meaning that at least a quarter of topologically correct branches were severely underestimated in length, versus mean df first quartiles near  <dig>  for 400-bp reads . read length appears to affect the dfs of tip branches much more than that of internal branches .

effect of number of reads
despite using measures of error that are normalized to adjust for the number of reads in a tree, we observed that topological and branch-length error increased with the number of reads. in some situations, the effect is dramatic; for instance, in the case of a small reference database and 400-bp mean read length, increasing the number of rpob reads from  <dig> to  <dig> increased the topological error of all three methods by at least 40% . in scenarios involving a small reference database, the rpob df third quartile is increased by increasing the number of reads, regardless of read length . this pattern is drastic with pplacer, an effect apparently stemming from relatively high distortion of tip branches .

effect of sequencing error
in rpob simulations with 100-bp mean read length and  <dig> reads, illumina-like sequencing error has little effect on topological accuracy but does impact branch-length estimation . according to the mean df first quartile and median, sequencing error may compensate for the underestimation of branch lengths occurring in simulations without sequencing error. however, the mean df third quartile indicates that some branch lengths are overestimated significantly more in simulations with sequencing error than in those without it. the effect of the reference database is apparent even in the context of sequencing error.

effect of phylogenetic algorithm
as has been previously documented, fasttree and pplacer are both capable of analyzing datasets of hundreds of sequences or more within minutes, whereas raxml is much slower  <cit> . at the scale of this study, the difference is not prohibitive for raxml . with some exceptions, in our study, fasttree’s topological error was typically worse than raxml’s and pplacer’s, all other factors being equal ; its relatively poor performance is particularly notable in scenarios with short reads or a large reference database. however, in simulations with a smaller reference database and  <dig> reads, pplacer tends to more severely overestimate branch lengths, i.e., its mean df third quartiles are much higher than those of the other methods , regardless of read length. like pplacer, raxml is better able than fasttree to leverage the larger reference database to improve topological accuracy, especially with 400-bp reads. one might suspect that raxml is favored because the fixed reference tree gives it a more restricted optimization landscape. we verified that this is not the case: raxml performs very similarly when it is not given a fixed reference tree .

effect of gene family
performance did vary somewhat across the gene families we tested but was not significantly or consistently associated with any variable in table  <dig>  overall trends in topological error were generally consistent across gene families . in scenarios with a larger reference database, the read length had less of an impact on the df distribution for gene families with shorter sequences , which we hypothesize is because short reads capture a greater proportion of the variation in the complete sequences.

fast unifrac accurately distinguishes communities using metagenomic phylogenies
despite the fact that read trees consistently contain some topological and branch-length errors, we hypothesized that downstream analyses that aggregate information across many branches of a tree might be robust to these errors. to test this hypothesis, we performed additional simulations to mimic metagenomic samples of 16s rrna sequences from individuals belonging to three types of gut microbiome communities. depending on other factors, microbiome communities may vary continuously or occupy discrete configurations  <cit> . our simulated communities were loosely modeled after those identified previously  <cit>   : one community  has low levels of a taxon unique to that community , while the other two communities are dominated by distinct taxa . we also simulated a reference database that has intermediate levels of most taxa.

we tested whether an analysis using fast unifrac of the read trees from these samples could reliably distinguish the underlying community structure while controlling false positive rates. since our communities differ critically in relative abundances of taxa, we used the weighted version of the unifrac metric  <cit> . first we compared samples from the same community and found that the observed unifrac false positive rate was consistently at or below the targeted 5% level . next we analyzed samples drawn from all three communities in order to evaluate power. weighted unifrac was able to accurately distinguish samples from different community types . variation in performance mainly depended on the types of communities being compared, rather than on the mean read length: pop <dig> and pop <dig> are much more difficult to distinguish than the other two pairs of communities . we did not observe significant differences in false positive rates or power between different phylogenetic methods, despite higher topological and branch-length error with fasttree in many simulations. thus, we conclude that, while imperfect, metagenomic read trees can be powerful tools for the analysis of microbial communities.

weighted fast unifrac could reliably distinguish the underlying community structure while controlling false positive rates. the false positive rates, which are based on the null simulations for both communities in each pair, were consistently at or below the targeted 5% level. weighted unifrac was able to accurately distinguish samples from pop <dig> versus pop <dig>  and from pop <dig> versus pop <dig>  while it had much less success distinguishing samples from pop <dig> and pop <dig>  variation in performance was largely independent of mean read length and phylogenetic method.

CONCLUSIONS
we presented and evaluated an approach for conducting evolutionary analyses of shotgun metagenomic data. our method uses a reference database to guide construction of a metagenomic read tree for a gene family. using a new simulation pipeline, called metapassage, we quantified topological and branch-length errors that occur when building trees of shotgun metagenomic reads versus full-length sequences. our findings indicate that individual branchings and branch lengths in a metagenomic read tree are reasonably likely to be erroneous, especially if reads are 100 bp or the reference database is not large and diverse. however, many phylogenetic relationships in read trees are accurate, despite how short shotgun reads are compared to full-length gene sequences.

the levels of accuracy we found may not be achievable in cases where the number of reads greatly exceeds that of the reference sequences, e.g., when samples contain a highly abundant or poorly characterized gene family. one potential option, beyond the scope of our study, is to use a hybrid approach that first clusters reads via sequence similarity and then uses representatives from the clusters to build read trees. less well-characterized gene families, which could not be used in our analysis, may also exhibit different error patterns from those we observed, a possibility consistent with a trend in some of our simulations towards higher error in less conserved genes. sequencing error may lessen or change read-tree accuracy to some degree, particularly with respect to branch-length estimation, an issue that we study here in the context of illumina sequencing. the effects of some other features of the data, such as read alignment within hypervariable or conserved regions of a gene family, may be investigated further by extending our modular metapassage software.

the results of this study have significant implications for metagenomics research and the development of new methods. when read trees can be reliably built, powerful statistical analyses and comparisons designed for full-length gene sequences  can be directly applied to metagenomics data. taken in aggregate, our results show that the evolutionary information encoded in a read tree carries almost as much information about community structure, as quantified by weighted fast unifrac, as the corresponding source tree. other approaches that consider an entire tree in order to find large-scale patterns may also be reasonably accurate when applied to metagenomic read trees built with our approach. in contrast, methods that make inferences based on individual branches should be used with caution.

the sheer range of the topological and branch-length error, and its dependence on parameters including read length and reference database diversity, suggest that researchers may be able to influence the applicability of this phylogenetic approach to their projects. our results provide an initial basis for evaluating trade-offs: for example, the improvement in accuracy obtained from using a larger reference database is in many situations comparable to the improvement obtained from using 400-bp  reads. hence, our study suggests that focusing on gene families with more complete reference databases is especially important when the choice of sequencing technology is limited to shorter reads. similarly, using the most accurate, but slowest inference method  may be worthwhile for analyzing 100-bp reads or gene families with small reference databases. on the other hand, other inference methods do have competitive accuracy, especially topologically, and are more feasible for large-scale studies. as individual gene families become more deeply characterized, they will be more amenable to analyses based on read trees. projects such as geba  <cit>  that sequence phylogenetically diverse complete genomes are paving the way for more sophisticated methods of analysis.


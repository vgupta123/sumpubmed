BACKGROUND
the evolution of dna, rna and protein sequences is driven by mutations such as base substitutions, insertions and deletions , recombination and other genomic rearrangements . some recent comparative genomic analyses revealed that indels account for more base differences between closely related genomes than base substitutions do . it is therefore imperative to develop a method to reliably calculate the probability of sequence evolution via mutations including indels. since the groundbreaking works by bishop and thompson  <cit>  and by thorne, kishino and felsenstein  <cit> , many studies have been made to calculate the probabilities of pairwise alignments  and multiple sequence alignments  under probabilistic models aiming to incorporate the effects of indels. and the methods have greatly improved in terms of the computational efficiency and the scope of application . most of these studies are based on hidden markov models   or transducer theories . even today, the studies on these methods are steadily advancing , and it seems that their mathematical and algorithmic bases are about to be established.

however, it is important to remember that these desirable properties alone are not sufficient for a model in natural science to be satisfactory. in addition to having the mathematical  soundness, a satisfactory model must also approximate well, or at least decently, the real phenomena it is intended to describe. in the case of an indel probabilistic model, there are two key elements for this requisite: one is the evolutionary consistency of the model, and the other is the model’s flexibility to accommodate various biologically realistic features, i.e., the biological realism, of indels.

let us first explain the evolutionary consistency. in natural sequence evolution, the probability  of an indel process must be given vertically, as a multiplicative accumulation of the probabilities of transitions between states of an entire sequence, each from one time point to the next one, along the time axis  . if a probabilistic model gives the probability density of each evolutionary process according to this natural design, we call it a “genuine stochastic evolutionary model”, or simply an “evolutionary model” for short. and we will consider an indel probabilistic model as “evolutionarily consistent”, if its alignment probabilities can be derived directly from an evolutionary model, even if it does not appear to follow the aforementioned natural design. by definition, each of hmms and transducers calculates  an alignment probability horizontally, as a product of either inter-column transition probabilities or block-wise contributions . therefore, it is a priori unclear whether each hmm or transducer is evolutionarily consistent or not, or, if it is, how . it would be worth mentioning that some models were indeed derived explicitly from some sorts of evolutionary models . unfortunately, all such studies in the past imposed some unnatural assumptions, such as the prohibition of overlapping indels and the restriction of deletions to single-base ones. such assumptions were necessary for an alignment probability to be trivially factorable, at least as a product of block-wise contributions. thus, they are unsatisfactory from the viewpoint of the second key element, i.e., the biological realism.fig.  <dig> genuine stochastic evolutionary model vs. hmm . a probability density calculation via a genuine stochastic evolutionary model. each sequence state is represented as an array of sites . sites to be deleted are shaded in red or magenta. inserted sites are shaded in blue or cyan. the s
i and s
f, respectively, denote the initial and final states. the s
ν  is an intermediate state.  b a pairwise alignment  between the initial  and final  states resulted from the indel process in panel a. the c
i  labels the alignment column below. c probability calculation via a hmm . it is a priori unclear whether or how the methods in panels a and c are related with each other. for clarity, residue states and substitutions were omitted.  panels a and b of this figure were adapted from panels b and f of fig.  <dig> of  <cit> 



regarding the biological realism, past empirical studies revealed some properties of real indels, in addition to their possibilities to affect multiple contiguous residues at a time and to overlap others. among the most important would be the studies that showed power-law distributions of indel lengths . on the contrary, standard hmms and transducers can usually implement geometric distributions of indel lengths, or at best mixed geometric distributions , but cannot implement the power-law distributions themselves. but some generalized hmms   can incorporate power-law indel length distributions. for example, the hmm of kim and sinha  <cit>  is quite flexible, and it can incorporate the power-law distributions and also do away with the commonly imposed time-reversibility. as discussed e.g., in  <cit>  and  <cit> , there is no biological reason for imposing the time reversibility, and they were usually imposed to reduce the computational time. in this sense, the hmm of kim and sinha is two steps closer to the biological reality than the standard hmms . unfortunately, similarly to the standard hmms and transducers, their hmm is not evolutionarily consistent and thus cannot correctly handle overlapping indels along the same branch, though they can handle overlapping indels along different branches. another possibly important biologically realistic feature is the indel rate variation across sites  , due to selection and the mutational predispositions . thus far, attempts to incorporate this feature have been rare , and most studies have handled space-homogeneous models, whose indel rates are homogeneous along the sequence.

as far as we know, except the models implemented in some genuine sequence evolution simulators , there is only one class of genuine stochastic evolutionary models discussed thus far that is also considerably biologically realistic, which are the “substitution/insertion/deletion  models” proposed by miklós et al.  <cit> . the sid models in general do not impose the aforementioned unnatural restrictions on indels. moreover, the general sid model can accommodate any indel length distributions, and also some indel rate variations across sites . unfortunately, however, we have not seen any further theoretical development of the general sid model since it was proposed. instead, miklós et al. developed the “long indel” model  <cit> , which is a space-homogeneous, time-reversible sid model.  and they gave a verbal justification that the probability of a pwa under the “long indel” model can be calculated via a generalized hmm, as a product of contributions from “chop-zones” delimited by gapless columns. in the present viewpoint, this is the most satisfactory hmm that we know was used for actual sequence analyses, because it satisfies both the evolutionary consistency and the biological realism to some degree. nevertheless, their justification, although plausible, has two problems. first, it is unclear exactly how their hmm is related to the ab initio probabilities of evolutionary  processes under their evolutionary model. and second, their justification takes advantage of the space-homogeneity of the model, which makes it unclear how their hmm can be extended to be space-heterogeneous while keeping the evolutionary consistency. to solve these two problems, we need at least to get back to their origin, i.e., the general sid model. it seems, however, that this model has never been theoretically dissected thus far, possibly due to the lack of mathematical or conceptual tools to handle it easily.

in this study, we examine a general continuous-time markov model of the evolution of an entire sequence via insertions, deletions and substitutions. this model could be regarded as an extension of the general sid model, in the sense that it allows explicit  rate variation across sites, not only due to residue state contexts. such rate variation could be regarded as the effect of, e.g., the epigenetic context and/or the context within the 3d structure of the protein product . <dig> to theoretically dissect the ab initio calculation of alignment probabilities under this model, we introduce some useful tools. among the most important would be the operator representation of mutations, namely, insertions, deletions and substitutions. this enabled us to shift our focus from the trajectory of sequence states, which played a central role in  <cit> , to the history of mutations . moreover, the operator representation enabled to algebraically define the equivalence relationships between two different series of indels. they, in cooperation with the focus shift, enabled to define the local history set  equivalence classes. these equivalence classes play an essential role when deriving the “sufficient and nearly necessary” set of conditions under which alignment probabilities are indeed factorable, thus providing a sort of generalized hmm. we also adapt techniques from the time-dependent perturbation expansion in quantum mechanics  <cit> , expanding each alignment probability into a summation over contributing mutational histories with different numbers of indels. it should be noted, however, that we formally deal with all terms in the expansion. <dig> thus, at least formally, the probabilities we deal with are exact solutions of the model’s defining equation. for clarity, we will focus on insertions/deletions in the bulk of the manuscript. however, we can also incorporate substitutions; see, e.g.,  <cit>  for more details.

this paper describes the backbone of our study  to give the theoretical basis of our ab initio probability calculation under the general continuous-time markov model of indels. peripheral topics surrounding the study can be found in  <cit> . <dig> throughout the paper, we suppose that each probability is calculated under a given evolutionary model setting, including the phylogenetic tree of the sequences. in section r <dig> of results and discussion, we briefly review the most general form of the sid model  <cit> . then, in section r <dig>  we introduce two important tools, namely, the ancestry index and the operator representation of mutations including indels. using the results of sections r <dig> and r <dig>  we define our general continuous-time markov model in section r <dig>  and formally give the general solution to its defining equation in terms of the operator representation. in section r <dig>  we formally express the ab initio probability of a given pwa in a perturbation expansion. then, using the concept of the lhs equivalence classes defined in section r <dig>  we derive in section r <dig> the conditions under which the pwa probability is factorable. in section r <dig>  the derivation is extended to the probability of a given msa. in section s <dig>  some examples are given to illustrate models with factorable and non-factorable alignment probabilities. the former category includes the indel evolutionary model of dawg  <cit>  and the “long indel” model  <cit> , among others. in section r <dig>  we discuss the merits, possible uses and extensions, as well as some outstanding issues, of the results in this study. in table  <dig>  we summarize the key concepts and results of this paper, mainly for those who want its gist quickly. likewise, table s <dig>  summarizes mathematical symbols used commonly in this paper, to facilitate the readers’ cruise through the equations. supplementary methods  and supplementary appendix  give detailed derivations of some important results. the former is more essential and accessible to a wider audience; the latter is for those who are interested in further mathematical details.table  <dig> key concepts and results in this paper


ancestry index
fig. 2

operator representation of mutations

fig.
3
eqs.  ,


eqs.  ,

defining equations 

eq.  ,


perturbation expansion 

binary equivalence relation

local-history-set  equivalence class

below eq. ,

factorability 

factorability 

eq. 

totally space-homogeneous model

equivalence  of the “chop-zone” method and our
ab initio
method

space-homogenous model flanked by essential sites

eqs. 
note: especially important things are in boldface



we end this section with two notes. first, in this paper, the term “an evolutionary  process” means a series of successive mutation  events with both the order and the specific timing specified, and the term “an evolutionary  history” means a series of successive events with only the order specified. this usage should conform to the common practice in this field. second, we will describe the results in the bra-ket notation, similar to that in quantum mechanics  <cit> . however, those who are unfamiliar with the notation need not worry about it. our formulation via the bra-ket notation can be proven to be equivalent to the standard formulation of the continuous-time markov model via the vector-matrix notation.  therefore, if desired, the symbols of a bra , a ket , and an operator  could be regarded simply as convenient reminders of a row vector, a column vector, and a matrix, respectively.4

RESULTS
the key concepts and results proposed/obtained in this paper are summarized in table  <dig>  readers can use the table to quickly grasp an overview of this paper, as well as to easily locate what they look for. also, most mathematical symbols are briefly explained in table s <dig> in additional file  <dig> 

r <dig>  brief review of general sid model
miklós et al.  <cit>  proposed a class of evolutionary models, which they called the “substitution/insertion/deletion  models”. they are continuous-time markov models defined on the space of strings  of any lengths, each of which consists of letters  from a given alphabet . following  <cit> , their state space will be denoted as: Ω*≡ ∪l = 0 ∞Ωl, whose component, Ωl, is the space of all sequences of length l. if desired, a sequence state, s ∈ Ωl, could be represented as: s =   . in this model, mutations are defined as transitions from a sequence state to another, and their instantaneous rates can be given via the following “rate grammar” they proposed:fig.  <dig> sequence states. a a sequence state in the sid models  <cit> . each site  is assigned a residue state . b the corresponding extended sequence state in our evolutionary model. each site is assigned an ancestry index  in addition to a residue state. c the corresponding basic sequence state. each site is assigned an ancestry index alone. the ω→ represents the set of residue states assigned to all sites. the υ→ represents the set of ancestry indices assigned to all sites.  used in panels a and c represent different types of states )

substitution: s=slωsr→ρsslωω′srs′=slω′sr; 

insertion: s=slsr→ρislsisrs′=slsisr; 

deletion: s=slsdsr→ρdslsdsrs′=slsr. 



here, ρm with m = s, i and d denote the rates of the substitution, the insertion, and the deletion, respectively, possibly depending on the arguments in the parentheses. in each of the above rules, s and s′, respectively, denote the sequence states before and after the mutation. the symbols sl and sr denote the subsequences flanking the mutated portion from the left and from the right, respectively. <dig> these sid models equipped with this “rate grammar” are genuine stochastic evolutionary models, and thus do not usually impose unnatural restrictions on the mutations . and the most general sid model can accommodate quite general mutation rates, including indel length distributions, by allowing their dependence on the sequence states before and after the mutation. <dig> as far as we know, however, this most general sid model was not theoretically examined further , maybe because adequate mathematical or conceptual tools were not devised and because of some other reasons . in the following sections, we will provide such tools, which in turn will help theoretically dissect an extended version of the most general sid model.

r <dig>  ancestry indices and operator representation of mutations
first, we slightly extend the framework of the sid models, by assigning an ancestry to each site, which is a unit position in the sequence that accommodates a single residue. hereafter, we will consider that it is the sites, instead of the residues, that are inserted/deleted. for example, the above example sequence state, s = , can be extended as:s˘=υ1ω1υ2ω2…υlωl∈ϒ×Ωl . here, υx is the ancestry index assigned to the x-th site of the sequence . alternatively, the extended sequence state could also be represented as: s˘=υ→ω→, <dig> where υ→=υ1υ2…υl∈ϒl is an array of ancestry indices assigned to the sites, and ω→=ω1ω2…ωl∈Ωl is an array of residue states that fill in the sites.  in the sid models ). the ancestry indices follow a number of rules:  different sites in the same sequence always have different ancestry indices;  the ancestry index of a site remain unchanged as long as the site exists; and  every time when an insertion takes place, new ancestry indices are assigned to the newly inserted sites. other than these rules, the assignment of the indices is arbitrary. especially, their values themselves are not so important. the most essential thing is whether two sites of different sequences share the same ancestry index or not; if so, the sites are mutually homologous . another important thing is the spatial relationship of the site having each ancestry with other sites, especially preserved ancestral sites . for the space of ancestry indices, ϒ, we will tentatively use the set of all positive integers , although there should be a more appropriate mathematical entity. <dig> because of the rules imposed above, the space of the extended sequence states  is included in but never equal to {ϒ × Ω}* = ∪l = 0∞{ϒ × Ω}l.

we devised the ancestry indices to facilitate the description of indel histories by keeping track of the evolutionary course of each site. for example, consider that a sequence whose initial state had the ancestry indices υ→i= <dig> evolved into the final state with υ→f=15689a <dig>   then, we can immediately infer what happened during its evolution by aligning the two sequences : r <dig>  υ→i123456−−−7υ→f1−−−5689a <dig>  

this alignment tells that the sites with ancestries  <dig>   <dig> and  <dig> were deleted and that the sites with ancestries  <dig>   <dig> and a were inserted. we can also see that the sites with  <dig>   <dig>   <dig> and  <dig> were preserved during the evolution. we will henceforth refer to such sites as “preserved ancestral sites ”. the pass indicate that no indels occurred at or through the sites during the evolution under consideration. thus, they can be used to narrow down the possible indel histories that might have resulted in the pairwise alignment  . a fringe benefit of the ancestry indices is that they enable the mutation rates to vary beyond the dependence on the residue states . hereafter, we refer to an array of ancestry indices  as a “basic sequence state” , which is a backbone to be fleshed out by the residue states  to give the extended sequence state . hereafter, the basic sequence state will often be denoted, e.g., as s . , which was a sequence state in section r1). and sii denotes the space of the basic states.

another, probably more important, tool we introduce here is the operator representation of mutations. when considering the evolutionary processes , we symbolically represent each  sequence state as a bra-vector, like s˘i, which could be regarded as an abstract extension of a row vector in the normal representation of the continuous-time markov model. then, each mutation of a sequence can be represented as a linear operator  acting on a bra-vector . operator m^sx,ω↦ω′ denotes the substitution of the residue to ω′ if it was ω at the x th site  . operator m^ixl denotes the insertion of l sites between the x-th and -th sites . the insertion operator alone does not determine the residue states of the inserted sites. it is the job of the “fill-in” operator, f^x,δω→′l, which fills in the l inserted sites with a new array of residues, δω→′l∈Ωl. . finally, operator m^dxbxe denotes the deletion of the subsequence between  the xb-th and xe-th sites in the sequence immediately before the event . the action of multiple successive mutation events can be expressed as a product of mutation operators on an initial  sequence state. for example, the indel history illustrated in panels a and b of fig.  <dig> can be represented as a series of indel events, m^d <dig> m^i <dig> m^d <dig> m^i <dig>  on the initial basic state si . then, the final result of this indel history is expressed as: sim^d33m^i52m^d23m^i <dig>  figure 4c shows the msa among the initial, intermediate and final sequence states. figure 4d shows the resulting pwa between the initial and final sequence states.fig.  <dig> operator representation of mutations. a a substitution operator, m^s <dig> t↦c. the residues before and after the substitution are in boldface in blue and red, respectively. b an insertion operator, m^i <dig> , and a fill-in operator, f^ <dig> tac. the inserted sites are shaded in cyan. . c a deletion operator, m^d <dig> . the sites to be deleted are shaded in magenta. in this figure, the extended sequence states were used for illustration. the bra-vector below each array denotes the state. the extended state, s˘, is identical to that in fig. 2b. each vertical arrow indicates the action of the mutation operator beside it. note that the first arguments of all operators and the second argument of the deletion operator specify positions along the sequence, and not ancestries 

fig.  <dig> example indel history and resulting alignments. a an example indel history in terms of the bra-vectors of sequence states and indel operators. b the graphical illustration of the history using basic sequence states. each sequence state in panel a is horizontally aligned with its graphical representation in panel b. c the resulting msa among the sequence states that the indel history went through. d the resulting pwa between the initial and final sequences. in both c and d, the bold italicized characters in the leftmost column are the suffixes indicating the sequence states in panel a. in panels b, c, and d, the number in each site  represents its ancestry, but not necessarily its position along the sequence. the ‘a’ in the final sequence abbreviates  <dig>  the same shading scheme as in fig.  <dig> is used. the figure was adapted from fig.  <dig> of  <cit> 



these new tools, the ancestry indices and the operator representation of mutations, will play essential roles in our theoretical development described below. in the sid models  <cit> , each evolutionary process was expressed as a  trajectory of sequence states, each of which was represented by an array of residues . in consequence, an instantaneous transition from a state to the next state was often expressed as a summation of multiple possible mutations. . ancestry indices help avoid such ambiguous channels by uniquely defining each instantaneous state-to-state transition as an action of a single mutation. . this, in conjunction with the operator representation of mutations, enables us to shift the focus from the trajectory of sequence states to the history of mutations, especially indels. this shift of focus, as well as the “equivalence relations” between the products of operators , facilitates the examination of the factorability of alignment probabilities, as we will see in sections r4-r <dig> 

r <dig>  instantaneous transition  operator and finite-time transition operator
now we are ready to define our evolutionary model, i.e., the general continuous-time markov model to describe the evolution of an entire sequence along a time axis. if desired, this could be done by extending the rate grammar, eqs. , so that each mutation rate depend on the entire extended sequence states  immediately before and after the mutation. ) however, to define the model more neatly, we will parametrize the mutation rates in coordination with the mutation operators defined in section r <dig>  although the parametrization is different from  eqs. , the two sets of mutation rates are equivalent.   instead of ρm.) let s be the extended sequence state immediately before the mutation. and let t be the time at which the mutation occurred. then, rsx,ω↦ω';s˘,t is the rate of the substitution, m^sx,ω↦ω′. it must be zero unless ω is at the x-th site of s˘. rix,l,δω→′l;s˘,t is the rate of the insertion, m^ixl . and rdxbxes˘t is the rate of the deletion, m^dxbxe. using these mutation rates that accompany the mutation operators, we can define our evolutionary model in a manner closer to the standard, by defining the instantaneous transition rate operator , which is an analog of the instantaneous transition rate matrix in a continuous-time markov model. because the state space we are working in, s˘ii, is essentially infinite, we cannot give the explicit matrix expression of the rate operator on the entire state space. nevertheless, the rate operator can be defined if we give its action on every state in s˘ii. let q^sidt denote our rate operator . it is convenient to decompose it as follows: r <dig>  q^sidt=q^st+q^it+q^dt, where q^mt with m = s, i and d, respectively, are the substitution, insertion, and deletion components of the rate operator. each of the three components can be further decomposed as: r <dig>  q^mt=q^mmt+q^xmtm=s,iandd. 

here, the “mutation part”, q^mmt, describes the transitions to different states via mutations of type m . and the “exit rate part”, q^xmt, attenuates the state retention probability at the exit rate, rxms˘t, which is determined by the type m mutations. it guarantees that the state probabilities sum up to unity at any time. specifically, the mutation parts are defined by the following actions on every state: r <dig>  s⌣q^mst≡∑x=1ls˘∑ω′∈Ω,ω'≠ωxs⌣rsx,ωxs⌣↦ω';s˘,t×s˘m^sx,ωxs˘↦ω',  r <dig>  s˘q^mit≡∑x=0ls˘∑l=1∞∑δω→′l∈Ωlrix,l,δω→′l;s˘,t×s˘m^ixlf^x,δω→′l,  r <dig>  s˘q^mdt≡∑xb=−∞ls˘∑xe=max1xb+∞rdxbxes˘t×s˘m^dxbxe. 

here, ls˘ denotes the length  of s˘, and ωxs˘ denotes the residue at the x-th site of s˘. figure  <dig> exemplifies the states on the right hand sides of eqs. . the terms with x =  <dig> and with x=ls˘ in eq.  represent insertions at the left and right ends, respectively, of the sequence. how to deal with such insertions varies depending on various factors including the model setting, and can be implemented by adjusting the insertion rates accordingly . the terms with xb <  <dig> or xe>ls˘ in eq.  represent the deletions of the subsequences sticking out of the subject sequence. these terms were included because the subject sequence is regarded as embedded in a “chromosome” with a virtually infinite length . <dig> the exit rate parts are defined in nearly the same form: r <dig>  s˘q^xmt≡−rxms˘ts˘m=s,iandd. 

they differ only in the exit rates: r <dig>  rxss˘t=∑x=1ls˘∑ω′∈Ω,ω′≠ωxs˘rsx,ωxs˘↦ω';s˘,t,  r <dig>  rxis˘t=∑x=0ls˘∑l=1∞∑δω→′l∈Ωlrix,l,δω→′l;s˘,t,  r <dig>  rxds˘t=∑xb=−∞ls˘∑xe=max1xb+∞rdxbxes˘t. 

these equations, eqs. , cooperatively define the instantaneous transition rate operator, q^sidt, and thus define our evolutionary model. if desired, q^sidt could be decomposed as: r <dig>  q^sidt=q^msidt+q^xsidt. 

here q^msidt≡q^mst+q^mit+q^mdt is the collection of all mutational transition terms, and q^xsidt≡q^xst+q^xit+q^xdt is the entire exit rate part, which attenuates the state retention probability at the total exit rate, rxsids˘t≡rxss˘t+rxis˘t+rxds˘t. actually, the total mutational part, q^msidt, is equivalent to  the “instantaneous rate matrix” of the general sid model  in  <cit> ), although the two expressions appear quite different from each other. the difference mainly stems from the parametrization and the state representation. we use our parametrization because we believe it to clarify the meaning of each term in the rate operator. and, in this section, the sequence state after the mutation  was represented as the result of the mutation operator  acting on the state before the mutation , like s˘′=s˘m^m…. this is legitimate because a mutation transfers a subject state uniquely to another state. this state representation will facilitate the unfolding of our theory below.

thus far, we included substitutions  mainly in order to discuss the relationship between our evolutionary model and the general sid model. however, our main interest here is in calculating the probability of the skeleton of a sequence alignment, composed only of the sites and gaps, which will then be filled in with residues to form a full alignment. because such a skeleton can be created only through an evolutionary process of indels, we will hereafter omit the description of substitutions and the resulting changes in the residue state .   but we will retain the basic sequence state consisting of ancestry indices . the rate heterogeneity will be realized only through the ancestry dependence. this would be almost sufficient for representing the dependence of the rates on, e.g., the epigenetic or 3d structural context . and this may also be able to approximate the dependence on some residue state contexts, especially in highly conserved regions. now, the rate operator defined by eqs.  is reduced as follows. . r <dig>  q^idt=q^it+q^dt,  r <dig>  sq^mit≡∑x=0ls∑l=1∞rixlstsm^ixl,  r <dig>  sq^mdt≡∑xb=−∞ls∑xe=max1xb+∞rdxbxestsm^dxbxe,  r <dig>  rxist=∑x=0ls∑l=1∞rixlst,  r <dig>  rxdst=∑xb=−∞ls∑xe=max1xb+∞rdxbxest. 

equations  remain unchanged except the exclusion of m = s and the replacement of s˘ by s. in eqs. , the insertion rates could be related to those in eqs.  by the equation: r <dig>  rixlst≡∑δω→′l∈Ωlrix,l,δω→′l;s,t, where the ω→-dependence of the right hand side was omitted.

now we can calculate the operator that gives the finite-time transition probabilities between states. we will call it the “finite-time transition operator”. let p^idtt′ be such an operator describing the state transition via indels alone from an initial time, t, to a final time, t′ . operator p^idtt′ is defined to give the following equations: r <dig>  sp^idtt′s′=ps′,t'stforss′∀∈sii <dig>  

on the right hand side, p is the probability that the sequence is in state s′ at time t′ conditioned on that it was in state s at time t. on the left hand side, |s′〉 denotes a ket-vector , whose exclusive role here is to give “inner-products” with bra-vectors: 〈s| s′〉 =  <dig> , =  <dig> . from the evolutionary principle that our model must satisfy, or equivalently, from the fundamental properties  of the continuous-time markov model, the finite-time transition operator must be given by the multiplicative accumulation of the effects of the rate operators along the time axis. thus, p^idtt′ is formally calculated as: r <dig>  p^idtt′=limnp→∞i^+t′−tnpq^idt1npi^+t′−tnpq^idt2np⋯i^+t′−tnpq^idtnpnp≡texp∫tt′dτq^idτ. 

in the middle of the equation, Î is the identity operator , and tknp≡t+k−12t′−tnp. on the rightmost side, t{…} denotes the meta-operator that rearranges the operators in each operator product term in the temporal order so that the earliest operator comes leftmost. another way to give p^idtt′ is through the first-order time-differential equation. again, from the fundamental properties of the continuous-time markov model, or equivalently, from eq. , we can show that the operator satisfies the following differential equations: r <dig>  ∂∂t′p^idtt′=p^idtt′q^idt′,  r <dig>  ∂∂tp^idtt′=−q^idtp^idtt′. 

equation  is the “forward equation”, and eq.  is the “backward equation”. and the evolutionary principle naturally includes the following equation: r <dig>  p^idtt=i^fort∀∈titf, where  is the time interval in which the model is defined. this equation could be used as the initial condition for each of eqs. . in the next section, we will obtain the solutions for eqs.  in a more tractable form than the defining solution, eq. .

r <dig>  perturbation expansion of finite-time transition operator and pairwise alignment probability: brief description
in time-dependent perturbation theory of quantum mechanics , the instantaneous time evolution operator ) is considered as a sum of two operators, h^t=h^0t+v^t, and the time evolution of the system is described as if the system mostly evolves according to the well-solvable instantaneous time-evolution operator ) and is occasionally perturbed by the “interaction” operator . we adapt such a technique of time-dependent perturbation expansion to our evolutionary model. here, we briefly describe the results. for their detailed derivations, see supplementary methods sm- <dig> in additional file  <dig>  we first re-express our rate operator as: r <dig>  q^idt=q^0idt+q^midt. 

here q^0idt≡q^xit+q^xdt describes the mutation-free evolution, and q^midt≡q^mit+q^mdt describes the single-mutation transition between states. from the reduced form of eq. , we get: r <dig>  sq^0idt=−rxidsts,  r <dig>  withrxidst≡rxist+rxdst. 

using eq. , the forward equation ) accompanied by the initial condition ) can be shown to be equivalent to a crucial integral equation: r <dig>  p^idtt′=p^0idtt′+∫tt′dτp^idtτq^midτp^0idτt′. 

here, p^0idt′t′′≡texp∫t′t′′dτq^0idτ. similarly, the backward equation ) accompanied by eq.  is equivalent to another crucial integral equation: r <dig>  p^idtt′=p^0idtt′+∫tt′dτp^0idtτq^midτp^idτt′. 

now, to formally solve eq. , we assume that the solution can be expanded as: p^idtt′=∑n=0∞p^nidtt′, where p^nidtt′ is the collection of terms containing n indel operators each. substituting this expansion into eq.  and performing some formal calculations, we get the final form of the ab initio solution we desire: r <dig>  s0p^idtitf=∑n=0∞∑m^1m^ <dig> ⋯m^n∈Ηidns0pm^1m^ <dig> …m^n,titfs0tis0m^1m^2⋯m^n. 

here, Ηid denotes the space of all possible histories of n indels each beginning with the sequence state, s <dig>  and r <dig>  pm^1m^2⋯m^ntitfs0ti=∫⋯∫ti=τ0<τ1<⋯<τn<τn+1=tfdτ1⋯dτn∏ν=1nrm^νsν−1τνexp−∑ν=0n∫τντν+1dτrxidsντsν=sν−1m^νν= <dig> …,n is the probability that an n -event indel history, m^1m^2⋯m^n  being the ν-th event), occurred during time interval , given an initial sequence state  at time ti. the rate, rm^νsν−1τν, is ri if m^ν=m^ixl, and it is rd if m^ν=m^dxbxe. it should be noted that Ηid≡{} consists only of the history with zero indel, , whose conditional probability is: ptitfs0ti=exp−∫titfdτrxids0τ. eq.  supplemented with eq.  is also the solution of eq. .  is a multiple-time integral over all possible timing, whose integrand is the probability density of an evolutionary process of n indels with particular timing, ).

equation  states that the finite-time transition operator  is the collection of the effects of all possible indel histories starting with s <dig>  each weighted by its probability ). thus, it mathematically underpins gillespie’s  <cit>  famous stochastic simulation algorithm, which provides the basis of genuine molecular evolution simulators . our derivation of eq.  and eq.  through the integral equation  or eq. ) bridges gillespie’s own intuitive reasoning and feller’s  <cit>  mathematically rigorous proof of the solution.

now, substitute an “ancestral” sequence state, sa, for s <dig> in eq. , and take the inner product between it and the ket-vector, |sd〉, of a “descendant” sequence state, sd. comparing the two sequence states in sii naturally gives a pwa, α ). <dig> hence, the summation of sap^idtitfsd’s over all “equivalent” sd’s providing the same α must be p)|], which is the probability that α results from sequence evolution during , given sa at ti. similarly to the derivation of eq. , we obtain its formal expression as: r <dig>  pαsasd,titfsati=∑n=nminαsasd∞∑m^1m^2⋯m^n∈Ηidn;αsasdpm^1m^2⋯m^ntitfsati. 

here, Ηid denotes the set of all indel histories with n indels each that can result in α, and nmin is the minimum number of indels required for creating the pwa.

using the set of all pwa-consistent histories, Η˜idαsasd≡∪n=nminαsasd∞Ηidn;αsasd, eq.  can be further simplified as: r <dig>  pαsasd,titfsati=∑m^1m^2⋯m^n∈Η˜idαsasdpm^1m^2⋯m^ntitfsati. 

equation  and eq.  are the formal expressions of the occurrence probability of α derived in effect from the defining equations, eqs. , of our evolutionary model. thus, they are the “ab initio probability” of the pwa. in the following, we will examine its factorability.

r <dig>  local history-set equivalence class of indel histories
before advancing to the factorability of general pwa probabilities, we will introduce an essential concept here. for this purpose, we first consider the very simple pwa, eq. , as an example. . in this case, nmin =  <dig>  and there are two 2-indel histories that can yield this pwa: one is m^d <dig> m^i <dig>  and the other is m^i <dig> m^d <dig> . thus, these two indel histories result in the same final state: sf=sim^d24m^i33=sim^i63m^d <dig> . in other words, the two different successive actions of two indel operators have the same effect on the sequence states . this fact will be phrased as “the two products of the operators are equivalent”, and represented by the relationship:fig.  <dig> binary equivalence relation and lhs equivalence class. a an indel history, m^d <dig> ,m^i <dig> . b another indel history, m^i <dig> ,m^d <dig> . these histories result in the same final state ). thus, their total effects are equivalent. c their equivalent local history set , m^d <dig> ,m^i <dig> , is represented by the isolated actions of local indel histories on the initial state 

 r <dig>  m^i63m^d24~m^d24m^i <dig>  

this “binary equivalence” can be generalized to the following relationships between two indel events separated at least by a pas: r <dig> a m^ix1l1m^ix2l2~m^ix2l2m^ix1+l <dig> l1forx1>x <dig>   r <dig> b m^dxbxem^ixl~m^ixlm^dxb+l,xe+lforxb>x+ <dig>   r <dig> c m^ixlm^dxbxe~m^dxbxem^ix−l′,lforx>xe,  r <dig> d m^dxb1xe1m^dxb2xe2~m^dxb2xe2m^dxb1−l2′,xe1−l2′forxb1>xe2+ <dig>  

here, l′≡min{xe − xb +  <dig>  xe} in eq. , and l2′≡min{xe2 − xb2 +  <dig>  xe2} in eq. . if you will, these equivalence relations could be phrased as follows. “the operator representing the event on the left along the sequence will not change whether it comes first or second. the operator representing the event on the right will shift its operational position to the left/right by the number of sites deleted/inserted before its operation, when it comes second”.11

now, we will extend the binary equivalence relations, eqs. , to the equivalence relations among more general complex indel histories, each consisting of more than two indel events. let us consider a global history of n indel events, m^1m^2…m^n, which begins with an “ancestral state”, sa, and ends with a “descendant state”, sd. obviously, the two states must satisfy the equation: r <dig>  sd=sam^1m^2⋯m^n. 

given an indel history, we can identify pass unambiguously. suppose that such pass separate the indel events, m^ν  in m^1m^2…m^n, into k local subsets of indels, each of which is confined either between a pair of pass or between a pas and an end of the resulting pwa. number the k local subsets as k =  <dig>   <dig>  …, k from left to right, and let nk be the number of indel events in the k th local subset. naturally, ∑k = 1knk = n. and let m^′kik be the element of m^νν= <dig> ,…,n representing the ik th event  in the k th local subset . . then, repeatedly applying the binary equivalence relations, eqs. , between the indel operators belonging to different local subsets, we can move the operators around in the product in eq.  and get the following equation: r <dig>  sd=sam^k1⋯m^knk⋯m^11⋯m^kn <dig>  

here m^kik is an operator that was obtained from m^′kik through the series of equivalence relations eqs.  that brought eq.  into eq. . as in eq. , the operators in each pair of large square parentheses in eq.  are arranged in temporal order, so that the earliest event in each local subset will come leftmost. but it should be noted that the order among the pairs of large square parentheses is the opposite of the actual spatial order among the local subsets, so that the rightmost one along the sequence  will come leftmost. in this way, the operators in each local subset, e.g., m^k <dig> …,m^knk, are exactly the same as those when the events in the subset alone struck 〈sa|. thus the series of operators, m^k <dig> …,m^knk, for the k th local subset defines the k th local indel history that was isolated from the global indel history, m^1m^2…m^n, on si ∈ s.

now, let us consider a history of n indel events other than m^1m^2…m^n. if the temporal operator product of the history is shown to be equivalent to eq.  through a series of eqs. , then it should also be connected to eq.  though another series of eqs. . therefore, it should be equivalent to m^1m^2…m^n in this sense. hence, we can define a particular equivalence class, which is the set of all global indel histories that can be “decomposed” into the identical set of local indel histories, such as eq. , only through a series of eqs. , between indel operators separated by at least a pas. we will call it the “local-history-set  equivalence class”. in the equivalence class defined by a local history set , m^k <dig> …,m^knkk= <dig> …,k , on an initial sequence state sa ∈ sii, there are n!∏k=1knk lhs-equivalent global indel histories beginning with sa. each of the global histories corresponds to a way of reordering n indel events while retaining the relative temporal order among nk events within the k th local indel history .

in the simplest example at the beginning of this section  and above), the corresponding lhs is: m^d24m^i <dig>  the lhs consists of two local histories, each of which is a single-indel history . as a slightly more complex example, consider the history, m^d <dig> m^i <dig> m^d <dig> m^i <dig>  illustrated in fig.  <dig>  this history belongs to the lhs equivalence class represented by the lhs: m^d <dig> m^d23m^i <dig> m^i <dig>  which consists of two 2-indel local histories. if this lhs is recast into the form in eq. , we have: m^11=m^d <dig>  m^12=m^d <dig>  m^21=m^i <dig>  and m^22=m^i <dig> 

r <dig>  factorability of pairwise alignment probability: brief description
now we are ready to examine the factorability of the ab initio probability of pwa α, p)|] in eq. , given the ancestral state  at the initial time . here the “factorability” means that the pwa probability can be re-expressed as the product of an overall factor and contributions from local regions. natural candidates for the local regions would be those in between the pass, because we know that indels never hit or pierced pass . we are not interested in trivial factorability. thus, we only consider pwas  each of which requires at least two local indel histories. in the following, we will only briefly describe our demonstration of the pwa probability factorization. its more detailed yet rather intuitive description is given in supplementary methods sm- <dig> in additional file  <dig>  .

we first notice that each component probability, pm^1m^2⋯m^ntitfsati given by eq. , will not be factorable. this is because its domain of multiple-time integration is not a direct product. so, lets consider the total probability of a lhs equivalence class, m^⇀⇀lhs : r <dig>  pm^⇀⇀lhstitfsati≡∑m^1m^2⋯m^n∈m^⇀⇀lhspm^1m^2⋯m^ntitfsati. 

we can show that this probability can be factorized as: r <dig>  μpm^⇀⇀lhsti,tfsati=∏k=1kμpm^k <dig> …,m^knktitfsati, where r <dig>  μpm^k <dig> …,m^knktitfsati≡pm^k <dig> …,m^knktitfsati/ptitfsati,  r <dig>  μpm^⇀⇀lhstitfsati≡pm^⇀⇀lhstitfsati/ptitfsati, if the following two conditions are satisfied.

condition : the rate of an indel event  is independent of the portion of the sequence state  outside of the region of the local history the event  belongs to.

condition : the increment of the exit rate due to an indel event ≡rxid − rxid, with sν=sν−1m^ν) is independent of the portion of the sequence state  outside of the region of the local history the event  belongs to.

see supplementary appendix sa- <dig> in additional file  <dig> for the derivation of the mathematically rigorous version of this set of conditions. ). condition  is somewhat similar to the “context-independence” condition imposed on the “long indel” model  <cit> , though our condition is slightly less restrictive. condition  has never been found or even discussed thus far. in fact, the “long indel” model trivially satisfies this condition , thus  <cit>  did not need to pay attention to it. however, this condition is not always satisfied. indeed, as exemplified in subsection r8- <dig>  some models have non-factorable alignment probabilities due to the violation of this condition even though condition  is satisfied.

each global indel history  belongs to a single lhs equivalence class . and all elements of m^⇀⇀lhs can result in the same pwa. therefore, we get the direct sum structure: r <dig>  Η˜idαsasd=∪m^⇀⇀∈Λ˜idαsa,sdm^⇀⇀lhs, where Λ˜idαsasd is the set of all lhss consistent with α. hence, the pwa probability, eq. , can be rewritten as: r <dig>  pαsasd,titfsati=∑m^⇀⇀∈Λ˜idαsasdpm^⇀⇀lhstitfsati. 

we are considering all indel histories, including non-parsimonious ones, that can yield α. thus, the lhss belonging to Λ˜idαsasd may consist of different numbers of local histories. we will choose the maximum possible set of pass in the given pwa, which separates the pwa into the finest potentially local-history-accommodating regions, denoted as γ <dig> γ <dig> …,γκmax. . <dig> then, we can represent any m^⇀⇀=m^k <dig> …,m^knkk= <dig> …,k∈Λ˜idαsasd as a vector with κmax components: m^⇀⇀=m^⇀γ <dig> m^⇀γ <dig> …,m^⇀γκmax. . substituting eqs.  into eq. , and exploiting the vector representation of the lhss, we can reach the desired expression: r <dig>  pαsasd,titfsati=ptitfsati×∏κ=1κmaxμ˜pΛ˜idγκ;αsasd,titfsati. 

here, Λ˜idγκ;αsasd denotes the set of local indel histories that can give rise to the sub-pwa of α confined in γκ, and the multiplication factor, r <dig>  μ˜pΛ˜idγκ;αsasd,titfsati≡∑m^⇀γκ∈Λ˜idγκ;αsasdμpm^⇀γκ,titfsati, represents the total contribution from Λ˜idγκ;αsasd to the pwa probability. |] =  <dig> should be remembered).

equation  states that the pwa probability is factorized into the product of an overall factor |]) and contributions from regions accommodating local indel histories . therefore, the set of conditions,  and , is sufficient for the factorability of the pwa probability. at present, we are not sure whether the set of conditions is also necessary or not. this may not be the case in the rigorous sense, and there may be some instances with factorable pwa probabilities despite the violation of condition  or . nevertheless, even if there are, we suspect that such cases should be isolated, requiring intricate cancellations of the terms. thus, we will refer to the conditions  and  as the “sufficient and nearly necessary set of conditions” for factorable pwa probabilities.

r <dig>  factorability of multiple sequence alignment probability: brief description
thus far, we only examined the probability of a given pwa, conditioned on an ancestral state at initial time. actually, once we know how to calculate such conditional pwa probabilities, we can build them up along the phylogenetic tree to calculate the probability of a given msa, as described in the introductions of  <cit>  and  <cit> .  here, we basically follow their procedures. however, it should be stressed that the msa probability here will be calculated ab initio under a genuine evolutionary stochastic model and not under a hmm or a transducer, which is not necessarily evolutionarily consistent. this section briefly explains the derivation of the factorization of an ab initio msa probability. for details on the derivation, see supplementary methods sm- <dig> in additional file  <dig> 

in this section, we formally calculate the ab initio probability of a msa given a rooted phylogenetic tree, t = , where {n}t is the set of all nodes of the tree, and {b}t is the set of all branches of the tree. we decompose the set of all nodes as: {n}t = Νin + Νx, where Νin is the set of all internal nodes and Νxt=n1…nnx is the set of all external nodes. | is the number of external nodes.) the root node plays an important role and will be denoted as nroot. because the tree is rooted, each branch b is directed. thus, let na denote the “ancestral node” on the upstream end of b, and let nd denote the “descendant node” on the downstream end of b. let s ∈ sii be a sequence state at the node n ∈ {n}t. especially, we use abbreviations: sa≡s) ∈ sii and sd≡s) ∈ sii. finally, as mentioned in background, we suppose that the branch lengths, {|b||b ∈ {b}t}, and the indel model parameters, {Θid}t≡{Θid|b ∈ {b}t}, are all given. note that the model parameters Θid could depend on the branch, at least theoretically.

first, we extend the ideas proposed in  <cit>  to each indel history along a tree, by regarding the indel history along a branch as a map  from the ancestral state to the descendant state, as follows. an indel history along a tree consists of indel histories along all branches of the tree that are interdependent, in the sense that the indel process of a branch b determines a sequence state sd at its descendant node nd, on which the indel processes along its downstream branches depend. thus, an indel history on a given root sequence state sroot = s ∈ sii automatically determines the sequence states at all nodes, {s ∈ siifor∀n ∈ {n}t}. let Η˜ids0≡∪n=0∞Ηidns <dig>  defined below eq. ) be the set of all indel histories along a time axis  starting with state s <dig>  then, each indel history, m^⇀bt, along tree t and starting with sroot can be specifically expressed as: r <dig>  sdb=sabm^b1⋯m^bnbforb∀∈btm^⇀b=m^b <dig> …,m^bnb∈Η˜idsabandsnroot=sroot. 

here, the symbol, m^νb, denotes the ν th event in the indel history along branch b ∈ {b}t. the probability of the indel history, eq. , can be calculated as: r <dig>  pm^⇀btsrootnroot=∏b∈btpm^⇀b,bsab,nabsnroot=sroot,sdb=sabm^1b⋯m^nbbforb∀∈bt. 

here, the probability of an indel history, m^⇀b=m^b <dig> …,m^bnb∈Η˜idsab, along branch b ∈ {b}t is given by the probability during the corresponding time interval, : r <dig>  pm^⇀b,bsab,nab≡pm^1b,⋯,m^nbbtnab,tndbsab,tnabΘidb. 

here we explicitly showed the branch-dependence of the model parameters.

now, consider a msa, αs1s2…snx, among the sequences at the external nodes, si = s ∈ sii ). ). let srootm^⇀bt be a pair of a root state and an indel history along t starting with the state. and let Ψ˜idαs1s2…snx;t be the set of all such pairs defined on t consistent with αs1s2…snx. then, analogously to eq.  supplemented with eq.  for a pwa, the probability of a given msa under a given model setting  should be expressed as: r <dig>  pαs1s2…snx|t=∑sroot,m^⇀bt∈Ψ˜idαs1s2…snx;tpsrootnrootpm^⇀btsrootnroot, which is supplemented with eq. . here, p is the probability of state sroot at the root node.  if you will, eqs.  and  could be considered as the “perturbation expansion” of an ab initio msa probability. to make this formal expansion more tractable, let snΝin≡sn∈sn∈Νint denote a set of ancestral states at all internal nodes ). to be consistent with a given msa, the ancestral states must satisfy the “phylogenetic correctness” condition in each msa column . <dig> let Σαs1s2…snx;n∈Νint;t be the set of all snΝin’s consistent with αs1s2…snx . then, eq.  supplemented with eq.  can be rewritten as: r <dig>  pαs1s2…snxt=∑snΝin∈Σαs1s2…snx;n∈Νint;tpαs1s2…snx;snΝint. 

here, pαs1s2…snx;snΝint is the probability of simultaneously getting αs1s2…snx and snΝin. this probability is the sum of contributions from all indel histories sharing the same homology structure among sequence states at all nodes. especially, the sequence states at internal nodes have homology structures  fixed for respective nodes. thus, through some reasoning , we get: r <dig>  pαs1s2…snx;snΝint=psrootnroot∏b∈btpαsab,sdb,bsab,nab. 

here, r <dig>  pαsab,sdb,bsab,nab≡pαsab,sdb,tnab,tndbsab,tnabΘidb is the probability of the ancestor-descendant pwa along branch b. this eq.  is basically the expression proposed in  <cit> , and we demonstrated in effect that their proposal also holds even with a genuine stochastic evolutionary model. usually, eq.  supplemented with eq.  is much more tractable than eq.  supplemented with eq. , because of the two reasons.  usually, it is not the indel history along the tree but  the set of ancestral sequence states that is inferred from a given msa.  the probability of each indel history along the tree ) is not factorable in general, whereas eq.  is a product of pwa probabilities, each of which should be factorable if the conditions  and  in section r <dig> are satisfied.

now, we can show that, if the “condition ” given below in addition to conditions  and  is satisfied, we can factorize the msa probability into a form somewhat similar to eq.  for the pwa probability. in subsection  <dig>  of  <cit> , we demonstrated it using the history-based expansion of the msa probability  supplemented with eq. ). in supplementary methods sm- <dig>  we will use the ancestral-state-based expansion  supplemented with eq. ), as was only briefly sketched at the bottom of subsection  <dig>  of . in a msa, gapless columns play almost the same role as pass in a pwa. because of the aforementioned “phylogenetic correctness” condition, a gapless column indicates that no indel event hit or pierced the site. therefore, gapless columns will partition a msa into regions each of which accommodates a local subset of every global history. analogously to the argument above eq. , let c <dig> c <dig> …,cΚmax be the maximum possible set of such regions determined by a given msa and a model setting  .  because the summation in eq.  involves the summation over all msa-consistent root states, it would be convenient to specify a “reference” root state, s0root. it can be anything, as long as it is the state at the root consistent with αs1s2…snx. technically, one good candidate for s0root would be a root state obtained by applying the dollo parsimony principle  <cit>  to each column of the msa, because it is arguably the most readily available state that satisfies the phylogenetic correctness condition along the entire msa. then, we will impose the following condition.

condition : r <dig>  psrootnroot=ps0rootnroot∏Κ=1Κmaxμpsroots0rootnrootcΚ. 

here the multiplication factor, μp, represents the change in the state probability at the root due to the difference between sroot and s0root within cΚ. this equation holds, e.g., when p is a geometric distribution or a uniform distribution of the root sequence length.14

under the conditions ,  and , through a series of formal calculations and reasoning, eq.  supplemented with eq.  can be re-expressed into the final factorized form: r <dig>  pαs1s2…snxt=p0s0roott∏Κ=1ΚmaxΜ⌣˜pαs1s2…snx;s0root;cΚt. 

here, r <dig>  p0s0roott≡ps0rootnrootpts0rootnroot is the probability of having state s0root that has been intact all across tree t, and Μ⌣˜pαs1s2…snx;s0root;cΚt is the multiplication factor contributed from all local indel histories  confined in cΚ. <dig> briefly, the multiplication factor is the summation of terms over all possible sets of the msa-consistent ancestral states in cΚ. and each of the terms is the product of the local pwa multiplication factors  confined in cΚ , the exponential of minus the summation over all b’s of the time-integrated exit rate differences between sa and s0root coming from cΚ, and μp for the root state probability. , see supplementary methods sm- <dig> in additional file 1).

r <dig>  examples: models with factorable/non-factorable alignment probabilities
a merit of conditions  and  given in section r <dig> is that they can draw the line between evolutionary models with factorable pwa probabilities and those with non-factorable ones. to illustrate the use of these conditions, we here give three examples:  a simple model with factorable probabilities,  a simple model with non-factorable probabilities, and  a non-trivial model with factorable probabilities. .

r8- <dig>  totally space-homogeneous model
the simplest conceivable indel models would be those whose indel rate parameters are space-homogeneous, i.e., independent of the positions where the indels occur: r8- <dig>  rixl1st=gil1t,  r8- <dig>  rdxb,xb+l2−1;s,t=gdl2t. 

in fully space-homogeneous models, these equations hold for 1 ≤ x ≤ l −  <dig>  1 ≤ l1 ≤ lico, 1 ≤ l2 ≤ ldco, and 2 − l2 ≤ xb ≤ l, where lico and ldco are the “cut-off lengths” for insertions and deletions, respectively.  = gi;l and ri, l; s, t) = gi;r could differ from gi in eq. ). in fact, these conditions were imposed in nearly all continuous-time markov models of indels that were studied in the past. note that the rate parameters in eqs.  could depend on time, although most studies thus far assumed that the rates are time-independent as well. eqs.  automatically guarantees condition . thus, all we have to do is check whether or not condition  is also satisfied. indeed, we can show it is. the exit rate of this model is calculated by substituting eqs.  into eq.  ), and we find that it is an affine function of the sequence length ): r8- <dig>  rxidst=atls+bt, with at=∑l=1licogilt+∑l=1ldcogdlt and bt=∑l=1ldcol−1gdlt−∑l=1licogilt+∑l=1licogi;llt+gi;rlt. if the exit rate is affine, we have, for sν=sν−1m^ν: r8- <dig>  δrxidsν,sν− <dig> t≡rxidsν,t−rxidsν− <dig> t=atlsν−lsν−1=atδlm^ν. 

here δlm^ν is the length change caused by the event, m^ν. the rightmost hand side of this equation depends only on m^ν and the time it occurred, but not on the sequence state ). thus, condition  is always satisfied under fully space-homogenous models, which means that alignment probabilities calculated ab initio  under such models are factorable, as shown in section r <dig> 

an important special case of the space-homogeneous model is the model used by dawg  <cit> , whose indel rate parameters are given as: gi = gi;l = gi;r = λifi and gd = λdfd. because this is a special case of eqs. , it naturally provides factorable alignment probabilities. this model is probably among the most flexible indel evolutionary models used thus far. the model accommodates any distributions of indel lengths  and fd) that are independent of each other, and independent total rates for insertions and deletions . some of our studies  <cit>  are mostly based on this model.

another important special case is the “long indel” model  <cit> , whose  rate parameters are given by: gi = λl, gi;llt=gi;rlt=λ˜lend  > 0), gi;llt=λ˜˜lwhole  = 0), and gd = μl. this model is less flexible than dawg’s model, because its indel rates are subject to the detailed-balance conditions: λl = lμl, λ˜lend=λ1/μ1l∑l′=lldcoμl′, and λ˜˜lwhole=λ1/μ1l∑l′=lldcol′−1+1μl′. like dawg’s model, this model is a special case of the model defined by eqs. . thus, the alignment probabilities calculated under it are indeed factorable, as verbally justified in  <cit> . indeed, we can explicitly show that, as far as each lhs equivalence class is concerned, the indel component of its probability calculated according to the recipe of  <cit>  equals the product of p and eq. , i.e., the “total probability” of the lhs equivalence class via our ab initio formulation, calculated with the aforementioned indel rate parameters. the proof is given in supplementary appendix sa- <dig> in additional file  <dig>  it should be stressed that, although  <cit>  ignored condition , this caused no problem thanks to eq.  satisfied by any fully space-homogeneous models. actually, it is this condition  that guarantees the equivalence of the probabilities calculated via the two methods, because it equates each increment of the exit rate of a chop-zone with that of an entire sequence. the equivalence can be extended to between pwa probabilities, provided that the contributing local indel histories are correctly enumerated. .

regarding the insertion rates, we could somewhat relax the space-homogeneity without compromising the factorability of alignment probabilities. for example, the insertion rates could depend on the ancestries, υ and υ, of sites flanking the event: r8- <dig>  rixlst=giυsx,υs,x+ <dig> l,t. 

these rates satisfy condition . eq.  combined with the space-homogeneous deletion rates, eq. , still gives an exit rate whose increment due to an indel event depends only on the inserted/deleted sub-sequence  but not on the regions separated from it by at least a pas. hence the model also satisfies condition , thus providing factorable alignment probabilities. relaxing the space-homogeneity of deletion rates, however, is somewhat difficult, particularly because of condition . in subsection r8- <dig>  we will attempt it.

r8- <dig>  space-homogeneous model flanked by biologically essential sites/regions
the space-homogeneous models discussed above may decently approximate the evolution of a sequence region under no selective pressure. a real genome, however, is scattered with regions and sites under strong or weak purifying selection. here, we consider one of the simplest such cases, in which biologically essential sites or regions flank a neutrally evolving region from both sides. <dig> the insertion rates of this model are given by eq.  with the same domain, and the deletion rates are: r8- <dig>  rdxbxest=gdxe−xb+ <dig> tfor1≤xb≤xe≤lsand1≤xe−xb+1≤ldco,0forxb≤ <dig> xe>lsorxe−xb+1>ldco. 

the exit rate for this model is calculated as: r8- <dig>  rxidst=ls−1∑l=1licogilt+∑l=1licogi;llt+gi;rlt+∑l=1minls,ldcols−l+1)gd ≥ ldco, this is affine, and given by eq.  with exactly the same a as before and bt=−∑l=1ldcol−1gdlt−∑l=1licogilt+∑l=1licogi;llt+gi;rlt. therefore, with such a sequence length, the alignment probability is still factorable even under this model. for l < ldco, in contrast, it exhibits a non-affine form: r8- <dig>  rxidst=ls−1∑l=1licogilt+∑l=1licogi;llt+gi;rlt+∑l=1lsls−l+1)gd will not be satisfied in general, whereas condition  is satisfied. this case gives the simplest example of a model with non-factorable pwa probabilities despite space-homogeneous rates of indels . in a model with non-factorable alignment probabilities, the “difference of exit rate differences”: r8- <dig>  δδrxids′′′s′′s′,st≡δrxids′′′s′′,t−δrxids′st, where s′=sm^ν <dig>  s′′=sm^ν <dig> and s′′′=sm^ν2m^ν <dig>  indicates the “degree of non-factorability” due to the pair of events, m^ν <dig> and m^ν <dig>  that belong to different local histories.  of  <cit>  for more details.)

r8- <dig>  model with rate-heterogeneity across regions
it is not only space-homogenous models but also some space-heterogeneous models that satisfy both conditions  and , albeit partially. here we give an example. we first define a set of non-overlapping regions, Εy≡ , that existed in the initial state, si ∈ sii. we define the “descendant region”, Εy, of Εy in a descendant state  by the closed interval, Εy≡, where xb;y and xe;y are the leftmost and the rightmost sites, respectively, among those descended from the sites in Εy. then, based on them, we define an indel model whose rate parameters are given by: r8- <dig>  rixlst=ri;basexlst+∑y=1yΔriΕyxlst.  r8- <dig>  rdxbxest=rd;basexbxest+∑y=1yΔrdΕyxbxest. 

here, the “baseline” indel rates, {ri;base}x,l and rd;basexbxestxb,xe, are given by eq.  and eq. , respectively. the region-specific increments, {Δri}x,l and ΔrdΕyxbxestxb,xe, can be non-zero only within Εy≡ defined above . moreover, the increments can depend only on the portion of the sequence state within Εy. the increments can be negative, as long as the entire rates, eqs. , are non-negative. from eqs. , the exit rates can be decomposed as: r8- <dig>  rxidst=rx;baseidst+∑y=1yΔrxidΕyst. 

here, r8- <dig>  rx;baseidst=∑x=0ls∑l=1licori;basexlst+∑xb=−ldco+2ls∑xe=maxxb1xb+ldco−1rd;basexbxest is the baseline exit rate. and r8- <dig>  ΔrxidΕyst≡∑x=xb;ysxe;ys−1∑l=1licoΔriΕyxlst+∑xb=xb;ysxe;ys∑xe=xbxe;ysΔrdΕyxbxest is the increment of the exit rate confined in, and dependent only on, Εy . as explained at the bottom of subsection r8- <dig>  rx;baseid alone gives factorable alignment probabilities. and the increments, {Δrxid}y =  <dig> …,y, behave independently of the portions of sequence states outside Εy. thus, if each indel event is completely confined in any of the Εy’s or in any spacer regions between neighboring Εy’s , the alignment probability can be expressed as the product of the overall factor and the contributions from Εy’s and within spacer regions. even if some events within a Εy are separated from the others by at least a pas, they must be put together into a single local indel history . a complexity arises because deletions may stick out of a Εy, or even bridge two or more regions . the rates of such deletions and indels that are completely outside of the regions are given by the baseline rates. when a deletion sticks out of a region, the region will be extended to encompass the deletion, and all events within the extended region are lumped into a single local indel history . when a deletion bridges two or more regions, a “meta-region” encompassing all bridged regions is defined, and all events within the meta-region will form a single local indel history . in contrast, the indels completely outside of the regions should be independent of each other as long as they are separated by at least a pas. hence, under this model, the pwa probabilities are “factorable” in this somewhat non-trivial sense.

in supplementary appendix sa- <dig> in additional file  <dig>  we explicitly showed that the probability of a lhs equivalence class via the recipe of  <cit>  is identical to that calculated via our ab initio formulation. although we assumed the space-homogeneity there, the proof can probably be extended to the model in this subsection as well, by slightly modifying the definition of the “chop-zone”.

r <dig>  merits, possible extensions & applications, and outstanding issues
in this paper, we presented a theoretical formulation built up by tools that help mathematically precise dissection of the ab initio calculation of alignment probabilities under genuine stochastic evolutionary models. another merit of this formulation is that it gives intuitively clear pictures. for example, the insertion and deletion operators simply mathematically represent the intuitive pictures of the indels naturally acting on sequences . thus, the action of the rate operator, given by eqs.  ), is intuitively understandable as merely the collection of all possible single-mutational channels from a given sequence state . then, the expansion formula for the action of the finite-time transition operator, eqs. , can also be intuitively interpreted as the collection of contributions from all possible mutational processes starting with an initial sequence state. importantly, this expansion was not posed via a hand-waving argument but rigorously derived as the solution of the defining equations of the model ), which justifies its ab initio status. and the integral equations, eqs. , bridged the expansion’s mathematically rigorous and intuitive aspects. finally, the binary equivalence relations, eqs.  , and their resulting lhs equivalence classes also allow intuitive interpretations as the invariance of the local effects of indels under their relative orders with spatially separate events. therefore, the conditions for the factorability of pwa probabilities are also intuitively understandable. although their mathematically rigorous derivations  might appear somewhat formidable, they are actually not so difficult once the aforementioned intuitive pictures are understood. hence, by coupling the mathematical preciseness with the intuitive clarity, our theoretical formulation is expected to facilitate further advances of the study of ab initio alignment probabilities under genuine stochastic evolutionary models with some biological realism.

for clarity, this study focused only on indels among various mutational types, because indels are essential for creating a sequence alignment. if desired, however, our theoretical formulation could also incorporate substitutions . moreover, the formulation could also be extended to incorporate other genome rearrangements, such as duplications and inversions.  such an extended formulation will provide tools to enable concrete analyses of “rate grammars” extended to incorporate genome rearrangements .

the practical use of our formulation depends on how efficiently it can calculate quite accurate alignment probabilities. although the factorability of alignment probabilities will help greatly speed up the computation, the contribution from each local region  or eq.  in additional file 1) is still composed of infinitely many terms. good news is that the first approximation of each local contribution, which is the summation of the terms from parsimonious local indel histories alone, is quite accurate, as long as the gap lengths and the branch lengths are at most moderate . thus, considerably efficient computation of considerably accurate alignment probabilities may be possible based on our formulation. especially, at least when the model is spatiotemporally homogeneous, our ab initio calculation was shown to be equivalent to the calculation of  <cit> , with a caveat . thus, their dynamic programming  may be applicable, possibly with some modifications, to a wider class of models with factorable probabilities.

despite these favorable aspects, our theoretical formulation still has some limitations and outstanding issues. first, we did not examine whether our “sufficient and nearly necessary” set of conditions for the alignment probability factorization is exactly necessary and sufficient or not. nor did we provide any counterexamples that violate our set of conditions and still have factorable alignment probabilities. solving these problems may be interesting at least mathematically.

second, although in this study we tentatively used the set of positive integers to represent the space of ancestry indices , it is obviously not the best choice. finding, or establishing, a mathematical entity  that is more suitable for representing ϒ should be another mathematically interesting issue.

third, in section r <dig> , we only considered simple boundary conditions. each sequence end was either freely mutable or flanked by a biologically essential region that allows no indels. these boundary conditions may remain good approximations if the subject sequences were extracted from well-characterized genomic regions. in real sequence analyses, however, the ends of the aligned sequences are often determined by artificial factors, such as the methods to sequence the genome, detect sequence homology, and annotate the sequences. moreover, the constant cutoff lengths  were introduced just for the sake of simplicity, to broadly take account of the effects of various factors that suppress very long indels . in reality, it is much more likely that the cutoff lengths will vary across regions. then, the alignment probabilities would be only approximately factorable, as in subsection r8- <dig>  in order to pursue further biological realism and to enable more accurate sequence analyses, it should be inevitable to address these issues seriously. eq.  may be useful for such studies.

fourth, we strongly caution the readers that, at this point, a naïve application of our formulation or its algorithmic implementation  <cit>  to a reconstructed msa is fraught with high risks of incorrect predictions of indel histories, etc. this is because reconstructed msas, even if they were reconstructed via state-of-the-art aligners , are known to be considerably erroneous . thus, it should be preferable to first develop a method or a program that accurately assesses and rectifies alignment errors, preferably by estimating the distribution of fairly likely alternative msas , before using our formulation to make some evolutionary or biological predictions.

fifth, in this study, the phylogenetic tree was regarded as given. in many cases, however, the phylogenetic trees must also be inferred from the input sequence data. a theoretically ideal way would be to infer the joint distribution of msas and phylogenetic trees, as it is expected to minimize possible prediction biases . a major problem is that such an analysis would be tremendously time-consuming in general. at present, it is a totally open question whether our formulation can be adapted to infer a quite accurate joint distribution efficiently enough.

CONCLUSIONS
to the best of our knowledge, this is the first study to theoretically dissect the ab initio calculation of alignment probabilities under a genuine stochastic evolutionary model, which describes the evolution of an entire sequence via insertions and deletions  along the time axis. the model handled here extends the previously most general evolutionary model, i.e., the general form of the “substitution/inserton/deletion models”  <cit> . it should be noted that we did not impose any unnatural restrictions such as the prohibition of overlapping indels. nor did we make the pre-proof assumption that the probability is factorable into the product of column-to-column transition probabilities or block-wise contributions. the essential tool introduced in this study was the operator representation of indels. this enabled us to shift the focus from the trajectory of sequence states  to the series of indel events, and to define local-history-set  equivalence classes of indel histories. moreover, the operator representation also facilitated the adaptation of the time-dependent perturbation expansion , which enabled us to express the probability of an alignment as a summation of probabilities over all alignment-consistent indel histories. then, under a most general set of indel rate parameters, we exploited the lhs equivalence classes and found a “sufficient and nearly necessary” set of conditions on the indel rate parameters and exit rates under which the ab initio alignment probabilities can be factorized to provide a sort of generalized hmms. we also showed that quite a wide variety of indel models could satisfy this set of conditions. such models include not only the “long indel” model  <cit>  and the indel model of a genuine molecular evolution simulator, dawg  <cit> , but also some sorts of models with rate variation across regions. moreover, we explicitly showed  that, as far as each lhs equivalence class is concerned, the probability calculated via the method of  <cit>  is equivalent to that calculated via our ab initio formulation, at least under their spatiotemporally homogeneous indel model.

to summarize, by depending purely on the first principle and by providing intuitively clear pictures, this study established firm theoretical grounds that will help further advance the ab initio calculation of alignment probabilities under genuine stochastic evolutionary models with some biological realism. and our theoretical formulation will also provide other indel probabilistic models with a sound reference point, provided that there exist approximate methods that can quite accurately estimate the ab initio alignment probabilities fairly efficiently. such approximate methods will be the subject of a related study .


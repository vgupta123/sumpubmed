BACKGROUND
the friedman  <cit>  rank sum test is a widely-used nonparametric method for the analysis of several related samples in computational biology and other fields. it is used, for example, to compare the performance results of a set of  classifiers over multiple datasets, covering case problems, benchmark functions, or performance indicators . some recent examples of the numerous applications of the friedman test in bioinformatics include . the test is supported by many statistical software packages and it is routinely discussed in textbooks on nonparametric statistics .

the friedman test procedure is an analysis of variance by ranks, i.e., observed rank scores or rank scores obtained by ordering ordinal or numerical outcomes, that is used when one is not willing to make strong distributional assumptions. a common approach is to present the test as a method for identifying treatment effects of k different treatments in a so-called randomized complete block design. this design uses n sets, called blocks, of k homogeneous units matched on some relevant characteristic, for example patients matched on snp genotype. the k treatments are assigned randomly to the k units within each block, with each treatment condition being administered once within a block. the friedman test is also conducted if the samples concern a repeated measures design. in such design each experimental unit constitutes a block that serves in all treatment conditions. examples are provided by experiments in which k different treatments  are compared on a single experimental unit , or if k units  are ranked in order by each of n ‘judges’ . in all these settings the objective is to determine if the k populations from which the observations were made are identically distributed.

applied to classifier comparison, the null hypothesis for the friedman test is that the performance results of the k classifiers over n datasets are samples that have been drawn from the same population or, equivalently, from different populations with the same distribution  <cit> . to examine this hypothesis, the test determines whether the rank sums of the k classifiers included in the comparison are significantly different. after applying the omnibus friedman test and observing that the rank sums are different, the next step is to compare all classifiers against each other or against a baseline classifier . in doing so, a series of comparisons of rank sums  is performed, adjusting the significance level using a bonferroni correction or more powerful approaches to control the familywise type-i error rate  <cit> .

preferably one should use the exact null distribution of the rank sum difference statistic in these subsequent analyses. only if the decision on the null hypothesis is based on the exact distribution is the probability of committing a type-i error known exactly. however, the exact distribution and the associated true tail probabilities are not yet adequately known. to be sure, tables of exact critical values at standard significance levels  and of exact p-values  <cit>  are available for small values of k and n, for which complete enumeration is possible. also, the lower order moments of the exact sampling distribution have been documented in detail  <cit> , and stuart  <cit>  proved the conjecture of whitfield  <cit>  that, on the null hypothesis, the difference between rank sum values is asymptotically normally distributed as n tends to infinity. further, in a recent study koziol  <cit>  used symbolic computation for finding the distribution of absolute values of differences in rank sums. apart from these important contributions there is, to the best of our knowledge, no publication available in the probability theory, rank statistics or other literature that addresses the exact distribution of the rank sum difference statistic.

as the null distribution in the general case is unknown and exact computation seemingly intractable, it is generally recommended to apply a large-sample approximation method to test the significance of the pairwise difference in rank sums. it is well known, however, that calculating probabilities using an asymptotic variant of an exact test may lead to inaccurate p-values when the sample size n is small, as in most applications of the friedman test, and thereby to a false acceptance or false rejection of the null hypothesis. furthermore, there are several large-sample tests available with different limiting distributions, and these tests may vary substantially in their results. consequently, there is little agreement in the nonparametric literature over which approximate method is most appropriate to employ for the comparison of friedman rank sums  <cit> . this statement refers both to approximate tests of significance for the comparison of all  = k/ <dig> pairs of treatments, and to tests for the comparison of k −  <dig> treatments with a single control. obviously, the utility of the asymptotic tests depends on their accuracy to approximate the exact sampling distribution of the discrete rank sum difference statistic.

the purpose of this note is twofold. the foremost aim is to provide an expression for calculating the exact probability mass function of the pairwise differences in friedman rank sums. this expression may be employed to quickly calculate the exact p-value and associated statistics such as the critical difference value. the calculation does not require a complicated algorithm and as it is easily incorporated into a computer program, there is no longer need to resort to asymptotic p-values. we illustrate the exact method in the context of two recently published analyses of the performance of classifiers and data projection methods. the second aim is to examine under what circumstances the exact distribution and the associated exact statistics offer an improvement over traditional approximate methods for friedman rank sum comparison.

it is important to note at the outset that this article is not concerned with the friedman test itself. the friedman test is an over-all test that evaluates the joint distribution of rank sums to examine equality in treatment distributions. computation of the exact joint distribution under the null is discussed by van de wiel  <cit> , and an efficient algorithm for computing the exact permutation distribution of the friedman test statistic is available in statxact  <cit> . the present paper offers an over-all exact test for pairwise comparison of friedman rank sums. the reason is essentially that researchers are usually not only interested in knowing whether any difference exists among treatments, but also in discovering which treatments are different from each other, and the friedman test is not designed for this purpose. although the type of test dealt with here is not the same as the friedman test, we will briefly discuss the latter as the procedures have important elements in common, such as the global null hypothesis. also, we assume in our discussion that the available data are such that it is appropriate to perform simultaneous rank sum tests. hence, we ignore empirical issues such as insufficient power , selection bias , and like complications that, as noted by boulesteix et al. , tend to invalidate statistical inference in comparative benchmarking studies of machine learning methods solving real-world problems. in anova, the term ‘treatment’ is used as a common term for the grouping variable for which a response is measured. to accommodate the wide variety of applications of the friedman test, the more general term ‘group’ is used instead of ‘treatment’ in the remainder of this paper. the term subject is used hereafter to include both objects and individuals.

methods
friedman data
to perform the friedman test the observed data are arranged in the form of a complete two-way layout, as in table 1a, where the k rows represent the groups  and the n columns represent the blocks .table  <dig> two-way layout for friedman test




the data consist of n blocks with k observations within each block. observations in different blocks are assumed to be independent. this assumption does not apply to the k observations within a block. the test procedure remains valid despite within-block dependencies  <cit> . the friedman test statistic is defined on ranked data so unless the original raw data are integer-valued rank scores, the raw data are rank-transformed. the rank entries in table 1b are obtained by first ordering the raw data {x
ij; i =  <dig>  …, n, j =  <dig>  …, k} in table 1a column-wise from least to greatest, within each of the n blocks separately and independently, and then to assign the integers  <dig> …,k as the rank scores of the k observations within a block. the row sum of the ranks for any group j is the rank sum defined as r
j = ∑i = 1n
r
ij.

null hypothesis
the general null hypothesis of the friedman test is that all the k blocked samples, each of size n, come from identical but unspecified population distributions. to specify this null hypothesis in more detail, let x
ij denote a random variable with unknown cumulative distribution function f
ij, and let x
ij denote the realization of x
ij.

the null hypothesis can be defined in two ways, depending on whether blocks are fixed or random  <cit> . if blocks are fixed, then all the k × n measurement values are independent. if there are k groups randomly assigned to hold k unrelated x
ij within each block, as in a randomized complete block design, then the null hypothesis that the k groups have identical distributions may be formulated as


h
0 : f
i1 = … = f
ik = f
i for each i =  <dig>  …, n,

where f
i is the distribution of the observations in the ith block  <cit> . the same hypothesis, but more specific, is obtained if the usual additive model is assumed to have generated the x
ij in the two-way layout  <cit> . the additive model decomposes the total effect on the measurement value into an overall effect μ, block i effect β
i, and group j effect τ
j. if the distribution function is denoted f
ij = f, the null hypothesis of no differences among the k groups may be stated as h0:τ1=…=τk, and the general alternative hypothesis as


h1:τj1≠τj <dig> for at least one  pair.

note that this representation also asserts that the underlying distribution functions f
i <dig>  …, f
ik within block i are the same, i.e., that f
i1 = … = f
ik = f
i, for each fixed i =  <dig>  …, n.

if blocks are random, measurements from the same random block will be positively correlated. for example, if a single subject forms a block and k observations are made on the subject, possibly in randomized order, the within-block observations are dependent. such dependency occurs in a repeated measures design where n subjects are observed and each subject is tested under k conditions. denote the joint distribution function of observations within block i by f
i. then the null hypothesis of no differences among the k groups is the hypothesis of exchangeability of the random variables x
i <dig>  …, x
ik  <cit> , formulated as


h
0 : f
i = f
i, …, x
σ) for i =  <dig>  …, n,

where σ, …, σ denotes any permutation of  <dig>  …, k. the model underlying this hypothesis is that the random variables x
ij have an exchangeable distribution. this is a suitable model for repeated measures, where it is not appropriate to assume independence within a block  <cit> . we also note that this formulation of the null hypothesis and the one for fixed blocks are consistent against the same alternative, namely the negation of h
 <dig>  for a detailed discussion of this matter, see  <cit> .

whether blocks are fixed or random, if the null hypothesis is true, then all the permutations of  <dig>  …, k are equally likely. there are k ! possible ways to assign k rank scores to the k groups within each block and all these intra-block permutations are equiprobable under h
 <dig>  as the same permutation argument applies to each of the n independent blocks, there are n equally likely rank configurations of the rank scores r
ij in the two-way layout  <cit> . each of these permutations has a probability of − n of being realized. this feature is used to evaluate the null distribution of the rank sums r
j, by enumerating all the permutations of the two-way layout of ranks.

friedman test statistic
under the friedman null hypothesis, the expected row sum of ranks for each group equals n/ <dig>  the friedman test statistic xr2=12nkk+1∑j=1krj−nk+1/ <dig> sums the squared deviations of the observed rank sums for each group, r
j, from the common expected value for each group, n/ <dig>  under the assumption that the k group distributions are identical. for small values of k and n, the exact distribution of x
r <dig> has been tabled, for example, by friedman  <cit> . an algorithm for computing the exact joint distribution of the friedman rank sums under the null is discussed in  <cit> . for the special case of two paired samples, see  <cit> .

calculating the test statistic using the null distribution of the n possible permutations is time consuming if k is large. however, friedman  <cit>  showed that as n tends to infinity, x
r <dig> converges in distribution to χ
df = k −  <dig>  a chi-squared random variable with k −  <dig> degrees of freedom. this result is used in the asymptotic friedman test. the friedman test rejects h
 <dig> at a pre-specified significance level α when the test statistic x
r <dig> exceeds the 100th percentile of the limiting chi-squared distribution of x
r <dig> with k −  <dig> degrees of freedom  <cit> . the test statistic needs to be adjusted if there are tied ranks within blocks  <cit> . also, various modifications of the friedman test have been proposed, for example the f distribution as an alternative to the chi-squared distribution  <cit> , as well as generalizations, such as the skillings-mack  <cit>  test statistic for use in the presence of missing data. these and various other adjustments and nonparametric competitors to the friedman test  are not discussed here .

pairwise comparison tests and approximate critical difference
frequently, researchers are not only interested in testing the global hypothesis of the equality of groups but also, or even more so, in inference on the equality of equality of pairs of groups. further, even if one is mainly interested in h
 <dig> and the hypothesis is rejected, a follow-up analysis may be conducted to determine possible reasons for the rejection. such analysis may disclose group differences, but it might also reveal that none of the pairs is significantly different, despite a globally significant test result.

to address these issues it is expedient to test hypotheses of equality for pairs of groups using simultaneous comparison tests. these multiple comparison procedures may involve, in 1 × n  comparisons, testing k −  <dig> hypotheses of equality of all non-control groups against the study control or, in n × n  comparisons, considering k/ <dig> hypotheses of equality between all pairs of groups. for both types of comparisons, large-sample approximate tests have been designed. they are derived for the situation where n, the number of blocks , is large.

table  <dig> displays the critical difference  approximate tests for 1 × n and n × n comparisons of friedman rank sums, as recommended in highly-cited monographs and papers and popular textbooks on nonparametric statistics. the critical difference is the minimum required difference in rank sums for a pair of groups to differ at the pre-specified alpha level of significance. it is to note that in many publications the cd statistic is calculated using the difference in rank sum averages, i.e., r
j/n, rather than rank sums. the results are identical, since each group has n observations, if the test statistic formulas are modified appropriately.table  <dig> recommended critical difference  approximate tests for 1 × n and n × n comparisons of friedman rank sums

1 × n
cdn=zα/c1nkk+1/ <dig> c1=k−1

cdm=mα,df=k− <dig> ρ=12nkk+1/6

n × n
cdn=z12α/c2nkk+1/ <dig> c2=kk−1/2

cdq=qα,df=k,∞nkk+1/12=qα,df=k,∞2nkk+1/6

cdχ2=χα,df=k−12nkk+1/6

note: the constant mα,df=k− <dig> ρ= <dig> is the upper αth percentile point for the distribution of the maximum of k −  <dig> equally correlated  unit normal n random variables. the constant q
α,df = k,∞ is the upper αth percentile point of the studentized range  distribution with  degrees of freedom. the references in the right-most column are ordered by year of publication .




when the null hypothesis of equidistribution of ranks in n independent rankings is true, and the condition of a large sample size is met, the differences in rank sums are approximately normally distributed  <cit> . let d = r
i − r
j, with i ≠ j, be the rank sum difference among a pair of groups i and j. the support of rank sum difference d is the closure . under the null hypothesis, the expected value e =  <dig> and the variance var = nk/ <dig>  <cit> . as the distribution of d is symmetric around e =  <dig>  the skewness is zero, as are all odd order moments. the kurtosis coefficient, derived by whitfield  <cit>  as kurtd=3−35n−125nk−65nkk+ <dig>  is less than  <dig> , implying that the discrete rank sum difference distribution has thinner tails than the normal. notice, however, that the kurtosis tends to  <dig> with increasing n, thus a normal approximation is reasonable. this implies that d has an asymptotic n) distribution and that the normal deviate d/vard is asymptotically n.

as can be seen in table  <dig>  the normal approximate test is recommended by various authors when all groups are to be compared against each other pairwise. it is also discussed by demšar  <cit>  as a test statistic to be employed when all groups are compared with a single control. note that the normal test procedures control the familywise type-i error rate by dividing the overall level of significance α by the number of comparisons performed . there are more powerful competitors to this bonferroni-type correction available, such as the holm, hochberg, and hommel procedures. these methods to control the overall false positive error rate are not elaborated in this paper. for a tutorial in the realm of classifier comparison, see derrac et al.  <cit> .

in addition to the ordinary normal approximation, simultaneous tests have been proposed that exploit the covariance structure of the distribution of the values of differences in rank sums. whereas the n rankings are mutually independent under h
 <dig>  the rank sums and the rank sum differences are dependent and correlated as well. the correlation among the rank sum differences depends on the rank sums involved. specifically, as reported by miller  <cit> , when the null hypothesis is true corri−rj,ri−rl=12i≠j≠l 
 corri−rj,rl−rm=0i≠j≠l≠m. 


hence the correlation is zero for pairs of rank sum differences with no group in common, and  <dig>  for pairs of differences with one group in common to both differences. the number of correlated pairs decreases as k increases. for a study involving k groups, the proportion of correlated pairs equals 4/  <cit> . hence when k =  <dig>  for example, 50% of the pairs are correlated, but when k =  <dig> only 5% are correlated.

as noted in various studies , for 1 × n comparisons this correlation structure implies that, when h
 <dig> is true and n tends to infinity, the distribution of the differences between the k −  <dig> group rank sums and the control rank sum coincides with an asymptotic  -variate normal distribution with zero means. the critical difference value can therefore be approximated by the test statistic labeled cd
m in table  <dig>  where the constant mα,df=k− <dig> ρ= <dig> is the upper αth percentile point for the distribution of the maximum value of  equally correlated n random variables with common correlation ρ= <dig>  the procedure has an asymptotic familywise error rate equal to α  <cit> .

for n × n comparisons, it means that the covariance of the rank sum differences equals the covariance of the differences between k independent random variables with zero means and variances nk/ <dig>  thus, the asymptotic distribution of maxri−rj/nkk+1/ <dig> coincides with the distribution of the range  of k independent n random variables. the associated test statistic is cd
q, where the constant q
α,df = k,∞ is the upper αth percentile point of the studentized range  distribution with  degrees of freedom  <cit> . again, as the test considers the absolute difference of all k groups simultaneously, the asymptotic familywise error rate equals α  <cit> .

the friedman statistic test itself gives rise to the simultaneous test mentioned in the bottom row of table  <dig>  the null hypothesis is accepted if the difference in rank sums fails to exceed the critical value cdχ <dig>  this asymptotic chi-squared approximation is recommended in some popular textbooks, although miller  <cit>  has argued that the probability statement is not the sharpest of tests.

statistical power and alternative tests
note that the cd test statistics presented in table  <dig> do not require information about the within-block ranks as determined in the experiment. rather, the simultaneous rank tests all assume that within each block each observation is equally likely to have any available rank. when this is true, the quantity / <dig> is the variance of the within-block rankings and nk/ <dig> the variance of the difference between any two rank sums  <cit> . hence the null distribution of d in the population has zero mean and known standard deviation. this is the precise reason why the normal approximate tests use the z-score as test statistic. however, it is important to emphasize in this context that the square root of nk/ <dig> is the standard deviation of d when the overall null hypothesis is true, but not when it is false. it holds, similar to p-values, only in a particular model, i.e. h
0; a model that may or may not be true. if the null hypothesis is false, the quantity nk/ <dig> is typically an over-estimate of the variance, and this causes simultaneous tests, approximate and exact, to lose power.

there are pairwise comparison tests for friedman rank sums available that are computed on the observed rank scores rather than the rank sums. these tests, such as the rosenthal-ferguson test  <cit>  and the popular conover test  <cit> , use the t-score as test statistic. the pairwise t-tests are often more powerful than the simultaneous tests discussed above, however, there are also drawbacks. in brief, the rosenthal-ferguson test uses the observed variances and covariance of the rank scores of each individual pair of groups, to obtain a standard error of d for the test of significance of the pairwise rank sum difference. this standard error is valid whether the null hypothesis of no pairwise difference is true or not. however, next to the formal constraint of the test that n should be larger than k +  <dig>  the variance of d may be estimated poorly, as there are typically few degrees of freedom available for variance estimation in small-sample friedman test applications. moreover, the observed variances are different for each pair of groups. consequently, it does not follow from the significance of a difference of a given rank sum a from another rank sum b, that a third rank sum c, more different from a than b is, would also be significantly different. this is an unpleasant feature of the test.

the conover test estimates the standard deviation of d by computing a pooled standard error from the variances of the observed rank scores of all groups, thus increasing statistical power. the method is similar to fisher’s protected least significant difference  test, applied to rank scores. in this methodology, no adjustment for multiple testing is made to the p-values to preserve the familywise error rate at the nominal level of significance. rather, the test is protected in the sense that no pairwise comparisons are performed unless the overall test statistic is significant. as in the fisher protected lsd procedure, the conover test has the property of incorporating the observed f-value of the overall test into the inferential decision process. however, in contrast to the fisher protected lsd, which uses the observed f-value only in a 0– <dig>  manner, the conover test uses the f-value in a smooth manner when computing the lsd. that is, it has the unusual characteristic that the larger the overall test statistic, the smaller the least significant difference threshold is for declaring a rank sum difference to be significant. the duncan-waller test  <cit>  has this same characteristic, but this test advocates a bayesian approach to multiple comparisons with bayes lsd. as the comparison tests in the second stage are conditional on the result of the first stage, the nominal alpha level used in the pairwise conover test has no real probabilistic meaning in the frequentist sense. as noted by conover and iman , “since the α level of the second-stage test is usually not known, it is no longer a hypothesis test in the usual sense but rather merely a convenient yardstick for separating some treatments from others.”

exact distribution and fast p-value calculation
we present an exact test for simultaneous pairwise comparison of friedman rank sums. the exact null distribution is determined using the probability generating function method. generating functions provide an elegant way to obtain probability or frequency distributions of distribution-free test statistics  <cit> . application of the generating function method gives rise to the following theorem, the proof of which is in additional file  <dig> 


theorem 1
for n mutually independent integer-valued rankings, each with equally likely rank scores ranging from  <dig> to k, the exact probability to obtain pairwise difference d for any two rank sums equals
 pd=d;k,n=kk−1−nwd=d;k,n, 



where
 wd=d;k,n=kk−1n∑h=0nnh1kh1−kn∑i=0h∑j=0h−1j−ihihjkj−i−d+h−1kj−i−d−h 



is the number of distinct ways a rank sum difference of d can arise, with d having support on d = .

additional file  <dig> also offers a closed-form expression for the exact p-value of d.  the p-value is defined as the probability of obtaining a result at least as extreme as the one observed, given that the null hypothesis is true. it is obtained as the sum of the probabilities of all possible d, for the same k and n, that are as likely or less likely than the observed value of d under the null. the exact p-value is denoted p, and it is computed using the expression pd≥d;k,n=∑h=0nnh1kh1−kn∑i=0h∑j=0h−1j−ihihjkj−i−d+hkj−i−d−h,d=−nk− <dig> …,nk− <dig>  


calculating the exact p-value with this triple summation expression provides a speed-up of orders of magnitude over complete enumeration of all possible outcomes and their probabilities by a brute-force permutation approach. for larger values of n, however, exact calculation is somewhat time-consuming and to extend the practical range for performing exact tests, it is desirable to compute the p-value more efficiently.

also, because in practice multiple comparison tests are concerned with absolute differences, it is expedient to compute the cumulative probability of the absolute value of differences in rank sums. as the number of mass points of the symmetric distribution of d is an integer of the form 2n +  <dig>  the distribution has an odd number of probabilities. this implies that, as the probability mass function of d is symmetric around zero, the probability mass to the left of d =  <dig> may be folded over, resulting in a folded distribution of non-negative d. consequently, the one-sided p-value of non-negative d in the range d =  <dig>  …, n may be obtained as the sum of the two one-sided p-values of the symmetric distribution with support d = . as doubling the one-sided p-value leads to a p-value for d =  <dig> that exceeds unity, the p-value for d =  <dig>  is computed as p = p + p, and this is exactly equal to  <dig> 

to accelerate computation, we transform the double summation over the indices i and j in the expression for p to a summation over a single index, s say, using theorem  <dig>  the proof is given in additional file  <dig> 


theorem 2
for nonnegative integers d and k
 ∑i=0h∑j=0h−1j−ihihjkj−i−d+hkj−i−d−h=∑s=0h−1s2hh+sks−d+hks−d−h. 


this reduction to a singly-sum function implies that the p-value can alternatively be calculated from the much simpler expression pd≥|d|;k,n=2∑h=0nnh1kh1−kn∑s=0h−1s2hh+sks−d+hks−d−h,d= <dig> …,nk−11d= <dig>  and, as we will show, even for larger values of n in a computationally fast manner.

software implementation
although the two expressions for the exact p-value are mathematically correct, straightforward computation may produce calculation errors. even for moderate values of n , the binomial coefficient that has d in the indices may become extremely large and storing these numbers for subsequent multiplication creates numerical overflow due to the precision limitation of fixed-precision arithmetic. one way to address this failure is to use a recurrence relation that satisfies the generating function  <cit> . the recursions we examined were all computationally expensive to run, however, except for small values of n and/or k. a faster way to compute the exact p-value correctly is to use arbitrary-precision arithmetic computation to deal with numbers that can be of arbitrary large size, limited only by the available computer memory.

the calculation of the p-value of the absolute rank sum difference d given k and n is implemented in r  <cit> . the r code, which requires the package rmpfr  <cit>  for high precision arithmetic to be installed, is in additional file  <dig>  the script labeled pexactfrsd computes the exact p-value p, and additionally affords the possibility to compute the probability p, and the  number of compositions of d  and w). the r code and potential future updates are also available at http://www.ru.nl/publish/pages/726696/friedmanrsd.zip.

to illustrate the derivations, additional file  <dig> offers a small-sized numerical example , and additional file  <dig> tabulates the number of compositions of d for combinations of k = n =  <dig> …, <dig>  for inclusion in the oeis  <cit> . as can be seen in additional file  <dig>  for small values of n the unfolded, symmetric distribution of d is bimodal, with modes at +  <dig> and −  <dig>  <cit> . this feature rapidly disappears as n increases, specifically, for k >  <dig> at n ≥  <dig> 

hereafter, unless otherwise stated, we will consider the value of rank sum difference d to be either zero or positive, ranging from  <dig> to n, and thus drop the absolute value symbol around d.

incomplete rankings
because the n rankings { <dig> ,…,k} are mutually independent, we may divide them into two , equal or unequal sized parts, labeled  and , with ∑t = 12
d
t = d, and d
t denoting the differences in rank sums of the two parts. the exact p-value can be obtained using pd≥d;k,n=pd≥d;k,n <dig> n2=∑i=−n1k−1n1k−1pd1=i;k,n1×pd2≥d−i;k,n <dig>  where – as indicated by the summation’s lower bound – calculation is performed using the p-value expression that allows for negative d. a unique and useful property of the exact method, which is not shared by the approximate methods discussed, is that it is easy to calculate p-value probabilities for designs with unequal block sizes k; e.g., designs in which n
 <dig> has ranks { <dig>   <dig>  …, k
1}, and n
 <dig> ranks { <dig>   <dig>  …, k
2}, with k
1 ≠ k
 <dig>  a general expression for calculating the exact p-value in incomplete designs with j unequal sized parts is pd≥d;k <dig> n <dig> k <dig> n <dig> ⋯,kj,nj=∑i1=−n1k1−1n1k1−1∑i2=−n2k2−1n2k2−1⋯∑ij−1=−nj−1kj−1−1nj−1kj−1−1pd1=i1;k <dig> n1×pd2=i2;k <dig> n2×⋯×pdj−1=ij−1;kj− <dig> nj−1×pdj≥d−i1−i2⋯−ij−1;kj,nj, where ∑t = 1j
d
t = d, and an example in which n is subdivided into three parts, each with a unique value of k , is pd≥d;k <dig> n <dig> k <dig> n <dig> k <dig> n3=∑i=−n1k1−1n1k1−1∑j=−n2k2−1n2k2−1pd1=i;k <dig> n1×pd2=j;k <dig> n2×pd3≥d−i−j;k <dig> n <dig>  


although the sum functions slow down calculation, this unique feature of exact p-value computation enables one to conduct valid simultaneous significance tests whenever some within-block ranks are missing by design. such tests would be hard to accomplish using one of the large-sample approximation methods. an empirical example will be given in the application section.

exact and mid p-values
as pairwise differences with support on d =  are symmetrically distributed around zero under h
 <dig>  doubling one-sided p-value is the most natural and popular choice for an ordinary exact test. a test using exact p-value guarantees that the probability of committing a type-i error does not exceed the nominal level of significance. however, as the type-i error rate is always below the nominal level, a significance test with exact p-value is a conservative approach to testing, especially if the test involves a highly discrete distribution  <cit> . the mid p-value, commonly defined as half the probability of an observed statistic plus the probability of more extreme values, i.e., pmidd≥d;k,n=12pd=d+pd>d, ameliorates this problem. the mid p-value is always closer to the nominal level than the exact p-value, at the expense of occasionally exceeding the nominal size.

tied rankings
the mid p-value may also be used to handle tied rankings. when ties occur within blocks, the midrank  is commonly assigned to each tied value. if, as a result of tied ranks, the observed rank sum difference is an integer value d plus  <dig> , the p-value may be obtained as the average of the exact p-values of the adjacent integers d and d +  <dig>  i.e., 12pd≥d+pd≥d+ <dig>  and this is equivalent to the mid p-value. it is to note that the resulting probability is not exactly valid. exact p-values represent exact frequency probabilities of certain events, and mid p-values have no such frequency interpretation. it may be argued, however, that this interpretational disadvantage is of little practical concern and that using mid p-values is an almost exact frequency approach. for a discussion of other treatments of ties in rank tests, see  <cit> .

RESULTS
time performance
the r program computes the exact p-value p at a fast speed. it takes about half a second, for example, to calculate the exact p-value for the rather demanding problem d = k = n =  <dig>  on a hp desktop computer using the interpreted r language running under windows  <dig> with an intel core i <dig> processor at  <dig> ghz. to examine the effects of d, k and n on the algorithm’s runtime, we measured the time it takes to calculate the exact p-value of d =  <dig> and d = n −  <dig>  for n =  <dig>  …,  <dig>  and k =  <dig> and k =  <dig>  the two support values next to the endpoints of the distribution were taken as the p-values of the lower and upper support boundaries can be trivially obtained as  <dig> and 2{k}− n, respectively. the computation time  is shown in fig.  <dig> fig.  <dig> computational time. time  for calculating the exact p-value of d =  <dig> and d = k −  <dig>  for n =  <dig>  …,  <dig> and k =  <dig>  and k =  <dig> 




the figure indicates that running time is no limitation when it comes to calculating the exact p-value, even for larger problems. computation time is moderately affected by the magnitude of the computed p-value. the smaller the p-value is, the faster the computation speed. for rank sum difference d =  <dig> running time increases polynomially  with increasing n, and for d = n −  <dig> it increases virtually linearly. also, for d =  <dig>  the minor runtime difference between k =  <dig> and k =  <dig> increases slowly with increase in value of n. for d = n −  <dig> the time to do the calculation is essentially the same for k =  <dig> as for k =  <dig>  in sum, these timing results show that the exact method admits an algorithm that is fast for all k and n values typically encountered in empirical studies testing differences in friedman rank sums, such as those comparing classifiers. this quality makes the algorithm for exact calculation appealing, compared to alternative asymptotic approximations. indeed, the algorithm is  faster than the one used here for evaluating the multivariate normal-approximate critical difference .

exact distribution examples
we present some examples to illustrate the frequency probability distribution of rank sum difference d. the left panel of fig. 2a displays the mass point probabilities p for k =  <dig> and n =  <dig>  over the entire support interval d = . the right panel shows the exact p-values p for k = n =  <dig>  i.e., the tail-probability at and beyond the value of d. the steps in the  probability distributions are due to the discreteness of d, implying that events are concentrated at a few mass points. to adjust the p-values for discreteness, one might opt to obtain mid p-values. the mid p-value is less than the exact p-value by half the mass point probability of the observed result, and it behaves more like the p-value for a test statistic with a continuous distribution.fig.  <dig> distribution of exact mass point probabilities and exact p-values. a exact mass point probabilities, and exact p-values, for k = n =  <dig>   exact p-values, and log10-transformed exact  and normal approximate p-values , for k = n =  <dig>   histogram of simulated p-values under the overall null hypothesis with expected null frequency superimposed, and cumulative distribution function of the simulated 1 − p-values with diagonal line overlay, for k =  <dig>  n =  <dig> 




the jumps at the steps decrease with increase in value of k and/or n. to exemplify this point, the left panel of fig. 2b displays the less discrete p-value distribution for k = n =  <dig>  the powerful benefit of exact calculation is shown in the right panel of the same figure. the graph displays the log10-transformed p-values obtained by exact calculation, with the cumulative normal density superimposed. as can be seen, the continuous normal is imperfect for estimating probabilities in the long right tail, where d values are large and p-values are small. note that the error increases as the p-values decline. compared to exact calculation, the cumulative normal is overly conservative in that it tends to over-predict the true p-value and thus understate the evidence against the null.

for continuous test statistics, p-values are known to be uniformly distributed over the interval  <cit>  when the null hypothesis is true  <cit> . also, uniformly distributed p-values, with a mean of  <dig>  and a variance of 1/12 ≈  <dig> , produce a linear cumulative distribution function corresponding to the true overall null hypothesis, implying that points in the cumulative p-value plot exhibit a straight line. we generated n =  <dig> monte carlo permutations of k =  <dig> integers from  <dig> to k inclusive, and calculated the rank sums and the exact p-value of the rank sum differences. for this particular set of permutations, the mean of the  =  <dig>   <dig> p-values was  <dig>  and the variance  <dig> . the left panel of fig. 2c confirms the intuitive notion that the discrete p-values are approximately uniformly distributed under h
 <dig>  the right panel plots the 1 − p-value against the number of p-values , expressed in terms of proportions. as can be seen, the ensemble of p-values in the cumulative plot is close to the diagonal line, as is to be expected when null hypotheses are all true.

exact versus approximate critical differences
table  <dig> presents the unadjusted and the bonferroni-adjusted exact and approximate critical differences for 1 × n and n × n comparisons of friedman rank sums, for n = k =  <dig> , <dig> , <dig>  at the familywise error rate of α=. <dig>  the values for cd
m were obtained using the r package mvtnorm  <cit> , and the other approximate values using standard distributions available in the r stats package  <cit> .table  <dig> exact  and approximate critical values of differences in rank sums, at the familywise error rate of α=.05


k
n

cd
cd
n
cd
cd
n
cd
m
cd
cd
n
cd
q
cd
χ
2
141
376
531
1019
1441

note: the tabled values satisfy the relation p <. <dig>  for presentational purposes, the approximate critical differences were rounded up to the smallest integer that is not less than the calculated value. italicized figures in the right-most column represent critical differences exceeding the maximum value of d, denoted max, implying that none of the rank sum differences is significant at the α=. <dig> level




the first point to note from table  <dig> is that, at the . <dig> level, the unadjusted normal-approximate critical differences  are identical to the exact cd for almost all k and n. in the event one chooses not to control the familywise error rate, the underestimation by cd
n amounts to  <dig> at most, at least for the values of k and n considered here.

the close correspondence of normal-approximate and exact cd deteriorates once the p-value threshold for significance is corrected for multiple testing. in 1 × n comparisons, the agreement is quite satisfactory as long as k is small relative to n, but the normal method overestimates the exact critical value if k is larger than n. the same goes for n × n comparisons, but worse. as can be seen, the normal approximation generally improves as n gets larger, for constant value of k, supporting large-sample normal theory. however, the normal method overestimates the exact critical value considerably if k is larger than n. the disparity is most pronounced if k is large and n is small. for example, for k =  <dig> and n =  <dig>  the exact cd is  <dig>  whereas the  normal approximate critical difference value equals  <dig>  the normal approximation produces larger than exact p-values at the tails and larger than exact critical difference values.

the second point to note is that the ordinary normal method – while understating the evidence against the null hypothesis – is, by and large, the most accurate approximate test of the asymptotic variants studied here. the cd
m for k −  <dig> comparisons with a control tends to underestimate the exact cd, even if n is large, which may lead one to incorrectly reject the null hypothesis. the same goes, but somewhat less so, for all-pairs comparisons with cd
q. the studentized range critical value is seen to be too liberal in the sense that it underestimates the critical difference value, even for larger values of n, and especially if n outnumbers k. the asymptotic procedure that draws on the chi-squared distribution is seen to perform inadequately overall. as the inferences are suspect, this test statistic is not advocated as a criterion for judging whether differences in friedman rank sums are significant.

hence, in general, the normal approximation is overly conservative if n is smaller than k and the other approximations are too liberal if n is larger than k, and this holds even for relatively large values of n. for many parameter settings the biases are considerable. in any case, they are large enough to imply that if the observed rank sum difference is near to the critical value, the choice between exact and approximate methods can mean the difference between pairs of groups being considered significantly different or not. it is equally important to note that the above results apply to a familywise error rate of α=. <dig>  the disparity between exact and asymptotic critical values increases, if the error rate is set to a lower value . this issue is well visualized in the right panel of the earlier discussed fig. 2b.

type-i error and mid p-values
the critical difference values denoted cd in table  <dig> were obtained by setting the bound on type-i error at 5%. for the asymptotic approximate methods, with a continuous reference distribution, the maximum probability of rejecting the null when it is in fact true is equal to α=. <dig>  an exact test, however, keeps the actual probability of a type-i error below 5%, as there are only certain p-values possible when working with discrete data. table  <dig> reports the actual probability of a type-i error  and the mid p-value, for the unadjusted exact cd values presented in table  <dig> .table  <dig> exact and mid p-values for unadjusted exact cd values


k
n
k
n
k
n
.0521
.0543
.0513
.0512
.0503
.0509
.0501

note: bold figures indicate mid p-values exceeding the nominal level of α=. <dig> 




note that, whereas the alpha level was set at 5%, the actual probability of a type-i error for the smallest n = k =  <dig> is a little above 3%. for larger values of k and n the ordinary exact test appears only slightly more conservative than the nominal level. note further that the mid p-value minimizes the discrepancy between the exact p-value and the significance level. the mid p-value occasionally exceeds the nominal level, and still tends to somewhat underrate the nominal in other instances, although necessarily less so than using the exact p-value. as can be seen, the difference between exact and mid p-value diminishes as k and/or n increases and the discreteness of the sample distribution diminishes.

we emphasize in this context that the inferential conservativeness associated with exact p-values is introduced by testing at a pre-specified alpha level of significance. in practice, it might be preferable to report observed levels of significance rather than testing at a particular cut-off value.

normal error and continuity correction
because the discrete rank sum difference distribution is approximated by a continuous distribution, a correction for continuity is advocated by some , to bring the asymptotic probabilities into closer agreement with the exact discrete probabilities. we restrict the discussion to the normal approximation and calculate the percentage relative error of the normal p-values to the true p-values using rd=100pnormald−c−pexactdpexactd, where c is equal to  <dig>  or  <dig> for the normal method with or without continuity correction, respectively. figure  <dig> displays the percentage relative error r versus exact p-values, for n = k =  <dig> .fig.  <dig> error normal approximation. percentage relative error r of normal approximation with  and without  continuity correction versus exact p-value, for n = k =  <dig> 




the graphics indicate that the relative error decreases with increasing n, both for k =  <dig> and k =  <dig>  they also show that, for k =  <dig> and n =  <dig> , the normal approximation without continuity correction underestimates the true p-value if the exact probabilities are large. however, small true p-values are overestimated by the normal and this overestimation increases as the probabilities become smaller. continuity correction brings large normal p-values into closer correspondence with the exact p-values, but for small p-values  it may worsen agreement and increase overestimation by the normal. for k =  <dig>  the rank sum difference distribution is less discrete and therefore correction for continuity has little effect. this suggests that the neglect of the continuity correction is not a serious matter, and may, indeed, occasionally be an advantage.

finally, as indicated, the large-sample approximations are derived for the situation where n is large. frequently, however, the number of groups may be quite large whereas the number of replications per group is limited  <cit> . such ‘large k, small n’ situation is fairly common in agricultural screening trials  <cit>  for example, and it also occurs quite often in comparisons of classifiers using ranked data. published examples in bioinformatics include classifier studies with dimensions k =  <dig> and n =  <dig>  <cit> , k =  <dig> and n =  <dig>  <cit> , and k =  <dig> and n =  <dig>  <cit> . a similar issue arises in the identification of k genes by ranking using n different algorithms, for example, k =  <dig> and n =  <dig> as in  <cit> , and k =  <dig> and n =  <dig> as in  <cit> . such ‘large k, small n’ data are common in gene-expression profiling studies  <cit> . particularly for these data conditions, the choice of an appropriate test statistic is vitally important to the validity of research inferences.

application
we present two data examples to illustrate potential non-equivalence of exact and approximate inference, and the benefit of exact calculation. recall that we assume that the data are such that it is appropriate to perform the friedman test. we pass no judgement on this, as that would require expertise in the substantive fields and detailed ‘in-house’ knowledge of selection and measurement procedures. for a proper statistical framework for comparison studies see boulesteix et al.  <cit> . this review study also shows that real-world applications comparing classifiers are often underpowered. that is, in small-sample settings the differences between the performances of pairs of algorithms are sometimes so variable that one is unable to draw statistically meaningful conclusions.

to illustrate the benefit of exact calculation, friedman rank data on the comparison of qpcr curve analysis methods were obtained from ruijter et al.  <cit> . the aim of the comparison of the k =  <dig> methods was to test their performance in terms of the following  indicators: bias, linearity, precision, and resolution in transcriptional biomarker identification. the null hypothesis is that there is no preferred ranking of the method results per gene for the performance parameters analyzed. the rank scores were obtained by averaging results across a large set of  <dig> genes in a biomarker data file.

table  <dig> displays the friedman rank sums of the methods and, in the upper top triangle, the absolute values of the differences in rank sums. we obtained the bonferroni-adjusted normal-approximate p-value, bonferroni-adjusted exact p-value, and studentized range approximate p-value for the  <dig> rank sum differences. the results are presented in the upper bottom, lower bottom, and lower top triangles of the table, respectively.table  <dig> friedman rank data for k =  <dig> methods and n =  <dig> performance indicators 

 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 
 <dig> 

note: the upper top triangle displays the rank sum differences, upper bottom triangle the bonferroni-adjusted normal approximate p-values, lower bottom triangle the bonferroni-adjusted exact p-values, and lower top triangle the studentized range approximate p-values. bold figures indicate p-values ≤ .05




straightforward comparison shows that the approximations are conservative estimates of the true probabilities. that is, the smallest exact p-values are considerably smaller than both the normal and the studentized range approximate p-values. according to the normal approximate test there is, at a familywise error rate of . <dig>  no evidence that the methods perform differently, except for cy <dig> and fpf-pcr, the pair of methods with the largest difference in rank sums. when applying the studentized range distribution we find a rank sum difference of d =  <dig> or larger to be significant. the true p-values are smaller however, and exact calculation provides evidence that the critical difference value at α=. <dig> is d =  <dig>  implying that four pairs of methods perform significantly different. this example illustrates the practical implication of using exact p-values in the sense that exact calculation uncovers more significantly different pairs of methods than the asymptotic approximations, and may thus lead to different conclusions.

we were reminded by the reviewers of this paper that the friedman test assumes that the n blocks are independent, so that the measurement in one block has no influence on the measurements in any other block. this leads to questioning the appropriateness of the friedman test in this application. we do not wish to make any firm judgement about this, other than making the observation that the rank scores presented in the source paper  are strongly related. the same goes for the results of a similar analysis of much the same data by other researchers .

the second illustration concerns exact calculation in incomplete designs. zagar et al.  <cit>  investigated the utility of k =  <dig> data transformation approaches and their predictive accuracy in a systematic evaluation on n =  <dig> cell differentiation datasets from different species  retrieved from the gene expression omnibus. to compare the predictive accuracy performance of the k =  <dig> methods on the n =  <dig> datasets, they used the friedman test. table  <dig> presents the friedman ranks obtained by ranking the raw scores presented in table  <dig> of zagar et al.  <cit> .table  <dig> friedman rank data for k =  <dig> methods and n =  <dig> cell differentiation datasets 

d
k
n
k
1
n
1
k
2
n
2
 <dig> 
 <dig> 
 <dig> 

note: bold figures indicate p-values ≤ .05




note that the ranks of pathrecon and pca-markers for dataset gds <dig> are missing. zagar et al.  <cit>  therefore decided to exclude all ranks within gds <dig> from the computation of the rank sums and restricted their analysis to n =  <dig> datasets. the rank sums excluding gds <dig> are displayed in the right-most column of table  <dig> 

instead of deleting gds <dig>  the missing data for pathrecon and pca-markers could be dealt with by substitution, for example by imputing the mean of the observed raw scores, followed by re-ranking the  <dig> methods according to their scores on gds <dig>  however, as noted by the authors, the score of pca-markers for gds <dig> is not given because “stem cell differentiation markers are not relevant for the process studied in this dataset” . hence the rank score is missing by design, and thus imputation is inappropriate at least for the pca-markers method.

an alternative procedure is to divide the n =  <dig> independent ranking into two different parts, one consisting of k =  <dig> methods and n =  <dig> datasets and the other one having k =  <dig> methods and n =  <dig> dataset. the computation of exact p-values in such incomplete design is readily accomplished, since the probabilities are easily obtained by the method outlined above. these p-values afford the possibility to conduct valid significance tests using all available rank data.

the bottom part of table  <dig> presents the exact p-values obtained for the comparison of the mce-euclid-fc and the pls-area-time methods. additional file  <dig> has the r code to reproduce the results. the next-to-last row displays the exact p-values for the difference d =  <dig> in rank sums, if the ranks for gds <dig> are not included in the sums. the bottom row shows the exact p-values for the rank sums difference d =  <dig> if the two rank sums include the available ranks of the methods for gds <dig>  note that for this particular comparison at least, the latter p-values, whether adjusted or not, are considerable smaller than the p-values obtained after listwise deletion of missing rank data.

the p-value probabilities pertaining to difference of sums of all available rank data can also be estimated using permutation testing and most likely also with methodology such as laplace approximation or the saddlepoint method. however, these stochastic and deterministic approximations tend to become rather complicated and more cumbersome to work with than the exact computation method described here.

CONCLUSIONS
we provide a combinatorial exact expression for obtaining the probability distribution of the discrete rank sum difference statistic for pairwise comparison of friedman rank sums. the exact null distribution contributes to the improvement of tests of significance in the comparison of friedman rank sums, and constitutes a framework for validating theoretical approximations to the true distribution. the numerical evaluations show that, in multiple comparison testing, determining the exact critical difference and the true p-value offers a considerable improvement over large-sample approximations in obtaining significance thresholds and achieved levels of significance. the empirical applications discussed exemplify the benefit, in practice, of using exact rather than asymptotic p-values.

of the large-sample approximation methods considered in this study, the simple normal approximation corresponds most closely to the exact results, both for many-one and all-pairs comparisons. however, the difference between exact and normal approximate p-values can be large for significant events further in the tail of the distribution. such events occur, in particular, whenever the number of groups k is large and the number of blocks n is small. in a multiple testing context with ‘large k and small n’, application of the normal approximation increases the probability of a type-ii error, hence false acceptance of the null hypothesis of ‘no difference’. the exact p-values also greatly improve the ability to detect significant differences if the observed rank sum differences are close to the approximate critical value. in such situation, the choice between exact and approximate methods can mean the difference between pairs  being considered significantly different or not. further, we typically prefer tests that are as accurate as possible while still being fast to compute. as the exact p-values can be computed swiftly by the method outlined in this note, there is no longer need to resort to occasionally flawed approximations.

finally, the rank sum and rank product statistics are widely used in molecular profiling to identify differentially expressed molecules   <cit> . molecule selection by ranking is important because only a limited number of candidate molecules can usually be followed up in the biological downstream analysis for subsequent study. the non-parametric statistic discussed here is potentially an additional new tool in the toolbox of methods for making justified, reproducible decisions about which molecules to consider as significantly differentially expressed.

additional files

additional file 1: proof of theorem  <dig>  


additional file 2: proof of theorem  <dig>  


additional file 3: friedmanrsd. a.zip file providing the script of the algorithm implemented in r. 


additional file 4: numerical example for k =  <dig>  n =  <dig>  


additional file 5: number of compositions of d for k,n =  <dig> …, <dig>  


additional file 6: computation of p-values presented in table  <dig>  a.zip file providing the r code to reproduce the exact p-values presented in table  <dig>  




abbreviations
cdcritical difference

lsdleast significant difference


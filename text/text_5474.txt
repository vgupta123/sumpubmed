BACKGROUND
the development of the live-cell imaging microscopy and fluorescent tagging provides us unprecedented opportunity to observe gene expression, nuclei movement and nuclei division processes during embryogenesis at the single cell level  <cit> . customized algorithms were developed using high temporal resolution of image stacks to automatically trace cell divisions during animal development.

one system named starrynite has been developed for automated cell lineage tracing and gene expression profiling during c.elegans embryogenesis  <cit> . a lineage tree can be generated with starrynite automatically based on the 3d time-lapse image of a developing c. elegans embryo. to obtain cell nuclei with high signal/noise ratio, the c. elegans embryos are first tagged with a fluorescent protein. then the authors took images every  <dig> or 90 seconds with a confocal microscope during c. elegans embryogenesis. at every time point there are  <dig> image planes and the resolution in the z-axis is  <dig>  microns. a complete 3d time-lapse image series contains 180– <dig> time points when the cell number of the embryo is over  <dig>  so there are over  <dig> images in a single image series, which record approximately  <dig> cell divisions and  <dig> nuclei at different time points. with these images as input to starrynite system, information on reporter expression, nucleus division and movement can be efficiently extracted from a huge mass of image data. .

however, due to the low resolution in the z-axis and high noise in the 3d time-lapse image of c. elegans, starrynite/matlab starrynite output suffers from high error rate especially during late embryogenesis. it takes around 2– <dig> human hours for manually annotating starrynite’s output up to  <dig> cell stage, but for most cells, at least one division process cannot be correctly traced in this kind of lineage tree  <cit> .

starrynite/matlab starrynite can be generally divided into two parts, namely, the nuclei segmentation part and the tracing part. the nuclei segmentation part will analyze the 3d time-lapse images of c. elegans and detect the nuclei positions, size and intensity at every time point. then the tracing part will build the lineage tree according to the nuclei information generated by the nuclei segmentation part. the main reason for starrynite/matlab starrynite not being able to reach the  <dig> cell stage, with an acceptable error rate, is that too many cells could not be detected by the nuclei segmentation algorithm that works relatively well at or before the  <dig> cell stage. in fact, the detection accuracy of the nuclei segmentation part in starrynite can only work for up to  <dig> cells at any one single time point . therefore at the end of embryogenesis , more than  <dig> cells cannot be detected correctly. therefore, for every 3d image data set, even if the tracing part is error free, the number of errors would still be more than  <dig>  which means that one to two weeks of manual editing time are needed for generation of a 550-celled lineage. therefore, development of a novel or optimization of the existing nuclei segmentation algorithm is the key to speed up the automatic lineaging throughout c. elegans embryogenesis.

in order to improve the performance of starrynite, several techniques have been developed and implemented into starrynite. santella et al.  <cit>  presents a blob-slice nuclei segmentation model to improve the correct nuclei detection rate and this model can be also used to analyze 3d images of other species, such as zebrafish and drosopila  <cit> . aydin builds a new tracing system with a svm classifier, which could greatly reduce the number of false positive errors that can be detrimental during the editing of the lineage tree  <cit> . richards et al.  <cit>  increase the 3d time-lapse image resolution in the z-axis with a resonance-scanning confocal microscope  <cit> . in his work, the lineage tree generated by matlab starrynite with these new images could reach the  <dig> cell stage with manual editing. in all the above-mentioned methods, the 3d local maximum is a must for the nuclei segmentation, based on the principle that one particular 3d local maximum point in images corresponds to a certain nucleus. however, as the number of images increases, nuclei at the top of the embryo will be flattened and crowded. consequently, one 3d local maximum point in images at this stage cannot always indicate one nucleus but two  nuclei. besides, in 3d local maximum, there are several other techniques available for 3d nuclei segmentation such as adaptive thresholds,  <cit>  mode finding,  <cit>  gradient flow tracking,  <cit>  watershed  <cit>  and level set methods  <cit> . these methods perform well when nuclei are widely spaced, but given conditions in which nuclei are crowded, as in the low resolution along the z axis in the 3d image, all these methods show some disfigurement to various degrees.

judging from these aspects, we speculate that under certain circumstances, all the above methods have difficulty in finding certain nuclei at some time points due to the low image quality. in view of this issue, we develop a technique called bi-directional prediction to reduce false negative errors and improve the precision and accuracy of nuclei segmentation. due to the minimum position shift of a nucleus between two adjacent time points, if there is a nucleus that can hardly be detected based on the image of one single time point, we can predict it by studying the images before and after the current time point.

in this paper, a new nuclei segmentation method is attempted to substitute that for starrynite, which enables a more accurate extraction of useful information from 3d time-lapse images. the results achieved by our new nuclei segmentation method demonstrate better performance in nuclei segmentation and reduced false negative errors. currently, editing a lineage up to  <dig> or  <dig> cell stage requires roughly  <dig>  or 8 hours respectively using our image series.

result
error rate analysis
the error statistics of the starrynite/matlab starrynite results of two data sets  are studied in our work. as shown in table  <dig>  errors produced by starrynite can be divided into two categories:  nuclei segmentation errors,  tracing errors.

081505: 1– <dig> time points ,

130108pha4p <dig> and 130108nhr25p1: 1– <dig> time points .

the main source of nuclei segmentation errors includes failure to identify nuclei , misjudgments of non-existent nuclei , false diameter errors and dislocation errors. as illustrated in table  <dig>  false negative errors are the most common errors in the starrynite/matlab starrynite output. what is more important is that nuclei segmentation errors will propagate to tracing errors. in fact, the majority of tracing errors in the starrynite/matlab starrynite output which do not detect matching errors and false division identification errors, are caused by nuclei segmentation errors like dislocations or false diameters. according to the above analysis, it is the nuclei segmentation errors, especially the false negative errors, that become the biggest stumbling barrier in using the starrynite/matlab starrynite system. for this reason we have built a new nuclei segmentation system which focuses on eliminating false negative errors.

there are three reasons why the multiplication of false negative errors occurs at the end of the embryonic development. first, the image resolution in the z-axis is  <dig>  microns, which means that one small nucleus  can be clearly seen in only two images. second, the increase in nuclei numbers makes the nuclei at the top of the embryos become flattened and crowded to such an extent that they are not always recovered by the iterative nuclei identification. <dig> this crowding becomes a significant source of errors after the 150-cell stage, when the nuclei first enter the very top of the embryo. third, neighboring cells may have different levels of gfp expression. when two nuclei are close to each other, the local signal density of the weaker one may blend into the edge of the high signal from the brighter one and, thus, no longer obey the rule of local maximum. accordingly, we designed our nuclei segmentation system for the purpose of avoiding false negative errors from the above three original sources of error formation.

algorithm design
figure  <dig> provides a flow of our method, which can be divided into five main steps.

step1: pre-processing with level-set method 
there are several limitations in the 3d time-lapse images of c. elegans embryo: first, the image resolution in the z-axis is  <dig>  microns, while the diameter of some nuclei at the  <dig> cell stage is around  <dig>  microns, so each of these small nuclei can only be mapped in one or two images. these defects cause extraordinary difficulties in nuclei detection. second, the gfp expression of some nuclei are quite low, so distinguishing the noises of the original images from a low gfp expression signal is a major issue. third, the nuclei boundaries are not clear, because of the crowed nuclei at the  <dig> cell stage, thus a boundary enhancement method is needed for an accurate segmentation. in our work we overcome the above difficulties by pre-processing the images with the level-set method before segmentation.

the level-set method is a numerical technique for tracking interfaces and shapes, it can also be applied to smooth an image under the its curvature. figure  <dig> shows the pre-processing method we use. as can be seen from the results shown in figure  <dig>  the level-set method can filter out noises existing in original images. it can also sharpen nuclei edges at the same time. after preprocessing with the level-set method, the images can be segmented with a region growing method. by using the level-set method we can obtain a predicted image between each pair of adjacent images, the total number of images in one single time point is increased from  <dig> to  <dig>  thus we could generate more slices for nuclei detection.

we then test the new image series and compare with the original starrynite. the results indicate that the number of errors generated by starrynite has shown an appreciable decrease after level-set processing . 

130108pha4p <dig> and 130108nhr25p1: 190– <dig> time points .

step2: 2d segmentation using the modified region growing method
in order to use the region growing method, the first and foremost step is to predetermine the initial ‘seed’ points, each of which will then grow into one 2d nuclei slice after being processed by a region growing algorithm. the method we use to search seed points is the 2d local maximization algorithm. following our goal of obtaining precise segmentation of nucleus slices, we improve the design of the region growing algorithm in our nuclei segmentation system, so that it can perform well even under the condition in which the nuclei are crowded together. the traditional region growing algorithm is an iterative process, in which neighboring pixels of initial “seed points” are examined and one fixed threshold is used to determine whether the pixel neighbors should be added to a certain region. in our modified region growing method, the value of the threshold is determined by the distance between each pixel and seed point respectively, as a precaution against nuclei with lower expression values being overshadowed by brighter neighboring ones when they are overcrowded.

according to the nuclei diameter  and the image resolution in the z-axis , every nuclei will correspond to 4– <dig> 2d nuclei slices, so even if some 2d nuclei slices of one nucleus cannot be recognized in some z-planes, we can still identify them by the 2d local maximum points in the other z-plane images. however, starrynite/matlab starrynite uses only the method in which each 3d local maximum point is considered as one nucleus, therefore, one nucleus will be left out in the case where the corresponding 3d local maximum point is omitted. thus it can be said in this sense that our method based on 2d nuclei slices is fault tolerant, which can reduce the false negative errors significantly.

step3: nuclei generation
santella et al.  <cit>  also developed a nuclei segmentation method based on 2d slices, but their method still requires 3d local maximum points as indicators for nuclei determination. however, given the above analysis, the 3d local maximum point is not error free especially after the  <dig> cell stage. hence, there are still many nuclei not being captured in the starrynite/matlab starrynite output. our method avoids this weakness of the 3d local maximization algorithm and identifies nuclei only by analyzing the features of the 2d slices. if one 2d slice is positioned in one nucleus center, this slice can be called a center slice, and each nucleus has only one center slice. therefore after obtaining all the center slices at different time points, we will finally get the positions of all nuclei at different time points correspondingly. we use a modified gradient method to recognize all the center slices, as shown in figure  <dig> 

if one slice’s z-axial gradient of gray value conforms to the following equation, it will be chosen as one nuclei center slice.

  gz+1n< <dig>  

  gz-1n< <dig>  

  gzn<gz‒1n, 

  gzn<gz+1n, 

where gzn is the mean gradient of slice n on image z, and gz‒1n is the mean gradient of slice n on image z- <dig>  the z-axial position of which is located just below image z.

due to the fact that the center slices contain data of the center position of each nucleus, we can work out which of the remaining slices are the constituent parts of one certain nucleus by calculating distances between the remaining slices and each center slice respectively. each nucleus turns out to be composed of 4– <dig> slices in this case and information about exact position, radius, volume and brightness of every nucleus is achieved through this procedure.

step4: bi-directional prediction
after step  <dig>  owing to the poor quality and low z-axial resolution of images, some nuclei segmentation errors especially the false negative errors surface inevitably if we do nuclei segmentation based only on images of one single time point. during the process of embryogenesis, every new nucleus in the lineage tree comes from cell division. these new nuclei will divide into other new nuclei or die, in other words, the same nuclei may not be captured via single-time images. further, the shift distance of every nucleus between two adjacent time points is very short, and the nuclei size will not change much within short-time intervals, so we can refer to the image before or after the current time point to forecast a nucleus in order to avoid the failure of capturing it at one single time point. this process effectively decreases the emergence of false negative errors. considering the possibility that one nucleus may divide into two nuclei during embryogenesis, a bi-directional prediction instead of only a forward or backward prediction is necessary and effective in nuclei prediction.

in order to achieve this bi-directional prediction, a score function is established to compute the degree of dissimilarity between two nuclei at two adjacent time points. in our score function, two aspects are considered: shift distance and nuclei volume.

  dsab=d <dig> ×ra+rb+vavb- <dig> , 

where a and b are the symbolic representation of the nuclei; ds
ae
 is the the dissimilarity degree between nuclei a and b; d is the shift distance between a and b; r
a
, r
b
 are the radii of a and b respectively; and v
a
 and v
b
 are the volume of a and b respectively.

if ds
ae
 is less than  <dig> , a and b are likely to be the same nuclei at different time points. figure  <dig> gives an illustration of this case, where no nuclei b
t+ <dig> exists in t +  <dig> time point image, but according to images before and after, dsbtbt+ <dig> is less than  <dig> , so the missed nuclei b
t+ <dig> can still be predicted. besides, if a nucleus captured by a single time point does not exist at the adjacent time points, we can come to the conclusion that this nucleus is a false positive. an example, nuclei d
t+ <dig> at time point t +  <dig>  is shown in figure  <dig> 

both false positive errors and false negative errors can be decreased significantly through our bi-directional prediction method. bi-directional prediction is capable of dealing with some problems that cannot be solved by simply improving image segmentation, and this is the most significant innovation of our method.

step5: nuclei filtering
through the above processing, all the possible nuclei for each time point are recognized and saved in one nuclei list. however, at several consecutive time points, some false positive errors which cannot be eliminated by our bi-directional prediction method, still remain, so we need a filter to deal with this kind of error.

there are two categories of false positive errors . first, the nucleus is actually part of another nucleus; second, the nucleus does not really exist. to distinguish these two kinds of errors, we calculate the distances between every pair of nuclei, and then form a judgement based on the following principles.

if there are two nuclei a and b, and their coordinates are  and  respectively, d
ae
 and d
ae
 are defined as

  dab=xa-xb2+ya-yb2+za-zb <dig>  

  dab=xa-xb2ya-yb <dig>  

we consider that nucleus a and b are actually part of each other if nuclei a and b satisfy the following relationship, where r
a
 and r
b
 are the radii of nuclei a and b respectively, and then we merge a and b into one new nucleus:

  dab<a×ra+rb, <dig> <a< <dig> , 

  dab<β×ra+rb, <dig> <β< <dig>  

we consider either nucleus a and b does not really exist, if nuclei a and b satisfy the following relationship

  dab<a×ra+rb, <dig> <a< <dig>  

  dab>β×ra+rb, <dig> <β< <dig>  

then we select nucleus a or b to be deleted based on their volume and gray values.

finally, an optimal nuclei list is obtained, representing the expected properties including nuclei id, 3d center coordinate, nucleus volume, radius, 2d slice and gray value. with this list we can generate the information for lineage tracing. in fact for the existing tracing method, the necessary information is the 3d coordinate of the nuclei center and gray value. other very important information can be used to improve the tracing algorithm in starrynite.

experiment 
RESULTS
we used our method on data sets obtained from our leica sp <dig> microscope.  we also applied our nuclei segmentation results to the generation of a lineage tree with the tracing algorithm in starrynite. the performance of the nuclei segmentation method can be evaluated by the following aspects: nuclei number, accuracy rate and editing time needed for building a lineage tree.

nuclei number
the maximum number of nuclei that can be detected  by starrynite  <cit>  and matlab starrynite  <cit>  for a single time point is about  <dig> and  <dig>  respectively. for matlab starrynite, after the  <dig> cell stage, the false negative errors begin to appear in large numbers. at the 500– <dig> cell stage, nuclei segmentation of starrynite will miss 20– <dig> nuclei in every time point, thereby the error rate at the 500– <dig> cell stage will be 4%-12%, leading to omissions of large numbers of nuclei in the lineage tree built by the tracing part even without any tracing errors. it makes it almost impossible for further editing after the  <dig> cell stage. however, in our method, as the nuclei number data shows in figure  <dig>  a considerable advance in nuclei number can be clearly observed at the 500– <dig> cell stage.

error rate
the number of nuclei is just a coarse evaluation index of performance of a nuclei segmentation system, because recognition errors of nuclei may still exist as interfering factors, while a leap in accuracy rate can directly reflect the application value of our method. as previously mentioned, the main error types caused by nuclei segmentation are false positives and false negatives. it can be seen in figures  <dig>   <dig> and  <dig> that our nuclei segmentation is much better than matlab starrynite  in at the 450– <dig> cell stage when tested on our data set. furthermore, at the  <dig> cell stage, a very low error rate  is still maintained as an assurance for the stability of the tracing result by using our nuclei segmentation system. the overall error rate  is less than 1%.

all our data sets are sampled with 90 seconds time resolution, but a better result will be reached if the time resolution is increased to 60 seconds as in the image protocol in aydin  <cit> . this is because the nuclei will become shorter as the time resolution is increased from 90 seconds to 60 seconds, which will greatly reduce the difficulty in the following bi-directional prediction.

editing time
editing time needed for one correct lineage tree is another important performance criterion. in bao  <cit> , starrynite requires 4–10 hours to edit the tree at the  <dig> cell stage, and due to the aforementioned maximum-number limit of nuclei by the nuclei segmentation part in starrynite, it is quite hard to edit the lineage tree beyond the  <dig> cell stage. one lineage tree, which was edited to the  <dig> cell stage using starrynite, required more than one week of manual editing  <cit> . santella’s 2d blob-slice method performed much better than starrynite, richards  <cit>  used santella’s method and could reach the  <dig> cell stage with 8–16 hours manually editing. their images have a double high resolution in the z direction, that is there are  <dig> images in every time point, nearly twice the number of images used in our case. as the number of images double, the storage space required for image and computation time also doubles as a consequence. we performed our method on data sets 130108nhr25p <dig> and 130108pha4p <dig>  which requires only 30 minutes for a  <dig> cells lineage tree, and eight hours for a  <dig> cell lineage tree.

discussion
there have been several methods for automatic cell lineage tree generation. starrynite  <cit>  together with a tool named acetree  <cit>  provided an efficient system for cell recognition and annotation. santella  <cit>  and richard  <cit>  improved the nuclei segmentation with a different method. santella  <cit>  revised the nuclei segmentation with a 2d blob-slice method, and richard  <cit>  advanced the output of the tracing procedure by increasing the image resolution of the z-axis with a new type of resonance-scanning microscopy. due to poor image quality and the rapid multiplying of nuclei after the  <dig> cell stage, there are substantial nuclei segmentation errors, especially false negative ones, causing large numbers of unavoidable follow-up errors and long time manual editing of the cell lineage. therefore a bi-directional prediction technique was developed by us as an efficient way to alleviate these issues. at the same time, other methods such as level-set, region growing and a modified gradient algorithm has also been adopted for the purpose of improving our nuclei segmentation system.

in our work, instead of using single time point images for nuclei segmentation, we take advantage of the bi-directional prediction technique, analyzing the images before and after the current time point to improve nuclei identification. as the interval between two adjacent sampling times is only 50–90 seconds, the coordinates, size, and expression value of the same nucleus in two adjacent time points remain nearly unchanged. this feature significantly reduces the segmentation errors in several continuous time points. one omitted nucleus could certainly be discovered from nuclei segmentation in another time point. we also apply level-set, 2d region growing and the gradient method to our whole nuclei segmentation system. first, the level-set method boosts the image resolution in the z-axis, and ensures the integrity of the edge information by smoothing the image under the curvature. moreover, noises existing in the images also get reduced by the level-set method. second, our 2d region growing method can achieve an accurate 2d slice segmentation. it is mainly because the threshold for our region growing method varies inversely with the size of the nuclei slice, which guarantees that the slices will not be eclipsed by a brighter neighbor. third, the modified gradient method is an effective way to search for the center slices, each of which represents one exclusive nucleus. as demonstrated in experiment results, when the error rate is low, the outcome of our nuclei segmentation method is much better in nuclei reorganization. but due to the existence of errors caused by the tracing part of starrynite, it is still impossible to get a perfectly accurate lineage without manual editing. future research may include work on improving the performance of the tracing algorithm. in fact, the weakest part of the tracing algorithm lies in the cell-division detection, as the algorithm is mainly based on the assumption that the parent cell is located at the center position of two daughter cells. however, at the  <dig> cell stage, a satisfactory result cannot be achieved via the present day cell-division detection algorithm, since the space distribution pattern of a cell becomes more complicated. at the same time, nuclei segmentation errors are common, which indicates that there is still room for much improvement of the starrynite method through the optimization of the tracing algorithm.

CONCLUSIONS
in this paper, we present a novel nuclei segmentation system which can be used for automatic cell lineage tracing. several new designs are introduced using our method, including level-set, region-growing, gradient tracing and bi-directional prediction. among these techniques, the bi-directional prediction, which is capable of detecting nuclei based on backward and forward information, provides a major advance in the nuclei segmentation algorithm. the results using our image data also demonstrate that the proposed algorithm is accurate and practical.

there are still two aspects which need to be noted. first, our level-set preprocessing is time-consuming. this problem can be solved in the future by using more efficient algorithms and more powerful computers. second, at a very late stage , some small and non-spherical nuclei may appear, which are hard to distinguish with the limitations in the current image resolution.

subsequent research may focus on the combination of nuclei segmentation and tracing procedure. a real-time lineage tracing system may then be achieved with this kind of architecture.

